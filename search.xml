<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Kevinello的minecraft服务器</title>
      <link href="/2022/04/11/Kevinello%E7%9A%84minecraft%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2022/04/11/Kevinello%E7%9A%84minecraft%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="kevinellos-minecraft-server-guide"><a class="markdownIt-Anchor" href="#kevinellos-minecraft-server-guide"></a> Kevinello’s Minecraft Server Guide</h1><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/10/mc-server-1-0fdacc.png" alt="mc-server-1" /></p><p>自建的一个小型服务器（目前是白嫖服务器用爱发电的形态)<br />QQ群号: 855073232</p><h2 id="依赖安装"><a class="markdownIt-Anchor" href="#依赖安装"></a> 依赖安装</h2><ul><li><strong>HMCL</strong>启动器依赖的 <code>zulu jdk fx 11</code>:  <a href="https://www.azul.com/downloads/?version=java-11-lts&amp;package=jdk-fx">https://www.azul.com/downloads/?version=java-11-lts&amp;package=jdk-fx</a> (高版本jdk在HMCL上有bug)</li><li><strong>minecraft 1.18</strong>依赖的<code>zulu jdk 17</code>: <a href="https://www.azul.com/downloads/?version=java-17-lts&amp;package=jdk">https://www.azul.com/downloads/?version=java-17-lts&amp;package=jdk</a></li></ul><p>注意对应上自己的系统和架构</p><h2 id="下载整合包以及安装"><a class="markdownIt-Anchor" href="#下载整合包以及安装"></a> 下载整合包以及安装</h2><p>整合包维护在client仓库的release中：<a href="https://github.com/Kevinello-s-minecraft-server/ClientPack/releases">client release</a></p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/10/image-20220410234559606-1eb959.png" alt="image-20220410234559606" /></p><p>点击<code>x.x.x.zip</code>即可下载</p><p>目前整合包内使用的是<a href="https://github.com/huanghongxun/HMCL/releases">HMCL启动器</a>，方便我们配置第三方登录验证以及兼容各架构设备，如有个人使用习惯可使用其它启动器</p><h3 id="首次安装整合包"><a class="markdownIt-Anchor" href="#首次安装整合包"></a> 首次安装整合包</h3><p>使用整合包内自带的启动器启动，启动时会自动安装整合包</p><h3 id="后续更新整合包"><a class="markdownIt-Anchor" href="#后续更新整合包"></a> 后续更新整合包</h3><p>下载好新整合包后，在HMCL的【游戏】中找到自己的游戏实例，点击进入游戏管理</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220219-142828.png" alt="image-20220219142827131" /></p><p>点击更新整合包，拖入新整合包中的modpack.zip，点击安装即可完成更新</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220225-185457.png" alt="image-20220225185456319" /></p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220225-185625.png" alt="image-20220225185625091" /></p><h3 id="littleskin第三方验证"><a class="markdownIt-Anchor" href="#littleskin第三方验证"></a> littleSkin第三方验证</h3><p>本服务器使用第三方认证服务器外置登录，配置方式如下：</p><p>点击进入账户页面</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220225-184158.png" alt="image-20220225184157344" /></p><p>点击添加认证服务器</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220225-184248.png" alt="image-20220225184247260" /></p><p>输入认证服务器地址： <a href="https://littleskin.cn/api/yggdrasil%EF%BC%8C%E7%82%B9%E5%87%BB%E4%B8%8B%E4%B8%80%E6%AD%A5">https://littleskin.cn/api/yggdrasil，点击下一步</a> -&gt; 完成即可</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220225-184444.png" alt="image-20220225184444017" /></p><h2 id="mod统计"><a class="markdownIt-Anchor" href="#mod统计"></a> mod统计</h2><p><strong>不包含依赖形mod（各种fabric API等）</strong></p><h3 id="整合包"><a class="markdownIt-Anchor" href="#整合包"></a> 整合包</h3><h4 id="medieval-minecraft-fabric-1181"><a class="markdownIt-Anchor" href="#medieval-minecraft-fabric-1181"></a> <a href="https://www.curseforge.com/minecraft/modpacks/medieval-minecraft-fabric/files/3663125">Medieval Minecraft [FABRIC] - 1.18.1</a></h4><p>大型中世纪RPG MC整合包</p><h5 id="modlist"><a class="markdownIt-Anchor" href="#modlist"></a> <a href="https://www.curseforge.com/minecraft/modpacks/medieval-minecraft-new/relations/dependencies">ModList</a>(太多了这里就不列了)</h5><h3 id="纯服务端mod"><a class="markdownIt-Anchor" href="#纯服务端mod"></a> 纯服务端mod</h3><p>无需客户端安装的mod</p><table><thead><tr><th>Mod名</th><th>说明</th><th>客户端</th><th>服务端</th></tr></thead><tbody><tr><td>BlueMap</td><td>实时web端地图</td><td>❌</td><td>✅</td></tr><tr><td>essential_commands</td><td>常用便捷命令集合</td><td>❌</td><td>✅</td></tr><tr><td>Lithium</td><td>mc全能优化(物理引擎，方块tick等)</td><td>❌</td><td>✅</td></tr><tr><td>LuckPerms</td><td>命令权限管理系统</td><td>❌</td><td>✅</td></tr><tr><td>neutral animals</td><td>更逼真的动物行为</td><td>❌</td><td>✅</td></tr><tr><td>Phospher</td><td>光照引擎优化</td><td>❌</td><td>✅</td></tr><tr><td>tabtps</td><td>服务器延迟，吞吐量显示</td><td>❌</td><td>✅</td></tr><tr><td>DungeonsArise</td><td>地下城主题生物群系拓展和自然建筑拓展</td><td>❌</td><td>✅</td></tr></tbody></table><h3 id="双端mod"><a class="markdownIt-Anchor" href="#双端mod"></a> 双端mod</h3><p>客户端必须安装的mod（不装可能会出现进不了服务器/区块加载错误等情况）</p><table><thead><tr><th>Mod名</th><th>说明</th><th>客户端</th><th>服务端</th></tr></thead><tbody><tr><td>wraith-waystones</td><td>更优秀的传送系统（传送碑）</td><td>✅</td><td>✅</td></tr><tr><td>XaerosWorldMap</td><td>世界地图（已禁用地图传送）</td><td>✅</td><td>✅</td></tr><tr><td>The Wild Mod</td><td>1.19内容前瞻</td><td>✅</td><td>✅</td></tr><tr><td>Campanion</td><td>户外主题拓展</td><td>✅</td><td>✅</td></tr><tr><td>VanitySlots</td><td>盔甲隐藏</td><td>✅</td><td>✅</td></tr><tr><td>Promenade</td><td>生物群系拓展和自然建筑拓展</td><td>✅</td><td>✅</td></tr><tr><td>Plasmovoice</td><td>mc内置语音系统</td><td>✅</td><td>✅</td></tr><tr><td>diggusmaximus</td><td>连锁挖掘</td><td>✅</td><td>✅</td></tr><tr><td>ferritecore</td><td>mc内存优化</td><td>✅</td><td>✅</td></tr><tr><td>IronChests</td><td>更多箱子</td><td>✅</td><td>✅</td></tr><tr><td>krypton</td><td>mc网络优化</td><td>✅</td><td>✅</td></tr><tr><td>Better Animals Plus</td><td>动物拓展</td><td>✅</td><td>✅</td></tr><tr><td>Create</td><td>机械动力</td><td>✅</td><td>✅</td></tr></tbody></table><h3 id="纯客户端mod"><a class="markdownIt-Anchor" href="#纯客户端mod"></a> 纯客户端mod</h3><p>可自行选择安装的mod（不装也可以正常游玩服务器）</p><table><thead><tr><th>Mod名</th><th>说明</th><th>客户端</th><th>服务端</th></tr></thead><tbody><tr><td>Roughly Enough Items</td><td>REI 更好的合成菜单</td><td>✅</td><td>❌</td></tr><tr><td>continuity</td><td>无缝玻璃</td><td>✅</td><td>❌</td></tr><tr><td>Iris</td><td>新时代光影mod</td><td>✅</td><td>❌</td></tr><tr><td>Sodium</td><td>新时代渲染引擎，客户端优化</td><td>✅</td><td>❌</td></tr><tr><td>Indium</td><td>Sodium附加包(Fabric Rendering API)</td><td>✅</td><td>❌</td></tr><tr><td>InventoryProfilesNext</td><td>背包整理</td><td>✅</td><td>❌</td></tr><tr><td>lambdynamiclights</td><td>动态光源优化</td><td>✅</td><td>❌</td></tr><tr><td>mod menu</td><td>mod管理</td><td>✅</td><td>❌</td></tr><tr><td>pinglist</td><td>实时显示ping值</td><td>✅</td><td>❌</td></tr><tr><td>Sodium Extra</td><td>视频设置控制面板优化</td><td>✅</td><td>❌</td></tr><tr><td>Reese’s Sodium Options</td><td>视频设置控制面板优化</td><td>✅</td><td>❌</td></tr><tr><td>Xaeros_Minimap</td><td>地图面板显示</td><td>✅</td><td>❌</td></tr><tr><td>ToroHealth Damage Indicators</td><td>伤害显示</td><td>✅</td><td>❌</td></tr></tbody></table><h2 id="注意事项"><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项</h2><ol><li>多上线plz</li><li>禁用高频红石，服务器资源有限</li></ol><h2 id="qa"><a class="markdownIt-Anchor" href="#qa"></a> Q&amp;A</h2><ul><li><p>如何在arm架构的系统上运行客户端</p><p>见另一篇文档<a href="https://kevinello.ltd/2022/04/11/Run-minecraft-on-mac-pro-m1/">Run minecraft on mac m1 pro</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 文档 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 服务器 </tag>
            
            <tag> Minecraft </tag>
            
            <tag> mod </tag>
            
            <tag> 游戏 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Run minecraft on mac pro m1</title>
      <link href="/2022/04/11/Run-minecraft-on-mac-pro-m1/"/>
      <url>/2022/04/11/Run-minecraft-on-mac-pro-m1/</url>
      
        <content type="html"><![CDATA[<h1 id="run-minecraft-on-mac-pro-m1"><a class="markdownIt-Anchor" href="#run-minecraft-on-mac-pro-m1"></a> Run minecraft on mac pro m1</h1><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>由于MC自带的必要动态链接库LWJGL的架构是X86，不兼容mac pro m1处理器的arm64架构，原生的MC是无法在m1上启动的；同时由于Apple强推了Metal API，在部分mod / 光影 / 材质包上会有损失部分<code>Feature</code>的情况</p><p>经典放送：</p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/image-20220411002355537-6f720a.png" alt="image-20220411002355537" /></p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/image-20220411002433481-f55c2d.png" alt="image-20220411002433481" /></p><h2 id="基本设置"><a class="markdownIt-Anchor" href="#基本设置"></a> 基本设置</h2><p>见<a href="https://github.com/Kevinello-s-minecraft-server/arm64-minecraft-wrapper">arm64 minecraft wrapper</a></p><p>完成配置后可正常启动<code>Minecraft</code></p><h2 id="mod支持情况"><a class="markdownIt-Anchor" href="#mod支持情况"></a> mod支持情况</h2><p>部分图形渲染相关mod会出现无法渲染文字 / 图像的情况</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220226-230148.png" alt="image-20220226230146964" /></p><h2 id="光影支持情况"><a class="markdownIt-Anchor" href="#光影支持情况"></a> 光影支持情况</h2><p>m1下仅支持部分光影（部分光影会因为Metal API产生Error）</p><p>欣赏经典：<img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220226-224445.png" alt="image-20220226224444049" /></p><h3 id="经过测试已支持的光影"><a class="markdownIt-Anchor" href="#经过测试已支持的光影"></a> 经过测试已支持的光影：</h3><p><a href="https://github.com/MoustacheOff/AppleSilicon-Minecraft-Shaders">https://github.com/MoustacheOff/AppleSilicon-Minecraft-Shaders</a></p><h3 id="推荐使用"><a class="markdownIt-Anchor" href="#推荐使用"></a> 推荐使用</h3><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/20220218-031259.png" alt="image-20220218031258705" /></p><p>注意下载<code>v1.20</code>版本的 <code>Slidur's Shaders</code>，高版本的在m1上有性能问题</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Minecraft </tag>
            
            <tag> Apple </tag>
            
            <tag> Apple silicon </tag>
            
            <tag> arm64 </tag>
            
            <tag> 光影 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小刮刮Scrapy</title>
      <link href="/2022/01/10/%E5%B0%8F%E5%88%AE%E5%88%AEScrapy/"/>
      <url>/2022/01/10/%E5%B0%8F%E5%88%AE%E5%88%AEScrapy/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>从大二开始接触<code>python</code>，到现在已经是第三个年头了；随着入职腾讯，进入云原生行业后，<code>python</code>已经不再是我的主要开发语言，我转而收养了<code>golang</code>小地鼠成为了一名<code>gopher</code></p><p>但<code>python</code>依然是我的工具人好伙伴（日常生活中一旦有自动化的念头也会直接想到<code>python</code>），并且作为数据工作者，对于<code>python</code>的数据处理能力还是挺依赖的，<code>golang</code>的生态也没有好到能面面俱到</p><p>鄙人大二时课设写过一个小小的b站爬虫（基于<code>bs4</code>, <code>re</code>和<code>selenium</code>等简单写的），最后也只是草草爬了几十万的用户数据以及几百万的视频数据，做了做没有什么意义的词频分析，而<code>scrapy</code>作为<strong>我一定会忘记的</strong>爬虫必会知识，还是有必要写一篇小笔记<code>record</code>一下的</p><h2 id="需要了解的词"><a class="markdownIt-Anchor" href="#需要了解的词"></a> 需要了解的词</h2><ul><li>网络爬虫：泛指获取网页信息，提取有用信息的行为</li><li>selenium: web自动化测试工具集，但在爬虫工程中也经常使用，模拟人的点击操作驱动浏览器来获取网页信息</li></ul><h2 id="scrapy是什么"><a class="markdownIt-Anchor" href="#scrapy是什么"></a> <code>Scrapy</code>是什么</h2><p><code>Scrapy</code>是一个为了爬取网站数据，提取结构性数据而编写的应用框架。 可以应用在包括数据挖掘，信息处理或存储历史数据等一系列的程序中。其最初是为了 页面抓取 (更确切来说, 网络抓取 )所设计的， 也可以应用在获取<code>API</code>所返回的数据(例如 <code>Amazon Associates Web Services</code> ) 或者通用的网络爬虫。也是高层次的屏幕抓取和web抓取框架，用于抓取web站点并从页面中提取结构化的数据。<code>Scrapy</code>用途广泛，可以用于数据挖掘、监测和自动化测试。<br /><code>Scrapy</code>吸引人的地方在于它是一个框架，任何人都可以根据需求方便的修改。它也提供了多种类型爬虫的基类，如<code>BaseSpider,sitemap</code>爬虫等</p><h2 id="架构"><a class="markdownIt-Anchor" href="#架构"></a> 架构</h2><p><code>Scrapy</code>使用了 <code>Twisted</code>异步网络库来处理网络通讯，整体架构大致如下：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20220108164149.png" alt="" /></p><h3 id="各组件的作用"><a class="markdownIt-Anchor" href="#各组件的作用"></a> 各组件的作用</h3><h4 id="scrapy-engine"><a class="markdownIt-Anchor" href="#scrapy-engine"></a> Scrapy Engine</h4><blockquote><p>引擎负责控制数据流在系统中所有组件中流动，并在相应动作发生时触发事件。 详细内容查看下面的数据流(Data Flow)部分。</p></blockquote><p>此组件相当于爬虫的“大脑”，是整个爬虫的调度中心</p><h4 id="调度器scheduler"><a class="markdownIt-Anchor" href="#调度器scheduler"></a> 调度器(Scheduler)</h4><blockquote><p>调度器从引擎接受request并将他们入队，以便之后引擎请求他们时提供给引擎。</p></blockquote><p>初始的爬取URL和后续在页面中获取的待爬取的URL将放入调度器中，等待爬取。同时调度器会自动去除重复的URL（如果特定的URL不需要去重也可以通过设置实现，如post请求的URL）</p><h4 id="下载器downloader"><a class="markdownIt-Anchor" href="#下载器downloader"></a> 下载器(Downloader)</h4><blockquote><p>下载器负责获取页面数据并提供给引擎，而后提供给spider</p></blockquote><h4 id="spiders"><a class="markdownIt-Anchor" href="#spiders"></a> Spiders</h4><blockquote><p>Spider是Scrapy用户编写用于分析response并提取item(即获取到的item)或额外跟进的URL的类。 每个spider负责处理一个特定(或一些)网站。</p></blockquote><h4 id="item-pipeline"><a class="markdownIt-Anchor" href="#item-pipeline"></a> Item Pipeline</h4><blockquote><p>Item Pipeline负责处理被spider提取出来的item。典型的处理有清理、 验证及持久化(例如存取到数据库中)</p></blockquote><p>当页面被爬虫解析所需的数据存入Item后，将被发送到项目管道(Pipeline)，并经过几个特定的次序处理数据，最后进行数据持久化</p><h4 id="下载器中间件downloader-middlewares"><a class="markdownIt-Anchor" href="#下载器中间件downloader-middlewares"></a> 下载器中间件(Downloader middlewares)</h4><blockquote><p>下载器中间件是在引擎及下载器之间的特定钩子(specific hook)，处理Downloader传递给引擎的response。 其提供了一个简便的机制，通过插入自定义代码来扩展Scrapy功能。</p></blockquote><p>通过设置下载器中间件可以实现爬虫自动更换<code>user-agent, IP</code>等功能</p><h4 id="spider中间件spider-middlewares"><a class="markdownIt-Anchor" href="#spider中间件spider-middlewares"></a> Spider中间件(Spider middlewares)</h4><blockquote><p>Spider中间件是在引擎及Spider之间的特定钩子(specific hook)，处理spider的输入(response)和输出(items及requests)。 其提供了一个简便的机制，通过插入自定义代码来扩展Scrapy功能。</p></blockquote><h2 id="数据流data-flow"><a class="markdownIt-Anchor" href="#数据流data-flow"></a> 数据流(Data flow)</h2><p><code>scrapy</code>爬取数据时的数据流如下：</p><ol><li>引擎打开一个网站(open a domain)，找到处理该网站的Spider并向该spider请求第一个要爬取的URL(s)</li><li>引擎从Spider中获取到第一个要爬取的URL并在调度器(Scheduler)以Request调度</li><li>引擎向调度器请求下一个要爬取的URL</li><li>调度器返回下一个要爬取的URL给引擎，引擎将URL通过下载中间件(请求(request)方向)转发给下载器(Downloader)</li><li>一旦页面下载完毕，下载器生成一个该页面的Response，并将其通过下载中间件(返回(response)方向)发送给引擎</li><li>引擎从下载器中接收到Response并通过Spider中间件(输入方向)发送给Spider处理。</li><li>Spider处理Response并返回爬取到的Item及(跟进的)新的Request给引擎</li><li>引擎将(Spider返回的)爬取到的Item给Item Pipeline，将(Spider返回的)Request给调度器</li><li>(从第二步)重复直到调度器中没有更多地request，引擎关闭该网站</li></ol><h2 id="hello-world-in-scrapy"><a class="markdownIt-Anchor" href="#hello-world-in-scrapy"></a> hello world in scrapy</h2><h3 id="创建scrapy项目"><a class="markdownIt-Anchor" href="#创建scrapy项目"></a> 创建<code>scrapy</code>项目</h3><p>在项目目录下shell执行：</p><blockquote><p>scrapy startproject tutorial</p></blockquote><p>创建后目录结构如下：</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tutorial&#x2F;</span><br><span class="line">    scrapy.cfg            # deploy configuration file</span><br><span class="line"></span><br><span class="line">    tutorial&#x2F;             # project&#39;s Python module, you&#39;ll import your code from here</span><br><span class="line">        __init__.py</span><br><span class="line"></span><br><span class="line">        items.py          # project items definition file</span><br><span class="line"></span><br><span class="line">        middlewares.py    # project middlewares file</span><br><span class="line"></span><br><span class="line">        pipelines.py      # project pipelines file</span><br><span class="line"></span><br><span class="line">        settings.py       # project settings file</span><br><span class="line"></span><br><span class="line">        spiders&#x2F;          # a directory where you&#39;ll later put your spiders</span><br><span class="line">            __init__.py</span><br></pre></td></tr></table></figure></blockquote><h3 id="定义目标类"><a class="markdownIt-Anchor" href="#定义目标类"></a> 定义目标类</h3><blockquote><p>​Scrapy spider可以以python的dict来返回提取的数据.虽然dict很方便，并且用起来也熟悉，但是其缺少结构性，容易打错字段的名字或者返回不一致的数据，尤其在具有多个spider的大项目中。<br />为了定义常用的输出数据，Scrapy提供了 Item 类。 Item 对象是种简单的容器，保存了爬取到得数据。 其提供了 类似于词典(dictionary-like) 的API以及用于声明可用字段的简单语法。<br />许多Scrapy组件使用了Item提供的额外信息: exporter根据Item声明的字段来导出数据、 序列化可以通过Item字段的元数据(metadata)来定义、 trackref 追踪Item实例来帮助寻找内存泄露 (see 使用 trackref 调试内存泄露) 等等。</p></blockquote><p>以我的习惯我喜欢先定好爬取目标，因为爬虫的主要目标就是从非结构性数据源中提取结构性信息，所以这里我们先在<code>items.py</code>中定义我们的目标数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># http://doc.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TutorialItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    <span class="comment"># name = scrapy.Field()</span></span><br><span class="line">    title = scrapy.Field()</span><br><span class="line">    price = scrapy.Field()</span><br><span class="line">    comment = scrapy.Field()</span><br><span class="line">    product_id = scrapy.Field()</span><br></pre></td></tr></table></figure><h3 id="制作爬虫"><a class="markdownIt-Anchor" href="#制作爬虫"></a> 制作爬虫</h3><p>制作爬虫，总体来说分为两步：<strong>先爬再取</strong></p><p>也就是说，首先你要获取整个网页的所有内容，然后再取出其中对你有用的部分</p><p>要建立一个<code>Spider</code>，你必须用<code>scrapy.spider.BaseSpider</code>创建一个子类，并确定三个强制的属性：</p><ul><li><code>name</code>：爬虫的识别名称，必须是唯一的，在不同的爬虫中你必须定义不同的名字</li><li><code>start_urls</code>：爬取的URL列表；爬虫从这里开始抓取数据，所以，第一次下载的数据将会从这些<code>urls</code>开始，其他子<code>URL</code>将会从这些起始URL中继承性生成</li><li><code>parse()</code>：解析的方法，调用的时候传入从每一个<code>URL</code>传回的<code>Response</code>对象作为唯一参数，负责解析并匹配抓取的数据(解析为<code>item</code>)，跟踪更多的<code>URL</code></li></ul><p>常规使用<code>scrapy.Request</code>来递归地创建<code>Response</code>进行爬取(这种形式下也可以使用<code>bs4</code>, <code>xpath</code>等工具来构建<code>url</code>)：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&quot;quotes&quot;</span></span><br><span class="line">    start_urls = [</span><br><span class="line">        <span class="string">&#x27;http://quotes.toscrape.com/page/1/&#x27;</span>,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="keyword">for</span> quote <span class="keyword">in</span> response.css(<span class="string">&#x27;div.quote&#x27;</span>):</span><br><span class="line">            <span class="keyword">yield</span> &#123;</span><br><span class="line">                <span class="string">&#x27;text&#x27;</span>: quote.css(<span class="string">&#x27;span.text::text&#x27;</span>).get(),</span><br><span class="line">                <span class="string">&#x27;author&#x27;</span>: quote.css(<span class="string">&#x27;small.author::text&#x27;</span>).get(),</span><br><span class="line">                <span class="string">&#x27;tags&#x27;</span>: quote.css(<span class="string">&#x27;div.tags a.tag::text&#x27;</span>).getall(),</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        next_page = response.css(<span class="string">&#x27;li.next a::attr(href)&#x27;</span>).get()</span><br><span class="line">        <span class="keyword">if</span> next_page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            next_page = response.urljoin(next_page)</span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(next_page, callback=self.parse)</span><br></pre></td></tr></table></figure><p>其中<code>20, 21</code>行又可以用<code>response.follow</code>简化为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> next_page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">yield</span> response.follow(next_page, callback=self.parse)</span><br></pre></td></tr></table></figure><p>也可以直接将<code>Selector</code>传递给<code>response.follow</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> href <span class="keyword">in</span> response.css(<span class="string">&#x27;li.next a::attr(href)&#x27;</span>):</span><br><span class="line">    <span class="keyword">yield</span> response.follow(href, callback=self.parse)</span><br></pre></td></tr></table></figure><p>至此我们就得到了我们的目标<code>items</code>，之后我们可以选择直接输出到文件或者pipelines.py`中做数据清洗 / 验证以及数据的持久化存储了</p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p><code>scrapy</code>整体看下来是一个完整但偏笨重的爬虫框架，其优势是支持并发，而且集成了 HTTP 请求、下载、解析、调度等爬虫程序中常见的功能模块，让爬虫工程师只专注于页面解析和制定抓取规则</p><p>但高度的抽象模块们让整个爬虫项目显得比较臃肿，每个爬虫项目都需要按照相应的模版生成好几个文件，这一点上可以类比<code>django</code>，可能在一些简单web应用上我就会选择<code>flask</code>；而对于爬虫来说，基于<code>golang</code>的<code>colly</code>就是一个非常轻便的爬虫框架，并发控制等在<code>golang</code>中也非常简单，在这里埋一个<code>colly</code>爬虫框架的文章坑吧hh</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 并发编程 </tag>
            
            <tag> python </tag>
            
            <tag> web爬虫 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面试官初体验</title>
      <link href="/2022/01/10/%E9%9D%A2%E8%AF%95%E5%AE%98%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
      <url>/2022/01/10/%E9%9D%A2%E8%AF%95%E5%AE%98%E5%88%9D%E4%BD%93%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>近期作为后台开发面试官整理的一些简单面试题（<strong>仅供参考仅供参考仅供参考</strong></p><h2 id="基础题"><a class="markdownIt-Anchor" href="#基础题"></a> 基础题</h2><h3 id="golang"><a class="markdownIt-Anchor" href="#golang"></a> Golang</h3><ol><li><p>Golang中函数调用是传值还是传引用</p><p><strong>golang中所有函数参数传递都是传值</strong>，<code>slice</code>、<code>map</code>和<code>chan</code>看上去像传引用只是因为他们内部有指针或本身就是指针而已；<code>slice</code>结构体里有一个指向底层数组array的指针，所以<code>slice</code>在作为函数参数传递进去的时候，虽然和<code>map</code>以及<code>chan</code>一样可以修改其中的值，但是内部<code>slice</code>若使用append之类的方法修改了大小，则这部分长度信息的变化不会反馈到外层<code>slice</code>中，甚至会因为底层数组扩容（<code>cap</code>扩充）导致内外<code>slice</code>指向了不同的底层数组；而<code>map</code>和<code>chan</code>因为本质上就是指针，故所有函数内的变动都会反馈到外面，除非在函数内部改变了这些指针指向的内存（这也是<code>map</code>和<code>chan</code>的<code>copy</code>的实现方法）</p></li><li><p>Golang中<code>make</code>和<code>new</code>的区别？</p><ul><li><code>make</code> 只能用来分配及初始化类型为 <code>slice</code>、<code>map</code>、<code>chan</code>的数据，<code>new</code>可以分配任意类型的数据</li><li><code>new</code> 分配返回的是指针，即类型 <code>*Type</code>。<code>make</code> 返回引用，即 Type</li><li><code>new</code> 分配的空间被清零；<strong><code>make</code> 分配空间后，会进行初始化</strong></li></ul></li><li><p>以下程序输出为？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    slice := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">    mymap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]*<span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index, value := <span class="keyword">range</span> slice &#123;</span><br><span class="line">        mymap[index] = &amp;value</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> key, value := <span class="keyword">range</span> mymap &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;map[%v]: %v\n&quot;</span>, key, *value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际输出为：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">map</span>[<span class="number">3</span>]=<span class="number">3</span></span><br><span class="line"><span class="keyword">map</span>[<span class="number">0</span>]=<span class="number">3</span></span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>]=<span class="number">3</span></span><br><span class="line"><span class="keyword">map</span>[<span class="number">2</span>]=<span class="number">3</span></span><br></pre></td></tr></table></figure><p>因为<code>for range</code>创建了迭代对象每个元素的副本，而不是直接返回每个元素的引用，如果使用该值变量的地址作为指向每个元素的指针，就会导致错误，在迭代时，返回的变量是<strong>同一个</strong>迭代过程中根据切片依次赋值的变量，所以最终<code>map</code>中存储的地址都是同一个变量的地址，而<strong>其值即为最后一次迭代中赋的值</strong></p></li><li><p>以下程序输出为？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> nums = []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> nums &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Print(nums[i])</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际输出为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">333</span><br></pre></td></tr></table></figure><p>每轮循环启动一个协程，而协程启动与循环变量递增不是在同一个协程，协程启动的速度远小于循环执行的速度，所以即使是第一个协程刚起启动时，循环变量可能已经递增完毕。由于所有的协程共享循环变量i，而且这个i会在最后一个使用它的协程结束后被销毁，所以最后输出结果时<code>i</code>是循环变量的末值即<code>2</code>，输出的都是<code>nums[2]</code></p><p>要想正确地打印<code>nums</code>内的元素，我们可以这样：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> nums = []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> nums &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Print(nums[i])</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>以下程序的输出是？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b <span class="keyword">uint64</span> = <span class="number">10</span></span><br><span class="line">atomic.AddUint64(&amp;b,<span class="number">-3</span>)</span><br><span class="line">fmt.Println(b)</span><br></pre></td></tr></table></figure><p>实际上这样写会使 Go 语言的编译器报错：</p><blockquote><p>constant -3 overflows uint64</p></blockquote><p>因为这样的运算溢出了</p><p>要正确的做这样的运算我们需要：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b <span class="keyword">uint64</span> = <span class="number">10</span></span><br><span class="line"><span class="keyword">var</span> c <span class="keyword">int64</span> = <span class="number">-3</span></span><br><span class="line">atomic.AddUint64(&amp;b, <span class="keyword">uint64</span>(c))</span><br><span class="line">fmt.Println(b)</span><br></pre></td></tr></table></figure></li><li><p>go defer，多个 defer 的顺序，defer 在什么时机会修改返回值？</p><p>阅读以下程序：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;a return:&quot;</span>, a())</span><br><span class="line">        fmt.Println(<span class="string">&quot;b return:&quot;</span>, b())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                i++</span><br><span class="line">                fmt.Println(<span class="string">&quot;defer:&quot;</span>, i)</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                i++</span><br><span class="line">                fmt.Println(<span class="string">&quot;defer:&quot;</span>, i)</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span><span class="params">()</span> <span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                i++</span><br><span class="line">                fmt.Println(<span class="string">&quot;defer:&quot;</span>, i)</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                i++</span><br><span class="line">                fmt.Println(<span class="string">&quot;defer:&quot;</span>, i)</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出为？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a defer: ?</span><br><span class="line">a defer: ?</span><br><span class="line">a return: ?</span><br><span class="line">b defer: ?</span><br><span class="line">b defer: ?</span><br><span class="line">b return: ?</span><br><span class="line">c defer: ?</span><br><span class="line">c defer: ?</span><br><span class="line">c return: ?</span><br></pre></td></tr></table></figure><p>实际输出为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a defer: 1</span><br><span class="line">a defer: 2</span><br><span class="line">a return: 0</span><br><span class="line">b defer: 1</span><br><span class="line">b defer: 2</span><br><span class="line">b return: 2</span><br><span class="line">c defer: 1</span><br><span class="line">c defer: 2</span><br><span class="line">c return: 2</span><br></pre></td></tr></table></figure><ol><li>多个defer的执行顺序为“后进先出”，栈的形式</li><li>defer、return、返回值三者的执行逻辑应该是：return最先执行，return负责将结果写入返回值中；接着defer开始执行一些收尾工作；最后函数携带当前返回值退出</li></ol><p>返回值不同的原因：</p><blockquote><p><code>a()int</code> 函数的返回值没有被提前声明，其值来自于其他变量的赋值，而defer中修改的也是其他变量，而非返回值本身，因此函数退出时返回值并没有被改变</p><p><code>b()(i int)</code> 函数的返回值被提前声明，也就意味着defer中是可以调用到真实返回值的，因此defer在return赋值返回值 i 之后，再一次地修改了 i 的值，最终函数退出后的返回值才会是defer修改过的值</p><p><code>c()*int</code> 的返回值虽然没有被提前声明，但是由于 <code>c()*int</code> 的返回值是指针变量，那么在return将变量 i 的地址赋给返回值后，defer再次修改了 i 在内存中的实际值，因此函数退出时返回值虽然依旧是原来的指针地址，但是其指向的内存实际值已经被成功修改了</p></blockquote></li><li><p>Golang 中的<code>interface</code>是什么？</p><p>go里面的interface分为两种：不带接口的eface和带接口的的iface</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211221141603.png" alt="img" /></p><p>eface只包含两个成员变量，分别是 指向interface类型信息结构体的指针和指向interface所包含的值的空间的指针</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211221141608.png" alt="img" /></p><p>iface包含两部分，itab结构和data结构。data结构与eface中的data结构一样，指向的是interface的值。itab结构中包含了interfacetype指针指向了该interface的静态类型，也就是该interface的类型，比如上文提到的TestInterface这个interface，以及这个interface所包含的方法集。itab的_type字段指向了该iface的动态类型类型，也就是我们把一个实现了该interface所有方法的interface赋值给当前interface的类型。fun字段指向了这个动态类型的函数集，这个函数集是大于静态类型的interface的方法集的。因为它可能包含自己一些另外的方法集。这些函数的集合以字母数序表做排序。至于为何这是一个动态数组，系统位数确定的情况下，函数指针大小是 固定的，往后照着排就可以了</p></li><li><p>反射是什么？Golang中的反射是基于什么实现的？</p><p>在编译时不知道类型的情况下，通过反射机制可以获取对象的类型、值、方法甚至动态改变对象的成员，这就是反射机制</p><p>Golang Reflection 三大法则：</p><ol><li><strong>Reflection goes from interface value to reflection object</strong></li><li><strong>Reflection goes from reflection object to interface value</strong></li><li><strong>To modify a reflection object, the value must be settable</strong></li></ol><p>总而言之，Golang中的反射是基于<code>interface</code>实现的，因为任意类型都实现了<code>interface&#123;&#125;</code>类型，所以可以把任意类型的变量转换成<code>interface&#123;&#125;</code>类型，所以反射能从<code>interface&#123;&#125;</code>的数据结构中反射出对象，也就是利用reflect.ValueOf和reflect.TypeOf从interface反射出对象的具体信息</p></li><li><p>以下程序会输出什么？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;reflect&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> x <span class="keyword">int</span> = <span class="number">8</span></span><br><span class="line">v := reflect.ValueOf(x)</span><br><span class="line">v.SetInt(<span class="number">24</span>)</span><br><span class="line"><span class="built_in">println</span>(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>会<code>Panic</code>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">panic</span>: reflect: reflect.Value.SetInt using unaddressable value</span><br></pre></td></tr></table></figure><p>对应 Reflection 三大法则的第三条，要修改一个反射对象，它的值必须是能修改的；简单点说，就是通过反射，必须反射出它的本身，而不是它的一份拷贝</p><p>传入<code>reflect.ValueOf()</code>的x只是x的一个拷贝，对v的修改反应不到x本身上，所以会panic</p><p>那怎么反射出它的本身，和我们函数传参的时候很像：地址；将上文的<code>v := reflect.ValueOf(x)</code>改为<code>v := reflect.ValueOf(&amp;x).Elem()</code>即可，如果想要操作原变量，反射变量 <code>Value</code> 必须要 hold 住原变量的地址才行：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;reflect&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> x <span class="keyword">int</span> = <span class="number">8</span></span><br><span class="line">v := reflect.ValueOf(&amp;x).Elem()</span><br><span class="line">v.SetInt(<span class="number">24</span>)</span><br><span class="line"><span class="built_in">println</span>(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>已关闭的channel再次读取会出现什么现象？</p></li></ol><p>closed channel是可以被消费者继续读取的，在读完了有意义的数据之后，将读到一堆空值</p><ol start="11"><li><p>如何判断一个<code>channel</code>已关闭？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsClosed</span><span class="params">(ch &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-ch:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数中ch是一个只读的channel，因为&lt;-ch左侧没有接收者，所以如果channel没有关闭，<code>case &lt;-ch</code>就会被阻塞，又因为select中写了default语句，所以select会直接执行default的空分支，最终return false；如果channel关闭了，<code>case &lt;-ch</code>就不会被阻塞，直接执行该分支return true</p></li><li><p>map 循环是有序的还是无序的？</p><p>无序的</p></li></ol><h3 id="java"><a class="markdownIt-Anchor" href="#java"></a> Java</h3><ol><li><p>ArrayList和LinkedList的区别</p><ol><li><p>数据的更新和查找</p><p>ArrayList的所有数据是在同一个地址上,而LinkedList的每个数据都拥有自己的地址.所以在对数据进行查找的时候，由于LinkedList的每个数据地址不一样，get数据的时候ArrayList的速度会优于LinkedList，而更新数据的时候，虽然都是通过循环循环到指定节点修改数据，但LinkedList的查询速度已经是慢的，而且对于LinkedList而言，更新数据时不像ArrayList只需要找到对应下标更新就好，LinkedList需要修改指针，速率不言而喻</p></li><li><p>数据的增加和删除</p><p>对于数据的增加元素，ArrayList是通过移动该元素之后的元素位置，其后元素位置全部+1，所以耗时较长，而LinkedList只需要将该元素前的后续指针指向该元素并将该元素的后续指针指向之后的元素即可。与增加相同，删除元素时ArrayList需要将被删除元素之后的元素位置-1，而LinkedList只需要将之后的元素前置指针指向前一元素，前一元素的指针指向后一元素即可。当然，事实上，若是单一元素的增删，尤其是在List末端增删一个元素，二者效率不相上下</p></li></ol></li><li><p>HashMap 和 HashTable 区别</p><p>最大的区别：</p><ol><li><p>HashMap 不是线程安全的</p><p>HashMap 是 map 接口的实现类，是将键映射到值的对象，其中键和值都是对象，并且不能包含重复键，但可以包含重复值。HashMap 允许 null key 和 null value，而 HashTable 不允许</p></li><li><p>HashTable 是线程安全 Collection</p><p>HashMap 是 HashTable 的轻量级实现，他们都完成了Map 接口，主要区别在于 HashMap 允许 null key 和 null value,由于非线程安全，效率上可能高于 Hashtable</p></li></ol><p>其它区别如下：</p><ul><li>HashMap允许将 null 作为一个 entry 的 key 或者 value，而 Hashtable 不允许。</li><li>HashMap 把 Hashtable 的 contains 方法去掉了，改成 containsValue 和 containsKey。因为 contains 方法容易让人引起误解。</li><li>HashTable 继承自 Dictionary 类，而 HashMap 是 Java1.2 引进的 Map interface 的一个实现。</li><li>HashTable 的方法是 Synchronize 的，而 HashMap 不是，在多个线程访问 Hashtable 时，不需要自己为它的方法实现同步，而 HashMap 就必须为之提供外同步。</li><li>Hashtable 和 HashMap 采用的 hash/rehash 算法都大概一样，所以性能不会有很大的差异。</li></ul></li><li><p>List接口、Set接口和Map接口的区别</p><p>Collection表示一组对象,这些对象也称为collection的元素;一些 collection允许有重复的元素,而另一些则不允许;一些collection是有序的,而另一些则是无序的;JDK中不提供此接口的任何直接实 现,它提供更具体的子接口(如 Set 和 List)实现;Map没有继承Collection接口,Map提供key到value的映射;一个Map中不能包含相同key,每个key只能映射一个value;Map接口提供3种集合的视图,Map的内容可以被当做一组key集合,一组value集合,或者一组key-value映射</p></li><li><p>Java线程间的通信方式</p><ol><li><p>wait()方法</p><p>wait()方法使得当前线程必须要等待，等到另外一个线程调用notify()或者notifyAll()方法。</p><p>当前的线程必须拥有当前对象的monitor，也即lock，就是锁。</p><p>线程调用wait()方法，释放它对锁的拥有权，然后等待另外的线程来通知它（通知的方式是notify()或者notifyAll()方法），这样它才能重新获得锁的拥有权和恢复执行。</p><p>要确保调用wait()方法的时候拥有锁，即，wait()方法的调用必须放在synchronized方法或synchronized块中。</p><p>一个小比较：</p><p>当线程调用了wait()方法时，它会释放掉对象的锁。</p><p>另一个会导致线程暂停的方法：Thread.sleep()，它会导致线程睡眠指定的毫秒数，但线程在睡眠的过程中是不会释放掉对象的锁的。</p></li><li><p>notify()方法</p><p>notify()方法会唤醒一个等待当前对象的锁的线程。</p><p>如果多个线程在等待，它们中的一个将会选择被唤醒。这种选择是随意的，和具体实现有关。（线程等待一个对象的锁是由于调用了wait方法中的一个）。</p><p>被唤醒的线程是不能被执行的，需要等到当前线程放弃这个对象的锁。</p><p>被唤醒的线程将和其他线程以通常的方式进行竞争，来获得对象的锁。也就是说，被唤醒的线程并没有什么优先权，也没有什么劣势，对象的下一个线程还是需要通过一般性的竞争。</p><p>notify()方法应该是被拥有对象的锁的线程所调用。</p><p>(This method should only be called by a thread that is the owner of this object’s monitor)</p><p>换句话说，和wait()方法一样，notify方法调用必须放在synchronized方法或synchronized块中。</p><p>wait()和notify()方法要求在调用时线程已经获得了对象的锁，因此对这两个方法的调用需要放在synchronized方法或synchronized块中。</p><p>一个线程变为一个对象的锁的拥有者是通过下列三种方法：</p><ol><li>执行这个对象的synchronized实例方法。</li><li>执行这个对象的synchronized语句块。这个语句块锁的是这个对象。</li><li>对于Class类的对象，执行那个类的synchronized、static方法。</li></ol></li></ol></li><li><p>判断对象是垃圾 ?</p><p>有两种经典的判断方法：</p><ul><li><p>引用计数法，思路很简单，但是如果出现循环引用，即：A 引用 B，B 又引用 A，这种情况下就不好办了，所以 JVM 中使用了另一种称为“可达性分析”的判断方法</p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/5730cbe92c7b18b703ec25cced784feb-75fd23.png" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p></li><li><p>可达性分析法</p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/16456a32e56133a848752b8ece9ce201-4479e1-7ae5b2.png" alt="img" /></p></li></ul></li><li><p>如果 A 引用 B，B 又引用 A，这 2 个对象是否能被 GC 回收？</p><p>关键不是在于 A、B 之间是否有引用，而是 A、B 是否可以一直向上追溯到 GC Roots。如果与 GC Roots 没有关联，则会被回收，否则将继续存活。</p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/0e93fb1a4ded082105a42ce3083c1870-8416df.png" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p>上图是一个用“可达性分析”标记垃圾对象的示例图，灰色的对象表示不可达对象，将等待回收。</p></li><li><p>常用的 GC 算法</p><ol><li><p>mark-sweep 标记清除法</p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/7c5cfe28cf47c791b84a687ffa1c11af-cd6c1d.png" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p>如上图，黑色区域表示待清理的垃圾对象，标记出来后直接清空。该方法简单快速，但是缺点也很明显，会产生很多内存碎片</p></li><li><p>mark-copy 标记复制法</p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/262523a518bcf925cc161aa6444cac30-274d4c.png" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p>思路也很简单，将内存对半分，总是保留一块空着（上图中的右侧），将左侧存活的对象（浅灰色区域）复制到右侧，然后左侧全部清空。避免了内存碎片问题，但是内存浪费很严重，相当于只能使用 50%的内存。</p></li><li><p>mark-compact 标记-整理（也称标记-压缩）法</p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/4c7fa2074cfeae304dd10f140e2ba6b0-f2be23.png" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p>避免了上述两种算法的缺点，将垃圾对象清理掉后，同时将剩下的存活对象进行整理挪动（类似于 windows 的磁盘碎片整理），保证它们占用的空间连续，这样就避免了内存碎片问题，但是整理过程也会降低 GC 的效率。</p></li></ol></li><li><p>equals()和 ==的区别</p><p>JAVA当中所有的类都是继承于Object这个超类的，在Object类中定义了一个equals的方法，equals的源码是这样写的：</p> <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public boolean equals(Object obj) &#123;</span><br><span class="line">    //this - s1</span><br><span class="line">    //obj - s2</span><br><span class="line">    return (this == obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" />可以看到，这个方法的初始默认行为是比较对象的内存地址值，一般来说，意义不大。所以，在一些类库当中这个方法被重写了，如String、Integer、Date。在这些类当中equals有其自身的实现（一般都是用来比较对象的成员变量值是否相同），而不再是比较类在堆内存中的存放地址了。<br />所以说，对于复合数据类型之间进行equals比较，在没有覆写equals方法的情况下，他们之间的比较还是内存中的存放位置的地址值，跟双等号（==）的结果相同；如果被复写，按照复写的要求来。</p><p>我们对上面的两段内容做个总结吧：</p><p><strong>== 的作用：</strong><br />　基本类型：比较的就是值是否相同<br />　引用类型：比较的就是地址值是否相同<br /><strong>equals 的作用:</strong><br />　引用类型：默认情况下，比较的是地址值。<br />注：不过，我们可以根据情况自己重写该方法。一般重写都是自动生成，比较对象的成员变量值是否相同</p></li></ol><h3 id="redis"><a class="markdownIt-Anchor" href="#redis"></a> Redis</h3><ol><li><p>redis<strong>事务</strong>满足关系性数据库事务的特性吗</p><p><code>Redis</code>事务仅具有一致性与隔离性，不保证原子性和持久性</p></li><li><p><strong>zset</strong>的实现原理（或者说数据结构）</p></li><li><p>redis中<strong>pipeline</strong>的作用</p><p>pipeline的作用是将一批命令进行打包，然后发送给服务器，服务器执行完按顺序打包返回，主要作用是减少与<code>redis server</code>的IO次数，减少网络IO消耗</p></li><li><p>LRU 和 LFU 是？</p><p>LRU（Least recently used，最近最少使用）算法根据数据的历史访问记录来进行淘汰数据，其核心思想是“如果数据最近被访问过，那么将来被访问的几率也很高”，反过来说“如果数据最近这段时间一直都没有访问,那么将来被访问的概率也会很低”，两种理解是一样的；常用于页面置换算法，为虚拟页式存储管理服务。</p></li><li><p>分布式锁的基本实现以及坑（展开到进阶实现）</p><p><strong>基于 Redis 的 <code>NX EX</code> 参数</strong></p><p>利用 <code>Redis set key</code> 的 NX 参数来保证在这个 key 不存在的情况下写入成功，并且再加上 EX 参数设置过期时间</p><p>进阶：</p><ul><li><p><strong>A进程释放了B进程的锁</strong><br />如果进程 A 获取了锁设置了超时时间，但是由于<strong>执行周期较长</strong>导致到了超时时间之后锁就自动释放了。这时进程 B 获取了该锁，然而这时进程 A 执行完了，释放了该锁；这样就会出现进程 A 将进程 B 的锁释放了<br />所以最好的方式是在每次解锁时都需要判断锁<strong>是否是自己</strong>的（生成uuid放到value中）</p></li><li><p><strong>锁过期了，业务还没执行完</strong><br />设置<code>看门狗</code>，在业务执行时自动延长锁的过期时间（<strong>举例子</strong>：假如加锁的时间是30秒，过10秒检查一次，一旦加锁的业务没有执行完，就会进行一次续期，把锁的过期时间再次重置成30秒）</p></li><li><p>redis 主从复制导致锁丢失<br />在分布式redis中，主节点没来的及把<strong>刚刚set进来这条数据</strong>给从节点，就挂了，这就造成了redis异步复制造成的锁丢失<br />使用<code>RedLock</code>：红锁算法认为，只要n/2+1个节点加锁成功，那么就认为获取了锁， 解锁时将所有实例解锁。 流程为：</p><ol><li>顺序向五个节点请求加锁</li><li>根据一定的<strong>超时时间</strong>来推断是不是跳过该节点</li><li>三个节点加锁成功并且花费时间小于锁的有效期</li><li>认定加锁成功</li></ol></li></ul></li><li><p>Redis的内存碎片是什么？Redis的内存碎片清理机制是什么？</p><h4 id="产生内存碎片的主要原因"><a class="markdownIt-Anchor" href="#产生内存碎片的主要原因"></a> 产生内存碎片的主要原因：</h4><ul><li><code>redis</code>自己实现的内存分配器：在<code>redis</code>中新建<code>key-value</code>值时，<code>redis</code>需要向操作系统申请内存，一般的进程在不需要使用申请的内存后，会直接释放掉、归还内存；但<code>redis</code>不一样，<code>redis</code>在使用完内存后并不会直接归还内存，而是放在<code>redis</code>自己实现的内存分配器中管理，这样就不需要每次都向操作系统申请内存了，实现了高性能（但这样其它应用可就不高兴了，自私的Redis）</li><li><code>value</code>的更新：<code>redis</code>的每个<code>key-value</code>对初始化的内存大小是最适合的，当这个<code>value</code>改变的并且原来内存大小不适用的时候，就需要重新分配内存了，重新分配之后，就会有一部分内存<code>redis</code>无法正常回收，一直占用着</li></ul><h4 id="如何清理内存碎片"><a class="markdownIt-Anchor" href="#如何清理内存碎片"></a> 如何清理内存碎片？</h4><h5 id="redis版本40以下"><a class="markdownIt-Anchor" href="#redis版本40以下"></a> Redis版本4.0以下</h5><p>重启<code>redis</code>，自动归还所有内存，简单粗暴</p><h5 id="redis版本40以上"><a class="markdownIt-Anchor" href="#redis版本40以上"></a> Redis版本4.0以上</h5><p>可以开启自动内存碎片清理：</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEXT</span><br><span class="line">127.0.0.1:6379[6]&gt; config set activedefrag yes</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>自动内存清理的一些相关配置如下：</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TEXT</span><br><span class="line"># Enabled active defragmentation</span><br><span class="line"># 碎片整理总开关</span><br><span class="line"># activedefrag yes</span><br><span class="line"></span><br><span class="line"># Minimum amount of fragmentation waste to start active defrag</span><br><span class="line"># 内存碎片达到多少的时候开启整理</span><br><span class="line">active-defrag-ignore-bytes 100mb</span><br><span class="line"></span><br><span class="line"># Minimum percentage of fragmentation to start active defrag</span><br><span class="line"># 碎片率达到百分之多少开启整理</span><br><span class="line">active-defrag-threshold-lower 10</span><br><span class="line"></span><br><span class="line"># Maximum percentage of fragmentation at which we use maximum effort</span><br><span class="line"># 碎片率小余多少百分比开启整理</span><br><span class="line">active-defrag-threshold-upper 100</span><br></pre></td></tr></table></figure><p>当然，在面对一些复杂的场景时我们希望能根据自己设计的策略来进行内存碎片清理，<code>redis</code>也提供了手动内存碎片清理的命令：</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEXT</span><br><span class="line">127.0.0.1:6379&gt; memory purge</span><br><span class="line">OK</span><br></pre></td></tr></table></figure></li></ol><h3 id="数据库"><a class="markdownIt-Anchor" href="#数据库"></a> 数据库</h3><ol><li><p>如何用Mysql实现分布式锁</p><p>创建一张锁表，然后通过操作该表中的数据来实现加锁和解锁。当要锁住某个方法或资源时，就向该表插入一条记录，表中设置方法名为唯一键，这样多个请求同时提交数据库时，只有一个操作可以成功，判定操作成功的线程获得该方法的锁，可以执行方法内容；想要释放锁的时候就删除这条记录，其他线程就可以继续往数据库中插入数据获取锁</p></li><li><p>什么是触发器？触发器的使用场景有哪些?</p><p>触发器是用户定义在关系表上的一类由事件驱动的特殊的存储过程。触发器是指一段代码，当触发某个事件时，自动执行这些代码</p><p>使用场景</p><p>可以通过数据库中的相关表实现级联更改。<br />实时监控某张表中的某个字段的更改而需要做出相应的处理。<br />例如可以生成某些业务的编号。<br />注意不要滥用，否则会造成数据库及应用程序的维护困难。<br />大家需要牢记以上基础知识点，重点是理解数据类型CHAR和VARCHAR的差异，表存储引擎InnoDB和MyISAM的区别</p></li><li><p>MySQL中都有哪些触发器?</p><p>在MySQL数据库中有如下六种触发器：</p><p>Before Insert<br />After Insert<br />Before Update<br />After Update<br />Before Delete<br />After Delete</p></li><li><p>SQL 约束有哪几种？</p><p>NOT NULL: 用于控制字段的内容一定不能为空（NULL）。<br />UNIQUE: 控件字段内容不能重复，一个表允许有多个 Unique 约束。<br />PRIMARY KEY: 也是用于控件字段内容不能重复，但它在一个表只允许出现一个。<br />FOREIGN KEY: 用于预防破坏表之间连接的动作，也能防止非法数据插入外键列，因为它必须是它指向的那个表中的值之一。<br />CHECK: 用于控制字段的值范围</p></li><li><p>六种关联查询</p><p>交叉连接（CROSS JOIN）<br />内连接（INNER JOIN）<br />外连接（LEFT JOIN/RIGHT JOIN）<br />联合查询（UNION与UNION ALL）<br />全连接（FULL JOIN）<br />交叉连接（CROSS JOIN）<br />SELECT * FROM A,B(,C)或者SELECT * FROM A CROSS JOIN B (CROSS JOIN C)#没有任何关联条件，结果是笛卡尔积，结果集会很大，没有意义，很少使用内连接（INNER JOIN）SELECT * FROM A,B WHERE A.id=B.id或者SELECT * FROM A INNER JOIN B ON A.id=B.id多表中同时符合某种条件的数据记录的集合，INNER JOIN可以缩写为JOIN</p></li><li><p>内连接分为三类</p><p>等值连接：ON <a href="http://A.id=B.id">A.id=B.id</a><br />不等值连接：ON <a href="http://A.id">A.id</a> &gt; <a href="http://B.id">B.id</a><br />自连接：SELECT * FROM A T1 INNER JOIN A T2 ON T1.id=T2.pid<br />外连接（LEFT JOIN/RIGHT JOIN）</p><p>左外连接：LEFT OUTER JOIN, 以左表为主，先查询出左表，按照ON后的关联条件匹配右表，没有匹配到的用NULL填充，可以简写成LEFT JOIN<br />右外连接：RIGHT OUTER JOIN, 以右表为主，先查询出右表，按照ON后的关联条件匹配左表，没有匹配到的用NULL填充，可以简写成RIGHT JOIN</p></li><li><p>varchar与char的区别</p><p>char的特点</p><p>char表示定长字符串，长度是固定的；</p><p>如果插入数据的长度小于char的固定长度时，则用空格填充；</p><p>因为长度固定，所以存取速度要比varchar快很多，甚至能快50%，但正因为其长度固定，所以会占据多余的空间，是空间换时间的做法；</p><p>对于char来说，最多能存放的字符个数为255，和编码无关</p><p>varchar的特点</p><p>varchar表示可变长字符串，长度是可变的；</p><p>插入的数据是多长，就按照多长来存储；</p><p>varchar在存取方面与char相反，它存取慢，因为长度不固定，但正因如此，不占据多余的空间，是时间换空间的做法；</p><p>对于varchar来说，最多能存放的字符个数为65532</p></li><li><p>索引有哪几种类型？</p><p>主键索引: 数据列不允许重复，不允许为NULL，一个表只能有一个主键。</p><p>唯一索引: 数据列不允许重复，允许为NULL值，一个表允许多个列创建唯一索引。</p><p>可以通过 ALTER TABLE table_name ADD UNIQUE (column); 创建唯一索引</p><p>可以通过 ALTER TABLE table_name ADD UNIQUE (column1,column2); 创建唯一组合索引</p><p>普通索引: 基本的索引类型，没有唯一性的限制，允许为NULL值。</p><p>可以通过ALTER TABLE table_name ADD INDEX index_name (column);创建普通索引</p><p>可以通过ALTER TABLE table_name ADD INDEX index_name(column1, column2, column3);创建组合索引</p><p>全文索引： 是目前搜索引擎使用的一种关键技术。</p><p>可以通过ALTER TABLE table_name ADD FULLTEXT (column);创建全文索引</p></li></ol><h3 id="网络"><a class="markdownIt-Anchor" href="#网络"></a> 网络</h3><ol><li><p>讲讲Nginx负载均衡</p><ul><li>轮询、轮询是默认的，每一个请求按顺序逐一分配到不同的后端服务器，如果后端服务器down掉了，则能自动剔除</li><li>ip_hash、个请求按访问IP的hash结果分配，这样来自同一个IP的访客固定访问一个后端服务器，有效解决了动态网页存在的session共享问题。</li><li>weight、weight是设置权重，用于后端服务器性能不均的情况，访问比率约等于权重之比</li><li>fair(第三方)、这是比上面两个更加智能的负载均衡算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx本身是不支持fair的，如果需要使用这种调度算法，必须下载Nginx的upstream_fair模块。</li><li>url_hash(第三方)此方法按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，可以进一步提高后端缓存服务器的效率。Nginx本身是不支持url_hash的，如果需要使用这种调度算法，必须安装Nginx 的hash软件包。</li></ul></li><li><p>正向代理，反向代理是什么？</p><p><strong>正向代理</strong>，也就是传说中的代理, 简单的说，我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。从网站的角度，只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求，也隐藏了用户的资料，这取决于代理告不告诉网站。</p><p><strong>反向代理</strong>： 结论就是，反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。</p></li><li><p>Cookie和Session的区别</p><p>cookie和session都是用来跟踪浏览器用户身份的会话方式</p><p>区别：</p><ul><li>cookie数据保存在客户端，session数据保存在服务器端。简单的说，当你登录一个网站的时候, 如果web服务器端使用的是session，那么所有的数据都保存在服务器上，客户端每次请求服务器的时候会发送当前会话的sessionid，服务器根据当前sessionid判断相应的用户数据标志，以确定用户是否登录或具有某种权限。由于数据是存储在服务器上面，所以你不能伪造。</li><li>sessionid是服务器和客户端链接时候随机分配的. 如果浏览器使用的是cookie，那么所有的数据都保存在浏览器端，比如你登录以后，服务器设置了cookie用户名，那么当你再次请求服务器的时候，浏览器会将用户名一块发送给服务器，这些变量有一定的特殊标记。服务器会解释为cookie变量，所以只要不关闭浏览器，那么cookie变量一直是有效的，所以能够保证长时间不掉线。如果你能够截获某个用户的 cookie变量，然后伪造一个数据包发送过去，那么服务器还是认为你是合法的。所以，使用 cookie被攻击的可能性比较大。</li></ul><p>如果设置了的有效时间，那么它会将 cookie保存在客户端的硬盘上，下次再访问该网站的时候，浏览器先检查有没有 cookie，如果有的话，就读取该 cookie，然后发送给服务器。如果你在机器上面保存了某个论坛 cookie，有效期是一年，如果有人入侵你的机器，将你的 cookie拷走，然后放在他的浏览器的目录下面，那么他登录该网站的时候就是用你的的身份登录的。所以 cookie是可以伪造的。当然，伪造的时候需要主意，直接copy cookie文件到 cookie目录，浏览器是不认的，他有一个index.dat文件，存储了 cookie文件的建立时间，以及是否有修改，所以你必须先要有该网站的 cookie文件，并且要从保证时间上骗过浏览器</p><p>两个都可以用来存私密的东西，同样也都有有效期的说法,区别在于session是放在服务器上的，过期与否取决于服务期的设定，cookie是存在客户端的，过去与否可以在cookie生成的时候设置进去。</p><p>(1)cookie数据存放在客户的浏览器上，session数据放在服务器上<br />(2)cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗,如果主要考虑到安全应当使用session<br />(3)session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用COOKIE<br />(4)单个cookie在客户端的限制是3K，就是说一个站点在客户端存放的COOKIE不能3K。</p></li><li><p>csrf攻击是什么？常见的防御手段有什么？</p><p><strong>跨站点请求伪造</strong></p><p>简单来说就是<strong>通过伪装成受信任用户的请求来利用受信任的网站</strong></p><blockquote><p>在用户信息通过验证后，网站A产生Cookie信息并返回给浏览器，此时用户登录网站A成功，可以正常发送请求到网站A；</p><p>用户未退出网站A之前，在同一浏览器中，打开一个TAB页访问网站B；</p><p>网站B接收到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点A；</p><p>浏览器在接收到这些攻击性代码后，根据网站B的请求，在用户不知情的情况下携带Cookie信息，向网站A发出请求。网站A并不知道该请求其实是由B发起的，所以会根据用户C的Cookie信息以C的权限处理该请求，导致来自网站B的恶意代码被执行</p></blockquote><h4 id="防御手段"><a class="markdownIt-Anchor" href="#防御手段"></a> 防御手段：</h4><ul><li>验证HTTP Referer字段</li><li>在请求地址中添加token并验证</li><li>在HTTP头中自定义属性并验证</li></ul></li><li><p>请说明一下http和https的区别</p><p>https协议要申请证书到ca，需要一定经济成本；2） http是明文传输，https是加密的安全传输；3） 连接的端口不一样，http是80，https是443；4）http连接很简单，没有状态；https是ssl加密的传输，身份认证的网络协议，相对http传输比较安全</p></li><li><p>请讲一下浏览器从接收到一个URL，到最后展示出页面，经历了哪些过程</p><p>1.DNS解析</p><p>2.TCP连接</p><p>3.发送HTTP请求</p><p>4.服务器处理请求并返回HTTP报文</p><p>5.浏览器解析渲染页面</p></li></ol><h3 id="锁"><a class="markdownIt-Anchor" href="#锁"></a> 锁</h3><ol><li><p>悲观锁</p><p>总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会阻塞直到它拿到锁（<strong>共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程</strong>）。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。Java中<code>synchronized</code>和<code>ReentrantLock</code>等独占锁就是悲观锁思想的实现</p></li><li><p>乐观锁</p><p>总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号机制和CAS算法实现。<strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量</strong>，像数据库提供的类似于<strong>write_condition机制</strong>，其实都是提供的乐观锁。在Java中<code>java.util.concurrent.atomic</code>包下面的原子变量类就是使用了乐观锁的一种实现方式<strong>CAS</strong>实现的</p></li><li><p>两种锁的使用场景</p><p>从上面对两种锁的介绍，我们知道两种锁各有优缺点，不可认为一种好于另一种，像<strong>乐观锁适用于写比较少的情况下（多读场景）</strong>，即冲突真的很少发生的时候，这样可以省去了锁的开销，加大了系统的整个吞吐量。但如果是多写的情况，一般会经常产生冲突，这就会导致上层应用会不断的进行retry，这样反倒是降低了性能，所以<strong>一般多写的场景下用悲观锁就比较合适。</strong></p><p>读的多，冲突几率小，乐观锁。<br />写的多，冲突几率大，悲观锁。</p></li></ol><h3 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h3><ol><li><p>docker多层构建镜像的意义</p><p>每一条 FROM 指令都是一个构建阶段，多条 FROM 就是多阶段构建，虽然最后生成的镜像只能是最后一个阶段的结果，但是，<strong>能够将前置阶段中的文件拷贝到后边的阶段中</strong>，这就是多阶段构建的最大意义</p><p>最大的使用场景是将<strong>编译环境和运行环境分离</strong></p></li><li><p>讲讲docker网络模式（bridge, host）</p><p>Docker 默认提供了 5 种网络驱动模式</p><ul><li><strong>bridge</strong>: 默认的网络驱动模式。如果不指定驱动程序，bridge 便会作为默认的网络驱动模式。当应用程序运行在需要通信的独立容器 (standalone containers) 中时，通常会选择 bridge 模式</li><li>host：移除容器和 Docker 宿主机之间的网络隔离，并<strong>直接使用主机的网络</strong>。host 模式仅适用于 Docker 17.06+</li><li>overlay：overlay 网络将多个 Docker 守护进程连接在一起，并使集群服务能够相互通信。您还可以使用 overlay 网络来实现 swarm 集群和独立容器之间的通信，或者不同 Docker 守护进程上的两个独立容器之间的通信。该策略实现了在这些容器之间进行操作系统级别路由的需求</li><li>macvlan：Macvlan 网络允许为容器分配 MAC 地址，使其显示为网络上的物理设备。 Docker 守护进程通过其 MAC 地址将流量路由到容器。对于希望直连到物理网络的传统应用程序而言，使用 macvlan 模式一般是最佳选择，而不应该通过 Docker 宿主机的网络进行路由</li><li>none：对于此容器，禁用所有联网。通常与自定义网络驱动程序一起使用。none 模式不适用于集群服务</li></ul></li><li><p>如何在一个<strong>自定义ip</strong>上运行docker容器？</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.18.0.0/16 mynetwork // 创建自定义网络，指定子网段</span><br><span class="line">docker run -itd --name networkTest --net mynetwork --ip 172.18.0.2 centos:latest /bin/bash // 使用该网络创建容器，并在该网段上指定ip</span><br></pre></td></tr></table></figure></li><li><p>dockerFile中最常见的指令是什么?</p><ul><li>COPY 复制文件</li><li>ADD 更高级的复制文件</li><li>CMD 容器启动命令</li><li>ENTRYPOINT 入口点</li><li>ENV 设置环境变量</li><li>ARG 构建参数</li><li>VOLUME 定义匿名卷</li><li>EXPOSE 暴露端口</li></ul><p>ADD和COPY的区别：</p><p>ADD可以完成COPY的所有工作，ADD还可以很方便的解压文件</p></li><li><p>Docker的常用命今?</p></li><li><p>如何临时退出一个正在交互的容器的终端，而不终止它？</p></li><li><p>什么是docker-compose?</p></li><li><p>如何退出容器时候自动删除?</p></li></ol><h3 id="kubenetes"><a class="markdownIt-Anchor" href="#kubenetes"></a> Kubenetes</h3><ol><li>简述Kubernetes和Docker的关系?</li><li>Kubernetes中的相关基础概念（deployment,service,pod,job等）</li><li>简述Kubernetes中Pod的健康检查方式</li></ol><h2 id="现场算法题"><a class="markdownIt-Anchor" href="#现场算法题"></a> 现场算法题</h2><h3 id="子集78"><a class="markdownIt-Anchor" href="#子集78"></a> 子集(78)</h3><p><code>Tag</code>: 位运算 / 回溯</p><h4 id="题目要求"><a class="markdownIt-Anchor" href="#题目要求"></a> 题目要求</h4><p>给你一个整数数组 <code>nums</code> ，数组中的元素<strong>互不相同</strong> ，返回该数组所有可能的子集（幂集）</p><p>解集<strong>不能</strong>包含重复的子集，你可以按<strong>任意顺序</strong>返回解集</p><h4 id="时间要求"><a class="markdownIt-Anchor" href="#时间要求"></a> 时间要求</h4><p>15 min</p><h4 id="输入输出示例"><a class="markdownIt-Anchor" href="#输入输出示例"></a> 输入输出示例</h4><ul><li><p>示例 1：</p><blockquote><p>输入：nums = [1,2,3]<br />输出：[[],[1],[2],[1,2],[3],[1,3],[2,3],[1,2,3]]</p></blockquote></li><li><p>示例 2：</p><blockquote><p>输入：nums = [0]<br />输出：[[],[0]]</p></blockquote></li></ul><h4 id="提示"><a class="markdownIt-Anchor" href="#提示"></a> 提示</h4><ul><li><code>1 &lt;= nums.length &lt;= 10</code></li><li><code>-10 &lt;= nums[i] &lt;= 10</code></li><li><code>nums</code> 中的所有元素 <strong>互不相同</strong></li></ul><h4 id="参考代码"><a class="markdownIt-Anchor" href="#参考代码"></a> 参考代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">subsets</span><span class="params">(nums []<span class="keyword">int</span>)</span> [][]<span class="title">int</span></span> &#123;</span><br><span class="line">    res := <span class="string">`make`</span>([][]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">    length := <span class="built_in">len</span>(nums)</span><br><span class="line">    <span class="keyword">for</span> position := <span class="number">0</span>; position &lt; <span class="number">1</span>&lt;&lt;length; position++ &#123;</span><br><span class="line">        subset := <span class="string">`make`</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> j:=<span class="number">0</span>; j &lt; length; j++ &#123;</span><br><span class="line">            <span class="keyword">if</span> position&amp;(<span class="number">1</span>&lt;&lt;j) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                subset = <span class="built_in">append</span>(subset, nums[j])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        res = <span class="built_in">append</span>(res, subset)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="top-k215"><a class="markdownIt-Anchor" href="#top-k215"></a> TOP K(215)</h3><p><code>Tag</code>: 分治 / 堆</p><h4 id="题目要求-2"><a class="markdownIt-Anchor" href="#题目要求-2"></a> 题目要求</h4><p>给定整数数组 nums 和整数 k，请返回数组中第 k 个最大的元素。</p><p>请注意，你需要找的是数组排序后的第 k 个最大的元素，而不是第 k 个不同的元素</p><h4 id="时间要求-2"><a class="markdownIt-Anchor" href="#时间要求-2"></a> 时间要求</h4><p>20 min</p><h4 id="输入输出示例-2"><a class="markdownIt-Anchor" href="#输入输出示例-2"></a> 输入输出示例</h4><ul><li><p>示例 1：</p><blockquote><p>输入: [3,2,1,5,6,4] 和 k = 2<br />输出: 5</p></blockquote></li><li><p>示例 2：</p><blockquote><p>输入: [3,2,3,1,2,4,5,5,6] 和 k = 4<br />输出: 4</p></blockquote></li></ul><h4 id="提示-2"><a class="markdownIt-Anchor" href="#提示-2"></a> 提示</h4><ul><li>1 &lt;= k &lt;= nums.length &lt;= 104</li><li>-104 &lt;= nums[i] &lt;= 104</li></ul><h4 id="参考代码-2"><a class="markdownIt-Anchor" href="#参考代码-2"></a> 参考代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findKthLargest</span><span class="params">(nums []<span class="keyword">int</span>, k <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> quickSelect(nums, <span class="number">0</span>, <span class="built_in">len</span>(nums)<span class="number">-1</span>, k)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">quickSelect</span><span class="params">(nums []<span class="keyword">int</span>, left, right, k <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> index := randomPartition(nums, left, right); index == k<span class="number">-1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nums[index]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> index &gt; k<span class="number">-1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> quickSelect(nums, left, index<span class="number">-1</span>, k)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> quickSelect(nums, index+<span class="number">1</span>, right, k)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randomPartition</span><span class="params">(nums []<span class="keyword">int</span>, left, right <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    randomIndex := (left+right)&gt;&gt;<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    nums[randomIndex], nums[right] = nums[right], nums[randomIndex]</span><br><span class="line">    pivot := nums[right]</span><br><span class="line">    <span class="keyword">for</span> i := left; i &lt; right; i++ &#123;</span><br><span class="line">        <span class="keyword">if</span> nums[i] &gt; pivot &#123;</span><br><span class="line">            nums[i], nums[left] = nums[left], nums[i]</span><br><span class="line">            left++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nums[left], nums[right] = nums[right], nums[left]</span><br><span class="line">    <span class="keyword">return</span> left</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="口答算法题"><a class="markdownIt-Anchor" href="#口答算法题"></a> 口答算法题</h2><h3 id="判断一个链表是否有环如何找到这个环的起点"><a class="markdownIt-Anchor" href="#判断一个链表是否有环如何找到这个环的起点"></a> 判断一个链表是否有环，如何找到这个环的起点</h3><p><strong>给定一个单链表，只给出头指针h：</strong><br /><strong>1、如何判断是否存在环？</strong><br /><strong>2、如何知道环的长度？</strong></p><p>1、对于问题1，使用追赶的方法，设定两个指针slow、fast，从头指针开始，每次分别前进1步、2步。如存在环，则两者相遇；如不存在环，fast遇到NULL退出。<br />2、对于问题2，记录下问题1的碰撞点p，slow、fast从该点开始，再次碰撞所走过的操作数就是环的长度s。</p><h3 id="设计一种数据结构"><a class="markdownIt-Anchor" href="#设计一种数据结构"></a> 设计一种数据结构</h3><p>满足：push、pop、getLast、getmax</p><h3 id="在单链表中如何用最快的方法找到中间元素"><a class="markdownIt-Anchor" href="#在单链表中如何用最快的方法找到中间元素"></a> 在单链表中如何用最快的方法找到中间元素？</h3><p>快慢指针</p><h3 id="给定一个非空整数数组除了某个元素只出现一次以外其余每个元素均出现两次-找出那个只出现了一次的元素"><a class="markdownIt-Anchor" href="#给定一个非空整数数组除了某个元素只出现一次以外其余每个元素均出现两次-找出那个只出现了一次的元素"></a> 给定一个<strong>非空</strong>整数数组，除了某个元素只出现一次以外，其余每个元素均出现两次。找出那个只出现了一次的元素</h3><p><strong>说明：</strong></p><p>你的算法应该具有线性时间复杂度。 你可以不使用额外空间来实现吗？</p><p><strong>示例 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入: [2,2,1]</span><br><span class="line">输出: 1</span><br></pre></td></tr></table></figure><p><strong>示例 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入: [4,1,2,1,2]</span><br><span class="line">输出: 4</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><h4 id="题目解析"><a class="markdownIt-Anchor" href="#题目解析"></a> 题目解析</h4><p>根据题目描述，由于加上了时间复杂度必须是 O(n) ，并且空间复杂度为 O(1) 的条件，因此不能用排序方法，也不能使用 map 数据结构。</p><p>程序员小吴想了一下午没想出来，答案是使用 <strong>位操作Bit Operation</strong> 来解此题。</p><p>将所有元素做异或运算，即a[1] ⊕ a[2] ⊕ a[3] ⊕ …⊕ a[n]，所得的结果就是那个只出现一次的数字，时间复杂度为O(n)。</p><h4 id="异或"><a class="markdownIt-Anchor" href="#异或"></a> 异或</h4><p>异或运算A ⊕ B的真值表如下：</p><p>AB⊕FFFFTTTFTTTF</p><h4 id="动画演示"><a class="markdownIt-Anchor" href="#动画演示"></a> 动画演示</h4><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/37c5e38e41ae587b8e4cfb49c6f7e8f4-b2baa9.gif" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/37c5e38e41ae587b8e4cfb49c6f7e8f4-b2baa9.gif" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><h3 id="有一个-n-个元素的数组除了两个数只出现一次外其余元素都出现两次让你找出这两个只出现一次的数分别是几要求时间复杂度为-on-且再开辟的内存空间固定与-n-无关"><a class="markdownIt-Anchor" href="#有一个-n-个元素的数组除了两个数只出现一次外其余元素都出现两次让你找出这两个只出现一次的数分别是几要求时间复杂度为-on-且再开辟的内存空间固定与-n-无关"></a> 有一个 n 个元素的数组，除了两个数只出现一次外，其余元素都出现两次，让你找出这两个只出现一次的数分别是几，要求时间复杂度为 O(n) 且再开辟的内存空间固定(与 n 无关)。</h3><h4 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例 :</h4><p>输入: [1,2,2,1,3,4]<br />输出: [3,4]</p><h4 id="题目再解析"><a class="markdownIt-Anchor" href="#题目再解析"></a> 题目再解析</h4><p>根据前面找一个不同数的思路算法，在这里把所有元素都异或，那么得到的结果就是那两个只出现一次的元素异或的结果。</p><p>然后，因为这两个只出现一次的元素一定是不相同的，所以这两个元素的二进制形式肯定至少有某一位是不同的，即一个为 0 ，另一个为 1 ，现在需要找到这一位。</p><p>根据异或的性质 <code>任何一个数字异或它自己都等于 0</code>，得到这个数字二进制形式中任意一个为 1 的位都是我们要找的那一位。</p><p>再然后，以这一位是 1 还是 0 为标准，将数组的 n 个元素分成两部分。</p><ul><li>将这一位为 0 的所有元素做异或，得出的数就是只出现一次的数中的一个</li><li>将这一位为 1 的所有元素做异或，得出的数就是只出现一次的数中的另一个。</li></ul><p>这样就解出题目。忽略寻找不同位的过程，总共遍历数组两次，时间复杂度为O(n)。</p><h4 id="动画再演示"><a class="markdownIt-Anchor" href="#动画再演示"></a> 动画再演示</h4><p><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/09/9d14f7004483dd347ddb1b4c9b94cf05-73d7e1.gif" alt="img" /><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><h3 id="两个水杯的问题"><a class="markdownIt-Anchor" href="#两个水杯的问题"></a> 两个水杯的问题</h3><h4 id="题目描述"><a class="markdownIt-Anchor" href="#题目描述"></a> 题目描述</h4><p>有一种玻璃杯从一栋100层的大楼扔下，该种玻璃杯超过某一层楼会摔碎。 现在给你两个杯子，问确定最低摔碎的楼层需要摔多少次？</p><h4 id="题目分析"><a class="markdownIt-Anchor" href="#题目分析"></a> 题目分析</h4><p>这道题的假设是：最低摔碎的楼层可能是每一层楼，且概率相同。我们需要找一种方法，使得定位到[1-100]之间的任意一个数都是快速的。</p><h4 id="解题思路"><a class="markdownIt-Anchor" href="#解题思路"></a> 解题思路</h4><p>最简单的方法是用一个杯子从第一层开始，不断一层层的往上试。但是这样的时间复杂度是O(n)。直觉也告诉我们<strong>想放大步子扔</strong>。</p><p>因为我们有两个杯子，可以考虑成一个<code>杯子Cup1</code>不断扔直到破碎，它用来确定最低摔碎的楼层在什么范围，</p><p>另一个<code>杯子Cup2</code>再此基础上一层层的扔。用来准确确定最低摔碎的楼层是多少。如果凭空想象，我们可能会想到二分法，每次隔5个楼层扔，10个楼层扔…</p><p>可是我们马上也应该会想到这么分的不妥之处在于：</p><p>确定最低摔碎的楼层所需次数是不均匀分布的。</p><p>我们再来看：每次扔的楼层间隔会带来什么影响？</p><p>确定最低摔碎的楼层：</p><p><strong>总次数 = Cup1扔的次数 + Cup2扔的次数</strong></p><p>楼层间隔越大，Cup2需要扔的次数越多。</p><p>相同楼层间隔下：最低摔碎的楼层越高，Cup1需要扔的次数越多，Cup2需要扔的次数可认为相同。</p><p>我们的目的其实是需要尽可能保证：不管最低摔碎的楼层是第一层还是第99层，扔的总次数都尽可能一致且减少。</p><p>如果小伙伴有看我上篇文章中LSMT分层步隆过滤器的实现，有没有受到启发？</p><p>这里我们可以使Cup1需要扔的楼层间隔递减，这样可改善高楼层所需Cup1/Cup2扔的次数。</p><p>假设第一次扔的楼层间隔为X，此后依次递减1层，直到楼层间隔为2.则： <strong>x+(x-1)+(x-2)+…+2 &gt;=100</strong></p><p>求解出答案为14。</p><h3 id="如何得到一个数据流中的中位数"><a class="markdownIt-Anchor" href="#如何得到一个数据流中的中位数"></a> 如何得到一个数据流中的中位数？</h3><p>数据是从一个数据流中读出来的，数据的数目随着时间的变化而增加。如果用一个数据容器来保存从流中读出来的数据，当有新的数据流中读出来时，这些数据就插入到数据容器中。</p><p>如果从数据流中读出奇数个数值，那么中位数就是所有值排序之后位于中间的数值。如果数据流中读出偶数个数值，那么中位数就是所有数值排序之后中间两个数的平均值。</p><p><strong>数组</strong>是最简单的容器。如果数组没有排序，可以用 Partition 函数找出数组中的中位数。在没有排序的数组中插入一个数字和找出中位数的时间复杂度是 O(1)和 O(n)。</p><p>我们还可以往数组里插入新数据时让数组保持排序，这是由于可能要移动 O(n)个数，因此需要 O(n)时间才能完成插入操作。在已经排好序的数组中找出中位数是一个简单的操作，只需要 O(1)时间即可完成。</p><p><strong>排序</strong>的链表时另外一个选择。我们需要 O(n)时间才能在链表中找到合适的位置插入新的数据。如果定义两个指针指向链表的中间结点（如果链表的结点数目是奇数，那么这两个指针指向同一个结点），那么可以在 O（1）时间得出中位数。此时时间效率与及基于排序的数组的时间效率一样。</p><p><strong>思路：</strong></p><p>如果能够保证数据容器左边的数据都小于右边的数据，这样即使左、右两边内部的数据没有排序，也可以根据左边最大的数及右边最小的数得到中位数。如何快速从一个容器中找出最大数？用最大堆实现这个数据容器，因为位于堆顶的就是最大的数据。同样，也可以快速从最小堆中找出最小数。 因此可以用如下思路来解决这个问题：用一个最大堆实现左边的数据容器，用最小堆实现右边的数据容器。往堆中插入一个数据的时间效率是O(logn).由于只需O(1)时间就可以得到位于堆顶的数据，因此得到中位数的时间效率是O(1).</p><p>接下来考虑用最大堆和最小堆实现的一些细节。首先要保证数据平均分配到两个堆中，因此两个堆中数据的数目之差不能超过1（为了实现平均分配，可以在数据的总数目是偶数时把新数据插入到最小堆中，否则插入到最大堆中）。还要保证最大堆中里的所有数据都要小于最小堆中的数据。当数据的总数目是偶数时，按照前面分配的规则会把新的数据插入到最小堆中。如果此时新的数据比最大堆中的一些数据要小，怎么办呢？</p><p>可以先把新的数据插入到最大堆中，接着把最大堆中的最大的数字拿出来插入到最小堆中。由于最终插入到最小堆的数字是原最大堆中最大的数字，这样就保证了最小堆中的所有数字都大于最大堆中的数字。</p><p>当需要把一个数据插入到最大堆中，但这个数据小于最小堆里的一些数据时，这个情形和前面类似。</p><h2 id="编程题"><a class="markdownIt-Anchor" href="#编程题"></a> 编程题</h2><h3 id="协程池"><a class="markdownIt-Anchor" href="#协程池"></a> 协程池</h3><p>原生实现一个协程池<code>package</code>，使用者应能使用该协程池<code>package</code><strong>并发</strong>完成自己输入的一系列<strong>自定义</strong>任务（要求<strong>解耦</strong>，即<strong>协程池本身和自定义任务完全无关</strong>）</p><h4 id="示例-2"><a class="markdownIt-Anchor" href="#示例-2"></a> 示例：</h4><p>输入任务列表（以下仅为伪代码，具体任务的数据结构请自行设计）</p><blockquote><p>[(“fibonacci”, 6), (“padovan”, 11), (“js_error_rate”, {“pv”: 30627846, “js_error_num”: 78456})]</p></blockquote><p>使用者应能基于自定义的<code>handler</code>完成并发任务（上述任务分别是<code>斐波那契数列的第n个数</code>、<code>巴都万数列的第n个数</code>、<code>计算js_error率</code>），得到以下输出：</p><blockquote><p>8, 12, 0.002562</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后台开发 </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 网络 </tag>
            
            <tag> 并发编程 </tag>
            
            <tag> 虚拟化 </tag>
            
            <tag> Redis </tag>
            
            <tag> 动态规划 </tag>
            
            <tag> Golang </tag>
            
            <tag> 面试 </tag>
            
            <tag> Java </tag>
            
            <tag> Docker </tag>
            
            <tag> Kubenetes </tag>
            
            <tag> 位运算 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Whosbug项目日志2</title>
      <link href="/2021/10/18/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%972/"/>
      <url>/2021/10/18/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%972/</url>
      
        <content type="html"><![CDATA[<h2 id="背景信息"><a class="markdownIt-Anchor" href="#背景信息"></a> 背景信息</h2><h3 id="团队规模"><a class="markdownIt-Anchor" href="#团队规模"></a> 团队规模</h3><p><code>whosbug</code>经手了多个团队的近20人，历史团队中：大家分别负责插件和数据流转的设计实现和优化、责任归属算法的设计实现与优化、<code>antlr</code>语法<code>AST</code>分析的多语言适配实现以及项目协同的管理；当前主要由<code>kevineluo</code>和<code>kevinmatthe</code>负责维护以及开源相关的规划，同时开源团队也有其它8位同学一起协作共建</p><h3 id="业务内容"><a class="markdownIt-Anchor" href="#业务内容"></a> 业务内容</h3><p>提供<code>DevOps</code>流程中的<code>CI</code>流水线插件，为线上项目提供发生错误时实时归属责任人的能力</p><p><img src="https://kevinmatt-1303917904.cos.ap-chengdu.myqcloud.com/image-20211008121311016.png" alt="image-20211008121311016" /></p><h2 id="项目诉求"><a class="markdownIt-Anchor" href="#项目诉求"></a> 项目诉求</h2><h3 id="关键痛点"><a class="markdownIt-Anchor" href="#关键痛点"></a> 关键痛点</h3><p>在很多大型项目中，一个重要缺陷往往会在不同的人手中流转很多次，这会导致很多不必要的时间成本和人力成本，甚至在一些情况下会引发新的问题（如修复人在对模块不熟悉的情况下进行了不恰当的<code>bugfix</code>）</p><h3 id="项目目标"><a class="markdownIt-Anchor" href="#项目目标"></a> 项目目标</h3><p><code>whosbug</code>致力于解决责任人归属这一问题的一个微服务，精确的定位到每一个<code>crash / bug</code>的责任人，缩短缺陷修复流程；同时也能在语法树这一层级为项目提供部分统计信息</p><h3 id="项目现状"><a class="markdownIt-Anchor" href="#项目现状"></a> 项目现状</h3><p>初版尝试在自动化测试产品（<code>NewMonkey</code>）、移动性能监控（<code>QAPM</code>）场景中接入了<code>whosbug</code>；近期也进行了一些更新，解决了下面提到的一些问题，不久后将会在内网发布，同时我们也将维护一个开源版本，为更多的人提供<code>whosbug</code>的服务</p><h2 id="关键挑战解决措施"><a class="markdownIt-Anchor" href="#关键挑战解决措施"></a> 关键挑战&amp;解决措施</h2><h4 id="1-大型仓库的冷启动问题"><a class="markdownIt-Anchor" href="#1-大型仓库的冷启动问题"></a> 1. 大型仓库的冷启动问题</h4><p>​大型仓库首次接入<code>whosbug</code>流水线插件进行解析时，会造成内存装载量过大，容易导致流水线机器<code>OOM</code></p><img src="https://kevinmatt-1303917904.cos.ap-chengdu.myqcloud.com/image-20211008121810807.png" alt="image-20211008121810807" style="zoom:50%;" /><h5 id="解决措施"><a class="markdownIt-Anchor" href="#解决措施"></a> 解决措施：</h5><ol><li>减少单次内存装载数据量，处理完毕的数据及时抛弃（以及必要的手动<code>GC</code>）</li><li>优化数据流动的过程，减小重复的内存开销，提高数据结构的复用能力</li></ol><h4 id="2-数据处理的效率低下问题"><a class="markdownIt-Anchor" href="#2-数据处理的效率低下问题"></a> 2. 数据处理的效率低下问题</h4><p>​单线进行的数据接入对<code>diff</code>内容的解析利用率有限，每次仅能处理单个<code>diff</code>或每次只能处理单个<code>commit</code>，无法有效的利用空闲的性能，效率低下</p><h5 id="解决措施-2"><a class="markdownIt-Anchor" href="#解决措施-2"></a> 解决措施：</h5><ol><li><p>引入协程池，将每一个未处理的<code>diff</code>内容作为<code>task</code>送入协程池队列，并发处理多次的数据（充分利用高<code>IO</code>并发下的空闲吞吐量）</p><p><img src="https://kevinmatt-1303917904.cos.ap-chengdu.myqcloud.com/image-20211008121826969.png" alt="image-20211008121826969" /></p></li><li><p>动态调整并发数目，避免并发数目过多导致的性能下降 / 程序崩溃</p></li><li><p>使用<code>pprof</code>等工具对程序工作过程中的<code>CPU</code>时间和内存占用进行记录分析，提供内存优化的思路和方向</p><p><img src="https://kevinmatt-1303917904.cos.ap-chengdu.myqcloud.com/image-20211008121835284.png" alt="image-20211008121835284" /></p></li></ol><h4 id="3-多语言支持的适配性"><a class="markdownIt-Anchor" href="#3-多语言支持的适配性"></a> 3. 多语言支持的适配性</h4><p>​原版使用<code>ctags</code>作为<code>AST</code>解析的工具时，对不同语言的支持适配很难复用，需要针对每一种语言重新适配，几乎需要为每个语言设计不同的接口，基本上不具有泛用性</p><p><img src="https://kevinmatt-1303917904.cos.ap-chengdu.myqcloud.com/image-20211008121914596.png" alt="image-20211008121914596" /></p><h5 id="解决措施-3"><a class="markdownIt-Anchor" href="#解决措施-3"></a> 解决措施：</h5><ol><li>使用<code>Antlr</code>作为<code>AST</code>解析的工具，使用统一的<code>Go-Antlr Runtime</code></li><li>定义广义的语法解析结构的接口，覆盖所有适配的语言，统一接口调用便于开发维护</li></ol><h4 id="4-antlr-go线程不安全"><a class="markdownIt-Anchor" href="#4-antlr-go线程不安全"></a> 4. Antlr-Go线程不安全</h4><p>​<code>Antlr</code>的<code>Go Runtime</code>原生并不是线程安全的，而这一点在<code>Antlr</code>的<code>doc</code>里面没有明确指出，亦没有提供实现线程安全的方法示例，在实现语法解析的并发执行的过程中遇到了阻力</p><h4 id="5-责任人归属算法的优化"><a class="markdownIt-Anchor" href="#5-责任人归属算法的优化"></a> 5. 责任人归属算法的优化</h4><p>​<code>whosbug</code>中最重要的莫过于责任人归属算法了，算法的优劣决定了整个微服务的效果；初版发布后我们进行了一系列的测试，发现了老算法在一些场景下的局限性（如对没有第三方库调用的处理、多语言下的泛用性不足等问题）</p><p>​于是在参考了部分论文后，我们结合实际落地场景设计了新的责任人归属算法 —— <a href="https://kevinello.ltd/2021/10/13/Keyman%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6/"><strong>Keyman</strong></a></p><h5 id="解决措施-4"><a class="markdownIt-Anchor" href="#解决措施-4"></a> 解决措施：</h5><ol><li>使用<code>sync.Pool</code>互斥管理语法解析树的<code>Listener</code>实例，实现其线程安全</li><li>为<code>Listener</code>的接口增加实现实例内的共享变量，帮助<code>AST</code>分析获得完整的语法解析树</li></ol>]]></content>
      
      
      <categories>
          
          <category> 项目日志 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Whosbug </tag>
            
            <tag> 语法分析 </tag>
            
            <tag> python </tag>
            
            <tag> Golang </tag>
            
            <tag> Django </tag>
            
            <tag> antlr4 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Keyman算法设计哲学</title>
      <link href="/2021/10/13/Keyman%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6/"/>
      <url>/2021/10/13/Keyman%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p><code>whosbug</code>项目中，最重要的无非是两个部分：</p><ul><li>对接入项目的<code>AST</code>静态语法解析</li><li>责任人归属算法</li></ul><p>​<code>whosbug</code>初版发布后我们进行了一系列的测试，发现了老算法在一些场景下的局限性（如对没有第三方库调用的处理、多语言下的泛用性不足等问题）</p><p>​于是在参考了部分论文后，我们结合实际落地场景设计了新的责任人归属算法 —— <strong>Keyman</strong>，本文我们就详细介绍下算法设计</p><h2 id="主要设计思想"><a class="markdownIt-Anchor" href="#主要设计思想"></a> 主要设计思想</h2><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211011145457.png" alt="" /></p><h2 id="函数唯一标识"><a class="markdownIt-Anchor" href="#函数唯一标识"></a> 函数唯一标识</h2><p>为了清晰一个函数在语法树中的精确位置，首先我们需要每个函数的唯一标识，这里我们的标识为：</p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211011154354.png" style="zoom: 50%;" /><p>并且包 / 类也视作一个函数，将包/类内的代码非函数内代码归入这个包 / 类的函数</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211011165924.png" alt="" /></p><h2 id="获取可能和这次错误相关的函数"><a class="markdownIt-Anchor" href="#获取可能和这次错误相关的函数"></a> 获取可能和这次错误相关的函数</h2><ul><li><code>Init</code>: 获取预设的迭代次数<code>NUMBER_OF_ITERATION</code>，新建相关方法集<code>methods</code>，以错误堆栈中涉及的所有方法为初值</li><li>不断地从<code>methods</code>内的每个函数/方法找到与其相连且未在<code>methods</code>内的方法，加入<code>methods</code>中，也同时得到该方法与直接错误方法的距离。如此全面进行<code>NUMBER_OF_ITERATION</code>次</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NUMBER_OF_ITERATION = <span class="number">3</span></span><br><span class="line">methods = stacks.all_methods()</span><br><span class="line"><span class="comment"># stacks.all_methods()内的method的relevance_weight都为0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(NUMBER_OF_ITERATION):</span><br><span class="line">   <span class="keyword">for</span> method <span class="keyword">in</span> methods:</span><br><span class="line">       members = [<span class="string">&#x27;father&#x27;</span>, <span class="string">&#x27;son&#x27;</span>, <span class="string">&#x27;brother&#x27;</span>]</span><br><span class="line">       <span class="keyword">for</span> member <span class="keyword">in</span> members:</span><br><span class="line">           method_got = method.__getattribute__(member)</span><br><span class="line">           <span class="keyword">if</span> method_got <span class="keyword">not</span> <span class="keyword">in</span> methods:</span><br><span class="line">               method_got.relevance_weight = method.relevance_weight + <span class="number">1</span></span><br><span class="line">               methods.append(method_got)</span><br></pre></td></tr></table></figure><h2 id="计算每个函数对该次出错的贡献"><a class="markdownIt-Anchor" href="#计算每个函数对该次出错的贡献"></a> 计算每个函数对该次出错的贡献</h2><h3 id="贡献"><a class="markdownIt-Anchor" href="#贡献"></a> 贡献</h3><p>考虑一个函数与直接导致错误的函数（输入的堆栈中的原始栈帧）的距离（语法树中的距离）、其原始栈帧到栈顶的距离以及其置信度</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>b</mi><mi>u</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mtext> </mtext><mo>=</mo><mtext> </mtext><mrow><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mtext> </mtext><mo>∗</mo><mtext> </mtext><mfrac><mn mathvariant="italic">1</mn><mrow><mi>f</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>N</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>r</mi><mo>+</mo><mn mathvariant="italic">1</mn></mrow></mfrac><mtext> </mtext><mo>∗</mo><mtext> </mtext><mrow><mo fence="true">(</mo><mi>N</mi><mi>U</mi><mi>M</mi><mi>B</mi><mi>E</mi><mi>R</mi><mi>_</mi><mi>O</mi><mi>F</mi><mi>_</mi><mi>I</mi><mi>T</mi><mi>E</mi><mi>R</mi><mi>A</mi><mi>T</mi><mi>I</mi><mi>O</mi><mi>N</mi><mo>−</mo><mi>r</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>v</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>D</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo fence="true">)</mo></mrow></mrow></mrow><annotation encoding="application/x-tex">\mathit{Contribution}\  =\  \mathit{Confidence\ *\ \frac{1}{frameNumber+1}\ *\ \left( NUMBER\_OF\_ITERATION - relevanceDist \right)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathit">r</span><span class="mord mathit">i</span><span class="mord mathit">b</span><span class="mord mathit">u</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">n</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span></span><span class="base"><span class="strut" style="height:2.20188em;vertical-align:-0.8804400000000001em;"></span><span class="mord"><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">f</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">f</span><span class="mord mathit">r</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">e</span><span class="mord mathit">N</span><span class="mord mathit">u</span><span class="mord mathit">m</span><span class="mord mathit">b</span><span class="mord mathit">e</span><span class="mord mathit">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord mathit">N</span><span class="mord mathit">U</span><span class="mord mathit">M</span><span class="mord mathit">B</span><span class="mord mathit">E</span><span class="mord mathit">R</span><span class="mord mathit">_</span><span class="mord mathit">O</span><span class="mord mathit">F</span><span class="mord mathit">_</span><span class="mord mathit">I</span><span class="mord mathit">T</span><span class="mord mathit">E</span><span class="mord mathit">R</span><span class="mord mathit">A</span><span class="mord mathit">T</span><span class="mord mathit">I</span><span class="mord mathit">O</span><span class="mord mathit">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">r</span><span class="mord mathit">e</span><span class="mord mathit">l</span><span class="mord mathit">e</span><span class="mord mathit">v</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">e</span><span class="mord mathit">D</span><span class="mord mathit">i</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span></span></span></p><h3 id="置信度"><a class="markdownIt-Anchor" href="#置信度"></a> 置信度</h3><p>置信度的设定能保证：</p><ol><li>函数保留的越久越可信（<strong>时间维度</strong>上的考虑，一定程度上也考虑了初版的假设：越近的修改越容易导致<code>bug</code>）</li><li>函数大改时会基本回落到初始化的置信度</li><li>一定程度上区分<code>bugfix</code>型的变动和<strong>业务</strong>变更的变动</li></ol><h4 id="初始化"><a class="markdownIt-Anchor" href="#初始化"></a> 初始化</h4><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mtext> </mtext><mo>=</mo><mtext> </mtext><msup><mi>a</mi><mrow><mi>l</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></msup><mtext> </mtext><mo>∗</mo><mtext> </mtext><mover accent="true"><mrow><mi>S</mi><mi>u</mi><mi>b</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi>.</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><mo stretchy="true">‾</mo></mover><mspace width="1em"/><mrow><mo fence="true">(</mo><mi>a</mi><mtext> </mtext><mi>ϵ</mi><mo stretchy="false">(</mo><mn mathvariant="italic">0</mn><mo separator="true">,</mo><mn mathvariant="italic">1</mn><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathit{Confidence\ =\ a^{lineCount}\ *\ \overline{SubMethod.Confidence} \quad \left(a\ \epsilon (0,1)\right)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">f</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mord"><span class="mord mathit">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">l</span><span class="mord mathit mtight">i</span><span class="mord mathit mtight">n</span><span class="mord mathit mtight">e</span><span class="mord mathit mtight">C</span><span class="mord mathit mtight">o</span><span class="mord mathit mtight">u</span><span class="mord mathit mtight">n</span><span class="mord mathit mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.89444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">S</span><span class="mord mathit">u</span><span class="mord mathit">b</span><span class="mord mathit">M</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord mathit">h</span><span class="mord mathit">o</span><span class="mord mathit">d</span><span class="mord mathit">.</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">f</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">e</span></span></span><span style="top:-3.81444em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:1em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathit">a</span><span class="mspace"> </span><span class="mord mathdefault">ϵ</span><span class="mopen">(</span><span class="mord mathit">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit">1</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></span></p><p>以下两种情况下，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mi>u</mi><mi>b</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">SubMethod.Confidence</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span></span></span>视为1：</p><ul><li>一个函数没有调用子函数时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mrow><mi>S</mi><mi>u</mi><mi>b</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{SubMethod.Confidence}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.08888em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.89444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span></span><span style="top:-3.81444em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span>整项视为1</li><li>调用的子函数为系统函数 / 第三方库函数时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mi>u</mi><mi>b</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">SubMethod.Confidence</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span></span></span>视为1</li></ul><h4 id="更新"><a class="markdownIt-Anchor" href="#更新"></a> 更新</h4><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>:</mo><mo>=</mo><msup><mrow><mo fence="true">(</mo><mfrac><mrow><mi>r</mi><mi>e</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow><mrow><mi>l</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></mfrac><mtext> </mtext><mo>∗</mo><mi>o</mi><mi>l</mi><mi>d</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mtext> </mtext><mo>+</mo><mfrac><mrow><mi>n</mi><mi>e</mi><mi>w</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow><mrow><mi>l</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></mfrac><mo>∗</mo><msup><mi>a</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></msup><mtext> </mtext><mo>∗</mo><mover accent="true"><mrow><mi>n</mi><mi>e</mi><mi>w</mi><mi>S</mi><mi>u</mi><mi>b</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi>.</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><mo stretchy="true">‾</mo></mover><mo fence="true">)</mo></mrow><mrow><mi>P</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>y</mi><mi>F</mi><mi>o</mi><mi>r</mi><mi>C</mi><mi>h</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>e</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathit{Confidence := \left(\frac{remainLineCount}{lineCount}\ *oldConfidence\ + \frac{newLineCount}{lineCount}*a^{newLineCount}\ *\overline{newSubMethod.Confidence}\right)^{PropensistyForChange}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.639038em;vertical-align:-0.95003em;"></span><span class="mord"><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">f</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">r</span><span class="mord mathit">e</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">o</span><span class="mord mathit">l</span><span class="mord mathit">d</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">f</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">w</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span><span class="mord mathit mtight">e</span><span class="mord mathit mtight">w</span><span class="mord mathit mtight">L</span><span class="mord mathit mtight">i</span><span class="mord mathit mtight">n</span><span class="mord mathit mtight">e</span><span class="mord mathit mtight">C</span><span class="mord mathit mtight">o</span><span class="mord mathit mtight">u</span><span class="mord mathit mtight">n</span><span class="mord mathit mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.89444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">w</span><span class="mord mathit">S</span><span class="mord mathit">u</span><span class="mord mathit">b</span><span class="mord mathit">M</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord mathit">h</span><span class="mord mathit">o</span><span class="mord mathit">d</span><span class="mord mathit">.</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">f</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">e</span></span></span><span style="top:-3.81444em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.689008em;"><span style="top:-3.9029000000000007em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">P</span><span class="mord mathit mtight">r</span><span class="mord mathit mtight">o</span><span class="mord mathit mtight">p</span><span class="mord mathit mtight">e</span><span class="mord mathit mtight">n</span><span class="mord mathit mtight">s</span><span class="mord mathit mtight">i</span><span class="mord mathit mtight">s</span><span class="mord mathit mtight">t</span><span class="mord mathit mtight">y</span><span class="mord mathit mtight">F</span><span class="mord mathit mtight">o</span><span class="mord mathit mtight">r</span><span class="mord mathit mtight">C</span><span class="mord mathit mtight">h</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight">n</span><span class="mord mathit mtight">g</span><span class="mord mathit mtight">e</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>函数大改时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mi>r</mi><mi>e</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow><mrow><mi>l</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></mfrac><mtext> </mtext><mo>∗</mo><mi>o</mi><mi>l</mi><mi>d</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">\frac{remainLineCount}{lineCount}\ *oldConfidence</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace"> </span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span></span></span>一项将接近于0，置信度会基本回落到初始化的置信度</p><h3 id="变更倾向系数"><a class="markdownIt-Anchor" href="#变更倾向系数"></a> 变更倾向系数</h3><p>变更倾向系数基于以下假设，在一个函数的一次变更内:</p><ol><li>逻辑代码行的修改越多，我们越倾向于认为这是一次<code>bugfix</code></li><li>调用方法行的修改越多，我们越倾向于认为这是一次业务更新</li><li>代码留存的时间越长，认为其置信度越高</li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>P</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>y</mi><mi>F</mi><mi>o</mi><mi>r</mi><mi>C</mi><mi>h</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>e</mi><mtext> </mtext><mo>=</mo><mtext> </mtext><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Δ</mi><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>c</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mi>/</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>c</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></mrow><mrow><mi>Δ</mi><mrow><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>C</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow><mi>/</mi><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>C</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></mfrac><mo>+</mo><mi>d</mi><mo fence="true">)</mo></mrow></mrow><mspace linebreak="newline"></mspace><mrow><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mtext> </mtext><mo>=</mo><mtext> </mtext><msup><mi>b</mi><mrow><mi>c</mi><mi>x</mi></mrow></msup></mrow><mspace linebreak="newline"></mspace><mi>b</mi><mtext> </mtext><mi>ϵ</mi><mtext> </mtext><mo stretchy="false">(</mo><mn>0</mn><mtext> </mtext><mo separator="true">,</mo><mtext> </mtext><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext> </mtext><mi>c</mi><mtext> </mtext><mi>ϵ</mi><mtext> </mtext><mo stretchy="false">(</mo><mn>0</mn><mtext> </mtext><mo separator="true">,</mo><mo>+</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext> </mtext><mi>d</mi><mtext> </mtext><mi>ϵ</mi><mtext> </mtext><mo stretchy="false">(</mo><mn>0</mn><mtext> </mtext><mo separator="true">,</mo><mo>+</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mrow><mi>P</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>y</mi><mi>F</mi><mi>o</mi><mi>r</mi><mi>C</mi><mi>h</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>e</mi></mrow><mtext> </mtext><mi>ϵ</mi><mrow><mo fence="true">(</mo><mn>0</mn><mo separator="true">,</mo><msup><mi>b</mi><mrow><mi>c</mi><mi>d</mi></mrow></msup><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathit{PropensistyForChange\ =\ trans\left(\frac{\Delta{logicLineCount/logicLineCount}}{\Delta{functionCallCount}/functionCallCount}+d\right)} \\ \mathit{trans(x)\ =\  b^{cx}} \\b\ \epsilon\ (0\ ,\ 1),\ c\ \epsilon\ (0\ ,+\infty),\ d\ \epsilon\ (0\ ,+\infty)\\\mathit{PropensistyForChange}\  \epsilon \left(0,b^{cd}\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="mord"><span class="mord mathit">P</span><span class="mord mathit">r</span><span class="mord mathit">o</span><span class="mord mathit">p</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">y</span><span class="mord mathit">F</span><span class="mord mathit">o</span><span class="mord mathit">r</span><span class="mord mathit">C</span><span class="mord mathit">h</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord mathit">g</span><span class="mord mathit">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mord mathit">t</span><span class="mord mathit">r</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord mathit">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">Δ</span><span class="mord"><span class="mord mathit">f</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">C</span><span class="mord mathit">a</span><span class="mord mathit">l</span><span class="mord mathit">l</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span><span class="mord mathit">/</span><span class="mord mathit">f</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">C</span><span class="mord mathit">a</span><span class="mord mathit">l</span><span class="mord mathit">l</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">Δ</span><span class="mord"><span class="mord mathit">l</span><span class="mord mathit">o</span><span class="mord mathit">g</span><span class="mord mathit">i</span><span class="mord mathit">c</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathit">/</span><span class="mord mathit">l</span><span class="mord mathit">o</span><span class="mord mathit">g</span><span class="mord mathit">i</span><span class="mord mathit">c</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit">C</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">d</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">t</span><span class="mord mathit">r</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord mathit">s</span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">c</span><span class="mord mathit mtight">x</span></span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mspace"> </span><span class="mord mathdefault">ϵ</span><span class="mspace"> </span><span class="mopen">(</span><span class="mord">0</span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord mathdefault">c</span><span class="mspace"> </span><span class="mord mathdefault">ϵ</span><span class="mspace"> </span><span class="mopen">(</span><span class="mord">0</span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">+</span><span class="mord">∞</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord mathdefault">d</span><span class="mspace"> </span><span class="mord mathdefault">ϵ</span><span class="mspace"> </span><span class="mopen">(</span><span class="mord">0</span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">+</span><span class="mord">∞</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.249118em;vertical-align:-0.35001em;"></span><span class="mord"><span class="mord mathit">P</span><span class="mord mathit">r</span><span class="mord mathit">o</span><span class="mord mathit">p</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">y</span><span class="mord mathit">F</span><span class="mord mathit">o</span><span class="mord mathit">r</span><span class="mord mathit">C</span><span class="mord mathit">h</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord mathit">g</span><span class="mord mathit">e</span></span><span class="mspace"> </span><span class="mord mathdefault">ϵ</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span></span></p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211018144809.png" alt="" /></p><p><code>trans</code>函数用于值域变换，使变更倾向归一化到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo fence="true">(</mo><mn>0</mn><mo separator="true">,</mo><msup><mi>b</mi><mrow><mi>c</mi><mi>d</mi></mrow></msup><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\left(0,b^{cd}\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span>，其中超参数<code>b, c</code>对曲线的走向有一定影响</p><p>同时超参数<code>d</code>使得<code>PropensistyForChange</code>始终小于1，保证每次置信度更新时都会更趋近于1（代码留存的时间越长，认为其置信度越高）</p><h2 id="计算获取一个函数的主要贡献者"><a class="markdownIt-Anchor" href="#计算获取一个函数的主要贡献者"></a> 计算获取一个函数的主要贡献者</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">commiters = []</span><br><span class="line"></span><br><span class="line">contribution_rate = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> commit <span class="keyword">in</span> related_commits:</span><br><span class="line">    weight = commit.commiter.weight</span><br><span class="line">    weight += contribution_rate*(changed_line_count/all_line_count)*Confidence</span><br><span class="line">    commiters.append(commit.commiter)</span><br><span class="line">    unchanged_rate *= <span class="number">1</span>-(changed_line_count/all_line_count)</span><br><span class="line">    </span><br><span class="line">commiters.sortByWeight(reverse = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>假设：有三次不同的commit存在，且三次提交的变动情况如图，</p><p><img src="https://kevinmatt-1303917904.cos.ap-chengdu.myqcloud.com/%E6%88%AA%E5%B1%8F2021-10-13%2014.27.11.png" alt="截屏2021-10-13 14.27.11" /></p><p>会被处理为</p><img src="https://kevinmatt-1303917904.cos.ap-chengdu.myqcloud.com/%E6%88%AA%E5%B1%8F2021-10-13%2014.31.23.png" alt="image-20211013143009732" style="zoom: 25%;" />]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Whosbug </tag>
            
            <tag> 语法分析 </tag>
            
            <tag> 算法 </tag>
            
            <tag> 语法树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TraceSim算法深入浅出</title>
      <link href="/2021/10/08/TraceSim%E7%AE%97%E6%B3%95%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA/"/>
      <url>/2021/10/08/TraceSim%E7%AE%97%E6%B3%95%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>现有研究使用的<code>stack trace</code>距离度量主要有以下两种：</p><ul><li><code>information retrieval techniques</code>(基于信息检索技术)</li><li><code>string matching methods</code>(基于字符串匹配技术)</li></ul><p><a href="https://kevinello.ltd/2020/12/08/ReBucket%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/"><code>Rebucket</code></a>就是<code>string matching methods</code>的一种，<a href="https://arxiv.org/abs/2009.12590">这篇论文</a>主要提出了<code>TraceSim</code>这一结合了两种方法的堆栈相似度度量方法</p><h2 id="需要了解的词"><a class="markdownIt-Anchor" href="#需要了解的词"></a> 需要了解的词</h2><ul><li><code>Levenshtein Distance Calculation</code>: 基于<code>string matching methods</code>的一种堆栈间距离的度量算法（本文中的<code>Levenshtein Distance Calculation</code>是其改进版本，下面会展开讲）</li><li><code>TF-IDF</code>: 基于<code>information retrieval techniques</code>的一种堆栈间距离的度量算法，其中<code>TF</code>代表单帧的重要程度，<code>IDF</code>代表单帧的罕见程度</li></ul><h2 id="tracesim"><a class="markdownIt-Anchor" href="#tracesim"></a> TraceSim</h2><blockquote><p>a novel approach to this problem which combines TF-IDF, Levenshtein distance, and machine learning to construct a similarity metric</p><p>the first algorithm for computing stack trace similarity that structurally combines TF-IDF and string distance while using machine learning to improve quality.</p></blockquote><p>论文的主要内容是基于<code>TF-IDF</code>, <code>Levenshtein Distance Calculation</code>结合 <code>machine learning</code> 来构建<code>stack trace</code>之间相似度的度量，相比于单纯的<code>string matching methods</code>（如<code>Rebucket</code>），这样的结合可能可以保证每个<code>bucket</code>内的堆栈关联更加紧密（更好的<code>bucket</code>质量），并可能优于任何单独的一种方法</p><ul><li><strong>TF-IDF</strong>(具体算法是改进版的<a href="https://doi.org/10.1145/2901739.29">Campbell et al.</a>)</li><li><strong>Levenshtein distance</strong>(同样也是改进版本的<a href="https://nymity.ch/sybilhunting/pdf/Levenshtein1966a.pdf">Levenshtein distance</a>)</li><li><strong>Machine Learning</strong>(本文中具体是指基于<strong>超参数</strong>[ <a href="https://papers.nips.cc/paper/2011/hash/86e8f7ab32cfd12577bc2619bc635690-Abstract.html">1</a>, <a href="https://proceedings.mlr.press/v28/bergstra13.pdf">2</a>, <a href="https://arxiv.org/abs/1502.02127">3</a> ]确定最佳参数集合用于权重计算)</li></ul><p>算法流程大致如下：</p><p><strong>特殊处理栈溢出异常，而对于非SOEs：</strong></p><ol><li>计算<code>stack traces</code>中每个<code>frame</code>的<code>weight</code>，原因：不同的帧对<code>stack traces similarity</code>的影响不一样</li><li>计算两个<code>stack traces</code>的<code>edit distance</code>这个距离在论文中被定义为带帧权重的<code>Levenshtein distance</code></li><li>将计算所得的<code>Levenshtein distance</code>规范化，作为最终两个堆栈间距离的度量值</li></ol><p>算法细节在下方展开阐述</p><h3 id="对soesstack-overflow-exceptions的特殊处理"><a class="markdownIt-Anchor" href="#对soesstack-overflow-exceptions的特殊处理"></a> 对SOEs(stack overflow exceptions)的特殊处理</h3><p><code>stack overflow exceptions</code>中有大量重复的递归调用产生的帧，两个<code>stack traces</code>的这部分如果相似，则他们很可能指向相同的错误情况；递归部分通常占这类堆栈的很大一部分，所以按照帧频次计算他们的相似性就足够了</p><h3 id="帧权值计算frame-weight-computation"><a class="markdownIt-Anchor" href="#帧权值计算frame-weight-computation"></a> 帧权值计算（Frame Weight Computation）</h3><p>这里我们基于一个基本的假设：靠近栈顶的<code>frames</code>的影响比更深层的<code>frames</code>大，因为上层<code>frames</code>更有可能包含<code>bug</code>源</p><p>对于上述结论，我们用<code>frame weight</code>反映；<code>frame weight</code>越高，影响越大</p><p><code>frame weigth</code>的影响因素：</p><ul><li><code>Stack trace</code>中<code>frame</code>的位置</li><li><code>frame</code>在数据库中所有<code>frames（all frames of all stack traces）</code>中出现的频率</li></ul><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>表示一个<code>stack</code>的第<code>i</code>帧，整个<code>stack trace</code>的所有帧表示为: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mi>T</mi><mo>=</mo><msub><mi>f</mi><mn>0</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>f</mi><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">S T=f_{0}, \ldots, f_{N-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.902771em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span></p><p>则<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的<strong>总权值计算公式</strong>如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>w</mi><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><msub><mrow><mi>l</mi><mi>w</mi></mrow><mi>α</mi></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>∗</mo><msub><mrow><mi>g</mi><mi>w</mi></mrow><mrow><mi>β</mi><mi>γ</mi></mrow></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathit{w}\left(f_{i}\right)=\mathit{lw}_{\alpha}\left(f_{i}\right) * \mathit{gw}_{\beta \gamma}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">w</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathit">l</span><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.130248em;vertical-align:-0.380248em;"></span><span class="mord"><span class="mord"><span class="mord mathit">g</span><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2419679999999999em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.380248em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><msub><mi mathvariant="bold">w</mi><mi>α</mi></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">l \mathbf{w}_{\alpha}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的本地权值，对应第一个因素</p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi mathvariant="normal">gw</mi><mo>⁡</mo><mrow><mi>β</mi><mi>γ</mi></mrow></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{gw}_{\beta \gamma}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.130248em;vertical-align:-0.380248em;"></span><span class="mop"><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em;">g</span><span class="mord mathrm" style="margin-right:0.01389em;">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2419679999999999em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.380248em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的全局权值，对应第二个因素</p><p>$\alpha  \beta  \gamma $是数值超参数，用于调整模型以适应数据（调整算法适应某个特定的stack trace集）</p><p><strong>本地权值的计算公式：</strong></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow><mi>l</mi><mi>w</mi></mrow><mi>α</mi></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><msup><mi>i</mi><mi>α</mi></msup></mfrac></mrow><annotation encoding="application/x-tex">\mathit{lw}_{\alpha}\left(f_{i}\right)=\frac{1}{i^{\alpha}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathit">l</span><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.590392em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>靠近栈顶的<code>frame</code>的本地权值更大。这是基于实践得出的结论；<strong>错误更有可能是由最近调用的方法所导致的</strong></p><p>这里的本地权值是一个完全基于上面这条假设而来的因子，在一些场景下这样的假设比较局限</p><p><strong>全局权值的计算：</strong></p><p>全局权值计算基于<code>TF-IDF</code>方法</p><p><code>TF-IDF</code>方法的基本定义：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>T</mi><mi>F</mi></mrow><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>∗</mo><mrow><mi>I</mi><mi>D</mi><mi>F</mi></mrow><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathit{TF}\left(f_{i}\right) * \mathit{IDF}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">T</span><span class="mord mathit">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">I</span><span class="mord mathit">D</span><span class="mord mathit">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>T</mi><mi>F</mi></mrow><mrow><mo fence="true">(</mo><mi>f</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathit{TF}\left(f\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">T</span><span class="mord mathit">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>表示特定帧在整个<code>stack trace</code>中的重要程度</p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>I</mi><mi>D</mi><mi>F</mi></mrow><mrow><mo fence="true">(</mo><mi>f</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathit{IDF}\left(f\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">I</span><span class="mord mathit">D</span><span class="mord mathit">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>表示<code>frame f</code>在所有<code>stack traces</code>中的罕见程度</p><p><strong>在本篇论文中，不使用TF-IDF方法的TF部分</strong>，并认为它等于1（实际落地时可根据使用场景自行发挥，这里不做阐述），在计算<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow><mi>l</mi><mi>w</mi></mrow><mi>α</mi></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathit{lw}_{\alpha}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathit">l</span><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>时，已经考虑过了<code>frame</code>的顺序问题</p><p>这里提一下我的另一个项目<code>whosbug</code><a href="https://kevinello.ltd/2020/11/27/WHOSBUG%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97/">[ 1 ]</a>，我们可以基于<code>whosbug</code>获取到一个堆栈中各帧的<strong>责任分布</strong>（可以简单的理解为堆栈内各帧对这次<code>crash</code>的<code>contribution</code>）；于是这里我们就可以用这个责任分布来作为各帧的<code>TF</code>了</p><p><strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">IDF</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{IDF}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop"><span class="mord mathrm">I</span><span class="mord mathrm">D</span><span class="mord mathrm">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>计算公式：</strong></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>I</mi><mi>D</mi><mi>F</mi></mrow><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><mi>log</mi><mo>⁡</mo><mfrac><mtext> Total num. of stack traces </mtext><mrow><mtext> Num. of stack traces </mtext><mi>S</mi><mi>T</mi><mo>:</mo><msub><mi>f</mi><mi>i</mi></msub><mo>∈</mo><mi>S</mi><mi>T</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\mathit{IDF}\left(f_{i}\right)=\log \frac{\text { Total num. of stack traces }}{\text { Num. of stack traces } S T: f_{i} \in S T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathit">I</span><span class="mord mathit">D</span><span class="mord mathit">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.25188em;vertical-align:-0.8804400000000001em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord"> Num. of stack traces </span></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord"> Total num. of stack traces </span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi mathvariant="normal">gw</mi><mo>⁡</mo><mrow><mi>β</mi><mi>γ</mi></mrow></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{gw}_{\beta \gamma}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.130248em;vertical-align:-0.380248em;"></span><span class="mop"><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em;">g</span><span class="mord mathrm" style="margin-right:0.01389em;">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2419679999999999em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.380248em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>计算公式：</strong></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow><mi>g</mi><mi>w</mi></mrow><mrow><mi>β</mi><mi>γ</mi></mrow></msub><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><mi>σ</mi><mrow><mo fence="true">(</mo><mi>β</mi><mrow><mo fence="true">(</mo><mi mathvariant="normal">IDF</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>−</mo><mi>γ</mi><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mspace linebreak="newline"></mspace><mi>σ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>x</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\mathit{gw}_{\beta \gamma}\left(f_{i}\right)=\sigma\left(\beta\left(\operatorname{IDF}\left(f_{i}\right)-\gamma\right)\right)\\\sigma(x)=\frac{1}{1+e^{-x}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.130248em;vertical-align:-0.380248em;"></span><span class="mord"><span class="mord"><span class="mord mathit">g</span><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2419679999999999em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.380248em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mop"><span class="mord mathrm">I</span><span class="mord mathrm">D</span><span class="mord mathrm">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.09077em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.697331em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight">x</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span></span></span></span>超参数是为了保证<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">IDF</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{IDF}\left(f_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop"><span class="mord mathrm">I</span><span class="mord mathrm">D</span><span class="mord mathrm">F</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>的曲线比较平滑</p><p>这样的算法能保证赋予大量<code>stack traces</code>中那些非常相似的<code>frames</code>以小的权值；这类<code>frames</code>可能是频繁调用的代码块，例如开发框架，日志或者协程池</p><h3 id="levenshtein-distance-计算"><a class="markdownIt-Anchor" href="#levenshtein-distance-计算"></a> Levenshtein distance 计算</h3><p>为了在数值上表达<code>stack traces</code>之间的差异，论文中使用了改进版的<code>Levenshtein distance</code></p><p>我们考虑了经典<code>Levenshtein distance</code>中的<strong>插入、删除、替换</strong>操作，没有考虑<strong>调换</strong>操作，因为<code>frames</code>在<code>stack trace</code>中的顺序是具有实际意义的；在一个<code>stack trace</code>中移动两个<code>frames</code>是不被允许的</p><p>对于两个字符串，经典<code>Levenshtein distance</code>被定义为最少的编辑开销，即将一个字符串变成另一个字符串所需要的最少的<strong>插入、删除、替换</strong>单个字符次数</p><p>对于两个<code>stack trace</code>，也用一样的方法，但这里我们使用上面提到的<strong>帧权值</strong></p><p><strong>插入、删除</strong>的开销即相对应的<code>frame</code>的权值</p><p><strong>替换</strong>的开销是替换前<code>frame</code>和替换后新<code>frame</code>的权值的总和</p><p>对两个分别长<code>m</code>和长<code>n</code>的堆栈<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mi mathvariant="normal">和</mi><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">S T^{\prime}和 S T^{\prime \prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord cjk_fallback">和</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>，我们定义<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal"><mrow><mi>d</mi><mi>i</mi><mi>s</mi><mi>t</mi></mrow></mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{\mathit{dist}}\left(S T^{\prime}, S T^{\prime \prime}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em;"></span><span class="mop"><span class="mord"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit">s</span><span class="mord mathit">t</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">S T^{\prime}, S T^{\prime \prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>的<code>Levenshtein distance</code>；定义长<code>m</code>宽<code>n</code>的矩阵 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">\mathit{D}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathit">D</span></span></span></span></span> ，其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>D</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathit{D}_{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">S T^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>的前<code>i</code>帧到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">S T^{\prime \prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>的前<code>j</code>帧的<code>Levenshtein distance</code>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">S T^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>的第<code>i</code>帧，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">f_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">S T^{\prime \prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>的第<code>j</code>帧，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">S T^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>中第<code>i</code>帧的帧权值，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>w</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">w_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">S T^{\prime \prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>中第<code>j</code>帧的<strong>帧权值</strong></p><p>则我们可以得到状态转移方程为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>D</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>D</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>f</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>D</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msub><mi>w</mi><mi>j</mi></msub><mo separator="true">,</mo><mtext> </mtext><msub><mi>D</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>+</mo><msub><mi>w</mi><mi>i</mi></msub><mo separator="true">,</mo><mtext> </mtext><msub><mi>D</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msub><mi>w</mi><mi>i</mi></msub><mo>+</mo><msub><mi>w</mi><mi>j</mi></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>≠</mo><msub><mi>f</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\mathit{D}_{i,j}=\begin{cases}\mathit{D}_{i-1, j-1} &amp;f_i = f_j \\\min\left(\mathit{D}_{i, j-1} + \mathit{w}_j,\     \mathit{D}_{i-1, j} + \mathit{w}_i,\     \mathit{D}_{i-1, j-1} + \mathit{w}_i + \mathit{w}_j\right) &amp;f_i \not= f_j\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mop">min</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>并且在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">\mathit{D}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathit">D</span></span></span></span></span>中:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.15999999999999992em" columnalign="left center left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>D</mi><mrow><mn>0</mn><mo separator="true">,</mo><mn>0</mn></mrow></msub><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>D</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>w</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>D</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>0</mn></mrow></msub><mo>=</mo><msub><mi>w</mi><mi>i</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{lcl}\mathit{D}_{0,0} = 0 \\\mathit{D}_{0, j} = \mathit{w}_j \\\mathit{D}_{i, 0} = \mathit{w}_i\end{array}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6000000000000005em;vertical-align:-1.5500000000000007em;"></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathit">D</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span></span></span></span></p><p>代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_dist</span>(<span class="params">trace1: List, weights1: List, trace2: List, weights2: List</span>) -&gt; float:</span></span><br><span class="line"></span><br><span class="line">    matrix = [[<span class="number">0.0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(trace1) + <span class="number">1</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(trace2) + <span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">    prev_column = matrix[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(trace1)):</span><br><span class="line">        prev_column[i + <span class="number">1</span>] = prev_column[i] + weights1[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(trace1) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(trace2) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    curr_column = matrix[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i2 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(trace2)):</span><br><span class="line"></span><br><span class="line">        frame2 = trace2[i2]</span><br><span class="line">        weight2 = weights2[i2]</span><br><span class="line"></span><br><span class="line">        curr_column[<span class="number">0</span>] = prev_column[<span class="number">0</span>] + weight2</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(trace1)):</span><br><span class="line"></span><br><span class="line">            frame1 = trace1[i1]</span><br><span class="line">            weight1 = weights1[i1]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> frame1 == frame2:</span><br><span class="line">                curr_column[i1 + <span class="number">1</span>] = prev_column[i1]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                change = weight1 + weight2 + prev_column[i1]</span><br><span class="line">                remove = weight2 + prev_column[i1 + <span class="number">1</span>]</span><br><span class="line">                insert = weight1 + curr_column[i1]</span><br><span class="line"></span><br><span class="line">                curr_column[i1 + <span class="number">1</span>] = <span class="built_in">min</span>(change, remove, insert)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i2 != <span class="built_in">len</span>(trace2) - <span class="number">1</span>:</span><br><span class="line">            prev_column = curr_column</span><br><span class="line">            curr_column = matrix[i2 + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> curr_column[-<span class="number">1</span>]</span><br></pre></td></tr></table></figure><h3 id="normalization归一化"><a class="markdownIt-Anchor" href="#normalization归一化"></a> Normalization（归一化）</h3><p>相似度归一化后即为：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal"><mrow><mi>s</mi><mi>i</mi><mi>m</mi></mrow></mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mo fence="true">)</mo></mrow><mo>=</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mi mathvariant="normal"><mrow><mi>d</mi><mi>i</mi><mi>s</mi><mi>t</mi></mrow></mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mo fence="true">)</mo></mrow></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><msup><mi>N</mi><mo mathvariant="normal">′</mo></msup><mo>−</mo><mn>1</mn></mrow></munderover><mi>w</mi><mrow><mo fence="true">(</mo><msubsup><mi>f</mi><mi>i</mi><mo mathvariant="normal">′</mo></msubsup><mo fence="true">)</mo></mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><msup><mi>N</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mo>−</mo><mn>1</mn></mrow></munderover><mi>w</mi><mrow><mo fence="true">(</mo><msubsup><mi>f</mi><mi>i</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msubsup><mo fence="true">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">\operatorname{\mathit{sim}}\left(S T^{\prime}, S T^{\prime \prime}\right)=1-\frac{\operatorname{\mathit{dist}}\left(S T^{\prime}, S T^{\prime \prime}\right)}{\sum_{i=0}^{N^{\prime}-1} \mathit{w}\left(f_{i}^{\prime}\right)+\sum_{i=0}^{N^{\prime \prime}-1} \mathit{w}\left(f_{i}^{\prime \prime}\right)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.051892em;vertical-align:-0.25em;"></span><span class="mop"><span class="mord"><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">m</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.5998330000000003em;vertical-align:-1.170941em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.428892em;"><span style="top:-2.128769em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">w</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.733692em;"><span style="top:-2.4231360000000004em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.27686399999999994em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">w</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.733692em;"><span style="top:-2.4231360000000004em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.27686399999999994em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mord"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit">s</span><span class="mord mathit">t</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.170941em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>这里<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal"><mrow><mi>d</mi><mi>i</mi><mi>s</mi><mi>t</mi></mrow></mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{\mathit{dist}}\left(S T^{\prime}, S T^{\prime \prime}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em;"></span><span class="mop"><span class="mord"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit">s</span><span class="mord mathit">t</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>S</mi><msup><mi>T</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">S T^{\prime}, S T^{\prime \prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>的<code>Levenshtein distance</code>，但也可以替换为<code>rebucket</code>中定义的<code>distance</code>，关于堆栈间距离的定义还有很多，都可以尝试做替换；具体效果还需要落地后观察</p><p><strong>总结：</strong></p><ul><li>本篇论文核心还是依据特定规则（帧到栈顶的距离，帧在<code>stack trace</code>中的出现次数）来进行归类。</li><li>从结果上看，<code>TraceSim</code>算法在<code>Jetbrain product</code>中的效果比其他现有算法要好（但也局限于这一个项目，在我看来每一个项目的堆栈特征都不同，对应的超参数组合也不同，实际效果是会存在差异的）</li><li><code>TraceSim</code>算法中的很多部分是可以尝试基于其它算法进行优化的</li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
            <tag> ReBucket </tag>
            
            <tag> 动态规划 </tag>
            
            <tag> 超参数 </tag>
            
            <tag> 聚类 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Service Mesh在接入层流量管理的应用</title>
      <link href="/2021/06/14/Service-Mesh%E5%9C%A8%E6%8E%A5%E5%85%A5%E5%B1%82%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8/"/>
      <url>/2021/06/14/Service-Mesh%E5%9C%A8%E6%8E%A5%E5%85%A5%E5%B1%82%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="service-mesh是什么"><a class="markdownIt-Anchor" href="#service-mesh是什么"></a> service mesh是什么</h2><blockquote><p>A service mesh, like the open source project <a href="https://www.redhat.com/en/topics/microservices/what-is-istio">Istio,</a> is a way to control how different parts of an application share data with one another. Unlike other systems for managing this communication, a service mesh is a dedicated infrastructure layer built right into an app. This visible infrastructure layer can document how well (or not) different parts of an app interact, so it becomes easier to optimize communication and avoid downtime as an app grows.</p><p>Each part of an app, called a “service,” relies on other services to give users what they want. If a user of an online retail app wants to buy something, they need to know if the item is in stock. So, the service that communicates with the company’s inventory database needs to communicate with the product webpage, which itself needs to communicate with the user’s online shopping cart. To add business value, this retailer might eventually build a service that gives users in-app product recommendations. This new service will communicate with a database of product tags to make recommendations, but it also needs to communicate with the same inventory database that the product page needed—it’s a lot of reusable, moving parts.</p><p>Modern applications are often broken down in this way, as a network of services each performing a specific business function. In order to execute its function, one service might need to request data from several other services. But what if some services get overloaded with requests, like the retailer’s inventory database? This is where a service mesh comes in—it routes requests from one service to the next, optimizing how all the moving parts work together.</p></blockquote><p><strong>提取重点：</strong></p><blockquote><p>A service mesh, is a way to control how different parts of an application share data with one another. Unlike other systems for managing this communication, a service mesh is a dedicated infrastructure layer built right into an app. Service mesh routes requests from one service to the next, optimizing how all the moving parts work together.</p></blockquote><p><strong>翻译一下：</strong></p><blockquote><p>服务网格是一种控制应用程序的不同部分如何共享数据的方法，不同于其他用于管理这类通信的系统，服务网格是直接内置在应用程序中的专用基础结构层。服务网格提供服务间请求的路由功能（负载均衡），从而优化所有服务的协同工作</p></blockquote><h2 id="需要了解的词"><a class="markdownIt-Anchor" href="#需要了解的词"></a> 需要了解的词</h2><ul><li><code>K8S</code>(<code>k8s</code>)：容器化管理服务的事实标准（<a href="https://kevinello.ltd/2020/11/28/K8s-RoadMap/">K8s RoadMap</a>）</li><li><code>microservices</code>：微服务-也称为微服务架构-是一种架构样式，可将应用程序构造为一组服务;在微服务架构下我们可以快速，频繁且可靠地交付大型，复杂的应用程序</li><li>集群：一般意义上K8S的部属单位，也指一组受管理的物理机器</li><li>灰度发布：给予一部分用户体验应用新版本内容的发布方式</li><li>PVC：本文中泛指<code>K8S</code>中的可灵活弹性伸缩（<strong>Persistent Volumes</strong>, <strong>Static Provisioning</strong>, <strong>awsElasticBlockStore</strong>）</li></ul><h2 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h2><p>[1] <a href="https://K8S.io/docs/concepts/services-networking/ingress/">https://K8S.io/docs/concepts/services-networking/ingress</a></p><p>[2] <a href="https://www.cncf.io/wp-content/uploads/2020/12/CNCF_Survey_Report_2020.pdf">https://www.cncf.io/wp-content/uploads/2020/12/CNCF_Survey_Report_2020.pdf</a></p><p>[3] <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy">https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy</a></p><p>[4] <a href="https://K8S.io/docs/concepts/services-networking/ingress-controllers/">https://K8S.io/docs/concepts/services-networking/ingress-controllers</a></p><p>[5] <a href="https://istio.io/latest/docs/reference/config/security/">https://istio.io/latest/docs/reference/config/security</a></p><p>[6] <a href="https://github.com/envoyproxy/ratelimit">https://github.com/envoyproxy/ratelimit</a></p><p>[7] <a href="https://istio.io/latest/docs/tasks/policy-enforcement/rate-limit/">https://istio.io/latest/docs/tasks/policy-enforcement/rate-limit</a></p><p>[8] <a href="https://istio.io/latest/docs/tasks/traffic-management/locality-load-balancing/">https://istio.io/latest/docs/tasks/traffic-management/locality-load-balancing</a></p><h2 id="原生k8s面临的挑战"><a class="markdownIt-Anchor" href="#原生k8s面临的挑战"></a> 原生K8S面临的挑战</h2><p>云原生阶段，容器资源的粒度更细，利用率高，启动/销毁速度达到秒级，且大部分应用都配置了<code>PVC</code>；网络管理环境也发生了变更，出现<code>Service</code>的概念，一个微服务往往是由<code>Deployment</code>部署的一组弹性伸缩、动态调度的容器(<code>Pod</code>)承载，<code>Pod</code>的<code>IP</code>地址动态变化，这一组<code>Pod</code>一般以<code>Service</code>对外提供访问，流量管理是以<code>Service</code>为单位，且<code>K8s</code>支持集群内的服务注册与服务发现，以及基本的负载均衡能力</p><p>服务化拆分业务模块使得构建应用更容易，加上容器环境良好的弹性伸缩能力，<code>DevOps</code>理念得以很好的实施，微服务的迭代步伐加快，经常需要滚动更新。此时的入口流量管理面临如下新挑战：</p><ul><li>需要与<code>K8s</code>集成，支持转发流量到指定<code>Pod</code></li><li>更新迭代速度加快，对服务新版本灰度发布的诉求更加强烈</li><li>出现集群概念，集群之间的服务发现是隔离的，接入层需支持跨集群的服务发现（即接入层可选择<code>backend</code>为多个集群的<code>Pod</code>）；这区别于传统物理机 / 虚拟机阶段，没有集群隔离，只需保证网络联通性，即可配置接入层后端为任意对应服务的<code>IP</code>地址</li><li>传统阶段到云原生阶段的迁移过程中，出现<code>VM</code>、容器环境混布的情况</li></ul><p>基于上述挑战，出现了以下容器环境的接入层流量管理解决方案：</p><ol><li><code>K8S</code>自带的 <code>Ingress API</code>：老牌网络代理（e.g. Nginx）或云厂商的负载均衡产品（e.g. AWS Elastic Load Balancer，腾讯云 CLB）都实现了各自的 <code>Ingress Controller</code>，作为单个集群的入口流量管理解决方案。灰度发布、鉴权限流等能力，视<code>Ingress Controller</code>的能力，可通过<code>Annotation</code>扩展，部分 <code>Ingress Controller</code> 还设计了自己的流量管理模型和语法</li><li><code>Service Mesh Ingress</code>：服务网格的服务发现和管理界限<strong>大于集群纬度</strong>，以<code>Istio Ingress Gatewa</code>为例，基于<code>Istio</code>跨集群的服务发现能力，<code>backend</code>可以来自不同集群的服务，同时还支持注册在网格内运行在虚拟机上的服务。<code>Istio</code> 也设计了自己的管理模型和语法，声明式支持配置一致的任何流量管理</li><li>沿用原有 <code>VM</code> 上部署的网络代理，转发流量至 <code>VM</code> 服务或 <code>K8S</code> 集群的服务</li></ol><h2 id="云原生接入层流量管理场景与解决方案"><a class="markdownIt-Anchor" href="#云原生接入层流量管理场景与解决方案"></a> 云原生接入层流量管理场景与解决方案</h2><h3 id="场景一基础流量管理"><a class="markdownIt-Anchor" href="#场景一基础流量管理"></a> <strong>场景一：基础流量管理</strong></h3><p>要求接入层具有基于流量内容路由的能力（最基础的服务发现能力）</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210517112911.png" alt="" /></p><h4 id="方案一load-balancer-nodeport"><a class="markdownIt-Anchor" href="#方案一load-balancer-nodeport"></a> <strong>方案一：Load Balancer + NodePort</strong></h4><p>在容器化的早期阶段，应用同时部署在虚拟机和 <code>K8S</code> 集群上，很多用户会使用原有负载均衡（e.g. Nginx, 腾讯云 CLB）将请求分别转发到虚拟机和容器，同时受限于容器网络方案，原有负载均衡不能直接访问 Pod IP，因此需要通过 NodePort 暴露集群内的服务</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210517112950.png" alt="" /></p><p>但是该方案存在以下问题：</p><ul><li><code>NodePort</code> 端口数量有限（默认 30000-32767）</li><li>随着集群规模的扩大，Nginx 配置文件越来越复杂，很难管理</li><li>用户将应用发布到 <code>K8S</code> 集群后，需要再单独修改 <code>Nginx</code> 配置，体验很差</li></ul><h4 id="方案二k8s-ingress"><a class="markdownIt-Anchor" href="#方案二k8s-ingress"></a> <strong>方案二：K8S Ingress</strong></h4><p>前面提到过其实这个能力<code>K8s</code>自身就有，<code>K8S</code> 提供了 <code>Ingress API</code> 用于暴露集群内的 <code>HTTP</code> 服务，<code>Ingress</code> 支持基于 Host 和 Path 将请求路由到不同 Service。为了让 Ingress 工作，集群必须有一个正在运行的 Ingress 控制器（e.g. Nginx Ingress Controller）。原生 Ingress 语法提供简单的基于 Host，Path 路由，以及配置 TLS 的能力</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614171315.png" alt="" /></p><p>但是另一方面原生 Ingress 的功能十分有限，不能满足很多复杂场景的需求。许多第三方的 Ingress Controller [4] 通过 annotation 或新的配置模型和语法扩展了原生 Ingress 的功能，但仍然受限于集群间服务发现隔离的问题，只能作为<strong>单集群入口</strong>流量管理方案</p><h3 id="场景二灰度发布"><a class="markdownIt-Anchor" href="#场景二灰度发布"></a> <strong>场景二：灰度发布</strong></h3><p>服务可暴露给外部访问后，还需要考虑如何做版本发布，做平滑、无风险地迭代。常见的两种做法是按权重或流量内容切部分流量至新版本验证稳定性，无问题后逐渐过渡至新版本，也就是<code>灰度发布</code>以及<code>AB test</code></p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614175950.png" alt="" /></p><p>在这方面K8S Ingress API 原生并没有灰度发布的功能，Nginx ingress controller 通过 annotation 的方式扩展了原生 Ingress API 的功能，实现了灰度发布，但这种方式并不能很好地支撑控制应用流量的发布策略，相比之下，<code>Istio CRD</code> 配置更灵活易用，下面介绍如何使用 Istio VirtualService 配置灰度发布路由规则</p><h4 id="方案一基于权重"><a class="markdownIt-Anchor" href="#方案一基于权重"></a> <strong>方案一：基于权重</strong></h4><p>这种方案是配置成本最低的一个方案，很简单，基于k8s的service进行路由流量：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614180128.png" alt="" /></p><p><code>Istio</code> 可通过 <code>Virtual Service</code> 配置基于权重的灰度发布，以下是配置来自 <code>&#123;namespace&#125;/&#123;gateway&#125;</code> 的入口流量 95% 路由到 <code>&#123;service&#125;</code> 的 <code>current</code> 版本，5% 路由到 <code>canary</code> 版本的示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary-weight</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="string">namespace</span>&#125;<span class="string">/&#123;gateway&#125;</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">current</span></span><br><span class="line">          <span class="attr">weight:</span> <span class="number">95</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">canary</span></span><br><span class="line">          <span class="attr">weight:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><h4 id="方案二基于请求内容"><a class="markdownIt-Anchor" href="#方案二基于请求内容"></a> <strong>方案二：基于请求内容</strong></h4><p>既然能基于流量分流，那自然也应该支持基于内容的路由：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614180418.png" alt="" /></p><p><code>VirtualService</code> 也支持配置基于内容的灰度发布路由规则，以下是配置来自 <code>&#123;namespace&#125;/&#123;gateway&#125;</code> 的入口流量 <code>header cookie &quot;version=stable&quot;</code> 时路由到 <code>&#123;service&#125;</code> 的 <code>current</code> 版本，<code>&quot;version=canary&quot;</code> 时路由到 <code>&#123;service&#125;</code>的 <code>canary</code> 版本的示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary-content</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="string">namespace</span>&#125;<span class="string">/&#123;gateway&#125;</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">cookie:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">version=stable</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">current</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">cookie:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">version=canary</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">canary</span></span><br></pre></td></tr></table></figure><h3 id="场景三应用流量鉴权与限流"><a class="markdownIt-Anchor" href="#场景三应用流量鉴权与限流"></a> <strong>场景三：应用流量鉴权与限流</strong></h3><blockquote><p>鉴权与限流，是保证南北流量的安全性与健壮性的两个重要能力</p></blockquote><p>接入层是访问后端服务的统一入口，保证接入层的安全是接入层流量管理的一个重要场景，一般在入口处需要配置认证与授权规则，传统架构下认证授权功能一般通过代码逻辑实现，比如Django的一些开源鉴权中间件</p><p>而<code>Istio</code>自 1.5 之后提供了 <code>AuthorizationPolicy</code> 和 <code>RequestAuthentication CRD</code> [5]，可灵活配置入口层的认证和授权规则</p><h4 id="方案一请求身份认证jwt"><a class="markdownIt-Anchor" href="#方案一请求身份认证jwt"></a> <strong>方案一：请求身份认证（JWT）</strong></h4><p>入口处认证请求携带的 Json Web Token，放通携带合法令牌的请求，拒绝携带非法令牌的请求。</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181413.png" alt="" /></p><p>以下是使用 <code>Istio RequestAuthentication</code> 配置 <code>Ingress Gateway</code> 放通携带合法 <code>JWT</code> 请求的配置示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">..</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RequestAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jwt-example</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">jwtRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">issuer:</span> &#123;<span class="string">issuer</span> <span class="string">that</span> <span class="string">issued</span> <span class="string">the</span> <span class="string">JWT</span>&#125;</span><br><span class="line">    <span class="attr">jwksUri:</span> &#123;<span class="string">URL</span> <span class="string">of</span> <span class="string">the</span> <span class="string">provider’s</span> <span class="string">public</span> <span class="string">key</span> <span class="string">set</span> <span class="string">to</span> <span class="string">validate</span> <span class="string">signature</span> <span class="string">of</span> <span class="string">the</span> <span class="string">JWT</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="方案二授权"><a class="markdownIt-Anchor" href="#方案二授权"></a> <strong>方案二：授权</strong></h4><p>在入口处配置授权策略，根据流量内容特征，允许/拒绝流量访问，例如在入口处配置 IP 黑/白名单；或有外部鉴权服务，希望入口组件可对接外部鉴权服务，按照其返回的鉴权结果放通/拒绝流量</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181441.png" alt="" /></p><p>以下是使用 <code>Istio AuthorizationPolicy</code> 为 <code>Ingress Gateway</code> 配置 <code>IP block</code> 白名单的示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">white-list</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">ipBlocks:</span> &#123;<span class="string">single</span> <span class="string">IP</span> <span class="string">or</span> <span class="string">CIDR</span>&#125;</span><br></pre></td></tr></table></figure><p><code>Istio 1.9</code> 增强了对 <code>AuthorizationPolicy</code> 对于对接外部鉴权系统的支持，可配置 <code>Ingress Gateway</code> 按照外部鉴权系统返回的结果放通或拒绝流量。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ext-authz</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">CUSTOM</span></span><br><span class="line">  <span class="attr">provider:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;my-ext-authz-service&quot;</span></span><br><span class="line">  <span class="attr">rules:</span> <span class="string">...</span></span><br></pre></td></tr></table></figure><h4 id="方案三限流"><a class="markdownIt-Anchor" href="#方案三限流"></a> <strong>方案三：限流</strong></h4><p>限流这一手段在业务规模较大时非常常见，后端服务提供给众多租户使用时，需要在入口处控制请求的速率（不然再扩容老板要鲨人了），例如限制每个 User ID 每分钟只能请求 <code>/product</code> 接口 100 次；为了使用<code>Istio Ingress Gateway</code> 的限流功能，首先需要安装 <code>Ratelimit service</code>，可以自行实现或直接使用社区的 <code>ratelimit</code> [6]，然后使用 <code>Envoyfilter</code> 配置限流规则，具体配置方法可参考官方文档[7]</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181605.png" alt="" /></p><h3 id="场景四多集群异构场景入口流量管理"><a class="markdownIt-Anchor" href="#场景四多集群异构场景入口流量管理"></a> <strong>场景四：多集群异构场景入口流量管理</strong></h3><blockquote><p>随着业务规模的增加，或对容灾、数据合规性、业务之间隔离要求的提升，业务会考虑与实施部署多个 K8S 集群，甚至会出现容器化环境与非容器化环境异构混布的情况，给入口流量管理又带来了一系列新的挑战</p></blockquote><p>多 <code>K8S</code> 集群一般是基于容灾和业务隔离两方面的考虑：</p><h5 id="容灾"><a class="markdownIt-Anchor" href="#容灾"></a> <strong>容灾</strong></h5><p><code>K8S</code> 集群有地域属性，根据应用交付提供服务的访问时效和容灾诉求，同一应用可能分布在多个不同的地理区域。多（公有）云、混合云（IDC + 公有云）架构的容灾，也需部署多个集群。跨地域多集群容灾与就近接入可通过 DNS 解析提供，但 DNS 有缓存，故障转移实际生效时间可能较长，并且无法视服务健康程度切部分流量到备份地域，只能全部切换</p><p><code>Istio</code> 基于以下能力：1. 多集群服务发现能力；2. 地域感知、故障感知、容灾流量容量规划，可以实现：① 当所有集群的服务都健康时，按照请求来源地就近路由至对应服务；② 某个集群的服务出现部分故障时，视服务的健康程度转移一定比例的流量到其他集群的备份服务</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181831.png" alt="" /></p><h5 id="业务隔离"><a class="markdownIt-Anchor" href="#业务隔离"></a> <strong>业务隔离</strong></h5><p>据 CNCF 2020 云原生调查报告显示 [2]，用多个集群做应用隔离是仅次于用 namespace 隔离的使用方式，使用率从 2019 年的 47% 上升到了2020年的 50%。多个业务仍共用一个流量入口时，接入层需具备多集群服务发现的能力，将流量按指定策略路由至指定集群的服务</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182459.png" alt="" /></p><h4 id="方案一service-mesh-ingress"><a class="markdownIt-Anchor" href="#方案一service-mesh-ingress"></a> <strong>方案一：Service Mesh Ingress</strong></h4><p>K8S Ingress Controller 遇到的一个挑战是，K8S 集群隔离了集群间的服务发现，Ingress Controller 只能作为集群级别的流量入口。而 Service Mesh 技术借助于控制面服务发现的能力，可发现或注册多个集群的服务甚至异构服务，打通集群间的服务发现壁垒，不受应用部署平台限制，天然提供一致的接入流量转发管理能力</p><p>Istio 作为最受欢迎的 Service Mesh 开源项目，它的接入层 Istio Ingress Gateway 同样提供了对 Ingress API 的支持，但是不建议使用 Ingress 去配置 Ingress Gateway，这大大削弱了 Istio 的能力。Istio 对流量管理模型提供了更高程度的抽象，可以直接使用 Istio API 实现更灵活的流量管理能力，实现灰度发布，跨集群路由，地域感知等高级特性</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182144.png" alt="" /></p><p>Istio Ingress Gateway 基于 Envoy [3] 实现，Envoy 最初由 Lyft 创建，是一款为云原生场景设计的高性能服务代理软件，后由 Lyft 捐献到了 CNCF 社区，并已从 CNCF 毕业</p><h5 id="多-k8s-集群服务管理"><a class="markdownIt-Anchor" href="#多-k8s-集群服务管理"></a> <strong>多 K8S 集群服务管理</strong></h5><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182151.png" alt="" /></p><p>Istiod 可以通过网格内所有集群的 API Server 来获取 endpoints 信息，聚合多个集群的信息后，将最终生成的配置推送到 Ingress Gateway，Ingress Gateway 可以将请求按需转发至网格内所有 Pod</p><h5 id="地域感知负载均衡"><a class="markdownIt-Anchor" href="#地域感知负载均衡"></a> <strong>地域感知负载均衡</strong></h5><blockquote><p>在服务网格中，一个 Pod 的地理信息包括以下 3 个部分 [8]：</p><ul><li><strong>Region（地域）</strong>：通常代表一个较大的地理区域（e.g 北京 上海），在 K8S 中，节点的地域由标签 <code>topology.K8S.io/region</code> 决定</li><li><strong>Zone（可用区）</strong>：一个地域通常包含多个可用区（e.g. 北京一区 北京二区），在 K8S 中，节点的可用区由标签 <code>topology.K8S.io/zone</code> 决定</li><li><strong>Sub-zone</strong> ：允许对可用区做进一步划分实现更细粒度的控制，例如可以按照 rack（机架）划分，在 K8S 中不存在 sub-zone 的概念，Istio 使用节点的 <code>topology.istio.io/subzone</code> 标签来定义 sub-zone</li></ul><p>如果使用云厂商托管的 K8S 服务，节点的 Region 和 Zone 标签已由云厂商配置，例如在 TKE 集群中，上海二区的节点会有以下标签：</p><ul><li><code>topology.K8S.io/region: sh</code></li><li><code>topology.K8S.io/zone: &quot;200002&quot;</code></li></ul></blockquote><p>网格内的集群可能分布在不同地域不同可用区，大多数情况下，我们希望尽量减少跨地域/跨可用区的请求调用，因为这会增加请求时延。因此接入层需具备感知 endpoints 地理信息的能力，并支持根据地理信息配置负载均衡及故障转移策略</p><h6 id="地域故障转移"><a class="markdownIt-Anchor" href="#地域故障转移"></a> <strong>地域故障转移</strong></h6><p>在开启地域负载均衡的情况下，Istio 会告知 Ingress Gateway 将请求就近转发。当所有实例都正常时，请求将保持在同一地点，当实例异常时，流量会分发到下一优先地域的实例</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182247.png" alt="" /></p><p>例如，位于 <a href="http://bj.bj/">bj.bj</a>-01 的 Ingress Gateway 转发请求的优先级如下：</p><table><thead><tr><th style="text-align:center">优先级</th><th style="text-align:center">地理位置</th><th style="text-align:center"></th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center"><a href="http://bj.bj/">bj.bj</a>-01</td><td style="text-align:center">Region Zone 完全匹配</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center"><a href="http://bj.bj/">bj.bj</a>-02</td><td style="text-align:center">Region 匹配 Zone 不匹配</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center"><a href="http://sh.sh/">sh.sh</a>-01/sh-02</td><td style="text-align:center">Region Zone 都不匹配</td></tr></tbody></table><h6 id="地域加权负载均衡"><a class="markdownIt-Anchor" href="#地域加权负载均衡"></a> <strong>地域加权负载均衡</strong></h6><p>地域加权负载均衡可以将用户定义的一定百分比的流量分发到某些地域，例如我们可以使用如下配置分发流量：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">localityLbSetting:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">distribute:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span> <span class="string">bj/bj-01/*</span></span><br><span class="line">      <span class="attr">to:</span></span><br><span class="line">        <span class="string">&quot;bj/bj-01/*&quot;</span><span class="string">:</span> <span class="number">70</span></span><br><span class="line">        <span class="string">&quot;bj/bj-02/*&quot;</span><span class="string">:</span> <span class="number">20</span></span><br><span class="line">        <span class="string">&quot;sh/sh-01/*&quot;</span><span class="string">:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p><img src="https://mmbiz.qpic.cn/mmbiz_png/gBXSicjuwMvHRX48bbV45hGUS3RgWicabsrXbaZUzCky3k8T3Z01oYnIr4oGSwavvu4PVVMh57OJrXtMBTZyHFRQ/640?wx_fmt=png" alt="img" /></p><h5 id="异构服务入口流量管理"><a class="markdownIt-Anchor" href="#异构服务入口流量管理"></a> <strong>异构服务入口流量管理</strong></h5><p>除了多集群，用户在云原生改造的过程中，常常会面临部分服务已经做了容器化改造，运行在 K8S 集群，部分不便改造的服务仍在虚拟机的情况，甚至会有部分使用的是云厂商 serverless 云函数服务（e.g. AWS lambda）。接入层需具备异构服务注册/发现的能力，以管理异构部署服务的南北向流量</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182336.png" alt="" />可以通过 Istio 提供的 WorkloadGroup 和 WorkloadEntry 将虚拟机上的服务注册到网格内，同一个服务可以同时运行在 K8S 集群和虚拟机上</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182343.png" alt="" /></p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>Istio Ingress Gateway 在入口灰度发布、安全、多集群异构流量管理等场景提供了多集群服务发现、地域感知、流量容量规划，以及更强大灵活的流量管理 API 的支持</p><p>但与此同时，用户也不得不面对 Istio 的复杂性；需要投入资源和人力成本运维 Istiod 和 Istio Ingress Gateway，集成 metric，trace，log 等可观测性及证书管理周边系统成本较高，还需要正确配置各种 CRD（Gateway VirtualService DestinationRule 等）；但在一两年前，这也是<code>K8S</code>为人所诟病的地方，相信开发者们很快就能熟悉<code>Istio</code>的运维方式</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> 后端 </tag>
            
            <tag> k8s </tag>
            
            <tag> 虚拟化技术 </tag>
            
            <tag> Service Mesh </tag>
            
            <tag> 流量管理 </tag>
            
            <tag> 灰度发布 </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis分布式锁的基本实现</title>
      <link href="/2021/06/14/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0/"/>
      <url>/2021/06/14/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>随着分布式系统的普遍运用，分布式锁的重要性也得到了体现</p><p>在单机系统中，我们可以运用普通的锁/信号量机制来实现对公共资源的有序访问；但在分布式系统中显然就不行了</p><p>因此业界常用的解决方案通常是借助于一个第三方组件，利用它自身的排他性来达到多进程的互斥；如：</p><ul><li>基于 DB 的唯一索引</li><li>基于 ZK 的临时有序节点</li><li>基于 Redis 的 <code>NX EX</code> 参数</li></ul><p>本文就主要以Redis分布式锁展开</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li>锁机制：<strong>锁</strong>是在执行<a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E7%BA%BF%E7%A8%8B">多线程</a>时用于强行限制资源访问的<a href="https://zh.wikipedia.org/wiki/%E5%90%8C%E6%AD%A5">同步</a>机制，即用于在<a href="https://zh.wikipedia.org/wiki/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6">并发控制</a>中保证对<a href="https://zh.wikipedia.org/wiki/%E4%BA%92%E6%96%A5">互斥</a>要求的满足（<a href="https://zh.wikipedia.org/wiki/%E9%94%81_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">Wiki百科</a>）</li><li>死锁：死锁是指两个或两个以上的进程在执行过程中，由于竞争资源或者由于彼此通信而造成的一种阻塞的现象，若无外力作用，它们都将无法推进下去。 此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程</li><li>ZK：即ZooKeeper，ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等</li></ul><h2 id="redis分布式锁的基本原理"><a class="markdownIt-Anchor" href="#redis分布式锁的基本原理"></a> Redis分布式锁的基本原理</h2><p>既然是选用了 Redis，那么它就得具有排他性才行；同时它最好也有锁的一些基本特性：</p><ul><li>高性能(加、解锁高性能)</li><li>可以使用阻塞锁与非阻塞锁</li><li>不能出现死锁</li><li>可用性(不能出现节点挂掉后加锁失败)</li></ul><p>这里利用 <code>Redis set key</code> 的 NX 参数来保证在这个 key 不存在的情况下写入成功，并且再加上 EX 参数设置过期时间</p><p>利用以上两个特性可以保证在同一时刻只会有一个进程获得锁，并且不会出现死锁（过期自动删除 key）</p><h3 id="加锁"><a class="markdownIt-Anchor" href="#加锁"></a> 加锁</h3><p>Show me the code:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLock</span><span class="params">(lockName <span class="keyword">string</span>, acquireTimeout time.Duration, lockTimeOut time.Duration)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    code := uuid.NewV4().String()</span><br><span class="line">    endTime := util.FwTimer.CalcMillis(time.Now().Add(acquireTimeout))</span><br><span class="line">    <span class="keyword">for</span> util.FwTimer.CalcMillis(time.Now()) &lt;= endTime &#123;</span><br><span class="line">        <span class="keyword">if</span> success, err := fwRedisClient.SetNX(lockName, code, lockTimeOut).Result(); err != <span class="literal">nil</span> &amp;&amp; err != redis.Nil &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> success &#123;</span><br><span class="line">            <span class="keyword">return</span> code, <span class="literal">nil</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> fwRedisClient.TTL(lockName).Val() == <span class="number">-1</span> &#123; <span class="comment">//-2:失效；-1：无过期；</span></span><br><span class="line">            fwRedisClient.Expire(lockName, lockTimeOut)</span><br><span class="line">        &#125;</span><br><span class="line">        time.Sleep(time.Millisecond)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>加锁很简单，直接setnx，监控下返回值和error就行啦</p><h3 id="解锁"><a class="markdownIt-Anchor" href="#解锁"></a> 解锁</h3><p>到这里我曾经以为解锁也跟加锁一样简单，直接del就完事了，然而并没有那么简单</p><p>如果进程 A 获取了锁设置了超时时间，但是由于执行周期较长导致到了超时时间之后锁就自动释放了。这时进程 B 获取了该锁，然而这时进程 A 执行完了，释放了该锁；这样就会出现进程 A 将进程 B 的锁释放了</p><p>所以最好的方式是在每次解锁时都需要判断锁<strong>是否是自己</strong>的</p><p>这时就需要结合加锁机制一起实现了</p><p>在上面的加锁实现中可以看到设置value为code时同时也返回了这个uuid，这样解锁时我们可以判断get到的值是否与自己的uuid相同，来决定是否解锁，同时 <code>WATCH</code> 锁保证不会错误的释放锁</p><p>Show me the code:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReleaseLock</span><span class="params">(lockName <span class="keyword">string</span>, code <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    txf := <span class="function"><span class="keyword">func</span><span class="params">(tx *redis.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> v, err := tx.Get(lockName).Result(); err != <span class="literal">nil</span> &amp;&amp; err != redis.Nil &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> v == code &#123;</span><br><span class="line">            _, err := tx.Pipelined(<span class="function"><span class="keyword">func</span><span class="params">(pipe redis.Pipeliner)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">                <span class="comment">//count++</span></span><br><span class="line">                <span class="comment">//fmt.Println(count)</span></span><br><span class="line">                pipe.Del(lockName)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := fwRedisClient.Watch(txf, lockName); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> err == redis.TxFailedErr &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;watch key is modified, retry to release lock. err:&quot;</span>, err.Error())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;err:&quot;</span>, err.Error())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样也就能满足锁的四个基本特性了：</p><ul><li>高性能(加、解锁高性能)</li><li>可以使用阻塞锁与非阻塞锁</li><li>不能出现死锁</li><li>可用性(不能出现节点挂掉后加锁失败)</li></ul><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>Redis分布式锁应该是比较简单的分布式锁了，同时本文介绍的也只是redis分布式锁的基本实现，在实际运用场景中还可以使用不同的方式实现<br />同时基本的实现方法也还存在一些问题，无法保证高可用，如：</p><ul><li>超时解锁导致并发业务</li><li>客户端无法等待锁释放</li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> 数据库 </tag>
            
            <tag> Redis </tag>
            
            <tag> 内存管理 </tag>
            
            <tag> 分布式 </tag>
            
            <tag> 锁 </tag>
            
            <tag> 异步编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从Redis事务到Redis pipeline</title>
      <link href="/2021/04/19/%E4%BB%8ERedis%E4%BA%8B%E5%8A%A1%E5%88%B0Redis-pipeline/"/>
      <url>/2021/04/19/%E4%BB%8ERedis%E4%BA%8B%E5%8A%A1%E5%88%B0Redis-pipeline/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>相信对关系性数据库有使用经验的，都对<strong>事务</strong>操作很熟悉，为了确保连续多个操作的原子性，我们常用的数据库都会有事务的支持，Redis 也不例外；但它又和关系型数据库支持的<strong>事务</strong>不太一样</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li><a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1"><strong>事务</strong></a>：数据库事务通常包含了一个序列的对数据库的读/写操作。包含有以下两个目的：<ol><li>为数据库操作序列提供了一个从失败中恢复到正常状态的方法，同时提供了数据库即使在异常状态下仍能保持一致性的方法</li><li>当多个<a href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">应用程序</a>在<a href="https://zh.wikipedia.org/wiki/%E5%B9%B6%E5%8F%91">并发</a>访问数据库时，可以在这些应用程序之间提供一个隔离方法，以防止彼此的操作互相干扰</li></ol></li><li><a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1#ACID%E6%80%A7%E8%B4%A8">ACID</a>：关系性数据库事务具有的四个特性：<strong>原子性（Atomicity）</strong>、<strong>一致性（Consistency）</strong>、<strong>隔离性（Isolation）</strong>、<strong>持久性（Durability）</strong></li><li>悲观锁(Pessimistic Lock)：顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 block 直到它拿到锁。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁</li><li>乐观锁(Optimistic Lock)：顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。乐观锁适用于多读的应用类型，这样可以提高吞吐量。乐观锁策略：提交版本必须大于记录当前版本才能执行更新</li></ul><h2 id="redis事务"><a class="markdownIt-Anchor" href="#redis事务"></a> Redis事务</h2><h3 id="基本使用形式"><a class="markdownIt-Anchor" href="#基本使用形式"></a> 基本使用形式</h3><ol><li>MULTI（开启事务）</li><li>一系列命令加入队列</li><li>EXEC（执行事务）/ DISCARD（取消事务）</li></ol><p>Redis 事务可以一次执行多个命令，本质是一组命令的集合；一个事务中的所有命令都会序列化，按顺序地串行化执行而不会被其它命令插入，不许加塞</p><p>可以保证一个队列中，一次性、顺序性、排他性的执行一系列命令（Redis 事务的主要作用其实就是串联多个命令防止别的命令插队）</p><table><thead><tr><th style="text-align:left">命令</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">MULTI</td><td style="text-align:left">将客户端的 <code>REDIS_MULTI</code> 选项打开， 让客户端从非事务状态切换到事务状态</td></tr><tr><td style="text-align:left">EXEC</td><td style="text-align:left">执行所有事务块内的命令</td></tr><tr><td style="text-align:left">DISCARD</td><td style="text-align:left">取消事务，放弃执行事务块内的所有命令</td></tr><tr><td style="text-align:left">WATCH</td><td style="text-align:left">监视一个（或多个）key，如果在事务执行之前这个（或多个）key被其他命令所改动，那么事务将被打断</td></tr><tr><td style="text-align:left">UNWATCH</td><td style="text-align:left">取消 WATCH 命令对所有 keys 的监视</td></tr></tbody></table><p>如果执行一帆风顺，到这里一切都显得那么合理：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210418160029.png" alt="" /></p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210418160343.png" alt="" /></p><p>但在实际的生产环境中往往还会遇到一些问题：</p><ul><li><p>事务在执行 <code>EXEC</code> 之前，入队的命令可能会出错。比如说，命令可能会产生语法错误（参数数量错误，参数名错误等等，往往是因为调用者没有对参数进行判空处理）</p></li><li><p>命令可能在 <code>EXEC</code> 调用之后失败。举个例子，事务中的命令可能处理了错误类型的键，比如将列表命令用在了字符串键上面</p></li><li><p>OOM / used_memory超过设置的maxmemory（图为redis-server pod挂掉了）</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210418160803.png" alt="" /></p></li></ul><p>Redis 针对如上两种错误采用了不同的处理策略，对于发生在 <code>EXEC</code> 执行之前的错误，服务器会对命令入队失败的情况进行记录，并在客户端调用 <code>EXEC</code> 命令时，拒绝执行并自动放弃这个事务（Redis 2.6.5 之前的做法是检查命令入队所得的返回值：如果命令入队时返回 <code>QUEUED</code> ，那么入队成功；否则，就是入队失败）</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210418161319.png" alt="" /></p><p>如上图，<code>EXEC</code>前命令入队时出现了语法错误，<code>EXEC</code>时则会直接拒绝该事务</p><p>对于那些在 <code>EXEC</code> 命令执行之后所产生的错误， 并没有对它们进行特别处理： 即使事务中有某个/某些命令在执行时产生了错误， 事务中的其他命令仍然会继续执行</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210418161447.png" alt="" /></p><p>如上图，<code>INCRBY kevinello 1</code>语法没有错误，但<code>kevinello</code>的<code>value</code>是字符串类型，不能对其使用<code>INCRBY</code>；这种情况执行<code>EXEC</code>不会报错，只有那一条命令执行失败</p><p>也就是说<code>Redis</code>是不支持回滚的</p><h2 id="为什么-redis-不支持回滚"><a class="markdownIt-Anchor" href="#为什么-redis-不支持回滚"></a> 为什么 Redis 不支持回滚</h2><p><a href="https://redislabs.com/blog/you-dont-need-transaction-rollbacks-in-redis/">以下是官方的解释</a>：</p><blockquote><p>This is the moment where one might say that rollbacks would be nice to have. I might agree if not for two considerations:</p><ol><li>The snapshotting mechanism required to implement rollbacks would have a considerable computational cost. That extra complexity wouldn’t sit well with Redis’ philosophy and ecosystem.</li><li>Rollbacks can’t catch all errors. In the example above, we set “counter” to “banana” in order to show a blatant error, but in the real world the process that used the “counter” key in the wrong way might instead have deleted it, or put in a credit-card number, for example. Rollbacks would add a considerable amount of complexity and would still not fully solve the problem.</li></ol><p>The second point is particularly important because it also applies to SQL: SQL DBMSs offer many mechanisms to help protect data integrity, but even they can’t completely protect you from programming errors. <strong>On both platforms, the burden of writing correct transactions remains on you.</strong></p></blockquote><p>翻译一下，两句话：</p><blockquote><ol><li>回滚是非常复杂的操作，不符合Redis的设计哲学和生态系统，且回滚也不能解决所有问题</li><li>需要回滚完全是你们的编程错误导致的，这些错误应该在开发时就被发现，我Redis不背这锅；鉴于没有任何机制能避免程序员自己造成的错误， 并且这类错误通常不会在生产环境中出现， 所以 Redis 选择了更简单、更快速的无回滚方式来处理事务</li></ol></blockquote><p>其实这篇解释很有意思，其中也多次提到了<code>Redis</code>的设计哲学以及与<code>SQL</code>的对比，感兴趣的同学可以详细阅读（看别人撕逼真有趣）</p><h2 id="基于watch的事务"><a class="markdownIt-Anchor" href="#基于watch的事务"></a> 基于WATCH的事务</h2><blockquote><p>how do you create a transaction that depends on the data present in Redis? For this purpose, Redis implements WATCH, a command for performing optimistic locking.</p><p>如何创建一个依赖于Redis中已存在的数据的事务？ 为此，Redis实现了WATCH，这是用于执行乐观锁的命令</p></blockquote><h3 id="redis实现的乐观锁"><a class="markdownIt-Anchor" href="#redis实现的乐观锁"></a> Redis实现的乐观锁</h3><p><code>WATCH</code> 命令用于在事务开始之前监视任意数量的键： 当调用 <code>EXEC</code> 命令执行事务时， 如果任意一个被监视的键已经被其他客户端修改了， 那么整个事务将被打断，不再执行， 直接返回失败</p><p><code>WATCH</code>命令可以被调用多次； 对键的监视从 <code>WATCH</code> 执行之后开始生效， 直到调用 <code>EXEC</code>为止</p><p>当多个<code>Redis</code>客户端尝试使用事务改动同一个被<code>WATCH</code>监视的键时，<code>Redis</code>会自动抛弃某些事务，这时客户端需要重试该事务</p><p><code>WATCH</code>的实现是基于<code>redis</code>中保存的<code>watched_keys</code> 字典实现的，字典的键是这个数据库被监视的键， 而字典的值则是一个链表， 链表中保存了所有监视这个键的客户端</p><p>具体实现见<a href="https://redisbook.readthedocs.io/en/latest/feature/transaction.html?spm=a2c6h.12873639.0.0.59911280BIyHp7#id3">官方文档</a></p><h2 id="pipeline"><a class="markdownIt-Anchor" href="#pipeline"></a> Pipeline</h2><blockquote><p>Another way to reduce the latency of Redis queries is by using <a href="http://redis.io/topics/pipelining">pipelining</a>. When you pipeline a group of operations, they are sent in a single batch that, while bigger and slower to process, requires only a single request-response round trip. This consolidation of trips makes for substantial overall latency reductions.</p></blockquote><p><code>Redis</code>事务在发送每个指令到事务缓存队列时都要经过一次网络读写，当一个事务内部的指令较多时，需要的网络 IO 时间也会线性增长。所以通常 <code>Redis</code>的客户端在执行事务时都会结合 <code>pipeline</code>一起使用，这样可以将多次 IO 操作压缩为单次 IO 操作</p><p>这里基于<code>go-redis</code>客户端实现的<code>pipeline</code>聊一下<code>pipeline</code>的使用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TxPipeline acts like Pipeline, but wraps queued commands with MULTI/EXEC.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">TxPipeline</span><span class="params">()</span> *<span class="title">Pipeline</span></span> &#123;</span><br><span class="line">pipe := Pipeline&#123;</span><br><span class="line">exec: c.pipelineExecer(c.txPipelineProcessCmds),</span><br><span class="line">&#125;</span><br><span class="line">pipe.cmdable.process = pipe.Process</span><br><span class="line">pipe.statefulCmdable.process = pipe.Process</span><br><span class="line"><span class="keyword">return</span> &amp;pipe</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面是<code>go-redis</code>中实现的事务<code>pipeline</code>，与普通<code>pipeline</code>不同的地方仅在于它的<code>Exec</code>方法，<code>txPipelineProcessCmds</code>中调用了<code>txPipelineWriteMulti</code>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">txPipelineWriteMulti</span><span class="params">(cn *pool.Conn, cmds []Cmder)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">multiExec := <span class="built_in">make</span>([]Cmder, <span class="number">0</span>, <span class="built_in">len</span>(cmds)+<span class="number">2</span>)</span><br><span class="line">multiExec = <span class="built_in">append</span>(multiExec, NewStatusCmd(<span class="string">&quot;MULTI&quot;</span>))</span><br><span class="line">multiExec = <span class="built_in">append</span>(multiExec, cmds...)</span><br><span class="line">multiExec = <span class="built_in">append</span>(multiExec, NewSliceCmd(<span class="string">&quot;EXEC&quot;</span>))</span><br><span class="line"><span class="keyword">return</span> writeCmd(cn, multiExec...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到<code>TxPipeline</code>只是做了一下包装使其支持事务</p><h2 id="pipeline的进阶使用"><a class="markdownIt-Anchor" href="#pipeline的进阶使用"></a> pipeline的进阶使用</h2><p><code>pipeline</code>的基本使用非常简单，但有<a href="https://redislabs.com/blog/redis-running-slowly-heres-what-you-can-do-about-it/">几点要注意</a>：</p><blockquote><p>Note, however, that a pipeline operation could block your application if it is waiting for replies without sending the pipeline – Redis will provide all of the replies to the pipelined stream of commands only after the pipeline has been sent. Also bear in mind that when using pipelining, Redis caches all the responses in memory before returning them to the client in bulk, so pipelining thousands of queries (especially those that return a large amount of data) can be taxing to both the server and client. If that is the case, use smaller pipeline sizes.</p></blockquote><ul><li>一个<code>pipeline</code>包含的命令不应太多，因为在使用流水线操作时，<code>Redis</code>在将所有响应批量返回给客户端之前会<strong>将所有响应缓存在内存</strong>中，因此对数千个查询（特别是那些返回大量数据的查询）进行流水线操作可能会对服务器和客户端都造成负担</li><li>因为即使是<code>TxPipeline</code>也只是弱事务性的，我们应该在设计业务模型时尽可能保证数据安全性，降低事务出错带来的影响（不要把自己带入基于SQL的设计思维）</li></ul><p>对于第一个问题我们可以简单封装一下<code>TxPipeline</code>：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> MaxPipeLineCmdCount = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyPipeline <span class="keyword">struct</span> &#123;</span><br><span class="line">Pipeline *redis.Pipeline</span><br><span class="line">CmdCount <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(myPipeline *MyPipeline)</span> <span class="title">IncrCmdCount</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">myPipeline.CmdCount++</span><br><span class="line"><span class="keyword">if</span> myPipeline.CmdCount &gt;= MaxPipeLineCmdCount &#123;</span><br><span class="line">kutil.Logger.Infof(<span class="string">&quot;myPipeline has %d cmds, will do exec and reset&quot;</span>, MaxPipeLineCmdCount)</span><br><span class="line">_, err = myPipeline.Pipeline.Exec()</span><br><span class="line">myPipeline.CmdCount = <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(myPipeline *MyPipeline)</span> <span class="title">ClearLeftCmds</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> myPipeline.CmdCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">kutil.Logger.Infof(<span class="string">&quot;myPipeline has %d cmds left, will do exec&quot;</span>, myPipeline.CmdCount)</span><br><span class="line">_, err = myPipeline.Pipeline.Exec()</span><br><span class="line">myPipeline.CmdCount = <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">kutil.Logger.Infof(<span class="string">&quot;myPipeline has no cmds left&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然也可以采用定时任务的方式检查<code>cmd</code>个数提交<code>pipeline</code></p><h2 id="txpipeline与lua脚本的选择"><a class="markdownIt-Anchor" href="#txpipeline与lua脚本的选择"></a> TxPipeline与Lua脚本的选择</h2><p>官方解释：</p><blockquote><p>There are, in my opinion, a couple of reasonable situations where you might legitimately prefer transactions with optimistic locking over Lua:</p><ol><li>The keys your transaction depends on are not modified frequently, meaning that you are confident optimistic locking will almost never abort transactions.</li><li>You depend on a lot of logic written on the client side—or maybe a third-party service—so there is no easy way to move that logic to a Lua script.</li></ol><p>Unless both these points are true for your application, I recommend you choose Lua over WATCH</p></blockquote><p>值得注意的是官方对比的是带<code>WATCH</code>的事务与Lua脚本</p><p>翻译一下</p><p>只有两种场景下应该使用带<code>WATCH</code>的事务而不是<code>Lua</code>脚本：</p><ul><li>事务依赖的数据并不会被频繁更改，也就是说我们有信心<code>WATCH</code>锁基本不会被打破</li><li>客户端的业务逻辑比较复杂，将其写成<code>Lua</code>脚本的成本较大</li></ul><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p><code>Redis</code>事务仅具有一致性与隔离性，不保证原子性和持久性，所以在设计使用<code>Redis</code>的业务时需要保证数据安全性，在<code>pipeline</code>与<code>Lua</code>脚本的取舍上其实也不用太过纠结，简单的业务可以直接封装成<code>Lua</code>脚本</p><p>在使用<code>pipeline</code>时需要注意监控其命令个数，避免对服务器和客户端造成过大的负担，导致业务延迟乃至于<code>OOM</code></p><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章"></a> 参考文章</h2><ul><li><p><a href="https://redislabs.com/blog/you-dont-need-transaction-rollbacks-in-redis/">You Don’t Need Transaction Rollbacks in Redis</a></p></li><li><p><a href="https://redislabs.com/blog/redis-running-slowly-heres-what-you-can-do-about-it/">Redis Running Slowly? Here’s What You Can Do About it</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
            <tag> Redis </tag>
            
            <tag> 内存管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis内存碎片的产生与清理</title>
      <link href="/2021/04/11/Redis%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%E7%9A%84%E4%BA%A7%E7%94%9F%E4%B8%8E%E6%B8%85%E7%90%86/"/>
      <url>/2021/04/11/Redis%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%E7%9A%84%E4%BA%A7%E7%94%9F%E4%B8%8E%E6%B8%85%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>在做redis内存清理时我们会关注redis的实时内存占用，即通过info memory命令查看内存使用情况：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210411150547.png" alt="" /></p><p>我们比较常关注的是<code>used_memory</code>以及<code>used_memory_rss</code>，这两项分别是<code>redis</code>中的数据占用的内存以及<code>redis</code>向操作系统申请的所有内存，可以看到这里这两项差距是很大的，我们也可以通过另一项更直观的观察这两项的差距，即<code>mem_fragmentation_ratio</code></p><blockquote><p>mem_fragmentation_ratio = used_memory_rss / used_memory</p></blockquote><p>但<code>Redis</code>申请了这么多内存是在干啥呢？？？非常的疑惑</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li><code>used_memory</code>: Amount of memory (in bytes) used by Redis</li><li><code>used_memory_rss</code>: Memory allocated by the operating system</li><li><code>mem_fragmentation_ratio</code>: Ratio of memory allocated by the operating system to memory requested by Redis</li></ul><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210411154651.png" alt="" /></p><h2 id="为什么会产生内存碎片"><a class="markdownIt-Anchor" href="#为什么会产生内存碎片"></a> 为什么会产生内存碎片？</h2><p>主要有两个原因：</p><ul><li><code>redis</code>自己实现的内存分配器：在<code>redis</code>中新建<code>key-value</code>值时，<code>redis</code>需要向操作系统申请内存，一般的进程在不需要使用申请的内存后，会直接释放掉、归还内存；但<code>redis</code>不一样，<code>redis</code>在使用完内存后并不会直接归还内存，而是放在<code>redis</code>自己实现的内存分配器中管理，这样就不需要每次都向操作系统申请内存了，实现了高性能（但这样其它应用可就不高兴了，自私的Redis）</li><li><code>value</code>的更新：<code>redis</code>的每个<code>key-value</code>对初始化的内存大小是最适合的，当这个<code>value</code>改变的并且原来内存大小不适用的时候，就需要重新分配内存了，重新分配之后，就会有一部分内存<code>redis</code>无法正常回收，一直占用着</li></ul><h2 id="内存碎片率的意义"><a class="markdownIt-Anchor" href="#内存碎片率的意义"></a> 内存碎片率的意义</h2><p><a href="https://www.datadoghq.com/blog/how-to-monitor-redis-performance-metrics/#memory-metrics">From 文档</a>：</p><blockquote><p>The operating system is responsible for allocating physical memory to each process. The operating system’s virtual memory manager handles the actual mapping, mediated by a memory allocator.</p><p>What does this mean? If your Redis instance has a memory footprint of 1GB, the memory allocator will first attempt to find a contiguous memory segment to store the data. If no contiguous segment is found, the allocator must divide the process’s data across segments, leading to increased memory overhead.</p><p>Tracking fragmentation ratio is important for understanding your Redis instance’s performance. A fragmentation ratio greater than 1 indicates fragmentation is occurring. A ratio in excess of 1.5 indicates excessive fragmentation, with your Redis instance consuming 150% of the physical memory it requested. A fragmentation ratio below 1 tells you that Redis needs more memory than is available on your system, which leads to swapping. Swapping to disk will cause significant increases in latency (see <a href="https://www.datadoghq.com/blog/how-to-monitor-redis-performance-metrics/#metric-to-watch-used-memory">used memory</a>). Ideally, the operating system would allocate a contiguous segment in physical memory, with a fragmentation ratio equal to 1 or slightly greater.</p></blockquote><ul><li>大于1小于1.5：正常值，有一些内存碎片，但也可以提高性能，可以接受</li><li>大于1.5：说明内存碎片率比较大，需要考虑是否要进行内存碎片清理，要引起重视</li><li>小于1：内存不够<code>redis</code>用了，已经开始使用swap机制交换内存，也就是使用硬盘了（swap可以在设置中禁用），需要考虑扩容<code>redis</code>了</li></ul><h2 id="如何清理内存碎片"><a class="markdownIt-Anchor" href="#如何清理内存碎片"></a> 如何清理内存碎片？</h2><p><a href="https://www.datadoghq.com/blog/how-to-monitor-redis-performance-metrics/#memory-metrics">From 文档</a>：</p><blockquote><p>If your server is suffering from a fragmentation ratio above 1.5, restarting your Redis instance will allow the operating system to recover memory previously unusable due to fragmentation. In this case, an <a href="https://www.datadoghq.com/blog/monitoring-101-alerting/#levels-of-urgency">alert as a notification</a> is probably sufficient.</p><p>If, however, your Redis server has a fragmentation ratio below 1, you may want to <a href="https://www.datadoghq.com/blog/pagerduty/">alert as a page</a> so that you can quickly increase available memory or reduce memory usage.</p><p>Starting in Redis 4, a new <a href="https://github.com/antirez/redis/blob/4.0/redis.conf#L1232">active defragmentation</a> feature is available when Redis is configured to use the included copy of jemalloc. This tool can be configured to kick in when fragmentation reaches a certain level and begin to copy values into contiguous memory regions and release the old copies, reducing fragmentation while the server is running.</p></blockquote><h3 id="redis版本40以下"><a class="markdownIt-Anchor" href="#redis版本40以下"></a> Redis版本4.0以下</h3><p>重启<code>redis</code>，自动归还所有内存，简单粗暴</p><h3 id="redis版本40以上"><a class="markdownIt-Anchor" href="#redis版本40以上"></a> Redis版本4.0以上</h3><p>可以开启自动内存碎片清理：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[6]&gt; config set activedefrag yes</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>自动内存清理的一些相关配置如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Enabled active defragmentation</span><br><span class="line"># 碎片整理总开关</span><br><span class="line"># activedefrag yes</span><br><span class="line"></span><br><span class="line"># Minimum amount of fragmentation waste to start active defrag</span><br><span class="line"># 内存碎片达到多少的时候开启整理</span><br><span class="line">active-defrag-ignore-bytes 100mb</span><br><span class="line"></span><br><span class="line"># Minimum percentage of fragmentation to start active defrag</span><br><span class="line"># 碎片率达到百分之多少开启整理</span><br><span class="line">active-defrag-threshold-lower 10</span><br><span class="line"></span><br><span class="line"># Maximum percentage of fragmentation at which we use maximum effort</span><br><span class="line"># 碎片率小余多少百分比开启整理</span><br><span class="line">active-defrag-threshold-upper 100</span><br></pre></td></tr></table></figure><p>当然，在面对一些复杂的场景时我们希望能根据自己设计的策略来进行内存碎片清理，<code>redis</code>也提供了手动内存碎片清理的命令：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; memory purge</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>占有欲很高的的<code>redis</code>总是会留下已经不用的内存，这在生产环境中必然是不能接受的，所以内存碎片的清理非常重要</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> 数据库 </tag>
            
            <tag> Redis </tag>
            
            <tag> 内存管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python-asyncio异步编程基础</title>
      <link href="/2021/03/17/Python-asyncio%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
      <url>/2021/03/17/Python-asyncio%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p><code>asyncio</code>是Python 3.4版本引入的标准库，直接内置了对异步IO的支持，并且如今<code>asyncio</code>的单线程异步性能已经做到与<code>Go</code> / <code>Node</code>持平</p><p>目前还没有基于asyncio开发大型项目的经历（主要还是在用<code>golang</code>）</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li><code>协程（coroutine）</code>：与<strong>线程</strong>很相似，不同之处在于多协程是同一个线程来执行的，这样就省去了线程切换的时间，而且不需要多线程的锁机制了，执行效率高很多</li><li><code>异步IO</code>：异步IO的概念和同步IO相对。当一个异步过程调用发出后，调用者不能立刻得到结果。实际处理这个调用的部件在完成后，通过状态、通知和回调来通知调用者</li><li><code>事件循环</code>：事件循环是一种处理多并发量的有效方式，在维基百科中它被描述为「一种等待程序分配事件或消息的编程架构」，我们可以定义事件循环来简化使用轮询方法来监控事件，通俗的说法就是「当A发生时，执行B」</li></ul><h2 id="asyncio-是什么"><a class="markdownIt-Anchor" href="#asyncio-是什么"></a> asyncio 是什么</h2><p><code>asyncio</code>模块提供了使用协程构建并发应用的工具，它使用一种单线程单进程的的方式实现并发，应用的各个部分彼此合作, 可以显式的切换任务，一般会在程序阻塞I/O操作的时候发生上下文切换如等待读写文件,或者请求网络；同时<code>asyncio</code>也支持调度代码在将来的某个特定时间运行，从而支持一个协程等待另一个协程完成，以处理系统信号和识别其他一些事件</p><p>其他的并发模型大多数采取线性的方式编写，并且依赖于语言运行时系统 / 操作系统的底层线程 / 进程来适当地改变上下文，而基于<code>asyncio</code>的应用要求应用代码显式地处理上下文切换</p><h2 id="asyncio基本使用"><a class="markdownIt-Anchor" href="#asyncio基本使用"></a> asyncio基本使用</h2><p><code>asyncio</code>的核心编程模型就是一个消息循环，我们从<code>asyncio</code>模块中直接获取一个<code>EventLoop</code>的引用，然后把需要执行的<a href="https://kevinello.ltd/2021/02/15/Python-yield%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3/">协程</a>扔到<code>EventLoop</code>中执行，就实现了异步IO</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>():</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(), my_coroutine()]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br></pre></td></tr></table></figure><p>由打印的当前线程id可以看出，两个<code>coroutine</code>是由同一个线程并发执行的</p><p>如果把<code>asyncio.sleep()</code>换成真正的IO操作，则多个<code>coroutine</code>就可以由一个线程并发执行</p><h2 id="async-await"><a class="markdownIt-Anchor" href="#async-await"></a> async / await</h2><p>Python 3.5开始引入了新的语法<code>async</code>和<code>await</code>，可以让coroutine的代码更简洁易读</p><p>用起来也很简单，只需要做两件事情：</p><ul><li>把<code>@asyncio.coroutine</code>替换为<code>async</code></li><li>把<code>yield from</code>替换为<code>await</code></li></ul><p>更新后的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>():</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(), my_coroutine()]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简洁 &amp; 优雅</p><h2 id="协程中调用普通函数"><a class="markdownIt-Anchor" href="#协程中调用普通函数"></a> 协程中调用普通函数</h2><p>在协程中可以通过调用<code>EventLoop</code>对象的<code>call_soon</code>，<code>call_later</code>，<code>call_at</code>方法来调用普通函数</p><h3 id="call_soon"><a class="markdownIt-Anchor" href="#call_soon"></a> call_soon</h3><p>字面意思，立即调用</p><p><code>call_soon(self, callback, *args, context=None)</code></p><blockquote><p>Arrange for a callback to be called as soon as possible.This operates as a FIFO queue: callbacks are called in theorder in which they are registered.  Each callback will becalled exactly once.Any positional arguments after the callback will be passed tothe callback when it is called.</p></blockquote><p>在<strong>下一个迭代的时间循环</strong>中立刻调用回调函数，看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">args</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;callback: <span class="subst">&#123;args&#125;</span> (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>(<span class="params">loop</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;first time&#x27;</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;second time&#x27;</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(loopEvent), my_coroutine(loopEvent)]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br></pre></td></tr></table></figure><h3 id="call_later"><a class="markdownIt-Anchor" href="#call_later"></a> call_later</h3><p>事件循环在<code>delay</code>一定时间后执行<code>callback</code>函数</p><p><code>call_later(self, delay, callback, *args, context=None)</code></p><blockquote><p>Arrange for a callback to be called at a given time.Return a Handle: an opaque object with a cancel() method thatcan be used to cancel the call.The delay can be an int or float, expressed in seconds.  It isalways relative to the current time.Each callback will be called exactly once.  If two callbacksare scheduled for exactly the same time, it undefined whichwill be called first.Any positional arguments after the callback will be passed tothe callback when it is called.</p></blockquote><p>直接看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">args</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;callback: <span class="subst">&#123;args&#125;</span> (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>(<span class="params">loop</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    loop.call_later(<span class="number">0.4</span>, callback, <span class="string">&#x27;second time&#x27;</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;first time&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(loopEvent), my_coroutine(loopEvent)]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br></pre></td></tr></table></figure><h3 id="call_at"><a class="markdownIt-Anchor" href="#call_at"></a> call_at</h3><p><code>call_at(self, when, callback, *args, context=None)</code></p><blockquote><p>Like call_later(), but uses an absolute time.</p><p>Absolute time corresponds to the event loop’s time() method.</p></blockquote><p>call_at第一个参数的含义代表的是一个单调时间，它和我们平时说的系统时间有点差异，</p><p>这里的时间指的是事件循环内部时间，可以通过<code>loop.time()</code>获取，然后可以在此基础上进行操作。后面的参数和前面的两个方法一样。实际上call_later内部就是调用的call_at</p><p>上代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">args</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;callback: <span class="subst">&#123;args&#125;</span> (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>(<span class="params">loop</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    loop.call_at(loop.time() + <span class="number">0.2</span>, callback, <span class="string">&#x27;second time&#x27;</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;first time&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(loopEvent), my_coroutine(loopEvent)]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> 并发编程 </tag>
            
            <tag> Python </tag>
            
            <tag> asyncio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python-yield关键字详解</title>
      <link href="/2021/02/15/Python-yield%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3/"/>
      <url>/2021/02/15/Python-yield%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p><code>yield</code>这个关键字很早的时候就了解过，但一直都只了解其基本使用，即转变函数为生成器的使用，节省大型迭代时的内存空间，但其实<code>yield</code>在python的很多特性中都起着重要的作用</p><p>这篇文章就详细展开一下<code>yield</code>关键字</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li><code>容器（container）</code>：python中容器指一个用来存储多个元素的数据结构，常见的list，tuple，dict，set，string都是容器</li><li><code>可迭代对象（iterable）</code>：在python中能被迭代获取的对象，iterable的对象一定实现了<code>__iter__()</code>方法</li><li><code>迭代器（iterator）</code>：迭代器实现了<code>__iter__()</code>和 <code>__next__()</code>方法，是一个带状态的对象，迭代器内部持有一个状态，该状态用于记录**当前迭代所在位置，**以便于下次迭代的时候获取正确的元素，迭代器可以通过next()方法来迭代获取下一个值</li><li><code>生成器（generator）</code>：生成器是一种特殊的迭代器，特殊在我们可以通过send()方法向生成器中传入数据，而迭代器只能将数据输出</li><li><code>协程（coroutine）</code>：与<strong>线程</strong>很相似，不同之处在于多协程是同一个线程来执行的，这样就省去了线程切换的时间，而且不需要多线程的锁机制了，执行效率高很多</li></ul><h2 id="可迭代对象迭代器与生成器的关系"><a class="markdownIt-Anchor" href="#可迭代对象迭代器与生成器的关系"></a> 可迭代对象，迭代器与生成器的关系</h2><p>简单来说可以用以下的韦恩图表示：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/iterable.png" alt="ii" /></p><p>从设计角度讲，容器是我们最常见最常用的数据结构，它们都是可迭代对象，而另一方面我们也可以在自定义类中实现<code>__iter__()</code>方法将该类的对象变成可迭代的</p><p>但这样的迭代有一个缺点，当一次迭代的内容过多时，会占用大量内存；这时迭代器就出现了，其实现了<code>__next__()</code>方法，在每个单次迭代中记录位置，每次返回一个值来进行完整的迭代，实现一种惰性的获取数据的方式；这样就不需要一次性把所有内容加载到内存，而是在需要的时候返回单个结果</p><p>生成器是一种特殊的迭代器，可以通过生成器函数和生成器表达式来创建生成器，其自带了<code>__iter__()</code>和<code>__next__()</code>方法，通过创建生成器来创建迭代器可以让我们更专注于业务逻辑的实现；此外其还实现了send()方法，可以往生成器函数中传值，赋给yield关键字的左值</p><h2 id="生成器中的yield"><a class="markdownIt-Anchor" href="#生成器中的yield"></a> 生成器中的yield</h2><p>在一个函数中使用yield关键字，这个函数就变成了生成器函数，看一个经典的输出斐波那契数列实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params"><span class="built_in">max</span></span>):</span></span><br><span class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="built_in">max</span>:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;done&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> fib(<span class="number">1000</span>):</span><br><span class="line">    print(num)</span><br></pre></td></tr></table></figure><p>非常优雅地就可以实现斐波那契数列的输出，并且在进行for循环时每次只占用一个数的内存</p><p>但使用for循环进行迭代我们无法获取到生成器函数的返回值（生成器结束迭代时会抛出<code>StopIteration</code>异常，但这个异常被for循环捕获并pass了）；想要获取返回值我们需要抛弃for循环，自己来捕获异常：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">g = fib(<span class="number">6</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">     <span class="keyword">try</span>:</span><br><span class="line">         x = <span class="built_in">next</span>(g)</span><br><span class="line">         print(<span class="string">&#x27;g:&#x27;</span>, x)</span><br><span class="line">     <span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</span><br><span class="line">         print(<span class="string">&#x27;Generator return value:&#x27;</span>, e.value)</span><br><span class="line">         <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="协程中的yield"><a class="markdownIt-Anchor" href="#协程中的yield"></a> 协程中的yield</h2><p>Python对协程的支持是通过generator实现的，在一般的generator使用中，我们不但可以通过<code>for</code>循环来迭代，还可以不断调用<code>next()</code>函数获取由<code>yield</code>语句返回的下一个值；但在生成器中我们还可以通过send向生成器函数中传值；到这里我们就可以拿出经典的生产者-消费者模型来看看了：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span>():</span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        product = <span class="keyword">yield</span> res</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> product:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        print(<span class="string">&#x27;[CONSUMER] Consuming %s...&#x27;</span> % product)</span><br><span class="line">        res = <span class="string">&#x27;200 OK&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">produce</span>(<span class="params">c</span>):</span></span><br><span class="line">    c.send(<span class="literal">None</span>)</span><br><span class="line">    product = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> product &lt; <span class="number">5</span>:</span><br><span class="line">        product += <span class="number">1</span></span><br><span class="line">        print(<span class="string">&#x27;[PRODUCER] Producing %s...&#x27;</span> % product)</span><br><span class="line">        r = c.send(product)</span><br><span class="line">        print(<span class="string">&#x27;[PRODUCER] Consumer return: %s&#x27;</span> % r)</span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line">c = consumer()</span><br><span class="line">produce(c)</span><br></pre></td></tr></table></figure><p>注意到<code>consumer</code>函数是一个<code>generator</code>，把一个<code>consumer</code>传入<code>produce</code>后：</p><ol><li>首先调用<code>c.send(None)</code>启动生成器；</li><li>然后，一旦生产了东西，通过<code>c.send(n)</code>切换到<code>consumer</code>执行；</li><li><code>consumer</code>通过<code>yield</code>拿到消息，处理，又通过<code>yield</code>把结果传回；</li><li><code>produce</code>拿到<code>consumer</code>处理的结果，继续生产下一条消息；</li><li><code>produce</code>决定不生产了，通过<code>c.close()</code>关闭<code>consumer</code>，整个过程结束。</li></ol><p>整个流程无锁，由一个线程执行，<code>produce</code>和<code>consumer</code>协作完成任务，所以称为“协程”，而非线程的抢占式多任务</p><p>如果没有协程，我们在写一个并发业务时会遇到以下问题：</p><ul><li>使用最常规的同步编程要实现异步并发效果并不理想，或者难度极高</li><li>由于GIL锁的存在，多线程的运行需要频繁的加锁解锁，<strong>切换线程</strong>，这极大地降低了并发性能</li></ul><p>而有了协程，我们就可以非常优雅高性能地实现一些<strong>高IO</strong>的并发任务了</p><h2 id="yield-from"><a class="markdownIt-Anchor" href="#yield-from"></a> yield from</h2><p><code>yield from</code> 是<code>Python 3.3</code>中才出现的语法，所以这个特性在<code>Python 2</code>中是没有的，<code>yield from</code>语法可以让我们方便地调用另一个<code>generator</code></p><p><code>yield from</code> 后面需要加的是可迭代对象，它可以是普通的可迭代对象，也可以是迭代器或生成器（不记得关系了的可以往上翻一翻）</p><h3 id="应用一拼接可迭代对象"><a class="markdownIt-Anchor" href="#应用一拼接可迭代对象"></a> 应用一：拼接可迭代对象</h3><p>我们可以用一个使用<code>yield</code>和一个使用<code>yield from</code>的例子来对比看</p><p>使用<code>yield</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字符串</span></span><br><span class="line">astr = <span class="string">&#x27;ABC&#x27;</span></span><br><span class="line"><span class="comment"># 列表</span></span><br><span class="line">alist = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="comment"># 字典</span></span><br><span class="line">adict = &#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;wangbm&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>&#125;</span><br><span class="line"><span class="comment"># 生成器（生成器表达式）</span></span><br><span class="line">agen = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> args:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> item:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">new_list = gen(astr, alist, adict， agen)</span><br><span class="line">print(<span class="built_in">list</span>(new_list))</span><br><span class="line"><span class="comment"># [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, 1, 2, 3, &#x27;name&#x27;, &#x27;age&#x27;, 4, 5, 6, 7]</span></span><br></pre></td></tr></table></figure><p>使用<code>yield from</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字符串</span></span><br><span class="line">astr = <span class="string">&#x27;ABC&#x27;</span></span><br><span class="line"><span class="comment"># 列表</span></span><br><span class="line">alist = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="comment"># 字典</span></span><br><span class="line">adict = &#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;wangbm&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>&#125;</span><br><span class="line"><span class="comment"># 生成器</span></span><br><span class="line">agen = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> args:</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> item</span><br><span class="line"></span><br><span class="line">new_list = gen(astr, alist, adict, agen)</span><br><span class="line">print(<span class="built_in">list</span>(new_list))</span><br><span class="line"><span class="comment"># [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, 1, 2, 3, &#x27;name&#x27;, &#x27;age&#x27;, 4, 5, 6, 7]</span></span><br></pre></td></tr></table></figure><p>由上面两种方式的对比，可以看出，yield from后面加上可迭代对象，他可以把可迭代对象里的每个元素一个一个的yield出来，对比yield来说代码更加简洁，结构更加清晰</p><h3 id="应用二生成器的嵌套"><a class="markdownIt-Anchor" href="#应用二生成器的嵌套"></a> 应用二：生成器的嵌套</h3><p>上面的只是<code>yield from</code>很简单的一个应用，它真正的作用并不在此；当 <code>yield from</code> 后面加上一个生成器后，就实现了生成器的嵌套</p><p>当然实现生成器的嵌套，并不是一定必须要使用<code>yield from</code>，而是使用<code>yield from</code>可以让我们避免让我们自己处理各种料想不到的异常，而让我们专注于业务代码的实现</p><p>如果自己用<code>yield</code>去实现，那只会加大代码的编写难度，降低开发效率，降低代码的可读性。既然Python已经想得这么周到，我们当然要好好利用起来</p><p>讲解它之前，首先要知道这个几个概念</p><ul><li><code>预激活</code>：通过<code>next()</code>方法或<code>send(None)</code>方法使生成器第一次停在<code>yield</code>关键字处，状态由<code>GEN_CREATED</code>变为<code>GEN_SUSPENDED</code></li><li><code>调用方</code>：调用委派生成器的客户端（调用方）代码</li><li><code>委托生成器</code>：包含<code>yield from</code>表达式的生成器函数</li><li><code>子生成器</code>：<code>yield from</code>后面加的生成器函数</li></ul><p>直接看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> getgeneratorstate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子生成器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">average_gen</span>():</span></span><br><span class="line">    total, count, average = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        new_num = <span class="keyword">yield</span> average</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> new_num:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        total += new_num</span><br><span class="line">        average = total / count</span><br><span class="line">    <span class="comment"># return 意味着当前协程结束</span></span><br><span class="line">    <span class="keyword">return</span> total, count, average</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 委托生成器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proxy_gen</span>():</span></span><br><span class="line">    <span class="comment"># 当前协程结束后，进入新的协程并在new_num = yield average处暂停返回给调用方（yield from对子生成器进行预激活）</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sub_coroutine = average_gen()</span><br><span class="line">        print(getgeneratorstate(sub_coroutine))  <span class="comment"># GEN_CREATED，还未预激活，yield from会进行预激活，使子生成器状态变为GEN_SUSPENDED</span></span><br><span class="line">        total, count, average = <span class="keyword">yield</span> <span class="keyword">from</span> sub_coroutine  <span class="comment"># 这里yield from处理了子生成器return时产生的StopIteration Error</span></span><br><span class="line">        print(<span class="string">&#x27;sub_coroutine close, stat: &#123;&#125;; total, count, average: &#123;&#125;, &#123;&#125;, &#123;&#125;&#x27;</span></span><br><span class="line">              .<span class="built_in">format</span>(getgeneratorstate(sub_coroutine), total, count, average))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用方</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    calc_average = proxy_gen()  <span class="comment"># 创建委托生成器</span></span><br><span class="line">    <span class="built_in">next</span>(calc_average)  <span class="comment"># 预激活委托生成器</span></span><br><span class="line">    </span><br><span class="line">    print(calc_average.send(<span class="number">10</span>))  <span class="comment"># 打印：10.0</span></span><br><span class="line">    print(calc_average.send(<span class="number">20</span>))  <span class="comment"># 打印：15.0</span></span><br><span class="line">    print(calc_average.send(<span class="number">30</span>))  <span class="comment"># 打印：20.0</span></span><br><span class="line">    calc_average.send(<span class="literal">None</span>)  <span class="comment"># 在子生成器中return，触发StopIteration Error结束当前协程</span></span><br><span class="line"></span><br><span class="line">    print(calc_average.send(<span class="number">20</span>))</span><br><span class="line">    print(calc_average.send(<span class="number">50</span>))</span><br><span class="line">    print(calc_average.send(<span class="number">70</span>))</span><br><span class="line">    print(calc_average.send(<span class="number">40</span>))</span><br><span class="line">    calc_average.send(<span class="literal">None</span>)</span><br><span class="line">    calc_average.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GEN_CREATED</span><br><span class="line">10.0</span><br><span class="line">15.0</span><br><span class="line">20.0</span><br><span class="line">sub_coroutine close, stat: GEN_CLOSED; total, count, average: 60, 3, 20.0</span><br><span class="line">GEN_CREATED</span><br><span class="line">20.0</span><br><span class="line">35.0</span><br><span class="line">46.666666666666664</span><br><span class="line">sub_coroutine close, stat: GEN_CLOSED; total, count, average: 140, 3, 46.666666666666664</span><br><span class="line">GEN_CREATED</span><br></pre></td></tr></table></figure><p>上面是一个实时计算平均值的实现，流程这里就不展开讲了，仔细看的都看得清楚，讲一下值得注意的几个点（结合注释）：</p><ul><li><code>inspect.getgeneratorstate</code>方法可以获取生成器的状态</li><li><code>yield from</code>会对子生成器进行预激活</li><li>委托生成器只起一个桥梁作用，它建立的是一个<code>双向通道</code>，它并没有权利也没有办法，对子生成器yield回来的内容做拦截</li><li><code>yield from</code>会帮我们处理子生成器的所有异常（不只是最常见的<code>StopIteration</code>）</li></ul><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p><code>yield</code>关键字在Python中可以说很重要了，很多地方的实现都是使用它，尤其在并发编程中，协程的实现也让我们的开发优雅简洁了不少</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> 并发编程 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python日志管理</title>
      <link href="/2021/02/08/Python%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/"/>
      <url>/2021/02/08/Python%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>一个长时间运行的项目，不管是从可维护性还是其他角度来说，日志管理都是必不可少的（我相信还有不少同学是直接输出日志到控制台的吧），将日志输出到日志文件中，不仅方便我们查看程序运行时的情况，也可以让我们在项目出现故障时根据运行时产生的日志快速定位问题出现的位置</p><h2 id="需要了解的词"><a class="markdownIt-Anchor" href="#需要了解的词"></a> 需要了解的词</h2><ul><li>单例模式：<strong>单例模式</strong>，也叫<strong>单子模式</strong>，是一种常用的<a href="https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">软件设计模式</a>，属于创建型模式的一种。在应用这个模式时，单例对象的<a href="https://zh.wikipedia.org/wiki/%E7%B1%BB_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">类</a>必须保证只有一个实例存在。许多时候整个系统只需要拥有一个的全局<a href="https://zh.wikipedia.org/wiki/%E5%AF%B9%E8%B1%A1">对象</a>，这样有利于我们协调系统整体的行为（<a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F">Wiki百科</a>），我在另一篇文章里写了Go单例模式的实现：<a href="https://kevinello.ltd/2021/02/07/Go%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">Go单例模式</a></li><li>好像暂时没有了，这篇文章很简单</li></ul><h2 id="日志级别"><a class="markdownIt-Anchor" href="#日志级别"></a> 日志级别</h2><p>Python 标准库 logging 用作记录日志，默认分为六种日志级别（括号为级别对应的数值），NOTSET（0）、DEBUG（10）、INFO（20）、WARNING（30）、ERROR（40）、CRITICAL（50）；如果需要自定义日志级别时注意不要和默认的日志级别数值相同，logging 执行时输出大于等于设置的日志级别的日志信息（不重要的不归我管），如设置日志级别是 INFO，则 INFO、WARNING、ERROR、CRITICAL 级别的日志都会输出</p><h2 id="日志输出流程"><a class="markdownIt-Anchor" href="#日志输出流程"></a> 日志输出流程</h2><p>logging输出日志的流程图如下：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210208160316.png" alt="" /></p><p>我们可以看到流程图中主要的控制类型有这几个：<strong>Logger</strong>、<strong>LogRecord</strong>、<strong>Filter</strong>、<strong>Handler</strong>、<strong>Formatter</strong></p><ul><li><strong>Logger</strong>：日志，暴露函数给应用程序，基于日志记录器和过滤器级别决定哪些日志有效</li><li><strong>LogRecord</strong> ：日志记录器，将日志传到相应的处理器处理</li><li><strong>Handler</strong> ：处理器, 将(日志记录器产生的)日志记录发送至合适的目的地</li><li><strong>Filter</strong> ：过滤器, 提供了更好的粒度控制,它可以决定输出哪些日志记录</li><li><strong>Formatter</strong>：格式化器, 指明了最终输出中日志记录的布局</li></ul><p>代码中的一次日志输出流程为：</p><ol><li>判断 Logger 对象对于设置的级别是否可用，如果可用，则往下执行，否则，流程结束</li><li>创建 LogRecord 对象，如果注册到 Logger 对象中的 Filter 对象过滤后返回 False，则不记录日志，流程结束，否则，则向下执行</li><li>LogRecord 对象将 Handler 对象传入当前的 Logger 对象（图中的子流程），如果 Handler 对象的日志级别大于设置的日志级别，再判断注册到 Handler 对象中的 Filter 对象过滤后是否返回 True 而放行输出日志信息，否则不放行，流程结束</li><li>如果传入的 Handler 大于 Logger 中设置的级别，也即 Handler 有效，则往下执行，否则，流程结束</li><li>判断这个 Logger 对象是否还有父 Logger 对象，如果没有（代表当前 Logger 对象是最顶层的 Logger 对象 root Logger），流程结束。否则将 Logger 对象设置为它的父 Logger 对象，重复上面的 3、4 两步，输出父类 Logger 对象中的日志输出，直到是 root Logger 为止</li></ol><h2 id="实际使用"><a class="markdownIt-Anchor" href="#实际使用"></a> 实际使用</h2><h3 id="硬编码方式配置logging"><a class="markdownIt-Anchor" href="#硬编码方式配置logging"></a> 硬编码方式配置logging</h3><h4 id="使用basicconfig方法"><a class="markdownIt-Anchor" href="#使用basicconfig方法"></a> 使用<code>basicConfig()</code>方法</h4><p>最简单的方式是直接使用<code>logging.basicConfig()</code>方法默认配置日志，可以满足基本使用，如果方法没有传入参数，会根据默认的配置创建Logger 对象，默认的日志级别被设置为 <strong>WARNING</strong>，下表为<code>basicConfig()</code>的可选参数：</p><table><thead><tr><th>Args</th><th>Statement</th></tr></thead><tbody><tr><td>filename</td><td>Specifies that a FileHandler be created, using the specified filename, rather than a StreamHandler.</td></tr><tr><td>filemode</td><td>Specifies the mode to open the file, if filename is specified (if filemode is unspecified, it defaults to ‘a’.</td></tr><tr><td>format</td><td>Use the specified format string for the handler.</td></tr><tr><td>datefmt</td><td>Use the specified date/time format.</td></tr><tr><td>style</td><td>If a format string is specified, use this to specify the type of format string (possible values ‘%’, ‘{’, ‘$’, for %-formatting, :meth:<code>str.format</code> and :class:<code>string.Template</code> - defaults to ‘%’).</td></tr><tr><td>level</td><td>Set the root logger level to the specified level.</td></tr><tr><td>stream</td><td>Use the specified stream to initialize the StreamHandler. Note that this argument is incompatible with ‘filename’ - if both are present, ‘stream’ is ignored.</td></tr><tr><td>handlers</td><td>If specified, this should be an iterable of already created handlers, which will be added to the root handler. Any handler in the list which does not have a formatter assigned will be assigned the formatter created in this function.</td></tr><tr><td>force</td><td>If this keyword  is specified as true, any existing handlers attached to the root logger are removed and closed, before carrying out the configuration as specified by the other arguments.</td></tr></tbody></table><p>示例代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig()</span><br><span class="line">logging.debug(<span class="string">&#x27;This is a debug message&#x27;</span>)</span><br><span class="line">logging.info(<span class="string">&#x27;This is an info message&#x27;</span>)</span><br><span class="line">logging.warning(<span class="string">&#x27;This is a warning message&#x27;</span>)</span><br><span class="line">logging.error(<span class="string">&#x27;This is an error message&#x27;</span>)</span><br><span class="line">logging.critical(<span class="string">&#x27;This is a critical message&#x27;</span>)</span><br></pre></td></tr></table></figure><p>输出结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WARNING:root:This is a warning message</span><br><span class="line">ERROR:root:This is an error message</span><br><span class="line">CRITICAL:root:This is a critical message</span><br></pre></td></tr></table></figure><p>传入常用的参数，示例代码如下（这里日志格式占位符中的变量放到后面介绍）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(filename=<span class="string">&quot;test.log&quot;</span>, filemode=<span class="string">&quot;w&quot;</span>, <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(name)s:%(levelname)s:%(message)s&quot;</span>, datefmt=<span class="string">&quot;%d-%m-%Y %H:%M:%S&quot;</span>, level=logging.DEBUG)</span><br><span class="line">logging.debug(<span class="string">&#x27;This is a debug message&#x27;</span>)</span><br><span class="line">logging.info(<span class="string">&#x27;This is an info message&#x27;</span>)</span><br><span class="line">logging.warning(<span class="string">&#x27;This is a warning message&#x27;</span>)</span><br><span class="line">logging.error(<span class="string">&#x27;This is an error message&#x27;</span>)</span><br><span class="line">logging.critical(<span class="string">&#x27;This is a critical message&#x27;</span>)</span><br></pre></td></tr></table></figure><p>生成的日志文件 test.log ，内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">13-10-18 21:10:32 root:DEBUG:This is a debug message</span><br><span class="line">13-10-18 21:10:32 root:INFO:This is an info message</span><br><span class="line">13-10-18 21:10:32 root:WARNING:This is a warning message</span><br><span class="line">13-10-18 21:10:32 root:ERROR:This is an error message</span><br><span class="line">13-10-18 21:10:32 root:CRITICAL:This is a critical message</span><br></pre></td></tr></table></figure><p>但是当发生异常时，直接使用无参数的 debug()、info()、warning()、error()、critical() 方法并不能记录异常信息，需要设置 exc_info 参数为 True 才可以，或者使用 exception() 方法，还可以使用 log() 方法，但还要设置日志级别和 exc_info 参数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(filename=<span class="string">&quot;test.log&quot;</span>, filemode=<span class="string">&quot;w&quot;</span>, <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(name)s:%(levelname)s:%(message)s&quot;</span>, datefmt=<span class="string">&quot;%d-%m-%Y %H:%M:%S&quot;</span>, level=logging.DEBUG)</span><br><span class="line">a = <span class="number">5</span></span><br><span class="line">b = <span class="number">0</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    c = a / b</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 下面三种方式三选一，推荐使用第一种</span></span><br><span class="line">    logging.exception(<span class="string">&quot;Exception occurred&quot;</span>)</span><br><span class="line">    logging.error(<span class="string">&quot;Exception occurred&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">    logging.log(level=logging.DEBUG, msg=<span class="string">&quot;Exception occurred&quot;</span>, exc_info=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h4 id="自定义logger"><a class="markdownIt-Anchor" href="#自定义logger"></a> 自定义<code>Logger</code></h4><p><code>basicConfig()</code>方法只能用于简单日志管理，在多等级多模块的大型项目中并不足以满足我们的需求，这时我们就需要自定义<code>Logger</code>了一个系统只有一个 Logger 对象，并且该对象不能被直接实例化，没错，这里用到了单例模式，获取 Logger 对象的方法为 <strong>getLogger</strong>。</p><p>注意：这里的单例模式并不是说只有一个 Logger 对象，而是指整个系统只有一个根 Logger 对象，Logger 对象在执行 info()、error() 等方法时实际上调用都是根 Logger 对象对应的 info()、error() 等方法。</p><p>我们可以创造多个 Logger 对象，但是真正输出日志的是根 Logger 对象。每个 Logger 对象都可以设置一个名字，如果设置<code>logger = logging.getLogger(__name__)</code>，<strong>name</strong> 是 Python 中的一个特殊内置变量，他代表当前模块的名称（默认为 <strong>main</strong>）。则 Logger 对象的 name 为建议使用使用以点号作为分隔符的命名空间等级制度。</p><p>Logger 对象可以设置多个 Handler 对象和 Filter 对象，Handler 对象又可以设置 Formatter 对象。Formatter 对象用来设置具体的输出格式，常用变量格式如下表所示，所有参数见 <a href="https://docs.python.org/3.7/library/logging.html#logrecord-attributes">Python(3.7)官方文档</a>：</p><table><thead><tr><th>format</th><th>statement</th></tr></thead><tbody><tr><td>%(name)s</td><td>Name of the logger (logging channel)</td></tr><tr><td>%(levelno)s</td><td>Numeric logging level for the message (DEBUG, INFO, WARNING, ERROR, CRITICAL)</td></tr><tr><td>%(levelname)s</td><td>Text logging level for the message (“DEBUG”, “INFO”, “WARNING”, “ERROR”, “CRITICAL”)</td></tr><tr><td>%(pathname)s</td><td>Full pathname of the source file where the logging call was issued (if available)</td></tr><tr><td>%(filename)s</td><td>Filename portion of pathname</td></tr><tr><td>%(module)s</td><td>Module (name portion of filename)</td></tr><tr><td>%(lineno)d</td><td>Source line number where the logging call was issued (if available)</td></tr><tr><td>%(funcName)s</td><td>Function name</td></tr><tr><td>%(created)f</td><td>Time when the LogRecord was created (time.time() return value)</td></tr><tr><td>%(asctime)s</td><td>Textual time when the LogRecord was created</td></tr><tr><td>%(msecs)d</td><td>Millisecond portion of the creation time</td></tr><tr><td>%(relativeCreated)d</td><td>Time in milliseconds when the LogRecord was created, relative to the time the logging module was loaded (typically at application startup time)</td></tr><tr><td>%(thread)d</td><td>Thread ID (if available)</td></tr><tr><td>%(threadName)s</td><td>Thread name (if available)</td></tr><tr><td>%(process)d</td><td>Process ID (if available)</td></tr><tr><td>%(message)s</td><td>The result of record.getMessage(), computed just as the record is emitted</td></tr></tbody></table><p>Logger 对象和 Handler 对象都可以设置级别，而默认 Logger 对象级别为 30 ，也即 WARNING，默认 Handler 对象级别为 0，也即 NOTSET。logging 模块这样设计是为了更好的灵活性，比如有时候我们既想在控制台中输出DEBUG 级别的日志，又想在文件中输出WARNING级别的日志。可以只设置一个最低级别的 Logger 对象，两个不同级别的 Handler 对象，示例代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;logger&quot;</span>)</span><br><span class="line"></span><br><span class="line">handler1 = logging.StreamHandler()</span><br><span class="line">handler2 = logging.FileHandler(filename=<span class="string">&quot;test.log&quot;</span>)</span><br><span class="line"></span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line">handler1.setLevel(logging.WARNING)</span><br><span class="line">handler2.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">formatter = logging.Formatter(<span class="string">&quot;%(asctime)s %(name)s %(levelname)s %(message)s&quot;</span>)</span><br><span class="line">handler1.setFormatter(formatter)</span><br><span class="line">handler2.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">logger.addHandler(handler1)</span><br><span class="line">logger.addHandler(handler2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别为 10、30、30</span></span><br><span class="line"><span class="comment"># print(handler1.level)</span></span><br><span class="line"><span class="comment"># print(handler2.level)</span></span><br><span class="line"><span class="comment"># print(logger.level)</span></span><br><span class="line"></span><br><span class="line">logger.debug(<span class="string">&#x27;This is a customer debug message&#x27;</span>)</span><br><span class="line">logger.info(<span class="string">&#x27;This is an customer info message&#x27;</span>)</span><br><span class="line">logger.warning(<span class="string">&#x27;This is a customer warning message&#x27;</span>)</span><br><span class="line">logger.error(<span class="string">&#x27;This is an customer error message&#x27;</span>)</span><br><span class="line">logger.critical(<span class="string">&#x27;This is a customer critical message&#x27;</span>)</span><br></pre></td></tr></table></figure><p>控制台输出结果为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-10-13 23:24:57,832 logger WARNING This is a customer warning message</span><br><span class="line">2018-10-13 23:24:57,832 logger ERROR This is an customer error message</span><br><span class="line">2018-10-13 23:24:57,832 logger CRITICAL This is a customer critical message</span><br></pre></td></tr></table></figure><p>文件中输出内容为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-10-13 23:44:59,817 logger DEBUG This is a customer debug message</span><br><span class="line">2018-10-13 23:44:59,817 logger INFO This is an customer info message</span><br><span class="line">2018-10-13 23:44:59,817 logger WARNING This is a customer warning message</span><br><span class="line">2018-10-13 23:44:59,817 logger ERROR This is an customer error message</span><br><span class="line">2018-10-13 23:44:59,817 logger CRITICAL This is a customer critical message</span><br></pre></td></tr></table></figure><p>创建了自定义的 Logger 对象，就不要再用 logging 中的日志输出方法了，这些方法使用的是默认配置的 Logger 对象，否则会输出的日志信息会重复。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;logger&quot;</span>)</span><br><span class="line">handler = logging.StreamHandler()</span><br><span class="line">handler.setLevel(logging.DEBUG)</span><br><span class="line">formatter = logging.Formatter(<span class="string">&quot;%(asctime)s %(name)s %(levelname)s %(message)s&quot;</span>)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line">logger.debug(<span class="string">&#x27;This is a customer debug message&#x27;</span>)</span><br><span class="line">logging.info(<span class="string">&#x27;This is an customer info message&#x27;</span>)</span><br><span class="line">logger.warning(<span class="string">&#x27;This is a customer warning message&#x27;</span>)</span><br><span class="line">logger.error(<span class="string">&#x27;This is an customer error message&#x27;</span>)</span><br><span class="line">logger.critical(<span class="string">&#x27;This is a customer critical message&#x27;</span>)</span><br></pre></td></tr></table></figure><p>输出结果如下（可以看到日志信息被输出了两遍）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2018-10-13 22:21:35,873 logger WARNING This is a customer warning message</span><br><span class="line">WARNING:logger:This is a customer warning message</span><br><span class="line">2018-10-13 22:21:35,873 logger ERROR This is an customer error message</span><br><span class="line">ERROR:logger:This is an customer error message</span><br><span class="line">2018-10-13 22:21:35,873 logger CRITICAL This is a customer critical message</span><br><span class="line">CRITICAL:logger:This is a customer critical message</span><br></pre></td></tr></table></figure><h4 id="configdictconfig方法"><a class="markdownIt-Anchor" href="#configdictconfig方法"></a> <code>config.dictConfig()</code>方法</h4><p>除了上面比较杂乱的配置方式外，我们还可以采用字典配置的方式：</p><p><strong>从字典中获取配置信息：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;formatters&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;simple&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 其他的 formatter</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;simple&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.FileHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;logging.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;simple&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 其他的 handler</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>:&#123;</span><br><span class="line">        <span class="string">&#x27;StreamLogger&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;FileLogger&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment"># 既有 console Handler，还有 file Handler</span></span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>, <span class="string">&#x27;file&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 其他的 Logger</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging.config.dictConfig(config)</span><br><span class="line">StreamLogger = logging.getLogger(<span class="string">&quot;StreamLogger&quot;</span>)</span><br><span class="line">FileLogger = logging.getLogger(<span class="string">&quot;FileLogger&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="配置文件配置logging"><a class="markdownIt-Anchor" href="#配置文件配置logging"></a> 配置文件配置logging</h3><p>在大型项目中为了安全性及可维护性，配置通常不能采用硬编码的方式，而是需要使用配置文件配置</p><p>常见的配置文件有 ini 格式、yaml 格式、JSON 格式，或者从网络中获取都是可以的，只要有相应的文件解析器解析配置即可，其中ini文件配置不需要安装任何解析包</p><p>test.ini 文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[loggers]</span><br><span class="line">keys&#x3D;root,sampleLogger</span><br><span class="line"></span><br><span class="line">[handlers]</span><br><span class="line">keys&#x3D;consoleHandler</span><br><span class="line"></span><br><span class="line">[formatters]</span><br><span class="line">keys&#x3D;sampleFormatter</span><br><span class="line"></span><br><span class="line">[logger_root]</span><br><span class="line">level&#x3D;DEBUG</span><br><span class="line">handlers&#x3D;consoleHandler</span><br><span class="line"></span><br><span class="line">[logger_sampleLogger]</span><br><span class="line">level&#x3D;DEBUG</span><br><span class="line">handlers&#x3D;consoleHandler</span><br><span class="line">qualname&#x3D;sampleLogger</span><br><span class="line">propagate&#x3D;0</span><br><span class="line"></span><br><span class="line">[handler_consoleHandler]</span><br><span class="line">class&#x3D;StreamHandler</span><br><span class="line">level&#x3D;DEBUG</span><br><span class="line">formatter&#x3D;sampleFormatter</span><br><span class="line">args&#x3D;(sys.stdout,)</span><br><span class="line"></span><br><span class="line">[formatter_sampleFormatter]</span><br><span class="line">format&#x3D;%(asctime)s - %(name)s - %(levelname)s - %(message)s</span><br></pre></td></tr></table></figure><p><a href="http://testinit.py">testinit.py</a> 文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import logging.config</span><br><span class="line"></span><br><span class="line">logging.config.fileConfig(fname&#x3D;&#39;test.ini&#39;, disable_existing_loggers&#x3D;False)</span><br><span class="line">logger &#x3D; logging.getLogger(&quot;sampleLogger&quot;)</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项</h2><h3 id="编码问题"><a class="markdownIt-Anchor" href="#编码问题"></a> 编码问题</h3><p>编码问题永远是最烦人的问题，FileHandler 创建对象时可以设置文件编码，如果将文件编码设置为 “utf-8”（utf-8 和 utf8 等价），就可以解决中文乱码问题啦。一种方法是自定义 Logger 对象，需要写很多配置；另一种方法是使用默认配置方法 basicConfig()，传入 handlers 处理器列表对象，在其中的 handler 设置文件的编码；关键参考代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义 Logger 配置</span></span><br><span class="line">handler = logging.FileHandler(filename=<span class="string">&quot;test.log&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="comment"># 使用默认的 Logger 配置</span></span><br><span class="line">logging.basicConfig(handlers=[logging.FileHandler(<span class="string">&quot;test.log&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)], level=logging.DEBUG)</span><br></pre></td></tr></table></figure><h3 id="临时禁用日志输出"><a class="markdownIt-Anchor" href="#临时禁用日志输出"></a> 临时禁用日志输出</h3><p>有时候我们又不想让日志输出，但在这后又想输出日志；一种方法是在使用默认配置时，给 logging.disabled() 方法传入禁用的日志级别，就可以禁止设置级别以下的日志输出了，另一种方法时在自定义 Logger 时，Logger 对象的 disable 属性设为 True，默认值是 False，也即不禁用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logging.disable(logging.INFO)</span><br><span class="line">logger.disabled &#x3D; True</span><br></pre></td></tr></table></figure><h3 id="日志文件按照时间划分或者按照大小划分"><a class="markdownIt-Anchor" href="#日志文件按照时间划分或者按照大小划分"></a> <strong>日志文件按照时间划分或者按照大小划分</strong></h3><p>如果将日志保存在一个文件中，那么时间一长，或者日志一多，单个日志文件就会很大，既不利于备份，也不利于查看;我们会想到能不能按照时间或者大小对日志文件进行划分呢？答案肯定是可以的，并且还很简单，logging 考虑到了我们这个需求。logging.handlers 文件中提供了 <strong>TimedRotatingFileHandler</strong> 和 <strong>RotatingFileHandler</strong> 类分别可以实现按时间和大小划分。打开这个 handles 文件，可以看到还有其他功能的 Handler 类，它们都继承自基类 <strong>BaseRotatingHandler</strong>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TimedRotatingFileHandler 类构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, filename, when=<span class="string">&#x27;h&#x27;</span>, interval=<span class="number">1</span>, backupCount=<span class="number">0</span>, encoding=<span class="literal">None</span>, delay=<span class="literal">False</span>, utc=<span class="literal">False</span>, atTime=<span class="literal">None</span></span>):</span></span><br><span class="line"><span class="comment"># RotatingFileHandler 类的构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, filename, mode=<span class="string">&#x27;a&#x27;</span>, maxBytes=<span class="number">0</span>, backupCount=<span class="number">0</span>, encoding=<span class="literal">None</span>, delay=<span class="literal">False</span></span>)</span></span><br></pre></td></tr></table></figure><p>示例代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每隔 1000 Byte 划分一个日志文件，备份文件为 3 个</span></span><br><span class="line">file_handler = logging.handlers.RotatingFileHandler(<span class="string">&quot;test.log&quot;</span>, mode=<span class="string">&quot;w&quot;</span>, maxBytes=<span class="number">1000</span>, backupCount=<span class="number">3</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="comment"># 每隔 1小时 划分一个日志文件，interval 是时间间隔，备份文件为 10 个</span></span><br><span class="line">handler2 = logging.handlers.TimedRotatingFileHandler(<span class="string">&quot;test.log&quot;</span>, when=<span class="string">&quot;H&quot;</span>, interval=<span class="number">1</span>, backupCount=<span class="number">10</span>)</span><br></pre></td></tr></table></figure><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>python的logging模块还是非常灵活的，正确使用可以让我们很方便地定位问题和观察项目运行状况（不要再用print输出日志了！！！）</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> Python </tag>
            
            <tag> 日志管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis分布式锁</title>
      <link href="/2021/02/07/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
      <url>/2021/02/07/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>随着分布式系统的普遍运用，分布式锁的重要性也得到了体现</p><p>在单机系统中，我们可以运用普通的锁/信号量机制来实现对公共资源的有序访问；但在分布式系统中显然就不行了</p><p>因此业界常用的解决方案通常是借助于一个第三方组件，利用它自身的排他性来达到多进程的互斥；如：</p><ul><li>基于 DB 的唯一索引</li><li>基于 ZK 的临时有序节点</li><li>基于 Redis 的 <code>NX EX</code> 参数</li></ul><p>本文就主要以Redis分布式锁展开</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li>锁机制：<strong>锁</strong>是在执行<a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E7%BA%BF%E7%A8%8B">多线程</a>时用于强行限制资源访问的<a href="https://zh.wikipedia.org/wiki/%E5%90%8C%E6%AD%A5">同步</a>机制，即用于在<a href="https://zh.wikipedia.org/wiki/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6">并发控制</a>中保证对<a href="https://zh.wikipedia.org/wiki/%E4%BA%92%E6%96%A5">互斥</a>要求的满足（<a href="https://zh.wikipedia.org/wiki/%E9%94%81_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">Wiki百科</a>）</li><li>死锁：死锁是指两个或两个以上的进程在执行过程中，由于竞争资源或者由于彼此通信而造成的一种阻塞的现象，若无外力作用，它们都将无法推进下去。 此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程</li><li>ZK：即ZooKeeper，ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等</li></ul><h2 id="redis分布式锁的基本原理"><a class="markdownIt-Anchor" href="#redis分布式锁的基本原理"></a> Redis分布式锁的基本原理</h2><p>既然是选用了 Redis，那么它就得具有排他性才行；同时它最好也有锁的一些基本特性：</p><ul><li>高性能(加、解锁高性能)</li><li>可以使用阻塞锁与非阻塞锁</li><li>不能出现死锁</li><li>可用性(不能出现节点挂掉后加锁失败)</li></ul><p>这里利用 <code>Redis set key</code> 的 NX 参数来保证在这个 key 不存在的情况下写入成功，并且再加上 EX 参数设置过期时间</p><p>利用以上两个特性可以保证在同一时刻只会有一个进程获得锁，并且不会出现死锁（过期自动删除 key）</p><h3 id="加锁"><a class="markdownIt-Anchor" href="#加锁"></a> 加锁</h3><p>Show me the code:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLock</span><span class="params">(lockName <span class="keyword">string</span>, acquireTimeout time.Duration, lockTimeOut time.Duration)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">code := uuid.NewV4().String()</span><br><span class="line">endTime := util.FwTimer.CalcMillis(time.Now().Add(acquireTimeout))</span><br><span class="line"><span class="keyword">for</span> util.FwTimer.CalcMillis(time.Now()) &lt;= endTime &#123;</span><br><span class="line"><span class="keyword">if</span> success, err := fwRedisClient.SetNX(lockName, code, lockTimeOut).Result(); err != <span class="literal">nil</span> &amp;&amp; err != redis.Nil &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> success &#123;</span><br><span class="line"><span class="keyword">return</span> code, <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> fwRedisClient.TTL(lockName).Val() == <span class="number">-1</span> &#123; <span class="comment">//-2:失效；-1：无过期；</span></span><br><span class="line">fwRedisClient.Expire(lockName, lockTimeOut)</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>加锁很简单，直接setnx，监控下返回值和error就行啦</p><h3 id="解锁"><a class="markdownIt-Anchor" href="#解锁"></a> 解锁</h3><p>到这里我曾经以为解锁也跟加锁一样简单，直接del就完事了，然而并没有那么简单</p><p>如果进程 A 获取了锁设置了超时时间，但是由于执行周期较长导致到了超时时间之后锁就自动释放了。这时进程 B 获取了该锁，然而这时进程 A 执行完了，释放了该锁；这样就会出现进程 A 将进程 B 的锁释放了</p><p>所以最好的方式是在每次解锁时都需要判断锁<strong>是否是自己</strong>的</p><p>这时就需要结合加锁机制一起实现了</p><p>在上面的加锁实现中可以看到设置value为code时同时也返回了这个uuid，这样解锁时我们可以判断get到的值是否与自己的uuid相同，来决定是否解锁，同时 <code>WATCH</code> 锁保证不会错误的释放锁</p><p>Show me the code:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReleaseLock</span><span class="params">(lockName <span class="keyword">string</span>, code <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">txf := <span class="function"><span class="keyword">func</span><span class="params">(tx *redis.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> v, err := tx.Get(lockName).Result(); err != <span class="literal">nil</span> &amp;&amp; err != redis.Nil &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> v == code &#123;</span><br><span class="line">_, err := tx.Pipelined(<span class="function"><span class="keyword">func</span><span class="params">(pipe redis.Pipeliner)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">//count++</span></span><br><span class="line"><span class="comment">//fmt.Println(count)</span></span><br><span class="line">pipe.Del(lockName)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := fwRedisClient.Watch(txf, lockName); err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> err == redis.TxFailedErr &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;watch key is modified, retry to release lock. err:&quot;</span>, err.Error())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;err:&quot;</span>, err.Error())</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样也就能满足锁的四个基本特性了：</p><ul><li>高性能(加、解锁高性能)</li><li>可以使用阻塞锁与非阻塞锁</li><li>不能出现死锁</li><li>可用性(不能出现节点挂掉后加锁失败)</li></ul><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>Redis分布式锁应该是比较简单的分布式锁了，同时本文介绍的也只是redis分布式锁的基本实现，在实际运用场景中还可以使用不同的方式实现<br />同时基本的实现方法也还存在一些问题，无法保证高可用，如：</p><ul><li>超时解锁导致并发业务</li><li>客户端无法等待锁释放</li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> Redis </tag>
            
            <tag> 分布式 </tag>
            
            <tag> 锁机制 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go单例模式</title>
      <link href="/2021/02/07/Go%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
      <url>/2021/02/07/Go%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>近期手上有一些需要定时任务的需求（Go定时任务可以看这一篇：<a href="https://kevinello.ltd/2021/01/26/Go-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%AE%9A%E6%97%B6%E5%99%A8/">Go-并发编程与定时器</a>），而单例模式可以很好的保证定时任务不被重复创建，Go在官方库中也提供了优雅的单例模式实现方式，即sync包中的Once类型</p><p>Once 官方描述 <strong>Once is an object that will perform exactly one action</strong>,即 Once 是一个对象,它提供了保证某个动作只被执行一次功能，最典型的场景就是单例模式</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li>单例模式：<strong>单例模式</strong>，也叫<strong>单子模式</strong>，是一种常用的<a href="https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">软件设计模式</a>，属于创建型模式的一种。在应用这个模式时，单例对象的<a href="https://zh.wikipedia.org/wiki/%E7%B1%BB_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">类</a>必须保证只有一个实例存在。许多时候整个系统只需要拥有一个的全局<a href="https://zh.wikipedia.org/wiki/%E5%AF%B9%E8%B1%A1">对象</a>，这样有利于我们协调系统整体的行为。比如在某个<a href="https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8">服务器</a>程序中，该服务器的配置信息存放在一个<a href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6">文件</a>中，这些配置数据由一个单例对象统一读取，然后服务<a href="https://zh.wikipedia.org/wiki/%E8%BF%9B%E7%A8%8B">进程</a>中的其他对象再通过这个单例对象获取这些配置信息。这种方式简化了在复杂环境下的配置管理（<a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F">Wiki百科</a>）</li><li>Goroutine：<em>Go</em> 程（goroutine）是由Go 运行时管理的轻量级线程。 go f(x, y, z). 会启动一个新的<em>Go</em> 程并执行 f(x, y, z)</li><li>原子操作：指具有原子性的操作，原子性是指<strong>一个操作是不可中断的，要么全部执行成功要么全部执行失败</strong></li><li>可观测性：Go中两个Goroutine之间不具有可观测性，这在并发编程中格外重要，值得注意</li></ul><h2 id="单例模式实例"><a class="markdownIt-Anchor" href="#单例模式实例"></a> 单例模式实例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//检查redis上限任务</span></span><br><span class="line">tickerR := time.NewTicker(time.Second * time.Duration(<span class="number">60</span>*<span class="number">15</span>))</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> tickerR.Stop()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-tickerR.C:</span><br><span class="line"><span class="keyword">if</span> err = GFeatureRedisController.CheckFieldNumLimit(msg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">kutil.Logger.ErrorfWithSpan(&amp;spanNew, <span class="string">&quot;FeatureRedisController.CheckFieldNumLimit error: %s&quot;</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> stop := &lt;-StopChan:</span><br><span class="line"><span class="keyword">if</span> stop &#123;</span><br><span class="line">kutil.Logger.Infof(<span class="string">&quot;shutdown ticker with task CheckFieldNumLimit&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><a href="http://once.Do">once.Do</a> 中的函数只会执行一次，并保证 <a href="http://once.Do">once.Do</a> 返回时，传入Do的函数已经执行完成。（多个 goroutine 同时执行 <a href="http://once.Do">once.Do</a> 的时候，可以保证抢占到 <a href="http://once.Do">once.Do</a> 执行权的 goroutine 执行完 <a href="http://once.Do">once.Do</a> 后，其他 goroutine 才能得到返回 ）</p><h2 id="源码"><a class="markdownIt-Anchor" href="#源码"></a> 源码</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sync</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;sync/atomic&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Once <span class="keyword">struct</span> &#123;</span><br><span class="line">done <span class="keyword">uint32</span></span><br><span class="line">m    Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Once)</span> <span class="title">Do</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> atomic.LoadUint32(&amp;o.done) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// Outlined slow-path to allow inlining of the fast-path.</span></span><br><span class="line">o.doSlow(f)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Once)</span> <span class="title">doSlow</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">o.m.Lock()</span><br><span class="line"><span class="keyword">defer</span> o.m.Unlock()</span><br><span class="line"><span class="keyword">if</span> o.done == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> atomic.StoreUint32(&amp;o.done, <span class="number">1</span>)</span><br><span class="line">f()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>遇事不决读源码，往往都能收获不一样的东西</p><p>这里的三个值得注意的问题：</p><ul><li>Do 方法为什么不直接 o.done == 0 而要使用 atomic.LoadUint32(&amp;o.done) == 0</li><li>为什么 doSlow 方法中直接使用 o.done == 0</li><li>既然已经在临界区内，为什么不直接 o.done = 1， 还需要使用 atomic.StoreUint32(&amp;o.done, 1)</li></ul><p>第一个问题很简单，如果直接 o.done == 0，会导致无法及时观察 doSlow 对 o.done 的值设置。具体原因可以参考 <a href="https://golang.org/ref/mem">Go 的内存模型</a> ，文章中提到：</p><blockquote><p>Programs that modify data being simultaneously accessed by multiple goroutines must serialize such access.</p><p>To serialize access, protect the data with channel operations or other synchronization primitives such as those in the sync and sync/atomic packages.</p></blockquote><p>大意是当一个变量被多个 Goroutine 访问的时候，必须要保证他们是有序的（同步），可以使用 sync 或者 sync/atomic 包来实现。用了 LoadUint32 可以保证 doSlow 设置 o.done 后可以及时的被取到</p><p>再看第二个问题，可以直接使用 o.done == 0 是因为使用了 Mutex 进行了锁操作，o.done == 0 处于锁操作的临界区中，所以可以直接进行比较</p><p>那么第三个问题呢？ atomic.StoreUint32(&amp;o.done, 1) 也处于临界区，为什么不直接通过 o.done = 1 进行赋值？这其实还是和内存模式有关；<strong>Mutex 只能保证临界区内的操作是可观测的</strong> 即只有处于o.m.Lock() 和 defer o.m.Unlock()之间的代码对 o.done 的值是可观测的；也就是说 Do函数 中对 o.done 访问就无法及时观测到，因此需要使用 StoreUint32 保证原子性，这样才不会出现一个Goroutine内已经o.done置一了，另一个Goroutine内判断if o.done == 0时因为没有及时观测到o.done已经被置一了而继续调用f函数的情况</p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>Go的单例模式的实现其实很优雅简单，但我们可以深究源码，深入了解到Go并发编程的一些相关知识</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> 后端 </tag>
            
            <tag> 并发编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis的过期策略&amp;内存淘汰策略</title>
      <link href="/2021/02/06/Redis%E7%9A%84%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5-%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/"/>
      <url>/2021/02/06/Redis%E7%9A%84%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5-%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>Redis作为当下最受欢迎的NoSQL数据库之一，在很多场景下都会使用到；Redis的存储分为内存存储、磁盘存储和log文件三部分，重启后，Redis可以从磁盘重新将数据加载到内存中，这些可以通过配置文件对其进行配置，正因为这样，Redis才能实现持久化</p><p>而内存存储向来都离不开内存管理的问题，本文就从Redis的内存过期策略和内存淘汰机制展开来讲</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li>LRU：LRU是Least Recently Used的缩写，即最久没有访问的内容作为替换对象，是一种常用的<a href="https://zh.wikipedia.org/wiki/%E5%BF%AB%E5%8F%96%E6%96%87%E4%BB%B6%E7%BD%AE%E6%8F%9B%E6%A9%9F%E5%88%B6">页面置换算法</a>，其它常见的还有FIFO、LFU、NMRU等；值得一提的是，Redis中的LRU实现与常规的LRU并不相同，我在以后的文章中可能会总结（咕咕咕）</li><li>定时器：这里的定时器指通过各种方式（如管道）实现的定时任务触发器，Go中的定时器可见我的另一篇文章：<a href="https://zh.wikipedia.org/wiki/%E5%BF%AB%E5%8F%96%E6%96%87%E4%BB%B6%E7%BD%AE%E6%8F%9B%E6%A9%9F%E5%88%B60">Go 并发编程与定时器</a></li><li>持久化存储：一般对比于缓存存储，即cache-only模式，此模式下若服务停止 / 停机，则会造成数据丢失；而持久化存储则会为内存中的数据持久备份到磁盘文件，在服务重启后可以恢复，此模式下数据相对安全</li></ul><h2 id="内存过期策略"><a class="markdownIt-Anchor" href="#内存过期策略"></a> 内存过期策略</h2><p>内存过期策略主要的作用就是，在缓存过期之后，能够及时的将失效的缓存从内存中删除，以减少内存的无效暂用，达到释放内存的目的</p><h3 id="过期策略分类"><a class="markdownIt-Anchor" href="#过期策略分类"></a> 过期策略分类</h3><p>Redis内存过期策略分为三类，定时策略、惰性策略和定期策略</p><h3 id="定时策略"><a class="markdownIt-Anchor" href="#定时策略"></a> 定时策略</h3><p>含义：在设置key的过期时间的同时，为该key创建一个定时器，让定时器在key的过期时间来临时，对key进行删除</p><p>优点：保证内存被尽快释放，减少无效的缓存暂用内存</p><p>缺点：若过期key很多，删除这些key会占用很多的CPU时间，在CPU时间紧张的情况下，CPU不能把所有的时间用来做要紧的事儿，还需要去花时间删除这些key；定时器的创建耗时，若为每一个设置过期时间的key创建一个定时器（将会有大量的定时器产生），性能影响严重，所以一般来说不会选择该策略模式<br /><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/redis%E5%86%85%E5%AD%98%E8%BF%87%E6%9C%9F%E5%AE%9A%E6%97%B6%E7%AD%96%E7%95%A5.jpg" alt="定时策略" /></p><h3 id="惰性策略"><a class="markdownIt-Anchor" href="#惰性策略"></a> 惰性策略</h3><p>含义：key过期的时候不删除，每次从数据库获取key的时候去检查是否过期，若过期，则删除，返回null。</p><p>优点：删除操作只发生在从数据库取出key的时候发生，而且只删除当前key，所以对CPU时间的占用是比较少的，而且此时的删除是已经到了非做不可的地步（如果此时还不删除的话，我们就会获取到了已经过期的key了）。</p><p>缺点：若大量的key在超出超时时间后，很久一段时间内，都没有被获取过，此时的无效缓存是永久暂用在内存中的，那么可能发生内存泄露（无用的垃圾占用了大量的内存）<br /><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/redis%E5%86%85%E5%AD%98%E8%BF%87%E6%9C%9F%E6%83%B0%E6%80%A7%E7%AD%96%E7%95%A5.jpg" alt="惰性策略" /></p><h3 id="定期策略"><a class="markdownIt-Anchor" href="#定期策略"></a> 定期策略</h3><p>含义：每隔一段时间对设置了缓存时间的key进行检测，如果可以已经失效，则从内存中删除，如果未失效，则不作任何处理。</p><p>优点：通过限制删除操作的时长和频率，来减少删除操作对CPU时间的占用–处理&quot;定时删除&quot;的缺点<br />定期删除过期key–处理&quot;惰性删除&quot;的缺点。</p><p>缺点:在内存友好方面，不如&quot;定时删除&quot;，因为是随机遍历一些key，因此存在部分key过期，但遍历key时，没有被遍历到，过期的key仍在内存中。在CPU时间友好方面，不如&quot;惰性删除&quot;，定期删除也会暂用CPU性能消耗。</p><p>难点:合理设置删除操作的执行时长（每次删除执行多长时间）和执行频率（每隔多长时间做一次删除）（这个要根据服务器运行情况和实际需求来决定）</p><p>该方式不会遍历所有的key，而是随机抽取一些key做过期检测</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/redis%E5%86%85%E5%AD%98%E8%BF%87%E6%9C%9F%E5%AE%9A%E6%9C%9F%E7%AD%96%E7%95%A5.jpg" alt="" /></p><h3 id="策略注意事项"><a class="markdownIt-Anchor" href="#策略注意事项"></a> 策略注意事项</h3><h4 id="过期策略对持久化存储的影响"><a class="markdownIt-Anchor" href="#过期策略对持久化存储的影响"></a> 过期策略对持久化存储的影响</h4><p>持久化存储，指的是将内存的缓存永久存在磁盘中。也就是说我们的AOF和RDB持久化存储方式。因为该两种方式，将内存中的数据写入磁盘，这时候就需要考虑到我们过期的缓存是否会被写入到磁盘中？如果写入磁盘又是怎么处理的？</p><h5 id="rdb持久化"><a class="markdownIt-Anchor" href="#rdb持久化"></a> RDB持久化</h5><p>持久化key之前，会检查是否过期，过期的key不进入RDB文件</p><p>数据载入数据库之前，会对key先进行过期检查，如果过期，不导入数据库（主库情况）</p><h5 id="aof持久化"><a class="markdownIt-Anchor" href="#aof持久化"></a> AOF持久化</h5><p>当key过期后，还没有被删除，此时进行执行持久化操作（该key是不会进入aof文件的，因为没有发生修改命令）</p><p>当key过期后，在发生删除操作时，程序会向aof文件追加一条del命令（在将来的以aof文件恢复数据的时候该过期的键就会被删掉）</p><blockquote><p>因为AOF方式，向存储文件追加的是Redis的操作命令，而不是具体的数据，然而RDB确是存储的安全的二进制内容</p></blockquote><p>重写时，会先判断key是否过期，已过期的key不会重写到aof文件</p><blockquote><p>即使在重写时，不验证是否过期，然而追加了del命令，测试无效的key同样会被删除。判断的情况是为了防止没有加入del命令的key</p></blockquote><h2 id="内存淘汰策略"><a class="markdownIt-Anchor" href="#内存淘汰策略"></a> 内存淘汰策略</h2><p>内存淘汰机制针对是内存不足的情况下的一种Redis处理机制。例如，当前的Redis存储已经超过内存限制了，然而我们的业务还在继续往Redis里面追加缓存内容，这时候Redis的淘汰机制就起到作用了</p><p>淘汰策略一般在redis.conf中设置</p><h3 id="redis常见的六种淘汰策略"><a class="markdownIt-Anchor" href="#redis常见的六种淘汰策略"></a> Redis常见的六种淘汰策略</h3><ul><li>noeviction: 不删除策略， 达到最大内存限制时， 如果需要更多内存， 直接返回错误信息。 大多数写命令都会导致占用更多的内存(有极少数会例外， 如 DEL )</li><li>allkeys-lru: 所有key通用; 优先删除最近最少使用(less recently used ，LRU) 的 key</li><li>volatile-lru: 只限于设置了 expire 的部分; 优先删除最近最少使用(less recently used ，LRU) 的 key</li><li>allkeys-random: 所有key通用; 随机删除一部分 key</li><li>volatile-random: 只限于设置了 expire 的部分; 随机删除一部分 key</li><li>volatile-ttl: 只限于设置了 expire 的部分; 优先删除剩余时间(time to live，TTL) 短的key</li></ul><h3 id="使用场景"><a class="markdownIt-Anchor" href="#使用场景"></a> 使用场景</h3><ul><li>如果分为热数据与冷数据， 推荐使用 allkeys-lru 策略；也就是， 其中一部分key经常被读写. 如果不确定具体的业务特征， 那么 allkeys-lru 是一个很好的选择</li><li>如果需要循环读写所有的key， 或者各个key的访问频率差不多， 可以使用 allkeys-random 策略， 即读写所有元素的概率差不多</li><li>假如要让 Redis 根据 TTL 来筛选需要删除的key， 请使用 volatile-ttl 策略</li></ul><p>volatile-lru 和 volatile-random 策略主要应用场景是: 既有缓存，又有持久key的实例中。一般来说， 像这类场景， 应该使用两个单独的 Redis 实例</p><p>值得一提的是， 设置 expire 会消耗额外的内存， 所以使用 allkeys-lru 策略， 可以更高效地利用内存， 因为这样就可以不再设置过期时间了</p><h3 id="淘汰的内部实现"><a class="markdownIt-Anchor" href="#淘汰的内部实现"></a> 淘汰的内部实现</h3><p>淘汰过程可以这样理解：</p><ul><li>应用执行一个命令， 导致 Redis 中的数据增加，占用更多内存</li><li>Redis 检查内存使用量， 如果超出 <code>maxmemory</code> （redis.conf中配置）限制，根据策略清除部分 key</li><li>继续执行下一条命令， 以此类推</li></ul><p>在这个过程中， 内存使用量会不断地达到 limit 值， 然后超过， 然后删除部分 key， 使用量又下降到 limit 值之下</p><p>如果某个命令导致大量内存占用(比如通过新key保存一个很大的set)， 在一段时间内， 可能内存的使用量会明显超过 maxmemory 限制</p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>本文讲的都是基本的过期策略和内存淘汰策略，但具体实现还是要看实际需求，具体问题具体分析</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 定时器 </tag>
            
            <tag> Redis </tag>
            
            <tag> 内存管理 </tag>
            
            <tag> LRU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>细探Redis scan命令</title>
      <link href="/2021/01/30/%E7%BB%86%E6%8E%A2Redis-scan%E5%91%BD%E4%BB%A4/"/>
      <url>/2021/01/30/%E7%BB%86%E6%8E%A2Redis-scan%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>这周遇到的一个小需求是通过Go实现对Redis的hash field实时上限检查，而因为是线上的服务，所以这个上限检查不能对redis pod造成负担，跟组内导师交流学习后了解到可以通过redis的HScan命令来实现这个需求</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li>cursor（游标）：数据库中常见的一个概念，通常提供一种从表中检索出的数据进行操作的灵活手段，能从包含数据记录的结果集中每次提取一条记录的机制</li><li>rehash：在<code>redis</code>的具体实现中，使用了一种叫做**渐进式哈希(rehashing)**的机制来提高<code>dict</code>的缩放效率</li><li>迭代完整性：保证完整遍历被遍历对象的性质</li><li>生产环境：不敢乱增加负载的环境（跑一下redis keys命令直接重大事故）</li></ul><h2 id="scan命令"><a class="markdownIt-Anchor" href="#scan命令"></a> Scan命令</h2><h3 id="scan命令是什么"><a class="markdownIt-Anchor" href="#scan命令是什么"></a> Scan命令是什么</h3><p>SCAN命令是基于游标（cursor）迭代的，SCAN命令并不单纯指代SCAN命令，还包含SSCAN、HSCAN、ZSCAN，每种命令操作对象是有区别的，但用法及功能基本相同</p><h3 id="为什么要用scan命令"><a class="markdownIt-Anchor" href="#为什么要用scan命令"></a> 为什么要用Scan命令</h3><p>当Redis中的数据量很大时，因为Redis是单线程服务，所以一些数据操作会导致Redis服务卡顿，甚至宕机。当某一指令耗时很长时（比如经典的keys *），就会阻塞后续的指令执行。当被积压的指令越来越多时，Redis服务占用CPU将不断升高，最终导致Redis pod崩溃</p><p>相比于keys命令，scan命令有两个比较明显的优势：</p><ul><li>scan命令的时间复杂度虽然也是O(N)，但它是分次进行的，不会阻塞线程</li><li>scan命令提供了limit参数，可以控制每次返回结果的最大条数（但这里也有个坑，下面细讲）</li></ul><h3 id="scan命令的基本使用"><a class="markdownIt-Anchor" href="#scan命令的基本使用"></a> Scan命令的基本使用</h3><p>通用参数：</p><ul><li>cursor：迭代游标</li><li>MATCH：数据匹配模式</li><li>COUNT：迭代返回数量</li></ul><table><thead><tr><th>命令</th><th>功能</th><th>参数</th><th>返回值</th></tr></thead><tbody><tr><td>SCAN</td><td>基于游标迭代DB</td><td>cursor [MATCH pattern] [COUNT count]</td><td>返回数组，第一个值是下一次迭代的游标（uint64），第2个值是元素列表（key列表）</td></tr><tr><td>SSCAN</td><td>基于游标迭代Sets</td><td>key cursor [MATCH pattern] [COUNT count]</td><td>返回数组，第一个值是下一次迭代的游标（uint64），第2个值是元素列表</td></tr><tr><td>HSCAN</td><td>基于游标迭代Hashes</td><td>key cursor [MATCH pattern] [COUNT count]</td><td>返回数组，第2个值是field-value列表</td></tr><tr><td>ZSCAN</td><td>基于游标迭代ZSets</td><td>key cursor [MATCH pattern] [COUNT count]</td><td>返回数组，第2个值是member-score列表</td></tr></tbody></table><h3 id="scan命令特性"><a class="markdownIt-Anchor" href="#scan命令特性"></a> Scan命令特性</h3><ul><li>增量迭代：和keys、Smembers等命令的全量迭代区分开，全量迭代对大集合执行时可能阻塞服务很长时间，增量迭代则不会</li><li>不保证准确结果：因为增量迭代过程中可能出现迭代元素被更改的情况，所以并不能保证准确结果</li><li>基于游标迭代：SCAN基于游标迭代，每次请求将返回下一次需要使用的游标；游标cursor可以比DB元素总量大，可以为负数；使用间断（不是迭代返回的）、负数、超出范围或其他非法游标，迭代不会报错，可能产生未定义行为（无法保证准确性）；</li><li>迭代结束标记：SCAN返回的游标不一定递增，是无序的**（因为考虑到redis rehash的情况，SCAN命令是以高位加1的方式进行遍历的，防止扩容时的重复遍历）**，某次迭代返回的元素数量可能为0；**返回元素列表为空，不代表迭代结束；一个完整的迭代是SCAN游标从0开始，返回游标为0结束；**迭代状态由返回的游标控制。<strong>可以并发执行迭代</strong>；可随时终止迭代；</li><li>迭代完整性：遍历开始到遍历结束一直存在的数据，一定能被迭代返回；同一个元素可能返回多次，数据去重应由应用程序完成；在迭代过程中增删的元素，可能返回，可能不返回（由于遍历的无序性）</li><li>为什么有时count参数失效了（直接返回了整个集合）？：<strong>当数据类型是sets（由integer组成）、hashes、sorted sets且集合较小时，迭代将返回整个集合的数据，与count无关</strong>（因为数据量较小时Redis的内存优化策略）<br /><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210130175444.png"/></li><li>参数count：count默认值是10；<strong>数据集较大时，如果没有使用match，返回元素为count或比count略大</strong>；每次迭代的count参数值可以不同，只要使用上次迭代返回的游标即可</li></ul><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>redis Scan命令是在生产环境中操作redis大key最合适的命令，但相应地，使用起来也是有很多坑点需要开发者注意的（我一开始也觉得这个需求几行加个定时任务就结束了，没想到一搞就是两天）</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> Redis </tag>
            
            <tag> 高负载 </tag>
            
            <tag> Hash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go 并发编程与定时器</title>
      <link href="/2021/01/26/Go-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
      <url>/2021/01/26/Go-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%AE%9A%E6%97%B6%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>在最近的日常后台开发中经常遇到定时任务的需求，如定时通知、定时检查等重要的需求，绝对时间一定不会是完全准确的，它对于一个运行中的分布式系统其实没有太多指导意义，但是由于相对时间的计算不依赖于外部的系统，所以它的计算可以做的比较准确，这里简单总结一下定时任务在Go中的实现</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li>Channel：Channel 是Go中的一个核心类型，你可以把它看成一个管道，通过它并发核心单元就可以发送或者接收数据进行通讯</li><li>Goroutine：并发是Go语言最大的特点之一，在Go中可以非常方便地实现并发；Go从语言层面支持并发，Goroutine是Go中最基本的执行单元；事实上每一个Go程序至少有一个Goroutine：主Goroutine；当程序启动时，它就会自动创建</li></ul><h2 id="go定时器的数据结构"><a class="markdownIt-Anchor" href="#go定时器的数据结构"></a> Go定时器的数据结构</h2><p><code>timer</code> 是 Golang 定时器的内部表示，每一个 <code>timer</code> 其实都存储在堆中，<code>tb</code> 就是用于存储当前定时器的桶，而 <code>i</code> 是当前定时器在堆中的索引，我们可以通过这两个变量找到当前定时器在堆中的位置：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> timer <span class="keyword">struct</span> &#123;</span><br><span class="line">    tb *timersBucket</span><br><span class="line">    i  <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">    when   <span class="keyword">int64</span></span><br><span class="line">    period <span class="keyword">int64</span></span><br><span class="line">    f      <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;, <span class="keyword">uintptr</span>)</span></span></span><br><span class="line">    arg    <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    seq    <span class="keyword">uintptr</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>when</code> 表示当前定时器（Timer）被唤醒的时间，而 <code>period</code> 表示两次被唤醒的间隔，每当定时器被唤醒时都会调用 <code>f(args, now)</code> 函数并传入 <code>args</code> 和当前时间作为参数。然而这里的 <code>timer</code> 作为一个私有结构体其实只是定时器的运行时表示，<code>time</code> 包对外暴露的定时器使用了如下所示的结构体：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Timer <span class="keyword">struct</span> &#123;</span><br><span class="line">    C &lt;-<span class="keyword">chan</span> Time</span><br><span class="line">    r runtimeTimer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Timer</code> 定时器必须通过 <code>NewTimer</code> 或者 <code>AfterFunc</code> 函数进行创建，其中的 <code>runtimeTimer</code> 其实就是上面介绍的 <code>timer</code> 结构体，当定时器失效时，失效的时间就会被发送给当前定时器持有的 Channel <code>C</code>，订阅管道中消息的 Goroutine 就会收到当前定时器失效的时间。</p><p>在 <code>time</code> 包中，除了 <code>timer</code> 和 <code>Timer</code> 两个分别用于表示运行时定时器和对外暴露的 API 之外，<code>timersBucket</code> 这个用于存储定时器的结构体也非常重要，它会存储一个处理器上的全部定时器，不过如果当前机器的核数超过了 64 核，也就是机器上的处理器 P 的个数超过了 64 个，多个处理器上的定时器就可能存储在同一个桶中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> timersBucket <span class="keyword">struct</span> &#123;</span><br><span class="line">    lock         mutex</span><br><span class="line">    gp           *g</span><br><span class="line">    created      <span class="keyword">bool</span></span><br><span class="line">    sleeping     <span class="keyword">bool</span></span><br><span class="line">    rescheduling <span class="keyword">bool</span></span><br><span class="line">    sleepUntil   <span class="keyword">int64</span></span><br><span class="line">    waitnote     note</span><br><span class="line">    t            []*timer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每一个 <code>timersBucket</code> 中的 <code>t</code> 就是用于存储定时器指针的切片，每一个运行的 Go 语言程序都会在内存中存储着 64 个桶，这些桶中都存储定时器的信息</p><p>每一个桶持有的 <code>timer</code> 切片其实都是一个最小堆，这个最小堆会按照 <code>timer</code> 应该触发的时间对它们进行排序，最小堆最上面的定时器就是最近需要被唤醒的 <code>timer</code>，下面展开介绍定时器的创建和触发过程</p><h2 id="具体实现"><a class="markdownIt-Anchor" href="#具体实现"></a> 具体实现</h2><h3 id="一次定时器timer"><a class="markdownIt-Anchor" href="#一次定时器timer"></a> 一次定时器（Timer）</h3><p><code>time</code> 包对外提供了两种创建定时器的方法，第一种方法就是 <code>NewTimer</code> 接口，这个接口会创建一个用于通知触发时间的 Channel、调用 <code>startTimer</code> 方法并返回一个创建指向 <code>Timer</code> 结构体的指针：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTimer</span><span class="params">(d Duration)</span> *<span class="title">Timer</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> Time, <span class="number">1</span>)</span><br><span class="line">    t := &amp;Timer&#123;</span><br><span class="line">        C: c,</span><br><span class="line">        r: runtimeTimer&#123;</span><br><span class="line">            when: when(d),</span><br><span class="line">            f:    sendTime,</span><br><span class="line">            arg:  c,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    startTimer(&amp;t.r)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另一个用于创建 <code>Timer</code> 的方法 <code>AfterFunc</code> 其实也提供了非常相似的结构，<strong>与 <code>NewTimer</code> 方法不同的是该方法没有创建一个用于通知触发时间的 Channel</strong>，它只会在定时器到期时调用传入的方法：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AfterFunc</span><span class="params">(d Duration, f <span class="keyword">func</span>()</span>) *<span class="title">Timer</span></span> &#123;</span><br><span class="line">    t := &amp;Timer&#123;</span><br><span class="line">        r: runtimeTimer&#123;</span><br><span class="line">            when: when(d),</span><br><span class="line">            f:    goFunc,</span><br><span class="line">            arg:  f,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    startTimer(&amp;t.r)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>NewTimer</code> 创建的定时器，传入函数时 <code>sendTime</code>，它会将当前时间发送到定时器持有的 Channel 中，而使用 <code>AfterFunc</code> 创建的定时器，在内层循环中调用的函数就会是调用方传入的函数</p><p>使用NewTimer创建的定时器，走完一个定时周期后，定时器就会暂停工作（Channel C不再发送消息），即可实现单次定时任务</p><h3 id="多次定时器ticker"><a class="markdownIt-Anchor" href="#多次定时器ticker"></a> 多次定时器（Ticker）</h3><p>在实际需求中我们更常遇到多次的定时任务，这时就可以用 Go 语言的 <code>time</code> 包中提供的用于多次通知的 Ticker 计时器，计时器中包含了一个用于接受通知的 Channel 和一个定时器，这两个字段共同组成了用于连续多次触发事件的计时器：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Ticker <span class="keyword">struct</span> &#123;</span><br><span class="line">    C &lt;-<span class="keyword">chan</span> Time <span class="comment">// The channel on which the ticks are delivered.</span></span><br><span class="line">    r runtimeTimer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>想要在 Go 语言中创建一个计时器有两种方法，一种是使用 <code>NewTicker</code> 方法显式地创建<code>Ticker</code> 计时器指针，另一种是直接通过 <code>Tick</code> 方法获取一个会定期发送消息的 Channel：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTicker</span><span class="params">(d Duration)</span> *<span class="title">Ticker</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(errors.New(<span class="string">&quot;non-positive interval for NewTicker&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> Time, <span class="number">1</span>)</span><br><span class="line">    t := &amp;Ticker&#123;</span><br><span class="line">        C: c,</span><br><span class="line">        r: runtimeTimer&#123;</span><br><span class="line">            when:   when(d),</span><br><span class="line">            period: <span class="keyword">int64</span>(d),</span><br><span class="line">            f:      sendTime,</span><br><span class="line">            arg:    c,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    startTimer(&amp;t.r)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Tick</span><span class="params">(d Duration)</span> &lt;-<span class="title">chan</span> <span class="title">Time</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NewTicker(d).C</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Tick</code> 其实也只是对 <code>NewTicker</code> 的简单封装，从实现上我们就能看出来它其实就是调用了 <code>NewTicker</code> 获取了计时器并返回了计时器中 Channel</p><p>需要注意的是每一个 <code>NewTicker</code> 方法开启的计时器都需要在不需要使用时调用 <code>Stop</code> 进行关闭，如果不显示调用 <code>Stop</code> 方法，创建的计时器就没有办法被<strong>垃圾回收</strong>，而通过 <code>Tick</code> 创建的计时器由于只对外提供了 Channel，所以没有办法关闭的，我们一定要谨慎使用这一接口创建计时器</p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>Go 语言的定时器在并发编程起到了非常重要的作用，它能够为我们提供比较准确的相对时间，基于它的功能，标准库中还提供了计时器、休眠等接口能够帮助我们在 Go 语言程序中更好地处理过期和超时等问题</p><p>标准库中的定时器在大多数情况下是能够正常工作并且高效完成任务的，但是在遇到极端情况或者性能敏感场景时，它可能没有办法胜任，如在10ms的粒度下误差就会变得无法接受</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> 并发编程 </tag>
            
            <tag> 定时器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据库缓存的常用设计模式</title>
      <link href="/2020/12/25/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98%E7%9A%84%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
      <url>/2020/12/25/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98%E7%9A%84%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>在DEM的某需求中涉及缓存模式的设计，终于要用到我少得可怜的数据库知识了，顺便做个总结</p><p>想要提高系统的性能，缓存是最直接最简单的方法之一；缓存一方面可以减少数据库负载，另一方面还可以减少相应时间、节省成本</p><p>总的来说，缓存的常见设计模式可分成五种</p><h2 id="几个需要了解的词"><a class="markdownIt-Anchor" href="#几个需要了解的词"></a> 几个需要了解的词</h2><ul><li>缓存：广义上的缓存，不仅仅指 Redis 这些常用作缓存的工具</li><li>命中缓存：指查询操作中直接在缓存中得到结果</li><li>数据更新：指同步缓存与数据库中的数据</li></ul><h2 id="cache-aside"><a class="markdownIt-Anchor" href="#cache-aside"></a> Cache-Aside</h2><p>Cache-Aside 是使用最为广泛的一种模式。应用直接去缓存中找数据，命中缓存则直接返回，如果未命中缓存，则需要先去数据库中查询数据，并将查询到的数据存储到缓存中，示意图如下：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201225134322.png" alt="" /></p><p>但因为在这种模式下，只有当未命中缓存时，才会从数据库查询最新的数据，所以这样的方式会导致缓存中的数据与数据库中的数据不一致。一般我们会给缓存中的数据设置过期时间（TTL），数据过期后就会去数据库取最新的数据</p><p>Cache-Aside模式对缓存失效具有一定的容忍性，即使缓存集群挂掉，我们仍然可以通过直接访问数据库的方式来进行操作；另外值得一提的一点是：缓存中的数据模型可以与数据库中的数据模型不同</p><h2 id="read-through-cache"><a class="markdownIt-Anchor" href="#read-through-cache"></a> Read-Through Cache</h2><p>Read-Through 的模式与 Cache-Aside 的模式很接近，区别在于，Cache-Aside 是通过应用程序来更新缓存中的数据，而 Read-Through 则是直接通过缓存自身来更新数据，也就是说应用和数据库之间不直接进行连接，并且，由于缓存与数据库之间没有应用程序的介入，read-through cache 中缓存的数据模型不能与数据库中的数据模型不同</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201227150400.png" alt="" /></p><p>Read-through 模式适合读量较大的工作负载，劣势是，当第一次请求数据时，它总是导致缓存丢失，并造成额外的数据加载到缓存的成本</p><p>这种模式也存在缓存中数据与数据库中数据不一致的情况，但是相比于给缓存设置过期时间，它只需要和下面的 Write-Through 搭配使用就可以解决这个问题</p><h2 id="write-through-cache"><a class="markdownIt-Anchor" href="#write-through-cache"></a> Write-Through Cache</h2><p>上面是两种以读为主的缓存，而 Write-Through 模式中，会先将数据写入到缓存中，然后由缓存将数据存入到数据库中</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201227150145.png" alt="" /></p><p>就其本身而言，Write-through 模式似乎没有多大作用，况且它还造成了额外的写延迟成本，因为数据先写到缓存，然后写到数据库，但是 Write-Through 与 Read-Through 相结合可以很好的解决缓存和数据库中数据不一致的问题，Write-Through 每次都会先更新缓存中的数据，这样就可以保证缓存中的数据总是最新的</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201227151534.png" alt="" /></p><h2 id="write-around"><a class="markdownIt-Anchor" href="#write-around"></a> Write-Around</h2><p>另一种非常简单的写模式，相比于 Write-Through ，Write-Around 模式中会直接将数据写入数据库中</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201227152329.png" alt="" /></p><p>Cache-Aside 要配合 Write-Around 而不能和 Write-Through 一起使用，因为 Write-Through 模式下会先更新缓存，而这时如果有一个线程未命中缓存，从数据库中读取了旧数据覆盖了缓存中的新数据，就会造成数据错误；而使用 Write-Around 就不会有这个问题</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201227153513.png" alt="" /></p><h2 id="write-back"><a class="markdownIt-Anchor" href="#write-back"></a> Write-Back</h2><p>Write-Back 模式可以说是 Write-Through 模式的改良版，Write-Through 模式中，每写一次缓存，缓存就会写一次数据库，而 Write-Back 模式中则是写多次缓存后才会写一次数据库，减少了写延迟，同时也大大减轻服务器的压力</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201227153559.png" alt="" /></p><p>当与read-through相结合的时候，它对于混合工作负载非常有效，最近更新和访问的数据总是在缓存中可用；而同时采用cache-aside和write-back两种策略时，则可以更好地吸收峰值负载期间的峰值</p><p>当然， Write-Back 也不是没有缺点，如果缓存出现了问题集体挂掉了，那么缓存中这部分没有持久化的数据就会丢失</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
            <tag> 缓存 </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker踩坑日记-1</title>
      <link href="/2020/12/13/Docker%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0-1/"/>
      <url>/2020/12/13/Docker%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0-1/</url>
      
        <content type="html"><![CDATA[<h2 id="问题背景"><a class="markdownIt-Anchor" href="#问题背景"></a> 问题背景</h2><p>这几天为了测试一个<code>Django</code>的<code>webservice</code>，想在云主机上用<code>docker-compose</code>部署一个本地版本进行测试，但<code>docker-compose up</code>的过程中，<code>build</code>镜像时无法拉取镜像；排查后发现使用自定义网桥（<code>docker</code>中的<code>bridge</code>网桥）<code>network</code>时都无法连接外网，而且容器内无法ping到网关，但宿主机内可以ping到容器的网关，<code>docker network inspect</code>查看自定义的网络，<code>ip</code>分配以及网关设置正常</p><p>使用<code>docker</code>默认的<code>bridge</code>网络创建容器，发现也无法访问外网，情况一模一样</p><h2 id="解决过程"><a class="markdownIt-Anchor" href="#解决过程"></a> 解决过程</h2><p>仔细排查后怀疑是<code>docker network</code>本身的问题，随后使用<code>bridge-utils</code>创建网桥：</p><ul><li><p>暂停<code>docker</code>服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker stop</span><br></pre></td></tr></table></figure></li><li><p>添加网桥：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brctl addbr br0</span><br></pre></td></tr></table></figure></li><li><p>设置网段：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 192.168.12.0&#x2F;24 dev br0</span><br></pre></td></tr></table></figure></li><li><p>启用网桥<code>br0</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip link set dev br0 up</span><br></pre></td></tr></table></figure></li><li><p>修改<code>docker</code>默认网桥：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br></pre></td></tr></table></figure></li><li><p>添加<code>bridge</code>字段：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;bridge&quot;:&quot;br0&quot;</span><br></pre></td></tr></table></figure></li><li><p>重启<code>docker</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker start</span><br></pre></td></tr></table></figure></li></ul><p>之后使用<code>docker</code>默认<code>bridge</code>网络运行测试容器，成功连接外网，确认是<code>docker network</code>的问题</p><p>随后又根据这个线索谷歌了一番，发现根因是docker 加载内核的<code>bridge.ko</code>驱动异常，导致<code>docker0</code>网卡无法转发数据包，也就是系统内核的网桥模块<code>bridge.ko</code>加载失败导致的</p><h2 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h2><p><a href="https://www.cnblogs.com/xzkzzz/p/9627658.html">升级<code>centos</code>内核</a>，重装<code>docker</code>后解决</p><h2 id="体会与收获"><a class="markdownIt-Anchor" href="#体会与收获"></a> 体会与收获</h2><p>从<code>docker</code>网络一步一步摸到<code>centos</code>内核问题，有些坑真是深不见底啊</p>]]></content>
      
      
      <categories>
          
          <category> 踩坑 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> 网络 </tag>
            
            <tag> centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReBucket算法总结</title>
      <link href="/2020/12/08/ReBucket%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/"/>
      <url>/2020/12/08/ReBucket%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>这次接触ReBucket算法是在实际需求中需要完成一个落地的相关功能模块，也算是少有的复现论文到落地项目的功能模块的机会了，这里做一下算法本身的总结，有关的实现后续会放在另一篇文章中</p><h2 id="几个需要了解的词"><a class="markdownIt-Anchor" href="#几个需要了解的词"></a> 几个需要了解的词</h2><ul><li><strong>PDM</strong>：位置相关模型（Position Dependent Model）</li><li><strong>并查集</strong>：一种树型的<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a>，用于处理一些<a href="https://zh.wikipedia.org/wiki/%E4%B8%8D%E4%BA%A4%E9%9B%86">不交集</a>（Disjoint Sets）的合并及查询问题</li><li><strong>层次聚类方法</strong>：一种自底向上的聚类方法（类似并查集，从每个元素都属于自己的集群开始）</li><li><strong>WER</strong>：Windows Error Reporting，微软部署的一套用于及时告警的分布式系统</li><li><strong>Grid Search</strong>：一项模型超参数（需要人工选择的参数）优化技术，常用于优化三个或者更少数量的超参数，本质是一种穷举法</li></ul><h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2><p>尽管在日常的开发工作中，开发团队已经在发布产品前花费大量资源和精力进行软件测试，但实际上，已发布的软件仍然有一些错误，而这些错误往往表现为release版本运行时崩溃</p><p>针对这个现象，微软部署了一套分布式系统<strong>WER</strong>（Windows Error Reporting）用于自动从崩溃现场收集崩溃信息、聚类到各个Bucket，当某个Bucket内的崩溃次数达到某个阈值后，<strong>WER</strong>会自动为其生成错误报告，并将其提供给开发人员；<strong>WER</strong>已经在运行的十几年内证明了其价值，收集了数十亿词崩溃报告，大大加快了开发人员的Debug流程，但另一方面，<strong>WER</strong>也仍存在一些问题，如“第二个Bucket问题”以及“长尾巴”问题（见下图）</p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201210101859.png"  /><p><strong>ReBucket</strong>算法就是为了解决这些已知问题而产生的一种堆栈聚类算法</p><h2 id="算法流程及逻辑"><a class="markdownIt-Anchor" href="#算法流程及逻辑"></a> 算法流程及逻辑</h2><h3 id="整体结构"><a class="markdownIt-Anchor" href="#整体结构"></a> 整体结构</h3><p>在<strong>ReBucket</strong>算法中，对于一系列新到达的崩溃信息（一个时间片内到达的崩溃信息），首先我们对其进行预处理，以提取简化的堆栈信息。然后使用<strong>层次聚类方法</strong>将崩溃报告聚类到相应的Bucket内；同时可以使用历史Bucket数据构建的训练模型训练在PDM中使用到的参数，下图为ReBucket算法的总流程图</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201208161749.png" alt="" /></p><h3 id="详细流程"><a class="markdownIt-Anchor" href="#详细流程"></a> 详细流程</h3><h4 id="堆栈预处理"><a class="markdownIt-Anchor" href="#堆栈预处理"></a> 堆栈预处理</h4><p>在计算PDM并进行聚类前我们需要从原始堆栈信息中删除以下几种函数（方法），以提取我们真正需要的堆栈信息：</p><ul><li><strong>白名单函数</strong>：白名单函数指那些被认为在软件崩溃时被视为<strong>不可能发生错误</strong>的函数，通常包括那些非常简单的函数，或者已经成功运行了很长时间的函数</li><li><strong>递归函数</strong>：递归函数经常出现在堆栈信息中，并且大多数递归函数并不包含有效信息，而且会影响到相似度的度量，尤其是当递归函数的数量比较大时。因此这里我们使用一种去除递归函数的算法来去掉它</li></ul><h4 id="计算堆栈间的相似度"><a class="markdownIt-Anchor" href="#计算堆栈间的相似度"></a> 计算堆栈间的相似度</h4><h5 id="堆栈分析"><a class="markdownIt-Anchor" href="#堆栈分析"></a> 堆栈分析</h5><p>在计算堆栈间相似度的过程中需要用到两个度量：</p><ul><li>当前帧到顶部帧的距离</li><li>对齐偏移：两个堆栈中匹配的函数到顶部帧的距离的偏移量（差的绝对值）</li></ul><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201208170449.png" alt="" /></p><p>以上图中的两个堆栈为例，对于两个堆栈<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，崩溃点都位于顶部帧，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>中的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">f_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">f_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">f_4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>与<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>中的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">f_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">f_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>6</mn></msub></mrow><annotation encoding="application/x-tex">f_6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>匹配，则可以很明显地算出<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">f_4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mn>6</mn></msub></mrow><annotation encoding="application/x-tex">f_6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的对齐偏移为2</p><h5 id="pdm位置相关模型"><a class="markdownIt-Anchor" href="#pdm位置相关模型"></a> PDM（位置相关模型）</h5><p>在ReBucket算法中，我们使用PDM来衡量两个堆栈之间的相似度，而PDM是基于以下两个观点的：</p><ul><li>应该放更大的权重在离顶部帧近的帧上，因为bug的根因更容易出现在离顶部帧近的帧上</li><li>两个相似的堆栈中的匹配函数之间的对齐偏移应该很小</li></ul><p>基于这两个观点，两个堆栈<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>之间的相似度可以由以下流程得出：</p><p>定义<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>之间所有公共帧序列（子序列）的集合，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为公共帧序列之一，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>2</mn></mrow></msub><mo separator="true">,</mo><mo>…</mo><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{i, 1}, S_{i, 2},\ldots S_{i, k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>内相匹配的函数</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo>=</mo><mrow><mo fence="true">{</mo><msub><mi>L</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>L</mi><mi>s</mi></msub><mo separator="true">,</mo><msub><mi>L</mi><mn>3</mn></msub><mo>…</mo><mo fence="true">}</mo></mrow><mspace width="1em"/><msub><mi>L</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>2</mn></mrow></msub><mo separator="true">,</mo><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>3</mn></mrow></msub><mo separator="true">,</mo><mo>…</mo><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo>…</mo><mo fence="true">}</mo></mrow></mrow><annotation encoding="application/x-tex">L=\left\{L_{1}, L_{s}, L_{3} \ldots\right\} \quad L_{i}=\left\{S_{i, 1}, S_{i, 2}, S_{i, 3}, \ldots S_{i, k} \ldots\right\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">{</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mclose delimcenter" style="top:0em;">}</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:1em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">{</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mclose delimcenter" style="top:0em;">}</span></span></span></span></span></span></p><p>定义<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mi>O</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>C</mi><mi>q</mi></msub><mo separator="true">,</mo><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">POS(C_q, S_{i,k})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{i,k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">C_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>堆栈内的位置，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span></span></span>为堆栈<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>中帧数量的最小值，由下列公式<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>可得出<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>之间的相似度：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">{</mo><mtable rowspacing="0.15999999999999992em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">sim</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mo><mi>max</mi><mo>⁡</mo></mo><mrow><msub><mi>L</mi><mi>i</mi></msub><mo>∈</mo><mi>L</mi></mrow></msub><mrow><mo fence="true">[</mo><mi>Q</mi><mrow><mo fence="true">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>l</mi></msubsup><msup><mi>e</mi><mrow><mo>−</mo><mi>c</mi><mi>j</mi></mrow></msup></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>Q</mi><mrow><mo fence="true">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><msub><mo>∑</mo><mrow><msub><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo>∈</mo><msub><mi>L</mi><mi>i</mi></msub></mrow></msub><msup><mi>e</mi><mrow><mo>−</mo><mi>c</mi><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi mathvariant="normal">Pos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow><mo separator="true">,</mo><mi mathvariant="normal">Pos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow></mrow></msup><msup><mi>e</mi><mrow><mo>−</mo><mi>o</mi><mo>∣</mo><mi mathvariant="normal">Pos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow><mo>−</mo><mi mathvariant="normal">Pos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow><mo>∣</mo></mrow></msup></mrow></mstyle></mtd></mtr></mtable></mrow><mspace width="1em"/><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\left\{ \begin{array}{lr}\operatorname{sim}\left(C_{1}, C_{2}\right)=\frac{\max_{L_{i}\in L} \left[ Q\left(L_{i}\right) \right] }{\sum_{j=0}^{l} e^{-cj}}\\\\Q\left(L_{i}\right)=\sum_{s_{i, k} \in L_{i}} e^{-c \min \left( \operatorname{Pos}\left(C_{1}, s_{i, k}\right), \operatorname{Pos}\left(C_{2}, s_{i, k}\right) \right)}e^{-o \mid \operatorname{Pos}\left(C_{1}, s_{i, k}\right)-\operatorname{Pos}\left(C_{2}, s_{i, k}\right) \mid}\end{array}\right.\quad (1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.4409019999999995em;vertical-align:-1.9704510000000002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35002em;"><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.1500100000000004em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.30001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.60002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8500199999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.4704509999999997em;"><span style="top:-4.470451em;"><span class="pstrut" style="height:3.092665em;"></span><span class="mord"><span class="mop"><span class="mord mathrm">s</span><span class="mord mathrm">i</span><span class="mord mathrm">m</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.092665em;"><span style="top:-2.56478em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8931714285714285em;"><span style="top:-2.1785614285714283em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.8971428571428572em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.46032428571428574em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight"><span class="mord mathdefault mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7570857142857144em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.567665em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop mtight">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.356707142857143em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.65952em;"></span><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.31472em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.36809285714285717em;"><span></span></span></span></span></span></span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">[</span></span><span class="mord mathdefault mtight">Q</span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">)</span></span></span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">]</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7574469999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.873004em;"><span class="pstrut" style="height:3.092665em;"></span><span class="mord"></span></span><span style="top:-1.6250040000000001em;"><span class="pstrut" style="height:3.092665em;"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.17862099999999992em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathdefault mtight">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.50279em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight">c</span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mop mtight">min</span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">(</span></span><span class="mop mtight"><span class="mord mathrm mtight">P</span><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">s</span></span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">)</span></span></span><span class="mpunct mtight">,</span><span class="mop mtight"><span class="mord mathrm mtight">P</span><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">s</span></span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">)</span></span></span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">)</span></span></span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight">o</span><span class="mrel mtight">∣</span><span class="mop mtight"><span class="mord mathrm mtight">P</span><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">s</span></span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">)</span></span></span><span class="mbin mtight">−</span><span class="mop mtight"><span class="mord mathrm mtight">P</span><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">s</span></span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">)</span></span></span><span class="mrel mtight">∣</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9704510000000002em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p><p>其中，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>为到顶部帧的距离系数，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>o</mi></mrow><annotation encoding="application/x-tex">o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">o</span></span></span></span>为对齐偏移系数。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>o</mi></mrow><annotation encoding="application/x-tex">o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">o</span></span></span></span>的值可以根据以往的经验手动设置。后续还有一种基于学习的自动获取最优系数值的方法。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>Q</mi><mrow><mo fence="true">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">Q\left(L_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">Q</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>用来衡量在公共帧序列<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>中匹配的函数的相似度值。其中第一个指数函数考虑了一对匹配函数到顶部帧的最小距离，第二个指数函数考虑最小对齐偏移，到顶部帧的距离以及对齐偏移越小，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>Q</mi><mrow><mo fence="true">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">Q\left( L_i \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">Q</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>的值越大</p><p>从公式<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>中可以看出：堆栈相似性的度量值由<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>Q</mi><mrow><mo fence="true">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">Q\left(L_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">Q</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>值最大的公共帧序列决定，但穷举所有的公共帧序列效率很低，这里就可以用到求最长公共子序列问题的方法了，用二维动态规划的方法可以高效地求出<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>Q</mi><mrow><mo fence="true">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">Q\left(L_{i}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">Q</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span>值最大的公共帧序列，具体步骤如下：</p><ul><li>定义一个相似度矩阵<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mrow><mo fence="true">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">M\left[i,j\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>表示<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>中从顶部帧开始的第<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>帧和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>中从顶部帧开始的第<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span></span></span>帧之间的相似度</li><li>根据相似度矩阵<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mrow><mo fence="true">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">M\left[i,j\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span>的定义，堆栈相似性的度量值由<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{m,n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>决定，其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的长度，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的长度（见公式<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>4</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(4)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mclose">)</span></span></span></span>）</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mrow><mo fence="true">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">M\left[i,j\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span>的状态转移方程也可以从<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>中得出，与求最长公共子序列比较相似（见公式<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span>,<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span></span></span></span>）</li></ul><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.15999999999999992em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>M</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><mi>max</mi><mo>⁡</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.15999999999999992em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>M</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><mi mathvariant="normal">cost</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>M</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>M</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">cost</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.15999999999999992em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mi>e</mi><mrow><mo>−</mo><msup><mi>c</mi><mo>∗</mo></msup><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><msup><mi>e</mi><mrow><mo>−</mo><msup><mi>o</mi><mo>∗</mo></msup><mrow><mo fence="true">∣</mo><mi>i</mi><mo>−</mo><mi>j</mi><mo fence="true">∣</mo></mrow></mrow></msup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mtext>if </mtext><mstyle scriptlevel="0" displaystyle="false"><mi>i</mi><mi>t</mi><mi>h</mi></mstyle><mtext> frame of </mtext></mrow><msub><mi>C</mi><mn>1</mn></msub><mo>=</mo><mo>=</mo><mrow><mstyle scriptlevel="0" displaystyle="false"><mi>j</mi><mi>t</mi><mi>h</mi></mstyle><mtext> frame of </mtext></mrow><msub><mi>C</mi><mn>2</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext> otherwise </mtext></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mn>3</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">sim</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow><mo>=</mo><mfrac><msub><mi>M</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>l</mi></msubsup><msup><mi>e</mi><mrow><mo>−</mo><mi>c</mi><mi>j</mi></mrow></msup></mrow></mfrac></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mn>4</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{lr}    M_{i, j}=\max     \left\{\begin{array}{lr}        M_{i-1, j-1} + \operatorname{cost}(i, j) \\        M_{i-1, j} \\        M_{i, j-1}    \end{array}\right.    &amp;(2)    \\\\    \operatorname{cost}(i, j)=    \left\{\begin{array}{lr}        e^{-c^{*} \min (i, j)} e^{-o^{*} \left| i-j \right|}        &amp; \text {if $ith$ frame of } C_1==\text {$jth$ frame of } C_2 \\        0        &amp; \text { otherwise }    \end{array}\right.    &amp;(3)    \\\\\operatorname{sim}\left(C_{1}, C_{2}\right)=\frac{M_{m, n}}{\sum_{j=0}^{l} e^{-c j}}&amp;(4)\end{array}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.200478em;vertical-align:-4.850239000000001em;"></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.350239em;"><span style="top:-7.350239em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop">max</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.49999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.30002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop"><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">s</span><span class="mord mathrm">t</span></span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-4.960219em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"></span></span><span style="top:-3.121549em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"><span class="mop"><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">s</span><span class="mord mathrm">t</span></span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.47867em;"><span style="top:-3.58133em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8973399999999998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathdefault mtight">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7633428571428571em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">∗</span></span></span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mop mtight">min</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8973399999999998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7633428571428571em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">∗</span></span></span></span></span></span></span></span></span><span class="minner mtight"><span class="mopen mtight delimcenter" style="top:0em;"><span class="mtight">∣</span></span><span class="mord mathdefault mtight">i</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight delimcenter" style="top:0em;"><span class="mtight">∣</span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-2.3813299999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9786700000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.47867em;"><span style="top:-3.58133em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord"> frame of </span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord"> frame of </span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.3813299999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord"> otherwise </span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9786700000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.3028789999999988em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"></span></span><span style="top:0.04277200000000125em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"><span class="mop"><span class="mord mathrm">s</span><span class="mord mathrm">i</span><span class="mord mathrm">m</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.985651em;"><span style="top:-2.56478em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8931714285714285em;"><span style="top:-2.1785614285714283em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.8971428571428572em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.46032428571428574em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight"><span class="mord mathdefault mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7570857142857144em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.50732em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:-0.10903em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7574469999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.850239000000001em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.350239em;"><span style="top:-7.350239em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span><span style="top:-3.121549em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span></span></span><span style="top:0.04277200000000125em;"><span class="pstrut" style="height:4.05002em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">4</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.850239000000001em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span></span></span></span></p><p>通过<strong>PDM</strong>我们就可以衡量任意两个堆栈的相似度，这也是下面对堆栈进行聚类操作的前提和依据</p><h4 id="clustering堆栈聚类"><a class="markdownIt-Anchor" href="#clustering堆栈聚类"></a> Clustering（堆栈聚类）</h4><p>对堆栈的聚类基于前面通过<strong>PDM</strong>计算的堆栈相似性度量，如果堆栈之间非常相似，则相关的崩溃报告会被分到相同的Bucket内</p><p>对堆栈聚类这里采用<strong>层次聚类方法</strong>（一种自底向上的聚类方法），其流程大致为：在聚类的开始，每个堆栈都属于其自己的集群；每一次迭代选择**“最近”**的集群并进行合并</p><p>为了确定某个集群在一次迭代中应该和哪个集群合并，我们需要定义<strong>集群之间的距离度量</strong>，这里我们将这个度量定义为两个集群中所有堆栈之间的最大距离（见公式<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>5</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">5</span><span class="mclose">)</span></span></span></span>,<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>6</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(6)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">6</span><span class="mclose">)</span></span></span></span>），其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><msub><mi>l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Cl_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><msub><mi>l</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">Cl_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>为一对集群，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>分别是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><msub><mi>l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Cl_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><msub><mi>l</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">Cl_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>中的堆栈</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.15999999999999992em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">distance</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mrow><mi>C</mi><mi>l</mi></mrow><mi>i</mi></msub><mo separator="true">,</mo><msub><mrow><mi>C</mi><mi>l</mi></mrow><mi>j</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><msub><mo><mi>max</mi><mo>⁡</mo></mo><mrow><msub><mi>C</mi><mn>1</mn></msub><mo>∈</mo><msub><mrow><mi>C</mi><mi>l</mi></mrow><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo>∈</mo><msub><mrow><mi>C</mi><mi>l</mi></mrow><mi>j</mi></msub></mrow></msub><mi mathvariant="normal">dist</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mn>5</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">dist</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow><mo>=</mo><mn>1</mn><mo>−</mo><mi mathvariant="normal">sim</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mn>6</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{lr}    \operatorname{distance}\left({Cl}_{i}, {Cl}_{j}\right)=\max_{C_{1} \in {Cl}_{i}, C_{2} \in {Cl}_{j}}    \operatorname{ dist }\left(C_{1}, C_{2}\right)    &amp; (5)    \\    \operatorname{ dist }\left(C_{1}, C_{2}\right)=1-\operatorname{sim}\left(C_{1}, C_{2}\right)    &amp; (6)\end{array}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4000000000000004em;vertical-align:-0.9500000000000004em;"></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mord mathrm">d</span><span class="mord mathrm">i</span><span class="mord mathrm">s</span><span class="mord mathrm">t</span><span class="mord mathrm">a</span><span class="mord mathrm">n</span><span class="mord mathrm">c</span><span class="mord mathrm">e</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34731999999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mord mathrm">d</span><span class="mord mathrm">i</span><span class="mord mathrm">s</span><span class="mord mathrm">t</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mord mathrm">d</span><span class="mord mathrm">i</span><span class="mord mathrm">s</span><span class="mord mathrm">t</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop"><span class="mord mathrm">s</span><span class="mord mathrm">i</span><span class="mord mathrm">m</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">5</span><span class="mclose">)</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">6</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span></span></span></span></p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20201209150955.png" alt="" /></p><p>在一次聚类过程中，考虑最坏的情况，所有堆栈都合并为一个集群，则<strong>层次聚类方法</strong>的时间复杂度为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，但在这里我们还会采用<strong>距离阈值</strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>作为聚类过程的停止标准。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>的值可以手动设置，也可以通过训练学习；一旦一个集群与其它集群距离的最小值大于<strong>距离阈值</strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>，则停止对该集群的聚类过程；最后则可以得到一系列包含集群和对应崩溃报告的Bucket，如上图中最后生成了两个Bucket</p><h4 id="训练pdm及clustering中的参数"><a class="markdownIt-Anchor" href="#训练pdm及clustering中的参数"></a> 训练PDM及Clustering中的参数</h4><p>PDM中用到的两个参数：</p><ul><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>：到顶部帧的距离的系数</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>o</mi></mrow><annotation encoding="application/x-tex">o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">o</span></span></span></span>：对齐偏移的系数</li></ul><p>分层聚类方法中的距离阈值<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>也是一个需要调优的参数</p><p>虽然这些参数都可以手动设置，但因为项目的不同，合适的参数也会不同，所以还是需要一个训练过程来学习这些参数的最优值</p><p>首先我们需要根据历史Bucket内的数据和相应的崩溃报告构建数据集，从<strong>同一Bucket</strong>中提取由开发人员确认的由相同错误引起的崩溃报告作为聚类正确的数据，从<strong>不同（不相似）的Bucket</strong>中提取由不同错误引起的崩溃报告作为聚类错误的数据（由于异类崩溃报告的数量通常很大，这里提取异类崩溃报告的过程是通过<strong>随机采样</strong>进行的）。基于获得的重复的和不相似的崩溃报告，收集成对的相似和不相似的堆栈，构建成数据集</p><p>对于需要训练的三个参数，它们的值独立变化，不同的参数直接导致不同的聚类性能，所以这里采用一种基于搜索的算法（类似Grid Search），在三个参数的有限集合的笛卡尔积内穷举搜索最优参数组合，流程如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 训练数据集中的堆栈对的数据结构</span></span><br><span class="line"><span class="keyword">type</span> trainStackPair <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> 添加堆栈对数据</span></span><br><span class="line">similarity       <span class="keyword">float64</span></span><br><span class="line">predictIsSimilar <span class="keyword">bool</span></span><br><span class="line">isSimilar        <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 训练参数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">trainParams</span><span class="params">()</span> <span class="params">(bestParamC <span class="keyword">float64</span>, bestParamO <span class="keyword">float64</span>, bestParamD <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">trainData    []trainStackPair</span><br><span class="line">paramC       <span class="keyword">float64</span></span><br><span class="line">paramO       <span class="keyword">float64</span></span><br><span class="line">paramD       <span class="keyword">float64</span></span><br><span class="line">bestFMeasure <span class="keyword">float64</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> paramC &lt;= <span class="number">2</span> &#123;</span><br><span class="line">paramO = <span class="keyword">float64</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> paramO &lt;= <span class="number">2</span> &#123;</span><br><span class="line">paramD = <span class="keyword">float64</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> paramD &lt;= <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, pair := <span class="keyword">range</span> trainData &#123;</span><br><span class="line">pair.getSimilarity()</span><br><span class="line"><span class="keyword">if</span> pair.similarity &gt; <span class="keyword">float64</span>(<span class="number">1</span> - paramD) &#123;</span><br><span class="line">pair.predictIsSimilar = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">pair.predictIsSimilar = <span class="literal">false</span> <span class="comment">// 这里可以删掉，因为bool默认值就是false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> newFMeasure := getFMeasure(trainData); newFMeasure &gt; bestFMeasure &#123;</span><br><span class="line">bestParamC, bestParamO, bestParamD = paramC, paramO, paramD</span><br><span class="line">bestFMeasure = newFMeasure</span><br><span class="line">&#125;</span><br><span class="line">paramD += <span class="number">0.01</span> <span class="comment">//d的学习率为0.01</span></span><br><span class="line">&#125;</span><br><span class="line">paramO += <span class="number">0.1</span> <span class="comment">//o的学习率为0.1</span></span><br><span class="line">&#125;</span><br><span class="line">paramC += <span class="number">0.1</span> <span class="comment">//c的学习率为0.1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*trainStackPair)</span> <span class="title">getSimilarity</span><span class="params">()</span> <span class="params">(similarity <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> PDM算法获取堆栈间相似度</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFMeasure</span><span class="params">(stackPairs []trainStackPair)</span> <span class="params">(FMeasure <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(stackPairs)</span><br><span class="line">TP, FN, FP, TN := <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _, pair := <span class="keyword">range</span> stackPairs &#123;</span><br><span class="line"><span class="keyword">if</span> pair.isSimilar &#123;</span><br><span class="line"><span class="keyword">if</span> pair.predictIsSimilar &#123;</span><br><span class="line">TP += <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">FN += <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> pair.predictIsSimilar &#123;</span><br><span class="line">FP += <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">TN += <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">FMeasure = <span class="number">2</span> * <span class="keyword">float64</span>(TP) / <span class="keyword">float64</span>(length+TP-TN)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>o</mi></mrow><annotation encoding="application/x-tex">o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">o</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>都初始化为0，最大值分别设定为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>c</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mn>2</mn><mo separator="true">,</mo><msub><mi>o</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mn>2</mn><mo separator="true">,</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c_{max}=2,o_{max}=2,d_{max}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>,训练中三个参数的学习率（步长）分别固定为0.1, 0.1, 0.01；根据每组参数预测的结果算出F值，最终返回能得到最大F值的参数组</p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>总的来说ReBucket算法可以分为四个模块：</p><ul><li>堆栈预处理（白名单，递归函数等）</li><li>PDM（二维动态规划）</li><li>Clustering（类似并查集，只是Find函数需要改一下）</li><li>参数训练（二分类模型，基于F值的Grid-Search）</li></ul><p>具体实现见下一篇文章</p><h2 id="存在的缺陷"><a class="markdownIt-Anchor" href="#存在的缺陷"></a> 存在的缺陷</h2><ul><li><code>应该放更大的权重在离顶部帧近的帧上，因为bug的根因更容易出现在离顶部帧近的帧上</code>这一观点在<strong>实际工程环境</strong>中并不对，实际上顶部帧存在许多系统调用 / sdk调用 / hook，所以顶部帧并不一定是bug的根因，这里可能可以利用堆栈预处理中的<strong>静态 / 动态白名单</strong>机制来解决（动态白名单：当一个方法被review并列入白名单后，若其发生变更，则移出白名单）</li><li>在oom，deadlock等崩溃报告中可能会有多个堆栈，计算其相似性度量时不能是简单的累加关系，而是应该<strong>赋予不同的权重</strong>；如oom中应该按各个调用所用的内存来分配权重、deadlock中应该按<code>lock</code>关键字等来分配权重。所以PDM模型应该按照崩溃类型异化</li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DEM </tag>
            
            <tag> 算法 </tag>
            
            <tag> Crash Clustering </tag>
            
            <tag> ReBucket </tag>
            
            <tag> 动态规划 </tag>
            
            <tag> 并查集 </tag>
            
            <tag> 线性模型 </tag>
            
            <tag> Grid-Search </tag>
            
            <tag> 二分类问题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>第一次实习考核总结</title>
      <link href="/2020/12/01/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%AE%9E%E4%B9%A0%E8%80%83%E6%A0%B8%E6%80%BB%E7%BB%93/"/>
      <url>/2020/12/01/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%AE%9E%E4%B9%A0%E8%80%83%E6%A0%B8%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1 id="第一次实习考核总结"><a class="markdownIt-Anchor" href="#第一次实习考核总结"></a> 第一次实习考核总结</h1><p>在腾讯的第一次实习考核，总结一下过程与收获</p><h2 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h2><p>我的实习考核ppt主要有以下内容：</p><ul><li>工作项目</li><li>难点&amp;解决方案</li><li>后续规划</li></ul><h2 id="收获"><a class="markdownIt-Anchor" href="#收获"></a> 收获</h2><ul><li>需要提高ppt能力，有一些内容可以更精炼</li><li><strong>量化指标</strong>很重要，<strong>量化指标</strong>很重要，<strong>量化指标</strong>很重要</li><li>在接入一个项目，或者一个项目做到尾期的时候，一定要有一个的思考是：如果从头开始这个项目的话，你会怎么设计逻辑</li><li>在遇到一些问题，被一些问题卡住的时候，要反思这个问题是否值得花这么多时间；解决问题后也要留下一些经验</li></ul><p>总之，意识到了自己的很多不足吧，还是需要更加努力</p><p>不能摸鱼力</p>]]></content>
      
      
      <categories>
          
          <category> 个人总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ppt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅尝antlr4</title>
      <link href="/2020/11/30/%E6%B5%85%E5%B0%9Dantlr4/"/>
      <url>/2020/11/30/%E6%B5%85%E5%B0%9Dantlr4/</url>
      
        <content type="html"><![CDATA[<h1 id="浅尝antlr4"><a class="markdownIt-Anchor" href="#浅尝antlr4"></a> 浅尝Antlr4</h1><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><h3 id="antlr是什么"><a class="markdownIt-Anchor" href="#antlr是什么"></a> Antlr是什么</h3><p>In a word, 多源语言多目标语言的一个语法分析框架</p><p>以下是官方文档的解释：</p><blockquote><p><strong>ANTLR</strong>（ANother Tool for Language Recognition）是一个功能强大的解析器生成器，用于读取，处理，执行或翻译结构化文本或二进制文件。它被广泛用于构建语言，工具和框架。ANTLR从语法上生成一个解析器，该解析器可以构建解析树，还可以生成一个侦听器接口（或访问者），从而可以轻松地对所关注短语的识别做出响应。</p><p><strong>ANTLR</strong> (ANother Tool for Language Recognition) is a powerful parser generator for reading, processing, executing, or translating structured text or binary files. It’s widely used to build languages, tools, and frameworks. From a grammar, ANTLR generates a parser that can build parse trees and also generates a listener interface (or visitor) that makes it easy to respond to the recognition of phrases of interest.</p></blockquote><p><a href="https://github.com/antlr/antlr4">Github项目地址</a></p><p>这次使用antlr的诱因是whosbug中使用的ctags（另一个语法分析器）只对c系语言支持较好，对java等语言的支持欠佳（甚至可以说很差了），为了whosbug的鲁棒性我认为还是有必要换一个语法分析器的</p><h3 id="几个需要了解的词"><a class="markdownIt-Anchor" href="#几个需要了解的词"></a> 几个需要了解的词</h3><ul><li><p>AST：<a href="https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9">抽象语法树</a></p></li><li><p>target language：antlr可以根据源语言的.g4文件生成不同语言（target language）的分析代码<br /><a href="https://github.com/antlr/antlr4/tree/master/doc">各种target language的文档（有些很简略）</a></p></li><li><p>Lexer：antlr中的词法分析器（<a href="https://zh.wikipedia.org/wiki/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90">词法分析</a>）</p></li><li><p>Parser：antlr中的语法分析器（<a href="https://zh.wikipedia.org/zh-hans/%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90">语法分析</a>）</p></li><li><p>Listener：是antlr中的独有概念，与传统源码分析不同，antlr提供Listener这一API供用户自定义自己的分析器，这种方式可以很大程度上使语法更易于阅读（按每位用户自己的设计），同时使得它们能避免与特定的应用程序耦合在一起，以下是官方的解释（<a href="https://github.com/antlr/antlr4/blob/master/doc/listeners.md">官方文档</a>）：</p><blockquote><p>Because we specify phrase structure with a set of rules, parse tree subtree roots correspond to grammar rule names. ANTLR has a ParseTreeWalker that knows how to walk these parse trees and trigger events in listener implementation objects that you can create. The ANTLR tool generates listener interfaces for you also, unless you turn that off with a commandline option. You can also have it generate visitors. For example from a Java.g4 grammar, ANTLR generates:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JavaListener</span> <span class="keyword">extends</span> <span class="title">ParseTreeListener</span>&lt;<span class="title">Token</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enterClassDeclaration</span><span class="params">(JavaParser.ClassDeclarationContext ctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">exitClassDeclaration</span><span class="params">(JavaParser.ClassDeclarationContext ctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enterMethodDeclaration</span><span class="params">(JavaParser.MethodDeclarationContext ctx)</span></span>;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>where there is an enter and exit method for each rule in the parser grammar. ANTLR also generates a base listener with the fall empty implementations of all listener interface methods, in this case called JavaBaseListener. You can build your listener by subclassing this base and overriding the methods of interest.</p><p>Listeners and visitors are great because they keep application-specific code out of grammars, making grammars easier to read and preventing them from getting entangled with a particular application.</p></blockquote></li></ul><p><a href="https://github.com/antlr/antlr4/tree/master/doc">其它相关概念见antlr在github上的官方文档</a></p><h2 id="安装antlr4"><a class="markdownIt-Anchor" href="#安装antlr4"></a> 安装antlr4</h2><p><a href="https://github.com/antlr/antlr4/blob/master/doc/getting-started.md">官方文档</a></p><ul><li><p>安装Java（1.7版或更高版本），这个不会就入土8</p></li><li><p>下载antlr4</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lib</span><br><span class="line">$ curl -O https://www.antlr.org/download/antlr-4.9-complete.jar</span><br></pre></td></tr></table></figure></li><li><p>添加<code>antlr-4.9-complete.jar</code>到<code>CLASSPATH</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> CLASSPATH=<span class="string">&quot;.:/usr/local/lib/antlr-4.9-complete.jar:<span class="variable">$CLASSPATH</span>&quot;</span></span><br></pre></td></tr></table></figure><p>将其放入<code>.bash_profile</code>，就不需要每次都改环境变量了</p></li><li><p>为ANTLR Tool和 <code>TestRig</code>创建alias：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">alias</span> antlr4=<span class="string">&#x27;java -Xmx500M -cp &quot;/usr/local/lib/antlr-4.9-complete.jar:$CLASSPATH&quot; org.antlr.v4.Tool&#x27;</span></span><br><span class="line">$ <span class="built_in">alias</span> grun=<span class="string">&#x27;java -Xmx500M -cp &quot;/usr/local/lib/antlr-4.9-complete.jar:$CLASSPATH&quot; org.antlr.v4.gui.TestRig&#x27;</span></span><br></pre></td></tr></table></figure></li></ul><p>输入antlr4验证一下安装情况：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-install-success.png" alt="" /></p><h2 id="获取targer-language为python的分析模块"><a class="markdownIt-Anchor" href="#获取targer-language为python的分析模块"></a> 获取targer language为python的分析模块</h2><h3 id="获取g4语法文件"><a class="markdownIt-Anchor" href="#获取g4语法文件"></a> 获取.g4语法文件</h3><p>ANTLR的GitHub项目中提供了用于不同语言的语法文件（.g4）</p><p><a href="https://github.com/antlr/grammars-v4">官方g4文件收录库</a></p><p>这次的需求先重点解决java的语法分析问题，所以一开始我找到了java9的g4文件，但生成分析代码的时候报错了：<br /><code>Incorrectly generated code for Python 3 target</code>，google了一番找到了对应的issue：<a href="https://github.com/antlr/grammars-v4/issues/739">https://github.com/antlr/grammars-v4/issues/739</a><br /><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-install-issue.png" alt="issue739" /></p><p>更换成https://github.com/antlr/grammars-v4/tree/master/java/java中的.g4文件后就没问题了</p><h3 id="生成分析模块"><a class="markdownIt-Anchor" href="#生成分析模块"></a> 生成分析模块</h3><p>按官方文档生成分析模块源码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">antlr4 -Dlanguage=Python3 JavaLexer.g4</span><br><span class="line">antlr4 -Dlanguage=Python3 JavaParser.g4</span><br></pre></td></tr></table></figure><p>生成结果见下图：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-get.png" alt="生成结果" /></p><p>其中<code>JavaLexer.py</code>,<code>JavaParser.py</code>,<code>JavaParserListener.py</code>是我们需要重点关注的</p><h3 id="安装antlr4-python3-runtime"><a class="markdownIt-Anchor" href="#安装antlr4-python3-runtime"></a> 安装antlr4-python3-runtime</h3><p>这步没什么好说的，直接pip install完事</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install antlr4-python3-runtime</span><br></pre></td></tr></table></figure><h2 id="创建自定义listener"><a class="markdownIt-Anchor" href="#创建自定义listener"></a> 创建自定义Listener</h2><p>我的目录结构如下：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-dir.png" alt="" /></p><h3 id="analyzerpy"><a class="markdownIt-Anchor" href="#analyzerpy"></a> <a href="http://analyzer.py">analyzer.py</a></h3><p>分析模块入口，main所在位置，废话不多说，上码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">from</span> ast_java.ast_processor <span class="keyword">import</span> AstProcessor</span><br><span class="line"><span class="keyword">from</span> ast_java.basic_info_listener <span class="keyword">import</span> BasicInfoListener</span><br><span class="line"></span><br><span class="line">logging.config.fileConfig(<span class="string">&#x27;log/utiltools_log.conf&#x27;</span>)</span><br><span class="line">AST_ANALYZER = AstProcessor(logging, BasicInfoListener())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyze_java</span>(<span class="params">target_file_path</span>):</span></span><br><span class="line">    <span class="keyword">return</span> AST_ANALYZER.execute(target_file_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    analyze_java(<span class="string">&#x27;testfiles/java/AllInOne7.java&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="ast_processorpy"><a class="markdownIt-Anchor" href="#ast_processorpy"></a> ast_processor.py</h3><p>调用antlr的语法分析模块，生成AST，供自定义Listener使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> antlr4 <span class="keyword">import</span> FileStream, CommonTokenStream, ParseTreeWalker</span><br><span class="line"><span class="keyword">from</span> ast_java.JavaLexer <span class="keyword">import</span> JavaLexer</span><br><span class="line"><span class="keyword">from</span> ast_java.JavaParser <span class="keyword">import</span> JavaParser</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pformat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AstProcessor</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, logging, listener</span>):</span></span><br><span class="line">        self.logging = logging</span><br><span class="line">        self.logger = logging.getLogger(self.__class__.__name__)</span><br><span class="line">        self.listener = listener</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">self, input_source</span>):</span></span><br><span class="line">        parser = JavaParser(CommonTokenStream(JavaLexer(FileStream(input_source, encoding=<span class="string">&quot;utf-8&quot;</span>))))</span><br><span class="line">        walker = ParseTreeWalker()</span><br><span class="line">        walker.walk(self.listener, parser.compilationUnit())</span><br><span class="line">        self.logger.debug(<span class="string">&#x27;Display all data extracted by AST. \n&#x27;</span> + pformat(self.listener.ast_info, width=<span class="number">160</span>))</span><br><span class="line">        <span class="keyword">return</span> self.listener.ast_info</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="basic_info_listenerpy"><a class="markdownIt-Anchor" href="#basic_info_listenerpy"></a> basic_info_listener.py</h3><p>这部分就完全是自定义的了，同时也是源码分析的关键，在这部分设计的分析模式决定了分析结果的数据结构</p><p>简单来说就是继承<code>JavaParserListener</code>，然后扩展自己需要的内容</p><p>具体的使用还是需要自己去读一下源码，这里放一下我写的作为参考：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ast_java.JavaParserListener <span class="keyword">import</span> JavaParserListener</span><br><span class="line"><span class="keyword">from</span> ast_java.JavaParser <span class="keyword">import</span> JavaParser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicInfoListener</span>(<span class="params">JavaParserListener</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.call_methods = []</span><br><span class="line">        self.ast_info = &#123;</span><br><span class="line">            <span class="string">&#x27;packageName&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;className&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;implements&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;extends&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;imports&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;fields&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;methods&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#packageDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterPackageDeclaration</span>(<span class="params">self, ctx: JavaParser.PackageDeclarationContext</span>):</span></span><br><span class="line">        self.ast_info[<span class="string">&#x27;packageName&#x27;</span>] = ctx.qualifiedName().getText()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#importDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterImportDeclaration</span>(<span class="params">self, ctx: JavaParser.ImportDeclarationContext</span>):</span></span><br><span class="line">        import_class = ctx.qualifiedName().getText()</span><br><span class="line">        self.ast_info[<span class="string">&#x27;imports&#x27;</span>].append(import_class)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#methodDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterMethodDeclaration</span>(<span class="params">self, ctx: JavaParser.MethodDeclarationContext</span>):</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">&quot;Start line: &#123;0&#125; | End line: &#123;1&#125; | Method name: &#123;2&#125;&quot;</span>.<span class="built_in">format</span>(ctx.start.line, ctx.methodBody().stop.line, ctx.getChild(<span class="number">1</span>).getText()))</span><br><span class="line">        self.call_methods = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Exit a parse tree produced by JavaParser#methodDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exitMethodDeclaration</span>(<span class="params">self, ctx: JavaParser.MethodDeclarationContext</span>):</span></span><br><span class="line">        c1 = ctx.getChild(<span class="number">0</span>).getText()  <span class="comment"># ---&gt; return type</span></span><br><span class="line">        c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; method name</span></span><br><span class="line">        params = self.parse_method_params_block(ctx.getChild(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">        method_info = &#123;</span><br><span class="line">            <span class="string">&#x27;startLine&#x27;</span>: ctx.start.line,</span><br><span class="line">            <span class="string">&#x27;endLine&#x27;</span>: ctx.methodBody().stop.line,</span><br><span class="line">            <span class="string">&#x27;returnType&#x27;</span>: c1,</span><br><span class="line">            <span class="string">&#x27;methodName&#x27;</span>: c2,</span><br><span class="line">            <span class="string">&#x27;params&#x27;</span>: params,</span><br><span class="line">            <span class="string">&#x27;depth&#x27;</span>: ctx.depth(),</span><br><span class="line">            <span class="string">&#x27;callMethods&#x27;</span>: self.call_methods</span><br><span class="line">        &#125;</span><br><span class="line">        self.ast_info[<span class="string">&#x27;methods&#x27;</span>].append(method_info)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#methodCall.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterMethodCall</span>(<span class="params">self, ctx: JavaParser.MethodCallContext</span>):</span></span><br><span class="line">        line_number = <span class="built_in">str</span>(ctx.start.line)</span><br><span class="line">        column_number = <span class="built_in">str</span>(ctx.start.column)</span><br><span class="line">        self.call_methods.append(line_number + <span class="string">&#x27; &#x27;</span> + column_number + <span class="string">&#x27; &#x27;</span> + ctx.parentCtx.getText())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#classDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterClassDeclaration</span>(<span class="params">self, ctx: JavaParser.ClassDeclarationContext</span>):</span></span><br><span class="line">        child_count = <span class="built_in">int</span>(ctx.getChildCount())</span><br><span class="line">        <span class="keyword">if</span> child_count == <span class="number">7</span>:</span><br><span class="line">            <span class="comment"># class Foo extends Bar implements Hoge</span></span><br><span class="line">            <span class="comment"># c1 = ctx.getChild(0)  # ---&gt; class</span></span><br><span class="line">            c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; class name</span></span><br><span class="line">            <span class="comment"># c3 = ctx.getChild(2)  # ---&gt; extends</span></span><br><span class="line">            c4 = ctx.getChild(<span class="number">3</span>).getChild(<span class="number">0</span>).getText()  <span class="comment"># ---&gt; extends class name</span></span><br><span class="line">            <span class="comment"># c5 = ctx.getChild(4)  # ---&gt; implements</span></span><br><span class="line">            <span class="comment"># c7 = ctx.getChild(6)  # ---&gt; method body</span></span><br><span class="line">            self.ast_info[<span class="string">&#x27;className&#x27;</span>] = c2</span><br><span class="line">            self.ast_info[<span class="string">&#x27;implements&#x27;</span>] = self.parse_implements_block(ctx.getChild(<span class="number">5</span>))</span><br><span class="line">            self.ast_info[<span class="string">&#x27;extends&#x27;</span>] = c4</span><br><span class="line">        <span class="keyword">elif</span> child_count == <span class="number">5</span>:</span><br><span class="line">            <span class="comment"># class Foo extends Bar</span></span><br><span class="line">            <span class="comment"># or</span></span><br><span class="line">            <span class="comment"># class Foo implements Hoge</span></span><br><span class="line">            <span class="comment"># c1 = ctx.getChild(0)  # ---&gt; class</span></span><br><span class="line">            c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; class name</span></span><br><span class="line">            c3 = ctx.getChild(<span class="number">2</span>).getText()  <span class="comment"># ---&gt; extends or implements</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># c5 = ctx.getChild(4)  # ---&gt; method body</span></span><br><span class="line">            self.ast_info[<span class="string">&#x27;className&#x27;</span>] = c2</span><br><span class="line">            <span class="keyword">if</span> c3 == <span class="string">&#x27;implements&#x27;</span>:</span><br><span class="line">                self.ast_info[<span class="string">&#x27;implements&#x27;</span>] = self.parse_implements_block(ctx.getChild(<span class="number">3</span>))</span><br><span class="line">            <span class="keyword">elif</span> c3 == <span class="string">&#x27;extends&#x27;</span>:</span><br><span class="line">                c4 = ctx.getChild(<span class="number">3</span>).getChild(<span class="number">0</span>).getText()  <span class="comment"># ---&gt; extends class name or implements class name</span></span><br><span class="line">                self.ast_info[<span class="string">&#x27;extends&#x27;</span>] = c4</span><br><span class="line">        <span class="keyword">elif</span> child_count == <span class="number">3</span>:</span><br><span class="line">            <span class="comment"># class Foo</span></span><br><span class="line">            <span class="comment"># c1 = ctx.getChild(0)  # ---&gt; class</span></span><br><span class="line">            c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; class name</span></span><br><span class="line">            <span class="comment"># c3 = ctx.getChild(2)  # ---&gt; method body</span></span><br><span class="line">            self.ast_info[<span class="string">&#x27;className&#x27;</span>] = c2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#fieldDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterFieldDeclaration</span>(<span class="params">self, ctx: JavaParser.FieldDeclarationContext</span>):</span></span><br><span class="line">        field = &#123;</span><br><span class="line">            <span class="string">&#x27;fieldType&#x27;</span>: ctx.getChild(<span class="number">0</span>).getText(),</span><br><span class="line">            <span class="string">&#x27;fieldDefinition&#x27;</span>: ctx.getChild(<span class="number">1</span>).getText()</span><br><span class="line">        &#125;</span><br><span class="line">        self.ast_info[<span class="string">&#x27;fields&#x27;</span>].append(field)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_implements_block</span>(<span class="params">self, ctx</span>):</span></span><br><span class="line">        implements_child_count = <span class="built_in">int</span>(ctx.getChildCount())</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">if</span> implements_child_count == <span class="number">1</span>:</span><br><span class="line">            impl_class = ctx.getChild(<span class="number">0</span>).getText()</span><br><span class="line">            result.append(impl_class)</span><br><span class="line">        <span class="keyword">elif</span> implements_child_count &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(implements_child_count):</span><br><span class="line">                <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                    impl_class = ctx.getChild(i).getText()</span><br><span class="line">                    result.append(impl_class)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_method_params_block</span>(<span class="params">self, ctx</span>):</span></span><br><span class="line">        params_exist_check = <span class="built_in">int</span>(ctx.getChildCount())</span><br><span class="line">        result = []</span><br><span class="line">        <span class="comment"># () ---&gt; 2</span></span><br><span class="line">        <span class="comment"># (Foo foo) ---&gt; 3</span></span><br><span class="line">        <span class="comment"># (Foo foo, Bar bar) ---&gt; 3</span></span><br><span class="line">        <span class="comment"># (Foo foo, Bar bar, int count) ---&gt; 3</span></span><br><span class="line">        <span class="keyword">if</span> params_exist_check == <span class="number">3</span>:</span><br><span class="line">            params_child_count = <span class="built_in">int</span>(ctx.getChild(<span class="number">1</span>).getChildCount())</span><br><span class="line">            <span class="keyword">if</span> params_child_count == <span class="number">1</span>:</span><br><span class="line">                param_type = ctx.getChild(<span class="number">1</span>).getChild(<span class="number">0</span>).getChild(<span class="number">0</span>).getText()</span><br><span class="line">                param_name = ctx.getChild(<span class="number">1</span>).getChild(<span class="number">0</span>).getChild(<span class="number">1</span>).getText()</span><br><span class="line">                param_info = &#123;</span><br><span class="line">                    <span class="string">&#x27;paramType&#x27;</span>: param_type,</span><br><span class="line">                    <span class="string">&#x27;paramName&#x27;</span>: param_name</span><br><span class="line">                &#125;</span><br><span class="line">                result.append(param_info)</span><br><span class="line">            <span class="keyword">elif</span> params_child_count &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(params_child_count):</span><br><span class="line">                    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                        param_type = ctx.getChild(<span class="number">1</span>).getChild(i).getChild(<span class="number">0</span>).getText()</span><br><span class="line">                        param_name = ctx.getChild(<span class="number">1</span>).getChild(i).getChild(<span class="number">1</span>).getText()</span><br><span class="line">                        param_info = &#123;</span><br><span class="line">                            <span class="string">&#x27;paramType&#x27;</span>: param_type,</span><br><span class="line">                            <span class="string">&#x27;paramName&#x27;</span>: param_name</span><br><span class="line">                        &#125;</span><br><span class="line">                        result.append(param_info)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里简单说明一下几个重要的点，便于理解：</p><ul><li><code>BasicInfoListener</code>继承<code>JavaParserListener</code>，供用户自定义遍历AST的方法</li><li><code>ast_info</code>为分析结果<code>dict</code></li><li><code>JavaParserListener</code>覆盖在<code>BasicInfoListener</code>中定义的挂钩点分析方法，并实现其自己的分析过程<br />例如，<code>enterPackageDeclaration</code>，顾名思义，它在Java源码包定义的开头（即enter）被调用<br />参数<code>ctx</code>（上下文）具有不同的类型，但是由于存在父类，因此任何上下文类都可以访问语法解析所需的基本信息（通过getChild,getParent等方法）</li></ul><p>还有很多的细节信息其实都有，这里就不一一赘述（都在源码里啦）</p><h2 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h2><p>到这里分析模块就完成啦，用<a href="https://github.com/antlr/grammars-v4/tree/master/java/java/examples">官方提供的Java被测源码</a>试一下效果8</p><p>命令行输出：<br /><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-console.png" alt="" /></p><p>ast_info：<br /><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-res.png" alt="" /></p><p>Done（antlr比ctags不知道好用多少倍）</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Whosbug </tag>
            
            <tag> 语法分析 </tag>
            
            <tag> python </tag>
            
            <tag> antlr4 </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DEM项目日志</title>
      <link href="/2020/11/29/DEM%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97/"/>
      <url>/2020/11/29/DEM%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>在Whosbug项目即将上线，已经开始mr合流、code review的时候，突然被领导拉去做DEM了（还是挺突然的）</p><p><strong>DEM</strong> 是基于Go开发的一套完善的告警系统，而我当时对于Go语言的使用仅限于简单使用iris框架和日常刷算法题，所以分配到这个需求还是很虚的</p><h2 id="dem一期开发工作"><a class="markdownIt-Anchor" href="#dem一期开发工作"></a> DEM一期开发工作</h2><p>和Whosbug不同，这次DEM的项目开发工作，我是半途加入的，而且是远程工作，所以免不了项目接入成本和环境成本，也是这次经历让我明白了为什么那么多公司不愿意提供远程实习的岗位</p><h3 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h3><h4 id="接入项目"><a class="markdownIt-Anchor" href="#接入项目"></a> 接入项目</h4><p>接到需求的第一天与学长进行了对接会议，当天和之后的一天按学长的介绍读了下我负责的alert模块的代码，熟悉一点了之后，开始尝试着手写负责的功能模块</p><h4 id="完成功能模块"><a class="markdownIt-Anchor" href="#完成功能模块"></a> 完成功能模块</h4><p>这部分工作在熟悉了数据流和数据结构后比我想象的要简单，一些细节问题上问了下学长之后，一个下午就写完了，与学长确认后认为应该妹有问题，但还是需要测试的</p><h4 id="测试环境准备"><a class="markdownIt-Anchor" href="#测试环境准备"></a> 测试环境准备</h4><p>配置好vscode的远程调试（卡了三天）</p><p>配置好依赖和一系列环境变量（卡了三天）</p><p>至此终于能正常调试了<br />大概这就是remote吧，踩了少说十个坑…</p><h4 id="功能模块的单元测试"><a class="markdownIt-Anchor" href="#功能模块的单元测试"></a> 功能模块的单元测试</h4><p>搭好环境过后开始马不停蹄地测试，期间遇到了一些问题（kafka消息长度校验，模块某些方法的缺陷等），但都一一解决了，都没有被卡很久，一个周末就完成了整个模块所有数据流的测试</p><h3 id="难点"><a class="markdownIt-Anchor" href="#难点"></a> 难点</h3><h4 id="接入项目-2"><a class="markdownIt-Anchor" href="#接入项目-2"></a> 接入项目</h4><p>因为太久没读过go了而且并没有读过大型go项目的源码，所以读起来还是比较生疏，甚至一些简单的结构都还要反应一下才能明白是什么意思，不过边读边和学长询问讨论，慢慢还是熟悉了数据结构和数据流</p><h4 id="测试环境准备-2"><a class="markdownIt-Anchor" href="#测试环境准备-2"></a> 测试环境准备</h4><p>因为DEM还没有配好灰度，而且之前whosbug没用到过远程调试，所以还需要配一下远程调试，一开始想试一下Goland的远程调试，好不容易挂上代理，sftp连上内网开发机之后，才发现jetbrain家的远程调试是基于 <strong>Delve</strong> 的，而基于 <strong>Delve</strong>就需要云主机开放一个端口，但腾讯Devcloud的云主机对外网只开放几个端口，都已经占用了，最后还是选择用vscode 的SSH调试</p><p>通过corkscrew挂上腾讯IOA的代理，并改了云主机中sshd的AllowTcpForwarding设置、删除~/.vscode-server后重连后，总算是能正常调试早就写好的功能模块了（这里卡了三天）</p><p>正常连接上了还没结束，要想正常调试功能模块，还得先把依赖都装上，通过docker装上了postgre,redis和kafka（期间还遇到了dockerhub限制pull次数的问题以及docker版本问题），并在pg内建好一系列要用的表，插入数据后；我以为万事俱备了，然而实际运行的时候却连不上kafka，在开发机试了下curl连接容器，报了个<code>connection reset by peer</code>，google一番发现是docker的网络问题，docker run的时候加上了–net指定了网络后就能正常访问了</p>]]></content>
      
      
      <categories>
          
          <category> 项目日志 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> 后端 </tag>
            
            <tag> 后台开发 </tag>
            
            <tag> kafka </tag>
            
            <tag> 数据库 </tag>
            
            <tag> docker </tag>
            
            <tag> k8s </tag>
            
            <tag> 计算机网络 </tag>
            
            <tag> SSH </tag>
            
            <tag> vscode </tag>
            
            <tag> remote调试 </tag>
            
            <tag> DEM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s-RoadMap</title>
      <link href="/2020/11/28/K8s-RoadMap/"/>
      <url>/2020/11/28/K8s-RoadMap/</url>
      
        <content type="html"><![CDATA[<h3 id="k8s-是什么"><a class="markdownIt-Anchor" href="#k8s-是什么"></a> K8s 是什么 ?</h3><p>容器编排工具，简单来讲，就是把一系列服务联合或非联合部署起来</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/">Kubernetes 是什么？</a></li></ul><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/components-of-kubernetes.svg" alt="K8s 架构" /></p><h3 id="k8s-有何优势"><a class="markdownIt-Anchor" href="#k8s-有何优势"></a> K8s 有何优势 ？</h3><ul><li>多种应用混合部署以降低成本</li><li>管理大规模复杂应用</li><li>更好的应用可观测性 (容器维度，而非机器维度)</li><li>以 K8s 为核心的丰富的工具链</li></ul><h3 id="几个必须了解的词"><a class="markdownIt-Anchor" href="#几个必须了解的词"></a> 几个必须了解的词</h3><ul><li><code>kubectl</code>: kubectl 是管理 k8s 集群的命令行客户端</li><li><code>Helm3</code>: K8s 应用打包/发布工具</li><li><code>Docker</code>: 容器引擎</li></ul><h2 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h2><p><code>Docker</code> 是新时代虚拟化，云原生的基础, 尽管有多种容器化的方案，但是 Docker 目前是事实标准</p><p>Docker 的官方文档emmmm，还是看别的博客文章吧：</p><ul><li><a href="https://yeasy.gitbook.io/docker_practice/introduction/what">什么是 Docker</a></li><li><a href="https://yeasy.gitbook.io/docker_practice/image/build">使用 Dockerfile 定制镜像</a></li><li><a href="https://www.jianshu.com/p/7c9e2247cfbd">Docker 常用指令详解</a></li></ul><h2 id="k8s-nodepodcontainer"><a class="markdownIt-Anchor" href="#k8s-nodepodcontainer"></a> K8s Node/Pod/Container</h2><blockquote><p><strong>Container</strong> 自然不用说，是docker中的基本概念（实例化的<strong>Image</strong>）<br /><strong>Node</strong> 相当于物理节点，一个 <strong>Node</strong> 中可能有多个 <strong>Pod</strong> ，每个 <strong>Node</strong> 会对应一个子网段，如<code>10.10.10.1/24</code>，而其中的每个 <strong>Pod</strong> 都会分配一个子网<br /><strong>Pod</strong> 是K8s调度的基本单位, 一个 <strong>Pod</strong> 包含几个关系紧密的 <strong>Container</strong><br /><strong>Pod</strong> 是 K8s 的逻辑概念，<strong>Node</strong>/<strong>Container</strong> 都是在 K8s 前已经有的概念</p></blockquote><p>为何要有 <strong>Pod</strong> ? 就如 <strong>Pod</strong> 本来的含义 <code>豌豆荚</code> 一样，容器就是每颗<code>豌豆</code></p><p>例如一个 Web网站的一个实例主要由: 一个 Nginx 容器组成，但是又想要做日志收集，又想要做指标收集，就可以额外加2个容器分别做这两件事情。<br />而将业务容器 Nginx, 日志收集，指标收集三个容器打包为一个<strong>Pod</strong>，因为这三个容器需要物理上在一台节点，而 <strong>Pod</strong> 这个概念可以描述这种情形。</p><ul><li><a href="https://kubernetes.io/zh/docs/tutorials/kubernetes-basics/explore/explore-intro/">Pod/Node 概念</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/containers/">Container文档</a></li></ul><h2 id="k8s-工作负载"><a class="markdownIt-Anchor" href="#k8s-工作负载"></a> K8s 工作负载</h2><p><code>Deployment</code>, <code>StatefulSets</code>, <code>DaemonSet</code>, <code>Job</code>, <code>CronJob</code> 是 K8s 常见的几种负载类型，了解这几种负载的使用场景，<br />并且动手去完成相关的例子，或许会对 K8s 的使用有一个认知（其实只了解Deployment在大部分时候也是够用的，但如果都会，就卷的过别人咯）</p><h3 id="deployment"><a class="markdownIt-Anchor" href="#deployment"></a> Deployment</h3><p>Deployment 是最常用的无状态服务部署方式，例如 Web 网站服务。<br /><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment 文档</a></p><h3 id="statefulsets"><a class="markdownIt-Anchor" href="#statefulsets"></a> StatefulSets</h3><p>StatefulSets 是最常用的有状态服务部署方式，一般需要使用存储的服务都会是 StatefulSets，例如 数据库。<br /><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/">StatefulSets 文档</a></p><h3 id="daemonset"><a class="markdownIt-Anchor" href="#daemonset"></a> DaemonSet</h3><p>DaemonSet 一般用于每个节点部署仅一个实例的情况，典型为 Agent，主机日志收集等。<br /><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/">StatefulSets 文档</a></p><h3 id="job"><a class="markdownIt-Anchor" href="#job"></a> Job</h3><p>Job 一般用于只需运行一次的临时性工作，例如进行一次压测任务。<br /><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/job/">Job 文档</a></p><h3 id="cronjob"><a class="markdownIt-Anchor" href="#cronjob"></a> CronJob</h3><p>CronJob 一般用于需要定期执行的任务，例如清理旧的数据。<br /><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/cron-jobs/">CronJob 文档</a></p><h2 id="pvpvc"><a class="markdownIt-Anchor" href="#pvpvc"></a> PV/PVC</h2><p>PV 代表了 K8s 的存储抽象概念，让单实例的有状态应用也获得了单机故障容忍能力，因为随时可以将存储/容器都切换到另一台主机。</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">PV</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/">PVC</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">Storage Classes</a></li></ul><h2 id="serviceingressdns"><a class="markdownIt-Anchor" href="#serviceingressdns"></a> Service/Ingress/DNS</h2><p>K8s Service 代表了 K8s 的网络抽象概念<br />我们有时候发现，即使Pod因为故障迁移到另一台主机，服务仍然能够正常运行，便是依赖 Service 提供的能力</p><p>K8s 解决的问题:</p><ul><li>一个 Pod 中的容器之间通过本地回路（loopback）通信</li><li>集群网络在不同 pod 之间提供通信</li><li>Service 资源允许你对外暴露 Pods 中运行的应用程序，以支持来自于集群外部的访问</li><li>可以使用 Services 来发布仅供集群内部使用的服务</li></ul><p>参考:</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/services-networking/">K8s 文档</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">Service</a></li></ul><p>Ingress 是 LB 的抽象，用于将服务以统一入口暴露</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">Ingress</a></li></ul><h2 id="调度"><a class="markdownIt-Anchor" href="#调度"></a> 调度</h2><p>调度是 K8s 得以<strong>提升资源利用率</strong>的重要手段，也是大部分K8s初学者与熟练使用者的分水岭<br />简而言之，调度就是如何决定每一个Pod应该位于哪个节点上<br />有许多因素需要考虑:</p><ul><li>Pod 需要的资源大小, CPU/Memory</li><li>每个主机总资源/剩余资源大小</li><li>尽量分散在不同的主机/可用区，提升容灾能力</li><li>是否考虑就地重启</li><li>Pod 是否必须调度到一些合适的机型 (例如有SSD硬盘)</li><li>Pod 是否最好和其他关系紧密的 Pod 调度到相同主机</li></ul><p>一般讲，调度会涉及到 <code>NodeSelector 节点选择</code>, <code>Affinity and anti-affinity 亲和性调度</code></p><ul><li><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector">NodeSelector 调度</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#%E4%BA%B2%E5%92%8C%E4%B8%8E%E5%8F%8D%E4%BA%B2%E5%92%8C">亲和性调度</a></li></ul><p>如果想要实现按照自己需求的调度，可以参考 <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-scheduling/624-scheduling-framework/README.md#configuring-plugins">Scheduling Framework</a></p><h2 id="rbac"><a class="markdownIt-Anchor" href="#rbac"></a> RBAC</h2><p>RBAC 是 K8s API 的权限控制策略，在需要使用 K8s API 时会涉及，尤其是需要在容器内部访问 API 时, 通常需要赋予容器足够的权限</p><ul><li><a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/">RBAC 文档</a></li></ul><h2 id="helm"><a class="markdownIt-Anchor" href="#helm"></a> Helm</h2><p>当应用规模变大，有许多服务需要管理的时候，Helm 是非常重要的一个工具<br />Helm 与 Kubectl 关系是: Helm 专门做应用部署并且很专业，可以管理比较复杂的应用。而 kubectl 部署简单的应用也是可以的，并且 Kubectl 也是管理K8s 集群的重要工具，所以 Helm 并不能替代 kubectl, 但是 Helm 可以让复杂应用的部署发布更轻松</p><p>Helm 是一个比较大并且实践性较强的 Topic，需要按照官方文档对照去练习</p><p>一定要用 Helm3，一定要用 Helm3，一定要用 Helm3</p><ul><li><a href="https://helm.sh/zh/docs/intro/">新手入门</a></li><li><a href="https://artifacthub.io/packages/search?page=1">Helm 仓库: Artifact Hub</a></li><li><a href="https://github.com/helm/charts">Helm 仓库: github charts</a></li></ul><h2 id="custom-resources-operator"><a class="markdownIt-Anchor" href="#custom-resources-operator"></a> Custom Resources &amp; Operator</h2><p>Custom Resources(自定义资源) 是 K8s 得以成功的关键因素之一<br />使 K8s 的 API 可以得到第三方扩展，例如 Spark 利用 Custom Resources 创建了 Spark-Operator，用于更方便的创建 Spark Job</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resources</a></li><li><a href="https://coreos.com/blog/introducing-operators.html">Operator</a></li></ul><p>如果要开发自己的 Operator，可以参考 <a href="https://operatorframework.io/">Operator Framework</a></p><h2 id="扩展阅读"><a class="markdownIt-Anchor" href="#扩展阅读"></a> 扩展阅读</h2><ul><li><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/44843.pdf">Borg, Omega, and Kubernetes，强烈推荐阅读，了解 Kubernetes 在Google内部的发展过程</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/overview/components/">Kubernetes 组件</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/architecture/">Kubernetes 架构</a></li><li><a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/43438.pdf">Large-scale cluster management at Google with Borg</a></li><li><a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/41684.pdf">Omega: flexible, scalable schedulers for large compute clusters</a></li><li><a href="https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt">Linux cgroups</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> docker </tag>
            
            <tag> k8s </tag>
            
            <tag> 虚拟化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Whosbug项目日志1</title>
      <link href="/2020/11/27/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%971/"/>
      <url>/2020/11/27/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%971/</url>
      
        <content type="html"><![CDATA[<h1 id="whosbug项目日志1"><a class="markdownIt-Anchor" href="#whosbug项目日志1"></a> Whosbug项目日志1</h1><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>从八月份的企业实训到现在，关于whosbug断断续续也开发了一个多月了（实际开发时间），</p><p>在正式上线前小小总结一下吧</p><h2 id="开发初期"><a class="markdownIt-Anchor" href="#开发初期"></a> 开发初期</h2><h3 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h3><p>​刚从腾讯那里拿到这个需求（或者说idea吧）的时候，还觉得挺简单的，基于Git不就可以很快找到是谁的问题了嘛但仔细想了想，这个需求是需要从项目报错的日志出发，最终找到责任人，这就涉及源码结构了（或者说语法分析、源码分析），还是…比较复杂的</p><p>作为开发小组组长，当时决定先花半周到一周的时间确定下来项目架构以及数据库设计等（作为软件工程专业学生，还是要明白需求分析以及系统设计的重要性的）</p><p>几天过后确定了初步的架构：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/whosbug%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="架构图" /></p><p>并完成了数据库的设计（这里就不po出来了）</p><p>分工后就开始正式的开发流程了，使用的协作平台是coding，每天联调任务的感觉还是挺新奇的（毕竟之前基本上都是单人开发或者双人开发，而且基本都不用任务协同）</p><h3 id="难点"><a class="markdownIt-Anchor" href="#难点"></a> 难点</h3><p>项目初期的架构设计还是有一定难度的，尤其是对基于git以及源码的分析结果的数据结构设计等</p><p>个人对docker、CICD以及Django不是很熟悉（docker只有一点点了解，Django之前没有用过，只用过flask），导致在win下使用ctags容器分析源码时连续踩坑，卡了比较久的时间</p><h2 id="开发中期"><a class="markdownIt-Anchor" href="#开发中期"></a> 开发中期</h2><h3 id="过程-2"><a class="markdownIt-Anchor" href="#过程-2"></a> 过程</h3><p>经过大约一周的马不停蹄的开发，项目各个模块在解决一系列问题后，基本上完成了各自的功能实现</p><p>源码分析模块能够输出分析结果的json文件，webservice完成本地部署，CI流水线方面也有了初步的设计</p><p>随后又花了一周时间在单元测试以及集成测试上，最后的部署方案是在腾讯云的k8s集群上部署，初次接触k8s自然是比较懵逼的，光速学了一天之后直接上手部署，调试两天配置文件后总算是部署完成了</p><p>最后准备了两天ppt，完成了实训答辩（2020.8.14）</p><p>DONE</p><h3 id="难点-2"><a class="markdownIt-Anchor" href="#难点-2"></a> 难点</h3><h4 id="语法分析"><a class="markdownIt-Anchor" href="#语法分析"></a> 语法分析</h4><p>语法分析方面，通过建立源码文件后缀与对应语言的映射关系，能基本完成大部分主流语言的语法分析，但ctags对部分语言的支持性不够好，当时采用的解决方案是支持性不好的语言通过正则表达式进行支持，如swift, kotlin等；ctags支持的正则表达式居然需要使用<strong>POSIX字符集</strong>，之前没有接触过，写起来还是比较不习惯的</p><h4 id="功能缺陷"><a class="markdownIt-Anchor" href="#功能缺陷"></a> 功能缺陷</h4><p>针对git更新中只更改方法名的特殊情况，我们讨论后得出了以下解决方案：每次diff分析前进行函数更名的检测，并维护新旧对象名的映射关系</p><p>针对内部类的情况，我们讨论后得出了以下解决方案：在找到变更函数后，基于ctags的分析结果，通过递归搜索找寻方法的外层类，同时在对象的存储数据结构上，借鉴链表的思想，在变更方法属性增加parent_name一项，记录完整的语法结构（这部分信息也为数据分析提供了更多的信息，以定位更准确的责任人）</p><h4 id="项目部署"><a class="markdownIt-Anchor" href="#项目部署"></a> 项目部署</h4><p>初学k8s，对k8s的各种概念不熟悉，写配置文件的时候比较懵，经常被很低级的错误卡住，不过最后还是一一解决了，新技能get</p><h2 id="开发后期"><a class="markdownIt-Anchor" href="#开发后期"></a> 开发后期</h2><h3 id="过程-3"><a class="markdownIt-Anchor" href="#过程-3"></a> 过程</h3><p>再次接触whosbug这个项目已经是九月下旬了(2020.9.24)，正式开始腾讯实习</p><p>第一个需求就是把whosbug迁移到内网，并完成最后的改进、showcase、最后内部上线使用</p><h4 id="蓝盾流水线插件"><a class="markdownIt-Anchor" href="#蓝盾流水线插件"></a> 蓝盾流水线插件</h4><p>由于最后实现的形式是一个CI流水线插件的形式（蓝盾平台），所以在熟悉工作环境后花了两三天时间开发了whosbug的蓝盾流水线插件，并又花了两天时间单元测试，解决了一系列环境问题后， DONE（2020.10.13）</p><h4 id="加密模块的开发和使用"><a class="markdownIt-Anchor" href="#加密模块的开发和使用"></a> 加密模块的开发和使用</h4><p>由于whosbug使用的数据库在外网，而其数据又涉及源码信息以及用户信息等敏感信息，所以和腾讯的前辈讨论后认为数据需要加密，小组内经过讨论和设计并与前辈确认后，花了一天时间进行开发和单元测试，并投入使用</p><h4 id="灰度环境部署"><a class="markdownIt-Anchor" href="#灰度环境部署"></a> 灰度环境部署</h4><p>虽然实训期间也基于k8s部署过，但环境完全不一样了，而且标准也不一样，与实训时的简单部署相比，配置文件中多了许多其它当时没有见过的字段；我参考了QAPM项目的其它很多部署项目的配置文件，边学边改边实践部署，一周半左右过后终于完成了部署</p><h4 id="showcase准备"><a class="markdownIt-Anchor" href="#showcase准备"></a> showcase准备</h4><p>showcase的方式是投入生产环境中的真实项目来测试使用，被测项目是QAPM内的一个app项目<br />—— <strong>LeafPic_qapm_newmonkey</strong>（<a href="https://github.com/HoraApps/LeafPic"> LeafPic 原项目地址</a>）<br />本身是一个在Github上面的知名相册app，里面埋入了卡顿、ANR、Crash等问题，便于测试<br />测试流程还需要与腾讯的NewMonkey项目对接进行，在与NewMonkey的一位负责人进行了几天的加班调试对接后，完整走了整个showcase流程，最终能够输出责任人以及对应缺陷到TAPD的缺陷页面（这个过程中遇到了许多问题，果然再完善的项目一旦投入生产环境使用，一定是会遇到各种各样的问题的，更何况是稚嫩的whosbug了hh）</p><h4 id="接入tps鉴权以及加入反馈模块"><a class="markdownIt-Anchor" href="#接入tps鉴权以及加入反馈模块"></a> 接入TPS鉴权以及加入反馈模块</h4><p>询问前辈后接入了CSIG的TPS鉴权模块<br />加入了对责任人结果正确与否的反馈模块</p><h3 id="难点-3"><a class="markdownIt-Anchor" href="#难点-3"></a> 难点</h3><h4 id="ci流水线插件开发"><a class="markdownIt-Anchor" href="#ci流水线插件开发"></a> CI流水线插件开发</h4><p>由于CI流水线的高自由度，其环境复杂多变，而且whosbug插件是基于python开发的，那就一定离不开python2 / python3兼容性的问题，我参考了很多python项目的解决方案，发现大多数项目都是直接分为python2版本和python3版本，于是我也按这个想法走，基于python的setuptools开发了两套whosbug插件</p><h4 id="加密模块"><a class="markdownIt-Anchor" href="#加密模块"></a> 加密模块</h4><p>由于whosbug的某些设计，我们对加密方式有一定的要求，即保证密文的有序性（使用流加密方法），个人对密码学一窍不通，只会调包，与组内成员交流测试并解决一些编码问题后，终于能正常投入使用了</p><h4 id="项目部署-2"><a class="markdownIt-Anchor" href="#项目部署-2"></a> 项目部署</h4><p>跟我预想的一样，在腾讯内网的正式环境部署的标准与以前在学校打比赛随手部署的标准完全不一样<br />首先就是k8s的调度问题，相关的配置之前我从来没有接触过，还好可以参考其它项目的配置文件配合学习，这部分很快就照猫画虎地写好了，但实际部署时还是会出问题，通过kubectl命令行工具仔细排查后发现在连接数据库容器时出现了一些问题，与组内前辈交流后处理了一系列问题，并更正了健康检查（livenessProbe）的相关配置后，部署成功</p><h4 id="语法分析工具的缺陷"><a class="markdownIt-Anchor" href="#语法分析工具的缺陷"></a> 语法分析工具的缺陷</h4><p>在准备showcase与负责人对接的过程中发现了ctags对java的语法分析能力十分有限，导致很多堆栈没法找到对应的owner，最终换了被测项目才终于能正常找到责任人</p><h2 id="todo"><a class="markdownIt-Anchor" href="#todo"></a> TODO</h2><h4 id="语法分析能力"><a class="markdownIt-Anchor" href="#语法分析能力"></a> 语法分析能力</h4><p>在后期投入生产环境使用的过程中发现ctags的语法分析能力严重不足，目前花了一周左右的时间研究了下其它的一些语法分析工具，主要看了下针对java的语法分析工具：</p><blockquote><p>antlr4</p><p>javac-parser</p><p>javaparser</p><p>javalang</p><p>astgen</p><p>plyj</p></blockquote><p>一圈试用下来，要么就是不支持对具有不完整语法结构的代码的分析，要么是对一些细节上兼容性不好，最后还是选择了antlr4，虽然它的target language为python的文档不多，但我还是慢慢摸索写出了一个能完整分析AllInOneJava7和AllInOneJava8（含有Java7和Java8所有语法结构的源码）的模块，而且antlr本身是一个框架，只需要编写各个语言对应的.g4（语法树）文件，就可以分析各种语言了，后续可以基于antlr4优化我们的语法分析能力</p><h4 id="源码分析数据结构的改进以及数据分析方式和架构的改进"><a class="markdownIt-Anchor" href="#源码分析数据结构的改进以及数据分析方式和架构的改进"></a> 源码分析数据结构的改进以及数据分析方式和架构的改进</h4><p>目前的数据结构较为简单（也是因为ctags的分析能力有限），进而导致数据分析方式和架构也比较幼稚，待语法分析换成antlr4后，这部分能力也需要跟进提高</p><p><a href="https://github.com/src-d/awesome-machine-learning-on-source-code">一些相关的论文</a></p>]]></content>
      
      
      <categories>
          
          <category> 项目日志 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后端 </tag>
            
            <tag> docker </tag>
            
            <tag> k8s </tag>
            
            <tag> Whosbug </tag>
            
            <tag> 语法分析 </tag>
            
            <tag> python </tag>
            
            <tag> Django </tag>
            
            <tag> antlr4 </tag>
            
            <tag> ctags </tag>
            
            <tag> CICD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pandas 大文件操作</title>
      <link href="/2020/11/27/pandas-%E5%A4%A7%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/"/>
      <url>/2020/11/27/pandas-%E5%A4%A7%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="常规的读取大文件的步骤"><a class="markdownIt-Anchor" href="#常规的读取大文件的步骤"></a> 常规的读取大文件的步骤</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./data/ows-raw.txt&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">reader = pd.read_table(f,  sep=<span class="string">&#x27;,&#x27;</span>,  iterator=<span class="literal">True</span>, error_bad_lines=<span class="literal">False</span>) <span class="comment">#跳过报错行</span></span><br><span class="line">loop = <span class="literal">True</span></span><br><span class="line">chunkSize = <span class="number">100000</span></span><br><span class="line">chunks = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> loop:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        chunk = reader.get_chunk(chunkSize)</span><br><span class="line">        chunks.append(chunk)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        loop = <span class="literal">False</span></span><br><span class="line">        print(<span class="string">&quot;Iteration is stopped.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">df = pd.concat(chunks, ignore_index=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2 id="story"><a class="markdownIt-Anchor" href="#story"></a> STORY</h2><p>这几天有一个需求是读取.dta文件并转为.csv，google了一下发现pandas也是支持dta格式的</p><p>于是直接开写，20行搞定</p><p>然而事情并没有那么简单…</p><p>read_stata方法就直接抛出ValueError了：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/pandas-%E5%A4%A7%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C-1.png" alt="1" /></p><p>又Google了一下，github issues上没有解决了的，stackoverflow里倒是有提议，但貌似不是抛出这个error</p><h2 id="解决"><a class="markdownIt-Anchor" href="#解决"></a> 解决</h2><p>无奈还是自己去读源码了，发现StataReader的get_chunk方法貌似在不给出chunksize时不能默认读取全部，无奈只能采用了下面的方法二分chunksize直到读取完毕：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target_path = <span class="string">&#x27;./data/excel/&#123;&#125;.csv&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dta_to_excel</span>(<span class="params">origin_path</span>):</span></span><br><span class="line">    CHUNKSIZE = <span class="number">2000</span></span><br><span class="line">    reader = pd.read_stata(origin_path, iterator=<span class="literal">True</span>)</span><br><span class="line">    file_name = re.sub(<span class="string">r&#x27;\.dta&#x27;</span>, <span class="string">&#x27;&#x27;</span>, origin_path.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line">    print(<span class="string">&#x27;&#123;&#125; translate start&#x27;</span>.<span class="built_in">format</span>(file_name))</span><br><span class="line"></span><br><span class="line">    chunks = []</span><br><span class="line">    <span class="keyword">while</span> CHUNKSIZE &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(<span class="string">&#x27;Will get &#123;&#125; lines&#x27;</span>.<span class="built_in">format</span>(CHUNKSIZE))</span><br><span class="line">            chunk = reader.get_chunk(CHUNKSIZE)</span><br><span class="line">            chunks.append(chunk)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            print(<span class="string">&#x27;CHUNKSIZE too large&#x27;</span>)</span><br><span class="line">            CHUNKSIZE //= <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    df = pd.concat(chunks, ignore_index=<span class="literal">True</span>)</span><br><span class="line">    df.to_csv(target_path.<span class="built_in">format</span>(file_name))</span><br><span class="line">    print(<span class="string">&#x27;&#123;&#125; translated done&#x27;</span>.<span class="built_in">format</span>(file_name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    origin_dir = <span class="string">&#x27;./data/origin&#x27;</span></span><br><span class="line">    <span class="comment">#  os.listdir:列出目标路径下的所有文件（文件夹）</span></span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> os.listdir(origin_dir):</span><br><span class="line">        dta_to_excel(os.path.join(origin_dir, path))</span><br></pre></td></tr></table></figure><p>总算是能正常输出了…</p>]]></content>
      
      
      <categories>
          
          <category> 技术文章 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> pandas </tag>
            
            <tag> stata </tag>
            
            <tag> 大文件IO </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
