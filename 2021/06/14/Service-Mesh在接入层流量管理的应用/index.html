<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Service Mesh在接入层流量管理的应用 | Kevinello</title><meta name="keywords" content="Golang,后端,Kubenetes,虚拟化技术,Service Mesh,流量管理,灰度发布,Istio"><meta name="author" content="Kevinello"><meta name="copyright" content="Kevinello"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="service mesh是什么  A service mesh, like the open source project Istio, is a way to control how different parts of an application share data with one another. Unlike other systems for managing this comm"><meta property="og:type" content="article"><meta property="og:title" content="Service Mesh在接入层流量管理的应用"><meta property="og:url" content="http://kevinello.ltd/2021/06/14/Service-Mesh%E5%9C%A8%E6%8E%A5%E5%85%A5%E5%B1%82%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8/index.html"><meta property="og:site_name" content="Kevinello"><meta property="og:description" content="service mesh是什么  A service mesh, like the open source project Istio, is a way to control how different parts of an application share data with one another. Unlike other systems for managing this comm"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614183524.png"><meta property="article:published_time" content="2021-06-14T10:32:54.000Z"><meta property="article:modified_time" content="2022-07-05T11:06:04.317Z"><meta property="article:author" content="Kevinello"><meta property="article:tag" content="Golang"><meta property="article:tag" content="后端"><meta property="article:tag" content="Kubenetes"><meta property="article:tag" content="虚拟化技术"><meta property="article:tag" content="Service Mesh"><meta property="article:tag" content="流量管理"><meta property="article:tag" content="灰度发布"><meta property="article:tag" content="Istio"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614183524.png"><link rel="shortcut icon" href="/imgs/K.jpg"><link rel="canonical" href="http://kevinello.ltd/2021/06/14/Service-Mesh%E5%9C%A8%E6%8E%A5%E5%85%A5%E5%B1%82%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2a20aecba22b2eaf60183c4831d9a52";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RV8K5FBVX5"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RV8K5FBVX5")</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"13UJR6CRNO","apiKey":"456e56f51ec27a1e13d67bef144f6747","indexName":"Kevinello_blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Service Mesh在接入层流量管理的应用",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-07-05 19:06:04"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2232093_k6128tldgy.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/myself-e3fde6.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">90</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614183524.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kevinello</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Service Mesh在接入层流量管理的应用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-14T10:32:54.000Z" title="发表于 2021-06-14 18:32:54">2021-06-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-05T11:06:04.317Z" title="更新于 2022-07-05 19:06:04">2022-07-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Service Mesh在接入层流量管理的应用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="service-mesh是什么"><a class="markdownIt-Anchor" href="#service-mesh是什么"></a> service mesh是什么</h2><blockquote><p>A service mesh, like the open source project <a target="_blank" rel="noopener" href="https://www.redhat.com/en/topics/microservices/what-is-istio">Istio,</a> is a way to control how different parts of an application share data with one another. Unlike other systems for managing this communication, a service mesh is a dedicated infrastructure layer built right into an app. This visible infrastructure layer can document how well (or not) different parts of an app interact, so it becomes easier to optimize communication and avoid downtime as an app grows.</p><p>Each part of an app, called a “service,” relies on other services to give users what they want. If a user of an online retail app wants to buy something, they need to know if the item is in stock. So, the service that communicates with the company’s inventory database needs to communicate with the product webpage, which itself needs to communicate with the user’s online shopping cart. To add business value, this retailer might eventually build a service that gives users in-app product recommendations. This new service will communicate with a database of product tags to make recommendations, but it also needs to communicate with the same inventory database that the product page needed—it’s a lot of reusable, moving parts.</p><p>Modern applications are often broken down in this way, as a network of services each performing a specific business function. In order to execute its function, one service might need to request data from several other services. But what if some services get overloaded with requests, like the retailer’s inventory database? This is where a service mesh comes in—it routes requests from one service to the next, optimizing how all the moving parts work together.</p></blockquote><p><strong>提取重点：</strong></p><blockquote><p>A service mesh, is a way to control how different parts of an application share data with one another. Unlike other systems for managing this communication, a service mesh is a dedicated infrastructure layer built right into an app. Service mesh routes requests from one service to the next, optimizing how all the moving parts work together.</p></blockquote><p><strong>翻译一下：</strong></p><blockquote><p>服务网格是一种控制应用程序的不同部分如何共享数据的方法，不同于其他用于管理这类通信的系统，服务网格是直接内置在应用程序中的专用基础结构层。服务网格提供服务间请求的路由功能（负载均衡），从而优化所有服务的协同工作</p></blockquote><h2 id="需要了解的词"><a class="markdownIt-Anchor" href="#需要了解的词"></a> 需要了解的词</h2><ul><li><code>k8s</code>(<code>Kubenetes</code>)：容器化管理服务的事实标准（<a href="https://kevinello.ltd/2020/11/28/k8s-RoadMap/">k8s RoadMap</a>）</li><li><code>microservices</code>：微服务-也称为微服务架构-是一种架构样式，可将应用程序构造为一组服务;在微服务架构下我们可以快速，频繁且可靠地交付大型，复杂的应用程序</li><li>集群：一般意义上K8S的部属单位，也指一组受管理的物理机器</li><li>灰度发布：给予一部分用户体验应用新版本内容的发布方式</li><li>PVC：本文中泛指<code>k8s</code>中的可灵活弹性伸缩（<strong>Persistent Volumes</strong>, <strong>Static Provisioning</strong>, <strong>awsElasticBlockStore</strong>）</li></ul><h2 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h2><p>[1] <a target="_blank" rel="noopener" href="https://k8s.io/docs/concepts/services-networking/ingress/">https://k8s.io/docs/concepts/services-networking/ingress</a></p><p>[2] <a target="_blank" rel="noopener" href="https://www.cncf.io/wp-content/uploads/2020/12/CNCF_Survey_Report_2020.pdf">https://www.cncf.io/wp-content/uploads/2020/12/CNCF_Survey_Report_2020.pdf</a></p><p>[3] <a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy">https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy</a></p><p>[4] <a target="_blank" rel="noopener" href="https://k8s.io/docs/concepts/services-networking/ingress-controllers/">https://k8s.io/docs/concepts/services-networking/ingress-controllers</a></p><p>[5] <a target="_blank" rel="noopener" href="https://istio.io/latest/docs/reference/config/security/">https://istio.io/latest/docs/reference/config/security</a></p><p>[6] <a target="_blank" rel="noopener" href="https://github.com/envoyproxy/ratelimit">https://github.com/envoyproxy/ratelimit</a></p><p>[7] <a target="_blank" rel="noopener" href="https://istio.io/latest/docs/tasks/policy-enforcement/rate-limit/">https://istio.io/latest/docs/tasks/policy-enforcement/rate-limit</a></p><p>[8] <a target="_blank" rel="noopener" href="https://istio.io/latest/docs/tasks/traffic-management/locality-load-balancing/">https://istio.io/latest/docs/tasks/traffic-management/locality-load-balancing</a></p><h2 id="原生k8s面临的挑战"><a class="markdownIt-Anchor" href="#原生k8s面临的挑战"></a> 原生K8S面临的挑战</h2><p>云原生阶段，容器资源的粒度更细，利用率高，启动/销毁速度达到秒级，且大部分应用都配置了<code>PVC</code>；网络管理环境也发生了变更，出现<code>Service</code>的概念，一个微服务往往是由<code>Deployment</code>部署的一组弹性伸缩、动态调度的容器(<code>Pod</code>)承载，<code>Pod</code>的<code>IP</code>地址动态变化，这一组<code>Pod</code>一般以<code>Service</code>对外提供访问，流量管理是以<code>Service</code>为单位，且<code>k8s</code>支持集群内的服务注册与服务发现，以及基本的负载均衡能力</p><p>服务化拆分业务模块使得构建应用更容易，加上容器环境良好的弹性伸缩能力，<code>DevOps</code>理念得以很好的实施，微服务的迭代步伐加快，经常需要滚动更新。此时的入口流量管理面临如下新挑战：</p><ul><li>需要与<code>k8s</code>集成，支持转发流量到指定<code>Pod</code></li><li>更新迭代速度加快，对服务新版本灰度发布的诉求更加强烈</li><li>出现集群概念，集群之间的服务发现是隔离的，接入层需支持跨集群的服务发现（即接入层可选择<code>backend</code>为多个集群的<code>Pod</code>）；这区别于传统物理机 / 虚拟机阶段，没有集群隔离，只需保证网络联通性，即可配置接入层后端为任意对应服务的<code>IP</code>地址</li><li>传统阶段到云原生阶段的迁移过程中，出现<code>VM</code>、容器环境混布的情况</li></ul><p>基于上述挑战，出现了以下容器环境的接入层流量管理解决方案：</p><ol><li><code>k8s</code>自带的 <code>Ingress API</code>：老牌网络代理（e.g. Nginx）或云厂商的负载均衡产品（e.g. AWS Elastic Load Balancer，腾讯云 CLB）都实现了各自的 <code>Ingress Controller</code>，作为单个集群的入口流量管理解决方案。灰度发布、鉴权限流等能力，视<code>Ingress Controller</code>的能力，可通过<code>Annotation</code>扩展，部分 <code>Ingress Controller</code> 还设计了自己的流量管理模型和语法</li><li><code>Service Mesh Ingress</code>：服务网格的服务发现和管理界限<strong>大于集群纬度</strong>，以<code>Istio Ingress Gatewa</code>为例，基于<code>Istio</code>跨集群的服务发现能力，<code>backend</code>可以来自不同集群的服务，同时还支持注册在网格内运行在虚拟机上的服务。<code>Istio</code> 也设计了自己的管理模型和语法，声明式支持配置一致的任何流量管理</li><li>沿用原有 <code>VM</code> 上部署的网络代理，转发流量至 <code>VM</code> 服务或 <code>k8s</code> 集群的服务</li></ol><h2 id="云原生接入层流量管理场景与解决方案"><a class="markdownIt-Anchor" href="#云原生接入层流量管理场景与解决方案"></a> 云原生接入层流量管理场景与解决方案</h2><h3 id="场景一基础流量管理"><a class="markdownIt-Anchor" href="#场景一基础流量管理"></a> <strong>场景一：基础流量管理</strong></h3><p>要求接入层具有基于流量内容路由的能力（最基础的服务发现能力）</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210517112911.png" alt=""></p><h4 id="方案一load-balancer-nodeport"><a class="markdownIt-Anchor" href="#方案一load-balancer-nodeport"></a> <strong>方案一：Load Balancer + NodePort</strong></h4><p>在容器化的早期阶段，应用同时部署在虚拟机和 <code>k8s</code> 集群上，很多用户会使用原有负载均衡（e.g. Nginx, 腾讯云 CLB）将请求分别转发到虚拟机和容器，同时受限于容器网络方案，原有负载均衡不能直接访问 Pod IP，因此需要通过 NodePort 暴露集群内的服务</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210517112950.png" alt=""></p><p>但是该方案存在以下问题：</p><ul><li><code>NodePort</code> 端口数量有限（默认 30000-32767）</li><li>随着集群规模的扩大，Nginx 配置文件越来越复杂，很难管理</li><li>用户将应用发布到 <code>k8s</code> 集群后，需要再单独修改 <code>Nginx</code> 配置，体验很差</li></ul><h4 id="方案二k8s-ingress"><a class="markdownIt-Anchor" href="#方案二k8s-ingress"></a> <strong>方案二：K8S Ingress</strong></h4><p>前面提到过其实这个能力<code>k8s</code>自身就有，<code>k8s</code> 提供了 <code>Ingress API</code> 用于暴露集群内的 <code>HTTP</code> 服务，<code>Ingress</code> 支持基于 Host 和 Path 将请求路由到不同 Service。为了让 Ingress 工作，集群必须有一个正在运行的 Ingress 控制器（e.g. Nginx Ingress Controller）。原生 Ingress 语法提供简单的基于 Host，Path 路由，以及配置 TLS 的能力</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614171315.png" alt=""></p><p>但是另一方面原生 Ingress 的功能十分有限，不能满足很多复杂场景的需求。许多第三方的 Ingress Controller [4] 通过 annotation 或新的配置模型和语法扩展了原生 Ingress 的功能，但仍然受限于集群间服务发现隔离的问题，只能作为<strong>单集群入口</strong>流量管理方案</p><h3 id="场景二灰度发布"><a class="markdownIt-Anchor" href="#场景二灰度发布"></a> <strong>场景二：灰度发布</strong></h3><p>服务可暴露给外部访问后，还需要考虑如何做版本发布，做平滑、无风险地迭代。常见的两种做法是按权重或流量内容切部分流量至新版本验证稳定性，无问题后逐渐过渡至新版本，也就是<code>灰度发布</code>以及<code>AB test</code></p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614175950.png" alt=""></p><p>在这方面K8S Ingress API 原生并没有灰度发布的功能，Nginx ingress controller 通过 annotation 的方式扩展了原生 Ingress API 的功能，实现了灰度发布，但这种方式并不能很好地支撑控制应用流量的发布策略，相比之下，<code>Istio CRD</code> 配置更灵活易用，下面介绍如何使用 Istio VirtualService 配置灰度发布路由规则</p><h4 id="方案一基于权重"><a class="markdownIt-Anchor" href="#方案一基于权重"></a> <strong>方案一：基于权重</strong></h4><p>这种方案是配置成本最低的一个方案，很简单，基于k8s的service进行路由流量：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614180128.png" alt=""></p><p><code>Istio</code> 可通过 <code>Virtual Service</code> 配置基于权重的灰度发布，以下是配置来自 <code>&#123;namespace&#125;/&#123;gateway&#125;</code> 的入口流量 95% 路由到 <code>&#123;service&#125;</code> 的 <code>current</code> 版本，5% 路由到 <code>canary</code> 版本的示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary-weight</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="string">namespace</span>&#125;<span class="string">/&#123;gateway&#125;</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">current</span></span><br><span class="line">          <span class="attr">weight:</span> <span class="number">95</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">canary</span></span><br><span class="line">          <span class="attr">weight:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><h4 id="方案二基于请求内容"><a class="markdownIt-Anchor" href="#方案二基于请求内容"></a> <strong>方案二：基于请求内容</strong></h4><p>既然能基于流量分流，那自然也应该支持基于内容的路由：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614180418.png" alt=""></p><p><code>VirtualService</code> 也支持配置基于内容的灰度发布路由规则，以下是配置来自 <code>&#123;namespace&#125;/&#123;gateway&#125;</code> 的入口流量 <code>header cookie &quot;version=stable&quot;</code> 时路由到 <code>&#123;service&#125;</code> 的 <code>current</code> 版本，<code>&quot;version=canary&quot;</code> 时路由到 <code>&#123;service&#125;</code>的 <code>canary</code> 版本的示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary-content</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="string">namespace</span>&#125;<span class="string">/&#123;gateway&#125;</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">cookie:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">version=stable</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">current</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">cookie:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">version=canary</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> &#123;<span class="string">service</span>&#125;</span><br><span class="line">            <span class="attr">subset:</span> <span class="string">canary</span></span><br></pre></td></tr></table></figure><h3 id="场景三应用流量鉴权与限流"><a class="markdownIt-Anchor" href="#场景三应用流量鉴权与限流"></a> <strong>场景三：应用流量鉴权与限流</strong></h3><blockquote><p>鉴权与限流，是保证南北流量的安全性与健壮性的两个重要能力</p></blockquote><p>接入层是访问后端服务的统一入口，保证接入层的安全是接入层流量管理的一个重要场景，一般在入口处需要配置认证与授权规则，传统架构下认证授权功能一般通过代码逻辑实现，比如Django的一些开源鉴权中间件</p><p>而<code>Istio</code>自 1.5 之后提供了 <code>AuthorizationPolicy</code> 和 <code>RequestAuthentication CRD</code> [5]，可灵活配置入口层的认证和授权规则</p><h4 id="方案一请求身份认证jwt"><a class="markdownIt-Anchor" href="#方案一请求身份认证jwt"></a> <strong>方案一：请求身份认证（JWT）</strong></h4><p>入口处认证请求携带的 Json Web Token，放通携带合法令牌的请求，拒绝携带非法令牌的请求。</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181413.png" alt=""></p><p>以下是使用 <code>Istio RequestAuthentication</code> 配置 <code>Ingress Gateway</code> 放通携带合法 <code>JWT</code> 请求的配置示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">..</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RequestAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jwt-example</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">jwtRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">issuer:</span> &#123;<span class="string">issuer</span> <span class="string">that</span> <span class="string">issued</span> <span class="string">the</span> <span class="string">JWT</span>&#125;</span><br><span class="line">    <span class="attr">jwksUri:</span> &#123;<span class="string">URL</span> <span class="string">of</span> <span class="string">the</span> <span class="string">provider’s</span> <span class="string">public</span> <span class="string">key</span> <span class="string">set</span> <span class="string">to</span> <span class="string">validate</span> <span class="string">signature</span> <span class="string">of</span> <span class="string">the</span> <span class="string">JWT</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="方案二授权"><a class="markdownIt-Anchor" href="#方案二授权"></a> <strong>方案二：授权</strong></h4><p>在入口处配置授权策略，根据流量内容特征，允许/拒绝流量访问，例如在入口处配置 IP 黑/白名单；或有外部鉴权服务，希望入口组件可对接外部鉴权服务，按照其返回的鉴权结果放通/拒绝流量</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181441.png" alt=""></p><p>以下是使用 <code>Istio AuthorizationPolicy</code> 为 <code>Ingress Gateway</code> 配置 <code>IP block</code> 白名单的示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">white-list</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">ipBlocks:</span> &#123;<span class="string">single</span> <span class="string">IP</span> <span class="string">or</span> <span class="string">CIDR</span>&#125;</span><br></pre></td></tr></table></figure><p><code>Istio 1.9</code> 增强了对 <code>AuthorizationPolicy</code> 对于对接外部鉴权系统的支持，可配置 <code>Ingress Gateway</code> 按照外部鉴权系统返回的结果放通或拒绝流量。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ext-authz</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">CUSTOM</span></span><br><span class="line">  <span class="attr">provider:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;my-ext-authz-service&quot;</span></span><br><span class="line">  <span class="attr">rules:</span> <span class="string">...</span></span><br></pre></td></tr></table></figure><h4 id="方案三限流"><a class="markdownIt-Anchor" href="#方案三限流"></a> <strong>方案三：限流</strong></h4><p>限流这一手段在业务规模较大时非常常见，后端服务提供给众多租户使用时，需要在入口处控制请求的速率（不然再扩容老板要鲨人了），例如限制每个 User ID 每分钟只能请求 <code>/product</code> 接口 100 次；为了使用<code>Istio Ingress Gateway</code> 的限流功能，首先需要安装 <code>Ratelimit service</code>，可以自行实现或直接使用社区的 <code>ratelimit</code> [6]，然后使用 <code>Envoyfilter</code> 配置限流规则，具体配置方法可参考官方文档[7]</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181605.png" alt=""></p><h3 id="场景四多集群异构场景入口流量管理"><a class="markdownIt-Anchor" href="#场景四多集群异构场景入口流量管理"></a> <strong>场景四：多集群异构场景入口流量管理</strong></h3><blockquote><p>随着业务规模的增加，或对容灾、数据合规性、业务之间隔离要求的提升，业务会考虑与实施部署多个 k8s 集群，甚至会出现容器化环境与非容器化环境异构混布的情况，给入口流量管理又带来了一系列新的挑战</p></blockquote><p>多 <code>k8s</code> 集群一般是基于容灾和业务隔离两方面的考虑：</p><h5 id="容灾"><a class="markdownIt-Anchor" href="#容灾"></a> <strong>容灾</strong></h5><p><code>k8s</code> 集群有地域属性，根据应用交付提供服务的访问时效和容灾诉求，同一应用可能分布在多个不同的地理区域。多（公有）云、混合云（IDC + 公有云）架构的容灾，也需部署多个集群。跨地域多集群容灾与就近接入可通过 DNS 解析提供，但 DNS 有缓存，故障转移实际生效时间可能较长，并且无法视服务健康程度切部分流量到备份地域，只能全部切换</p><p><code>Istio</code> 基于以下能力：1. 多集群服务发现能力；2. 地域感知、故障感知、容灾流量容量规划，可以实现：① 当所有集群的服务都健康时，按照请求来源地就近路由至对应服务；② 某个集群的服务出现部分故障时，视服务的健康程度转移一定比例的流量到其他集群的备份服务</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614181831.png" alt=""></p><h5 id="业务隔离"><a class="markdownIt-Anchor" href="#业务隔离"></a> <strong>业务隔离</strong></h5><p>据 CNCF 2020 云原生调查报告显示 [2]，用多个集群做应用隔离是仅次于用 namespace 隔离的使用方式，使用率从 2019 年的 47% 上升到了2020年的 50%。多个业务仍共用一个流量入口时，接入层需具备多集群服务发现的能力，将流量按指定策略路由至指定集群的服务</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182459.png" alt=""></p><h4 id="方案一service-mesh-ingress"><a class="markdownIt-Anchor" href="#方案一service-mesh-ingress"></a> <strong>方案一：Service Mesh Ingress</strong></h4><p>k8s Ingress Controller 遇到的一个挑战是，K8S 集群隔离了集群间的服务发现，Ingress Controller 只能作为集群级别的流量入口。而 Service Mesh 技术借助于控制面服务发现的能力，可发现或注册多个集群的服务甚至异构服务，打通集群间的服务发现壁垒，不受应用部署平台限制，天然提供一致的接入流量转发管理能力</p><p>Istio 作为最受欢迎的 Service Mesh 开源项目，它的接入层 Istio Ingress Gateway 同样提供了对 Ingress API 的支持，但是不建议使用 Ingress 去配置 Ingress Gateway，这大大削弱了 Istio 的能力。Istio 对流量管理模型提供了更高程度的抽象，可以直接使用 Istio API 实现更灵活的流量管理能力，实现灰度发布，跨集群路由，地域感知等高级特性</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182144.png" alt=""></p><p>Istio Ingress Gateway 基于 Envoy [3] 实现，Envoy 最初由 Lyft 创建，是一款为云原生场景设计的高性能服务代理软件，后由 Lyft 捐献到了 CNCF 社区，并已从 CNCF 毕业</p><h5 id="多-k8s-集群服务管理"><a class="markdownIt-Anchor" href="#多-k8s-集群服务管理"></a> <strong>多 k8s 集群服务管理</strong></h5><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182151.png" alt=""></p><p>Istiod 可以通过网格内所有集群的 API Server 来获取 endpoints 信息，聚合多个集群的信息后，将最终生成的配置推送到 Ingress Gateway，Ingress Gateway 可以将请求按需转发至网格内所有 Pod</p><h5 id="地域感知负载均衡"><a class="markdownIt-Anchor" href="#地域感知负载均衡"></a> <strong>地域感知负载均衡</strong></h5><blockquote><p>在服务网格中，一个 Pod 的地理信息包括以下 3 个部分 [8]：</p><ul><li><strong>Region（地域）</strong>：通常代表一个较大的地理区域（e.g 北京 上海），在 k8s 中，节点的地域由标签 <code>topology.k8s.io/region</code> 决定</li><li><strong>Zone（可用区）</strong>：一个地域通常包含多个可用区（e.g. 北京一区 北京二区），在 k8s 中，节点的可用区由标签 <code>topology.k8s.io/zone</code> 决定</li><li><strong>Sub-zone</strong> ：允许对可用区做进一步划分实现更细粒度的控制，例如可以按照 rack（机架）划分，在 k8s 中不存在 sub-zone 的概念，Istio 使用节点的 <code>topology.istio.io/subzone</code> 标签来定义 sub-zone</li></ul><p>如果使用云厂商托管的 k8s 服务，节点的 Region 和 Zone 标签已由云厂商配置，例如在 TKE 集群中，上海二区的节点会有以下标签：</p><ul><li><code>topology.k8s.io/region: sh</code></li><li><code>topology.k8s.io/zone: &quot;200002&quot;</code></li></ul></blockquote><p>网格内的集群可能分布在不同地域不同可用区，大多数情况下，我们希望尽量减少跨地域/跨可用区的请求调用，因为这会增加请求时延。因此接入层需具备感知 endpoints 地理信息的能力，并支持根据地理信息配置负载均衡及故障转移策略</p><h6 id="地域故障转移"><a class="markdownIt-Anchor" href="#地域故障转移"></a> <strong>地域故障转移</strong></h6><p>在开启地域负载均衡的情况下，Istio 会告知 Ingress Gateway 将请求就近转发。当所有实例都正常时，请求将保持在同一地点，当实例异常时，流量会分发到下一优先地域的实例</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182247.png" alt=""></p><p>例如，位于 <a target="_blank" rel="noopener" href="http://bj.bj/">bj.bj</a>-01 的 Ingress Gateway 转发请求的优先级如下：</p><table><thead><tr><th style="text-align:center">优先级</th><th style="text-align:center">地理位置</th><th style="text-align:center"></th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center"><a target="_blank" rel="noopener" href="http://bj.bj/">bj.bj</a>-01</td><td style="text-align:center">Region Zone 完全匹配</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center"><a target="_blank" rel="noopener" href="http://bj.bj/">bj.bj</a>-02</td><td style="text-align:center">Region 匹配 Zone 不匹配</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center"><a target="_blank" rel="noopener" href="http://sh.sh/">sh.sh</a>-01/sh-02</td><td style="text-align:center">Region Zone 都不匹配</td></tr></tbody></table><h6 id="地域加权负载均衡"><a class="markdownIt-Anchor" href="#地域加权负载均衡"></a> <strong>地域加权负载均衡</strong></h6><p>地域加权负载均衡可以将用户定义的一定百分比的流量分发到某些地域，例如我们可以使用如下配置分发流量：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">localityLbSetting:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">distribute:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span> <span class="string">bj/bj-01/*</span></span><br><span class="line">      <span class="attr">to:</span></span><br><span class="line">        <span class="string">&quot;bj/bj-01/*&quot;</span><span class="string">:</span> <span class="number">70</span></span><br><span class="line">        <span class="string">&quot;bj/bj-02/*&quot;</span><span class="string">:</span> <span class="number">20</span></span><br><span class="line">        <span class="string">&quot;sh/sh-01/*&quot;</span><span class="string">:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p><img src="https://mmbiz.qpic.cn/mmbiz_png/gBXSicjuwMvHRX48bbV45hGUS3RgWicabsrXbaZUzCky3k8T3Z01oYnIr4oGSwavvu4PVVMh57OJrXtMBTZyHFRQ/640?wx_fmt=png" alt="img"></p><h5 id="异构服务入口流量管理"><a class="markdownIt-Anchor" href="#异构服务入口流量管理"></a> <strong>异构服务入口流量管理</strong></h5><p>除了多集群，用户在云原生改造的过程中，常常会面临部分服务已经做了容器化改造，运行在 k8s 集群，部分不便改造的服务仍在虚拟机的情况，甚至会有部分使用的是云厂商 serverless 云函数服务（e.g. AWS lambda）。接入层需具备异构服务注册/发现的能力，以管理异构部署服务的南北向流量</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182336.png" alt="">可以通过 Istio 提供的 WorkloadGroup 和 WorkloadEntry 将虚拟机上的服务注册到网格内，同一个服务可以同时运行在 k8s 集群和虚拟机上</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614182343.png" alt=""></p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>Istio Ingress Gateway 在入口灰度发布、安全、多集群异构流量管理等场景提供了多集群服务发现、地域感知、流量容量规划，以及更强大灵活的流量管理 API 的支持</p><p>但与此同时，用户也不得不面对 Istio 的复杂性；需要投入资源和人力成本运维 Istiod 和 Istio Ingress Gateway，集成 metric，trace，log 等可观测性及证书管理周边系统成本较高，还需要正确配置各种 CRD（Gateway VirtualService DestinationRule 等）；但在一两年前，这也是<code>k8s</code>为人所诟病的地方，相信开发者们很快就能熟悉<code>Istio</code>的运维方式</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">Kevinello</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://kevinello.ltd/2021/06/14/Service-Mesh%E5%9C%A8%E6%8E%A5%E5%85%A5%E5%B1%82%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8/">http://kevinello.ltd/2021/06/14/Service-Mesh在接入层流量管理的应用/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://kevinello.ltd" target="_blank">Kevinello</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang</a><a class="post-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a><a class="post-meta__tags" href="/tags/Kubenetes/">Kubenetes</a><a class="post-meta__tags" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/">虚拟化技术</a><a class="post-meta__tags" href="/tags/Service-Mesh/">Service Mesh</a><a class="post-meta__tags" href="/tags/%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/">流量管理</a><a class="post-meta__tags" href="/tags/%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/">灰度发布</a><a class="post-meta__tags" href="/tags/Istio/">Istio</a></div><div class="post_share"><div class="social-share" data-image="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614183524.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/08/TraceSim%E7%AE%97%E6%B3%95%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA/"><img class="prev-cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210508141907.jpeg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">TraceSim算法深入浅出</div></div></a></div><div class="next-post pull-right"><a href="/2021/06/14/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0/"><img class="next-cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210508140417.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis分布式锁的基本实现</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/11/29/DEM%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97/" title="DEM项目日志"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/sky5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-29</div><div class="title">DEM项目日志</div></div></a></div><div><a href="/2021/02/07/Go%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="Go单例模式"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/sunset3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-07</div><div class="title">Go单例模式</div></div></a></div><div><a href="/2022/01/10/%E9%9D%A2%E8%AF%95%E5%AE%98%E5%88%9D%E4%BD%93%E9%AA%8C/" title="面试官初体验"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20220110130328.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-10</div><div class="title">面试官初体验</div></div></a></div><div><a href="/2020/11/28/K8s-RoadMap/" title="K8s-RoadMap"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/v2-582b2a32df399cc3f40ef62fd099e438_720w.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-28</div><div class="title">K8s-RoadMap</div></div></a></div><div><a href="/2020/11/27/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%971/" title="Whosbug项目日志1"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/night3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-27</div><div class="title">Whosbug项目日志1</div></div></a></div><div><a href="/2022/10/30/API%E6%85%A2%E8%AF%B7%E6%B1%82%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95%E3%80%8C1%E3%80%8D/" title="API慢请求问题排查记录「1」"><img class="cover" src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/10/31/What-is-an-API-3d10cb.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-30</div><div class="title">API慢请求问题排查记录「1」</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div id="comment-switch"><span class="first-comment">Utterances</span><span class="switch-btn"></span><span class="second-comment">Twikoo</span></div></div><div class="comment-wrap"><div><div id="utterances-wrap"></div></div><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/myself-e3fde6.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Kevinello</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">90</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kevinello"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/kevinello" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://space.bilibili.com/23149976" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili-fill"></i></a><a class="social-icon" href="mailto:kevinello42@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#service-mesh%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.</span> <span class="toc-text">service mesh是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84%E8%AF%8D"><span class="toc-number">2.</span> <span class="toc-text">需要了解的词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9Fk8s%E9%9D%A2%E4%B8%B4%E7%9A%84%E6%8C%91%E6%88%98"><span class="toc-number">4.</span> <span class="toc-text">原生K8S面临的挑战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%91%E5%8E%9F%E7%94%9F%E6%8E%A5%E5%85%A5%E5%B1%82%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%E5%9C%BA%E6%99%AF%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">5.</span> <span class="toc-text">云原生接入层流量管理场景与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%80%E5%9F%BA%E7%A1%80%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">场景一：基础流量管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80load-balancer-nodeport"><span class="toc-number">5.1.1.</span> <span class="toc-text">方案一：Load Balancer + NodePort</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8Ck8s-ingress"><span class="toc-number">5.1.2.</span> <span class="toc-text">方案二：K8S Ingress</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%BA%8C%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83"><span class="toc-number">5.2.</span> <span class="toc-text">场景二：灰度发布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%E5%9F%BA%E4%BA%8E%E6%9D%83%E9%87%8D"><span class="toc-number">5.2.1.</span> <span class="toc-text">方案一：基于权重</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%E5%9F%BA%E4%BA%8E%E8%AF%B7%E6%B1%82%E5%86%85%E5%AE%B9"><span class="toc-number">5.2.2.</span> <span class="toc-text">方案二：基于请求内容</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%89%E5%BA%94%E7%94%A8%E6%B5%81%E9%87%8F%E9%89%B4%E6%9D%83%E4%B8%8E%E9%99%90%E6%B5%81"><span class="toc-number">5.3.</span> <span class="toc-text">场景三：应用流量鉴权与限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%E8%AF%B7%E6%B1%82%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81jwt"><span class="toc-number">5.3.1.</span> <span class="toc-text">方案一：请求身份认证（JWT）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%E6%8E%88%E6%9D%83"><span class="toc-number">5.3.2.</span> <span class="toc-text">方案二：授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%89%E9%99%90%E6%B5%81"><span class="toc-number">5.3.3.</span> <span class="toc-text">方案三：限流</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%9B%9B%E5%A4%9A%E9%9B%86%E7%BE%A4%E5%BC%82%E6%9E%84%E5%9C%BA%E6%99%AF%E5%85%A5%E5%8F%A3%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-number">5.4.</span> <span class="toc-text">场景四：多集群异构场景入口流量管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E7%81%BE"><span class="toc-number">5.4.0.1.</span> <span class="toc-text">容灾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%9A%94%E7%A6%BB"><span class="toc-number">5.4.0.2.</span> <span class="toc-text">业务隔离</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80service-mesh-ingress"><span class="toc-number">5.4.1.</span> <span class="toc-text">方案一：Service Mesh Ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A-k8s-%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">多 k8s 集群服务管理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%B0%E5%9F%9F%E6%84%9F%E7%9F%A5%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">地域感知负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%B0%E5%9F%9F%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">5.4.1.2.1.</span> <span class="toc-text">地域故障转移</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%B0%E5%9F%9F%E5%8A%A0%E6%9D%83%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.4.1.2.2.</span> <span class="toc-text">地域加权负载均衡</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%9E%84%E6%9C%8D%E5%8A%A1%E5%85%A5%E5%8F%A3%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-number">5.4.1.3.</span> <span class="toc-text">异构服务入口流量管理</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/30/API%E6%85%A2%E8%AF%B7%E6%B1%82%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95%E3%80%8C1%E3%80%8D/" title="API慢请求问题排查记录「1」"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/10/31/What-is-an-API-3d10cb.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="API慢请求问题排查记录「1」"></a><div class="content"><a class="title" href="/2022/10/30/API%E6%85%A2%E8%AF%B7%E6%B1%82%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95%E3%80%8C1%E3%80%8D/" title="API慢请求问题排查记录「1」">API慢请求问题排查记录「1」</a><time datetime="2022-10-30T14:44:07.000Z" title="发表于 2022-10-30 22:44:07">2022-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/23/Linux%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0-No-such-file-or-directory/" title="Linux踩坑日记-No such file or directory"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/10/23/tux_linux_penguin_code_binary-1d5088.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Linux踩坑日记-No such file or directory"></a><div class="content"><a class="title" href="/2022/10/23/Linux%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0-No-such-file-or-directory/" title="Linux踩坑日记-No such file or directory">Linux踩坑日记-No such file or directory</a><time datetime="2022-10-23T10:11:18.000Z" title="发表于 2022-10-23 18:11:18">2022-10-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/16/Golang-optimization%E3%80%8C2%E3%80%8D-%E5%AD%97%E7%AC%A6%E4%B8%B2/" title="Golang-optimization「2」: 字符串"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/10/16/Screenshot-from-2022-06-23-01-35-59-1170x694-afe109.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Golang-optimization「2」: 字符串"></a><div class="content"><a class="title" href="/2022/10/16/Golang-optimization%E3%80%8C2%E3%80%8D-%E5%AD%97%E7%AC%A6%E4%B8%B2/" title="Golang-optimization「2」: 字符串">Golang-optimization「2」: 字符串</a><time datetime="2022-10-16T07:39:14.000Z" title="发表于 2022-10-16 15:39:14">2022-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/16/Golang-optimization%E3%80%8C1%E3%80%8D-%E6%95%B0%E7%BB%84%E5%92%8C%E5%88%87%E7%89%87/" title="Golang-optimization「1」: 数组和切片"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/10/16/Screenshot-from-2022-06-23-01-35-59-1170x694-afe109.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Golang-optimization「1」: 数组和切片"></a><div class="content"><a class="title" href="/2022/10/16/Golang-optimization%E3%80%8C1%E3%80%8D-%E6%95%B0%E7%BB%84%E5%92%8C%E5%88%87%E7%89%87/" title="Golang-optimization「1」: 数组和切片">Golang-optimization「1」: 数组和切片</a><time datetime="2022-10-16T07:34:11.000Z" title="发表于 2022-10-16 15:34:11">2022-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/15/Golang-optimization%E3%80%8C0%E3%80%8D-%E5%BA%8F%E7%AB%A0/" title="Golang-optimization「0」: 序章"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/10/16/Screenshot-from-2022-06-23-01-35-59-1170x694-afe109.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Golang-optimization「0」: 序章"></a><div class="content"><a class="title" href="/2022/10/15/Golang-optimization%E3%80%8C0%E3%80%8D-%E5%BA%8F%E7%AB%A0/" title="Golang-optimization「0」: 序章">Golang-optimization「0」: 序章</a><time datetime="2022-10-15T07:34:11.000Z" title="发表于 2022-10-15 15:34:11">2022-10-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210614183524.png)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Kevinello</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">🥳 🥳 🥳 🥳 🥳</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Algolia</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/search/optimized_algolia.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadUtterances () {
  let ele = document.createElement('script')
  ele.setAttribute('id', 'utterances_comment')
  ele.setAttribute('src', 'https://utteranc.es/client.js')
  ele.setAttribute('repo', 'Kevinello/gitalk')
  ele.setAttribute('issue-term', 'pathname')
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
  ele.setAttribute('theme', nowTheme)
  ele.setAttribute('crossorigin', 'anonymous')
  ele.setAttribute('async', 'true')
  document.getElementById('utterances-wrap').insertAdjacentElement('afterbegin',ele)
}

function utterancesTheme () {
  const iframe = document.querySelector('.utterances-frame')
  if (iframe) {
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
    const message = {
      type: 'set-theme',
      theme: theme
    };
    iframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }
}

if ('Utterances' === 'Utterances' || !false) {
  if (false) btf.loadComment(document.getElementById('utterances-wrap'), loadUtterances)
  else loadUtterances()
} else {
  function loadOtherComment () {
    loadUtterances()
  }
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'blog-comments-9gil6as164013b6c',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.vemoji)'))
      }
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'blog-comments-9gil6as164013b6c',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      document.getElementById('twikoo-count').innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Utterances' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>