<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Python-asyncio异步编程基础 | Kevinello</title><meta name="keywords" content="后端,并发编程,Python,asyncio"><meta name="author" content="Kevinello"><meta name="copyright" content="Kevinello"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言 asyncio是Python 3.4版本引入的标准库，直接内置了对异步IO的支持，并且如今asyncio的单线程异步性能已经做到与Go &#x2F; Node持平 目前还没有基于asyncio开发大型项目的经历（主要还是在用golang）  需要了解的几个词  协程（coroutine）：与线程很相似，不同之处在于多协程是同一个线程来执行的，这样就省去了线程切换的时间，而且不需要多线程的锁机制了，执"><meta property="og:type" content="article"><meta property="og:title" content="Python-asyncio异步编程基础"><meta property="og:url" content="http://kevinello.ltd/2021/03/17/Python-asyncio%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/index.html"><meta property="og:site_name" content="Kevinello"><meta property="og:description" content="前言 asyncio是Python 3.4版本引入的标准库，直接内置了对异步IO的支持，并且如今asyncio的单线程异步性能已经做到与Go &#x2F; Node持平 目前还没有基于asyncio开发大型项目的经历（主要还是在用golang）  需要了解的几个词  协程（coroutine）：与线程很相似，不同之处在于多协程是同一个线程来执行的，这样就省去了线程切换的时间，而且不需要多线程的锁机制了，执"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141902_04_compressed.jpg"><meta property="article:published_time" content="2021-03-17T06:17:53.000Z"><meta property="article:modified_time" content="2022-04-09T15:00:29.745Z"><meta property="article:author" content="Kevinello"><meta property="article:tag" content="后端"><meta property="article:tag" content="并发编程"><meta property="article:tag" content="Python"><meta property="article:tag" content="asyncio"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141902_04_compressed.jpg"><link rel="shortcut icon" href="/imgs/K.jpg"><link rel="canonical" href="http://kevinello.ltd/2021/03/17/Python-asyncio%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2a20aecba22b2eaf60183c4831d9a52";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RV8K5FBVX5"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RV8K5FBVX5")</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"13UJR6CRNO","apiKey":"456e56f51ec27a1e13d67bef144f6747","indexName":"Kevinello_blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Python-asyncio异步编程基础",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-04-09 23:00:29"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2232093_k6128tldgy.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/myself-e3fde6.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141902_04_compressed.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kevinello</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Python-asyncio异步编程基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-03-17T06:17:53.000Z" title="发表于 2021-03-17 14:17:53">2021-03-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-04-09T15:00:29.745Z" title="更新于 2022-04-09 23:00:29">2022-04-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>8分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Python-asyncio异步编程基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p><code>asyncio</code>是Python 3.4版本引入的标准库，直接内置了对异步IO的支持，并且如今<code>asyncio</code>的单线程异步性能已经做到与<code>Go</code> / <code>Node</code>持平</p><p>目前还没有基于asyncio开发大型项目的经历（主要还是在用<code>golang</code>）</p><h2 id="需要了解的几个词"><a class="markdownIt-Anchor" href="#需要了解的几个词"></a> 需要了解的几个词</h2><ul><li><code>协程（coroutine）</code>：与<strong>线程</strong>很相似，不同之处在于多协程是同一个线程来执行的，这样就省去了线程切换的时间，而且不需要多线程的锁机制了，执行效率高很多</li><li><code>异步IO</code>：异步IO的概念和同步IO相对。当一个异步过程调用发出后，调用者不能立刻得到结果。实际处理这个调用的部件在完成后，通过状态、通知和回调来通知调用者</li><li><code>事件循环</code>：事件循环是一种处理多并发量的有效方式，在维基百科中它被描述为「一种等待程序分配事件或消息的编程架构」，我们可以定义事件循环来简化使用轮询方法来监控事件，通俗的说法就是「当A发生时，执行B」</li></ul><h2 id="asyncio-是什么"><a class="markdownIt-Anchor" href="#asyncio-是什么"></a> asyncio 是什么</h2><p><code>asyncio</code>模块提供了使用协程构建并发应用的工具，它使用一种单线程单进程的的方式实现并发，应用的各个部分彼此合作, 可以显式的切换任务，一般会在程序阻塞I/O操作的时候发生上下文切换如等待读写文件,或者请求网络；同时<code>asyncio</code>也支持调度代码在将来的某个特定时间运行，从而支持一个协程等待另一个协程完成，以处理系统信号和识别其他一些事件</p><p>其他的并发模型大多数采取线性的方式编写，并且依赖于语言运行时系统 / 操作系统的底层线程 / 进程来适当地改变上下文，而基于<code>asyncio</code>的应用要求应用代码显式地处理上下文切换</p><h2 id="asyncio基本使用"><a class="markdownIt-Anchor" href="#asyncio基本使用"></a> asyncio基本使用</h2><p><code>asyncio</code>的核心编程模型就是一个消息循环，我们从<code>asyncio</code>模块中直接获取一个<code>EventLoop</code>的引用，然后把需要执行的<a href="https://kevinello.ltd/2021/02/15/Python-yield%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3/">协程</a>扔到<code>EventLoop</code>中执行，就实现了异步IO</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>():</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(), my_coroutine()]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 14260)&gt;)</span><br></pre></td></tr></table></figure><p>由打印的当前线程id可以看出，两个<code>coroutine</code>是由同一个线程并发执行的</p><p>如果把<code>asyncio.sleep()</code>换成真正的IO操作，则多个<code>coroutine</code>就可以由一个线程并发执行</p><h2 id="async-await"><a class="markdownIt-Anchor" href="#async-await"></a> async / await</h2><p>Python 3.5开始引入了新的语法<code>async</code>和<code>await</code>，可以让coroutine的代码更简洁易读</p><p>用起来也很简单，只需要做两件事情：</p><ul><li>把<code>@asyncio.coroutine</code>替换为<code>async</code></li><li>把<code>yield from</code>替换为<code>await</code></li></ul><p>更新后的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>():</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(), my_coroutine()]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简洁 &amp; 优雅</p><h2 id="协程中调用普通函数"><a class="markdownIt-Anchor" href="#协程中调用普通函数"></a> 协程中调用普通函数</h2><p>在协程中可以通过调用<code>EventLoop</code>对象的<code>call_soon</code>，<code>call_later</code>，<code>call_at</code>方法来调用普通函数</p><h3 id="call_soon"><a class="markdownIt-Anchor" href="#call_soon"></a> call_soon</h3><p>字面意思，立即调用</p><p><code>call_soon(self, callback, *args, context=None)</code></p><blockquote><p>Arrange for a callback to be called as soon as possible.This operates as a FIFO queue: callbacks are called in theorder in which they are registered. Each callback will becalled exactly once.Any positional arguments after the callback will be passed tothe callback when it is called.</p></blockquote><p>在<strong>下一个迭代的时间循环</strong>中立刻调用回调函数，看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">args</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;callback: <span class="subst">&#123;args&#125;</span> (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>(<span class="params">loop</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;first time&#x27;</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;second time&#x27;</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(loopEvent), my_coroutine(loopEvent)]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 11056)&gt;)</span><br></pre></td></tr></table></figure><h3 id="call_later"><a class="markdownIt-Anchor" href="#call_later"></a> call_later</h3><p>事件循环在<code>delay</code>一定时间后执行<code>callback</code>函数</p><p><code>call_later(self, delay, callback, *args, context=None)</code></p><blockquote><p>Arrange for a callback to be called at a given time.Return a Handle: an opaque object with a cancel() method thatcan be used to cancel the call.The delay can be an int or float, expressed in seconds. It isalways relative to the current time.Each callback will be called exactly once. If two callbacksare scheduled for exactly the same time, it undefined whichwill be called first.Any positional arguments after the callback will be passed tothe callback when it is called.</p></blockquote><p>直接看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">args</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;callback: <span class="subst">&#123;args&#125;</span> (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>(<span class="params">loop</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    loop.call_later(<span class="number">0.4</span>, callback, <span class="string">&#x27;second time&#x27;</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;first time&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(loopEvent), my_coroutine(loopEvent)]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 17904)&gt;)</span><br></pre></td></tr></table></figure><h3 id="call_at"><a class="markdownIt-Anchor" href="#call_at"></a> call_at</h3><p><code>call_at(self, when, callback, *args, context=None)</code></p><blockquote><p>Like call_later(), but uses an absolute time.</p><p>Absolute time corresponds to the event loop’s time() method.</p></blockquote><p>call_at第一个参数的含义代表的是一个单调时间，它和我们平时说的系统时间有点差异，</p><p>这里的时间指的是事件循环内部时间，可以通过<code>loop.time()</code>获取，然后可以在此基础上进行操作。后面的参数和前面的两个方法一样。实际上call_later内部就是调用的call_at</p><p>上代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">args</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;callback: <span class="subst">&#123;args&#125;</span> (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">my_coroutine</span>(<span class="params">loop</span>):</span></span><br><span class="line">    print(<span class="string">f&#x27;I ain\&#x27;t got no money (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line">    loop.call_at(loop.time() + <span class="number">0.2</span>, callback, <span class="string">&#x27;second time&#x27;</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="string">&#x27;first time&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(<span class="string">f&#x27;Do not go gentle into that good night (<span class="subst">&#123;threading.currentThread()&#125;</span>)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loopEvent = asyncio.get_event_loop()</span><br><span class="line">    tasks = [my_coroutine(loopEvent), my_coroutine(loopEvent)]</span><br><span class="line">    loopEvent.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    loopEvent.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">I ain&#39;t got no money (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: first time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">callback: second time (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br><span class="line">Do not go gentle into that good night (&lt;_MainThread(MainThread, started 18504)&gt;)</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">Kevinello</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://kevinello.ltd/2021/03/17/Python-asyncio%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/">http://kevinello.ltd/2021/03/17/Python-asyncio%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://kevinello.ltd" target="_blank">Kevinello</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a><a class="post-meta__tags" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/asyncio/">asyncio</a></div><div class="post_share"><div class="social-share" data-image="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141902_04_compressed.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/11/Redis%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%E7%9A%84%E4%BA%A7%E7%94%9F%E4%B8%8E%E6%B8%85%E7%90%86/"><img class="prev-cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210411164926.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis内存碎片的产生与清理</div></div></a></div><div class="next-post pull-right"><a href="/2021/02/15/Python-yield%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3/"><img class="next-cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141913_00.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python-yield关键字详解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/02/15/Python-yield%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3/" title="Python-yield关键字详解"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141913_00.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-15</div><div class="title">Python-yield关键字详解</div></div></a></div><div><a href="/2021/02/07/Go%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="Go单例模式"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/sunset3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-07</div><div class="title">Go单例模式</div></div></a></div><div><a href="/2021/02/08/Python%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/" title="Python日志管理"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/street3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-08</div><div class="title">Python日志管理</div></div></a></div><div><a href="/2020/11/28/K8s-RoadMap/" title="K8s-RoadMap"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/v2-582b2a32df399cc3f40ef62fd099e438_720w.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-28</div><div class="title">K8s-RoadMap</div></div></a></div><div><a href="/2020/11/29/DEM%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97/" title="DEM项目日志"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/sky5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-29</div><div class="title">DEM项目日志</div></div></a></div><div><a href="/2021/04/11/Redis%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%E7%9A%84%E4%BA%A7%E7%94%9F%E4%B8%8E%E6%B8%85%E7%90%86/" title="Redis内存碎片的产生与清理"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20210411164926.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-11</div><div class="title">Redis内存碎片的产生与清理</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div id="comment-switch"><span class="first-comment">Utterances</span><span class="switch-btn"></span><span class="second-comment">Twikoo</span></div></div><div class="comment-wrap"><div><div id="utterances-wrap"></div></div><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/myself-e3fde6.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Kevinello</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kevinello"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/kevinello" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://space.bilibili.com/23149976" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili-fill"></i></a><a class="social-icon" href="mailto:kevinello42@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84%E5%87%A0%E4%B8%AA%E8%AF%8D"><span class="toc-number">2.</span> <span class="toc-text">需要了解的几个词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asyncio-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">3.</span> <span class="toc-text">asyncio 是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asyncio%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">asyncio基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async-await"><span class="toc-number">5.</span> <span class="toc-text">async &#x2F; await</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E4%B8%AD%E8%B0%83%E7%94%A8%E6%99%AE%E9%80%9A%E5%87%BD%E6%95%B0"><span class="toc-number">6.</span> <span class="toc-text">协程中调用普通函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#call_soon"><span class="toc-number">6.1.</span> <span class="toc-text">call_soon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call_later"><span class="toc-number">6.2.</span> <span class="toc-text">call_later</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call_at"><span class="toc-number">6.3.</span> <span class="toc-text">call_at</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/11/Kevinello%E7%9A%84minecraft%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="Kevinello的minecraft服务器"><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/10/mc-server-1-0fdacc.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Kevinello的minecraft服务器"></a><div class="content"><a class="title" href="/2022/04/11/Kevinello%E7%9A%84minecraft%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="Kevinello的minecraft服务器">Kevinello的minecraft服务器</a><time datetime="2022-04-10T16:59:10.000Z" title="发表于 2022-04-11 00:59:10">2022-04-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/11/Run-minecraft-on-mac-pro-m1/" title="Run minecraft on mac pro m1"><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/image-20220411004009248-89fe44.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Run minecraft on mac pro m1"></a><div class="content"><a class="title" href="/2022/04/11/Run-minecraft-on-mac-pro-m1/" title="Run minecraft on mac pro m1">Run minecraft on mac pro m1</a><time datetime="2022-04-10T16:12:47.000Z" title="发表于 2022-04-11 00:12:47">2022-04-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/%E5%B0%8F%E5%88%AE%E5%88%AEScrapy/" title="小刮刮Scrapy"><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20220110152859.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="小刮刮Scrapy"></a><div class="content"><a class="title" href="/2022/01/10/%E5%B0%8F%E5%88%AE%E5%88%AEScrapy/" title="小刮刮Scrapy">小刮刮Scrapy</a><time datetime="2022-01-10T07:30:10.000Z" title="发表于 2022-01-10 15:30:10">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/%E9%9D%A2%E8%AF%95%E5%AE%98%E5%88%9D%E4%BD%93%E9%AA%8C/" title="面试官初体验"><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20220110130328.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试官初体验"></a><div class="content"><a class="title" href="/2022/01/10/%E9%9D%A2%E8%AF%95%E5%AE%98%E5%88%9D%E4%BD%93%E9%AA%8C/" title="面试官初体验">面试官初体验</a><time datetime="2022-01-10T04:59:10.000Z" title="发表于 2022-01-10 12:59:10">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/18/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%972/" title="Whosbug项目日志2"><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211018194549.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Whosbug项目日志2"></a><div class="content"><a class="title" href="/2021/10/18/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%972/" title="Whosbug项目日志2">Whosbug项目日志2</a><time datetime="2021-10-18T11:41:15.000Z" title="发表于 2021-10-18 19:41:15">2021-10-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141902_04_compressed.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Kevinello</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Algolia</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>function loadUtterances () {
  let ele = document.createElement('script')
  ele.setAttribute('id', 'utterances_comment')
  ele.setAttribute('src', 'https://utteranc.es/client.js')
  ele.setAttribute('repo', 'Kevinello/gitalk')
  ele.setAttribute('issue-term', 'pathname')
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
  ele.setAttribute('theme', nowTheme)
  ele.setAttribute('crossorigin', 'anonymous')
  ele.setAttribute('async', 'true')
  document.getElementById('utterances-wrap').insertAdjacentElement('afterbegin',ele)
}

function utterancesTheme () {
  const iframe = document.querySelector('.utterances-frame')
  if (iframe) {
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
    const message = {
      type: 'set-theme',
      theme: theme
    };
    iframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }
}

if ('Utterances' === 'Utterances' || !false) {
  if (false) btf.loadComment(document.getElementById('utterances-wrap'), loadUtterances)
  else loadUtterances()
} else {
  function loadOtherComment () {
    loadUtterances()
  }
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'blog-comments-9gil6as164013b6c',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.vemoji)'))
      }
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'blog-comments-9gil6as164013b6c',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      document.getElementById('twikoo-count').innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Utterances' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>