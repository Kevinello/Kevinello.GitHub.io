<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>浅尝antlr4 | Kevinello</title><meta name="keywords" content="Whosbug,语法分析,Python,antlr4,java"><meta name="author" content="Kevinello"><meta name="copyright" content="Kevinello"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="浅尝Antlr4  前言  Antlr是什么 In a word, 多源语言多目标语言的一个语法分析框架 以下是官方文档的解释：  ANTLR（ANother Tool for Language Recognition）是一个功能强大的解析器生成器，用于读取，处理，执行或翻译结构化文本或二进制文件。它被广泛用于构建语言，工具和框架。ANTLR从语法上生成一个解析器，该解析器可以构建解析树，还可以"><meta property="og:type" content="article"><meta property="og:title" content="浅尝antlr4"><meta property="og:url" content="http://kevinello.ltd/2020/11/30/%E6%B5%85%E5%B0%9Dantlr4/index.html"><meta property="og:site_name" content="Kevinello"><meta property="og:description" content="浅尝Antlr4  前言  Antlr是什么 In a word, 多源语言多目标语言的一个语法分析框架 以下是官方文档的解释：  ANTLR（ANother Tool for Language Recognition）是一个功能强大的解析器生成器，用于读取，处理，执行或翻译结构化文本或二进制文件。它被广泛用于构建语言，工具和框架。ANTLR从语法上生成一个解析器，该解析器可以构建解析树，还可以"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/metro.png"><meta property="article:published_time" content="2020-11-30T03:11:15.000Z"><meta property="article:modified_time" content="2022-07-05T10:33:54.053Z"><meta property="article:author" content="Kevinello"><meta property="article:tag" content="Whosbug"><meta property="article:tag" content="语法分析"><meta property="article:tag" content="Python"><meta property="article:tag" content="antlr4"><meta property="article:tag" content="java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/metro.png"><link rel="shortcut icon" href="/imgs/K.jpg"><link rel="canonical" href="http://kevinello.ltd/2020/11/30/%E6%B5%85%E5%B0%9Dantlr4/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2a20aecba22b2eaf60183c4831d9a52";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RV8K5FBVX5"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RV8K5FBVX5")</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"13UJR6CRNO","apiKey":"456e56f51ec27a1e13d67bef144f6747","indexName":"Kevinello_blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"浅尝antlr4",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-07-05 18:33:54"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2232093_k6128tldgy.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/myself-e3fde6.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">83</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/metro.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kevinello</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">浅尝antlr4</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-30T03:11:15.000Z" title="发表于 2020-11-30 11:11:15">2020-11-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-05T10:33:54.053Z" title="更新于 2022-07-05 18:33:54">2022-07-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="浅尝antlr4"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="浅尝antlr4"><a class="markdownIt-Anchor" href="#浅尝antlr4"></a> 浅尝Antlr4</h1><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><h3 id="antlr是什么"><a class="markdownIt-Anchor" href="#antlr是什么"></a> Antlr是什么</h3><p>In a word, 多源语言多目标语言的一个语法分析框架</p><p>以下是官方文档的解释：</p><blockquote><p><strong>ANTLR</strong>（ANother Tool for Language Recognition）是一个功能强大的解析器生成器，用于读取，处理，执行或翻译结构化文本或二进制文件。它被广泛用于构建语言，工具和框架。ANTLR从语法上生成一个解析器，该解析器可以构建解析树，还可以生成一个侦听器接口（或访问者），从而可以轻松地对所关注短语的识别做出响应。</p><p><strong>ANTLR</strong> (ANother Tool for Language Recognition) is a powerful parser generator for reading, processing, executing, or translating structured text or binary files. It’s widely used to build languages, tools, and frameworks. From a grammar, ANTLR generates a parser that can build parse trees and also generates a listener interface (or visitor) that makes it easy to respond to the recognition of phrases of interest.</p></blockquote><p><a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4">Github项目地址</a></p><p>这次使用antlr的诱因是whosbug中使用的ctags（另一个语法分析器）只对c系语言支持较好，对java等语言的支持欠佳（甚至可以说很差了），为了whosbug的鲁棒性我认为还是有必要换一个语法分析器的</p><h3 id="几个需要了解的词"><a class="markdownIt-Anchor" href="#几个需要了解的词"></a> 几个需要了解的词</h3><ul><li><p>AST：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9">抽象语法树</a></p></li><li><p>target language：antlr可以根据源语言的.g4文件生成不同语言（target language）的分析代码<br><a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/tree/master/doc">各种target language的文档（有些很简略）</a></p></li><li><p>Lexer：antlr中的词法分析器（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90">词法分析</a>）</p></li><li><p>Parser：antlr中的语法分析器（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90">语法分析</a>）</p></li><li><p>Listener：是antlr中的独有概念，与传统源码分析不同，antlr提供Listener这一API供用户自定义自己的分析器，这种方式可以很大程度上使语法更易于阅读（按每位用户自己的设计），同时使得它们能避免与特定的应用程序耦合在一起，以下是官方的解释（<a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/doc/listeners.md">官方文档</a>）：</p><blockquote><p>Because we specify phrase structure with a set of rules, parse tree subtree roots correspond to grammar rule names. ANTLR has a ParseTreeWalker that knows how to walk these parse trees and trigger events in listener implementation objects that you can create. The ANTLR tool generates listener interfaces for you also, unless you turn that off with a commandline option. You can also have it generate visitors. For example from a Java.g4 grammar, ANTLR generates:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JavaListener</span> <span class="keyword">extends</span> <span class="title">ParseTreeListener</span>&lt;<span class="title">Token</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enterClassDeclaration</span><span class="params">(JavaParser.ClassDeclarationContext ctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">exitClassDeclaration</span><span class="params">(JavaParser.ClassDeclarationContext ctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enterMethodDeclaration</span><span class="params">(JavaParser.MethodDeclarationContext ctx)</span></span>;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>where there is an enter and exit method for each rule in the parser grammar. ANTLR also generates a base listener with the fall empty implementations of all listener interface methods, in this case called JavaBaseListener. You can build your listener by subclassing this base and overriding the methods of interest.</p><p>Listeners and visitors are great because they keep application-specific code out of grammars, making grammars easier to read and preventing them from getting entangled with a particular application.</p></blockquote></li></ul><p><a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/tree/master/doc">其它相关概念见antlr在github上的官方文档</a></p><h2 id="安装antlr4"><a class="markdownIt-Anchor" href="#安装antlr4"></a> 安装antlr4</h2><p><a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/doc/getting-started.md">官方文档</a></p><ul><li><p>安装Java（1.7版或更高版本），这个不会就入土8</p></li><li><p>下载antlr4</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lib</span><br><span class="line">$ curl -O https://www.antlr.org/download/antlr-4.9-complete.jar</span><br></pre></td></tr></table></figure></li><li><p>添加<code>antlr-4.9-complete.jar</code>到<code>CLASSPATH</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> CLASSPATH=<span class="string">&quot;.:/usr/local/lib/antlr-4.9-complete.jar:<span class="variable">$CLASSPATH</span>&quot;</span></span><br></pre></td></tr></table></figure><p>将其放入<code>.bash_profile</code>，就不需要每次都改环境变量了</p></li><li><p>为ANTLR Tool和 <code>TestRig</code>创建alias：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">alias</span> antlr4=<span class="string">&#x27;java -Xmx500M -cp &quot;/usr/local/lib/antlr-4.9-complete.jar:$CLASSPATH&quot; org.antlr.v4.Tool&#x27;</span></span><br><span class="line">$ <span class="built_in">alias</span> grun=<span class="string">&#x27;java -Xmx500M -cp &quot;/usr/local/lib/antlr-4.9-complete.jar:$CLASSPATH&quot; org.antlr.v4.gui.TestRig&#x27;</span></span><br></pre></td></tr></table></figure></li></ul><p>输入antlr4验证一下安装情况：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-install-success.png" alt=""></p><h2 id="获取targer-language为python的分析模块"><a class="markdownIt-Anchor" href="#获取targer-language为python的分析模块"></a> 获取targer language为python的分析模块</h2><h3 id="获取g4语法文件"><a class="markdownIt-Anchor" href="#获取g4语法文件"></a> 获取.g4语法文件</h3><p>ANTLR的GitHub项目中提供了用于不同语言的语法文件（.g4）</p><p><a target="_blank" rel="noopener" href="https://github.com/antlr/grammars-v4">官方g4文件收录库</a></p><p>这次的需求先重点解决java的语法分析问题，所以一开始我找到了java9的g4文件，但生成分析代码的时候报错了：<br><code>Incorrectly generated code for Python 3 target</code>，google了一番找到了对应的issue：<a target="_blank" rel="noopener" href="https://github.com/antlr/grammars-v4/issues/739">https://github.com/antlr/grammars-v4/issues/739</a><br><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-install-issue.png" alt="issue739"></p><p>更换成https://github.com/antlr/grammars-v4/tree/master/java/java中的.g4文件后就没问题了</p><h3 id="生成分析模块"><a class="markdownIt-Anchor" href="#生成分析模块"></a> 生成分析模块</h3><p>按官方文档生成分析模块源码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">antlr4 -Dlanguage=Python3 JavaLexer.g4</span><br><span class="line">antlr4 -Dlanguage=Python3 JavaParser.g4</span><br></pre></td></tr></table></figure><p>生成结果见下图：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-get.png" alt="生成结果"></p><p>其中<code>JavaLexer.py</code>,<code>JavaParser.py</code>,<code>JavaParserListener.py</code>是我们需要重点关注的</p><h3 id="安装antlr4-python3-runtime"><a class="markdownIt-Anchor" href="#安装antlr4-python3-runtime"></a> 安装antlr4-python3-runtime</h3><p>这步没什么好说的，直接pip install完事</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install antlr4-python3-runtime</span><br></pre></td></tr></table></figure><h2 id="创建自定义listener"><a class="markdownIt-Anchor" href="#创建自定义listener"></a> 创建自定义Listener</h2><p>我的目录结构如下：</p><p><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-dir.png" alt=""></p><h3 id="analyzerpy"><a class="markdownIt-Anchor" href="#analyzerpy"></a> <a target="_blank" rel="noopener" href="http://analyzer.py">analyzer.py</a></h3><p>分析模块入口，main所在位置，废话不多说，上码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">from</span> ast_java.ast_processor <span class="keyword">import</span> AstProcessor</span><br><span class="line"><span class="keyword">from</span> ast_java.basic_info_listener <span class="keyword">import</span> BasicInfoListener</span><br><span class="line"></span><br><span class="line">logging.config.fileConfig(<span class="string">&#x27;log/utiltools_log.conf&#x27;</span>)</span><br><span class="line">AST_ANALYZER = AstProcessor(logging, BasicInfoListener())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyze_java</span>(<span class="params">target_file_path</span>):</span></span><br><span class="line">    <span class="keyword">return</span> AST_ANALYZER.execute(target_file_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    analyze_java(<span class="string">&#x27;testfiles/java/AllInOne7.java&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="ast_processorpy"><a class="markdownIt-Anchor" href="#ast_processorpy"></a> ast_processor.py</h3><p>调用antlr的语法分析模块，生成AST，供自定义Listener使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> antlr4 <span class="keyword">import</span> FileStream, CommonTokenStream, ParseTreeWalker</span><br><span class="line"><span class="keyword">from</span> ast_java.JavaLexer <span class="keyword">import</span> JavaLexer</span><br><span class="line"><span class="keyword">from</span> ast_java.JavaParser <span class="keyword">import</span> JavaParser</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pformat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AstProcessor</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, logging, listener</span>):</span></span><br><span class="line">        self.logging = logging</span><br><span class="line">        self.logger = logging.getLogger(self.__class__.__name__)</span><br><span class="line">        self.listener = listener</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">self, input_source</span>):</span></span><br><span class="line">        parser = JavaParser(CommonTokenStream(JavaLexer(FileStream(input_source, encoding=<span class="string">&quot;utf-8&quot;</span>))))</span><br><span class="line">        walker = ParseTreeWalker()</span><br><span class="line">        walker.walk(self.listener, parser.compilationUnit())</span><br><span class="line">        self.logger.debug(<span class="string">&#x27;Display all data extracted by AST. \n&#x27;</span> + pformat(self.listener.ast_info, width=<span class="number">160</span>))</span><br><span class="line">        <span class="keyword">return</span> self.listener.ast_info</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="basic_info_listenerpy"><a class="markdownIt-Anchor" href="#basic_info_listenerpy"></a> basic_info_listener.py</h3><p>这部分就完全是自定义的了，同时也是源码分析的关键，在这部分设计的分析模式决定了分析结果的数据结构</p><p>简单来说就是继承<code>JavaParserListener</code>，然后扩展自己需要的内容</p><p>具体的使用还是需要自己去读一下源码，这里放一下我写的作为参考：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ast_java.JavaParserListener <span class="keyword">import</span> JavaParserListener</span><br><span class="line"><span class="keyword">from</span> ast_java.JavaParser <span class="keyword">import</span> JavaParser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicInfoListener</span>(<span class="params">JavaParserListener</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.call_methods = []</span><br><span class="line">        self.ast_info = &#123;</span><br><span class="line">            <span class="string">&#x27;packageName&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;className&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;implements&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;extends&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;imports&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;fields&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;methods&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#packageDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterPackageDeclaration</span>(<span class="params">self, ctx: JavaParser.PackageDeclarationContext</span>):</span></span><br><span class="line">        self.ast_info[<span class="string">&#x27;packageName&#x27;</span>] = ctx.qualifiedName().getText()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#importDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterImportDeclaration</span>(<span class="params">self, ctx: JavaParser.ImportDeclarationContext</span>):</span></span><br><span class="line">        import_class = ctx.qualifiedName().getText()</span><br><span class="line">        self.ast_info[<span class="string">&#x27;imports&#x27;</span>].append(import_class)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#methodDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterMethodDeclaration</span>(<span class="params">self, ctx: JavaParser.MethodDeclarationContext</span>):</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">&quot;Start line: &#123;0&#125; | End line: &#123;1&#125; | Method name: &#123;2&#125;&quot;</span>.<span class="built_in">format</span>(ctx.start.line, ctx.methodBody().stop.line, ctx.getChild(<span class="number">1</span>).getText()))</span><br><span class="line">        self.call_methods = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Exit a parse tree produced by JavaParser#methodDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exitMethodDeclaration</span>(<span class="params">self, ctx: JavaParser.MethodDeclarationContext</span>):</span></span><br><span class="line">        c1 = ctx.getChild(<span class="number">0</span>).getText()  <span class="comment"># ---&gt; return type</span></span><br><span class="line">        c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; method name</span></span><br><span class="line">        params = self.parse_method_params_block(ctx.getChild(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">        method_info = &#123;</span><br><span class="line">            <span class="string">&#x27;startLine&#x27;</span>: ctx.start.line,</span><br><span class="line">            <span class="string">&#x27;endLine&#x27;</span>: ctx.methodBody().stop.line,</span><br><span class="line">            <span class="string">&#x27;returnType&#x27;</span>: c1,</span><br><span class="line">            <span class="string">&#x27;methodName&#x27;</span>: c2,</span><br><span class="line">            <span class="string">&#x27;params&#x27;</span>: params,</span><br><span class="line">            <span class="string">&#x27;depth&#x27;</span>: ctx.depth(),</span><br><span class="line">            <span class="string">&#x27;callMethods&#x27;</span>: self.call_methods</span><br><span class="line">        &#125;</span><br><span class="line">        self.ast_info[<span class="string">&#x27;methods&#x27;</span>].append(method_info)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#methodCall.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterMethodCall</span>(<span class="params">self, ctx: JavaParser.MethodCallContext</span>):</span></span><br><span class="line">        line_number = <span class="built_in">str</span>(ctx.start.line)</span><br><span class="line">        column_number = <span class="built_in">str</span>(ctx.start.column)</span><br><span class="line">        self.call_methods.append(line_number + <span class="string">&#x27; &#x27;</span> + column_number + <span class="string">&#x27; &#x27;</span> + ctx.parentCtx.getText())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#classDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterClassDeclaration</span>(<span class="params">self, ctx: JavaParser.ClassDeclarationContext</span>):</span></span><br><span class="line">        child_count = <span class="built_in">int</span>(ctx.getChildCount())</span><br><span class="line">        <span class="keyword">if</span> child_count == <span class="number">7</span>:</span><br><span class="line">            <span class="comment"># class Foo extends Bar implements Hoge</span></span><br><span class="line">            <span class="comment"># c1 = ctx.getChild(0)  # ---&gt; class</span></span><br><span class="line">            c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; class name</span></span><br><span class="line">            <span class="comment"># c3 = ctx.getChild(2)  # ---&gt; extends</span></span><br><span class="line">            c4 = ctx.getChild(<span class="number">3</span>).getChild(<span class="number">0</span>).getText()  <span class="comment"># ---&gt; extends class name</span></span><br><span class="line">            <span class="comment"># c5 = ctx.getChild(4)  # ---&gt; implements</span></span><br><span class="line">            <span class="comment"># c7 = ctx.getChild(6)  # ---&gt; method body</span></span><br><span class="line">            self.ast_info[<span class="string">&#x27;className&#x27;</span>] = c2</span><br><span class="line">            self.ast_info[<span class="string">&#x27;implements&#x27;</span>] = self.parse_implements_block(ctx.getChild(<span class="number">5</span>))</span><br><span class="line">            self.ast_info[<span class="string">&#x27;extends&#x27;</span>] = c4</span><br><span class="line">        <span class="keyword">elif</span> child_count == <span class="number">5</span>:</span><br><span class="line">            <span class="comment"># class Foo extends Bar</span></span><br><span class="line">            <span class="comment"># or</span></span><br><span class="line">            <span class="comment"># class Foo implements Hoge</span></span><br><span class="line">            <span class="comment"># c1 = ctx.getChild(0)  # ---&gt; class</span></span><br><span class="line">            c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; class name</span></span><br><span class="line">            c3 = ctx.getChild(<span class="number">2</span>).getText()  <span class="comment"># ---&gt; extends or implements</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># c5 = ctx.getChild(4)  # ---&gt; method body</span></span><br><span class="line">            self.ast_info[<span class="string">&#x27;className&#x27;</span>] = c2</span><br><span class="line">            <span class="keyword">if</span> c3 == <span class="string">&#x27;implements&#x27;</span>:</span><br><span class="line">                self.ast_info[<span class="string">&#x27;implements&#x27;</span>] = self.parse_implements_block(ctx.getChild(<span class="number">3</span>))</span><br><span class="line">            <span class="keyword">elif</span> c3 == <span class="string">&#x27;extends&#x27;</span>:</span><br><span class="line">                c4 = ctx.getChild(<span class="number">3</span>).getChild(<span class="number">0</span>).getText()  <span class="comment"># ---&gt; extends class name or implements class name</span></span><br><span class="line">                self.ast_info[<span class="string">&#x27;extends&#x27;</span>] = c4</span><br><span class="line">        <span class="keyword">elif</span> child_count == <span class="number">3</span>:</span><br><span class="line">            <span class="comment"># class Foo</span></span><br><span class="line">            <span class="comment"># c1 = ctx.getChild(0)  # ---&gt; class</span></span><br><span class="line">            c2 = ctx.getChild(<span class="number">1</span>).getText()  <span class="comment"># ---&gt; class name</span></span><br><span class="line">            <span class="comment"># c3 = ctx.getChild(2)  # ---&gt; method body</span></span><br><span class="line">            self.ast_info[<span class="string">&#x27;className&#x27;</span>] = c2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enter a parse tree produced by JavaParser#fieldDeclaration.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enterFieldDeclaration</span>(<span class="params">self, ctx: JavaParser.FieldDeclarationContext</span>):</span></span><br><span class="line">        field = &#123;</span><br><span class="line">            <span class="string">&#x27;fieldType&#x27;</span>: ctx.getChild(<span class="number">0</span>).getText(),</span><br><span class="line">            <span class="string">&#x27;fieldDefinition&#x27;</span>: ctx.getChild(<span class="number">1</span>).getText()</span><br><span class="line">        &#125;</span><br><span class="line">        self.ast_info[<span class="string">&#x27;fields&#x27;</span>].append(field)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_implements_block</span>(<span class="params">self, ctx</span>):</span></span><br><span class="line">        implements_child_count = <span class="built_in">int</span>(ctx.getChildCount())</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">if</span> implements_child_count == <span class="number">1</span>:</span><br><span class="line">            impl_class = ctx.getChild(<span class="number">0</span>).getText()</span><br><span class="line">            result.append(impl_class)</span><br><span class="line">        <span class="keyword">elif</span> implements_child_count &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(implements_child_count):</span><br><span class="line">                <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                    impl_class = ctx.getChild(i).getText()</span><br><span class="line">                    result.append(impl_class)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_method_params_block</span>(<span class="params">self, ctx</span>):</span></span><br><span class="line">        params_exist_check = <span class="built_in">int</span>(ctx.getChildCount())</span><br><span class="line">        result = []</span><br><span class="line">        <span class="comment"># () ---&gt; 2</span></span><br><span class="line">        <span class="comment"># (Foo foo) ---&gt; 3</span></span><br><span class="line">        <span class="comment"># (Foo foo, Bar bar) ---&gt; 3</span></span><br><span class="line">        <span class="comment"># (Foo foo, Bar bar, int count) ---&gt; 3</span></span><br><span class="line">        <span class="keyword">if</span> params_exist_check == <span class="number">3</span>:</span><br><span class="line">            params_child_count = <span class="built_in">int</span>(ctx.getChild(<span class="number">1</span>).getChildCount())</span><br><span class="line">            <span class="keyword">if</span> params_child_count == <span class="number">1</span>:</span><br><span class="line">                param_type = ctx.getChild(<span class="number">1</span>).getChild(<span class="number">0</span>).getChild(<span class="number">0</span>).getText()</span><br><span class="line">                param_name = ctx.getChild(<span class="number">1</span>).getChild(<span class="number">0</span>).getChild(<span class="number">1</span>).getText()</span><br><span class="line">                param_info = &#123;</span><br><span class="line">                    <span class="string">&#x27;paramType&#x27;</span>: param_type,</span><br><span class="line">                    <span class="string">&#x27;paramName&#x27;</span>: param_name</span><br><span class="line">                &#125;</span><br><span class="line">                result.append(param_info)</span><br><span class="line">            <span class="keyword">elif</span> params_child_count &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(params_child_count):</span><br><span class="line">                    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                        param_type = ctx.getChild(<span class="number">1</span>).getChild(i).getChild(<span class="number">0</span>).getText()</span><br><span class="line">                        param_name = ctx.getChild(<span class="number">1</span>).getChild(i).getChild(<span class="number">1</span>).getText()</span><br><span class="line">                        param_info = &#123;</span><br><span class="line">                            <span class="string">&#x27;paramType&#x27;</span>: param_type,</span><br><span class="line">                            <span class="string">&#x27;paramName&#x27;</span>: param_name</span><br><span class="line">                        &#125;</span><br><span class="line">                        result.append(param_info)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里简单说明一下几个重要的点，便于理解：</p><ul><li><code>BasicInfoListener</code>继承<code>JavaParserListener</code>，供用户自定义遍历AST的方法</li><li><code>ast_info</code>为分析结果<code>dict</code></li><li><code>JavaParserListener</code>覆盖在<code>BasicInfoListener</code>中定义的挂钩点分析方法，并实现其自己的分析过程<br>例如，<code>enterPackageDeclaration</code>，顾名思义，它在Java源码包定义的开头（即enter）被调用<br>参数<code>ctx</code>（上下文）具有不同的类型，但是由于存在父类，因此任何上下文类都可以访问语法解析所需的基本信息（通过getChild,getParent等方法）</li></ul><p>还有很多的细节信息其实都有，这里就不一一赘述（都在源码里啦）</p><h2 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h2><p>到这里分析模块就完成啦，用<a target="_blank" rel="noopener" href="https://github.com/antlr/grammars-v4/tree/master/java/java/examples">官方提供的Java被测源码</a>试一下效果8</p><p>命令行输出：<br><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-console.png" alt=""></p><p>ast_info：<br><img src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/antlr-res.png" alt=""></p><p>Done（antlr比ctags不知道好用多少倍）</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">Kevinello</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://kevinello.ltd/2020/11/30/%E6%B5%85%E5%B0%9Dantlr4/">http://kevinello.ltd/2020/11/30/浅尝antlr4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://kevinello.ltd" target="_blank">Kevinello</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Whosbug/">Whosbug</a><a class="post-meta__tags" href="/tags/%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90/">语法分析</a><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/antlr4/">antlr4</a><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/metro.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/01/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%AE%9E%E4%B9%A0%E8%80%83%E6%A0%B8%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/street.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">第一次实习考核总结</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/29/DEM%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97/"><img class="next-cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/sky5.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">DEM项目日志</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/11/27/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%971/" title="Whosbug项目日志1"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/night3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-27</div><div class="title">Whosbug项目日志1</div></div></a></div><div><a href="/2021/10/18/Whosbug%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%972/" title="Whosbug项目日志2"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211018194549.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-18</div><div class="title">Whosbug项目日志2</div></div></a></div><div><a href="/2021/10/13/Keyman%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6/" title="Keyman算法设计哲学"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/20211013151243.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-13</div><div class="title">Keyman算法设计哲学</div></div></a></div><div><a href="/2021/03/17/Python-asyncio%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" title="Python-asyncio异步编程基础"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141902_04_compressed.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-17</div><div class="title">Python-asyncio异步编程基础</div></div></a></div><div><a href="/2021/02/15/Python-yield%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3/" title="Python-yield关键字详解"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/02141913_00.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-15</div><div class="title">Python-yield关键字详解</div></div></a></div><div><a href="/2020/11/27/pandas-%E5%A4%A7%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/" title="pandas 大文件操作"><img class="cover" src="https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/sky3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-27</div><div class="title">pandas 大文件操作</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div id="comment-switch"><span class="first-comment">Utterances</span><span class="switch-btn"></span><span class="second-comment">Twikoo</span></div></div><div class="comment-wrap"><div><div id="utterances-wrap"></div></div><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/04/11/myself-e3fde6.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Kevinello</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">83</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kevinello"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/kevinello" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://space.bilibili.com/23149976" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili-fill"></i></a><a class="social-icon" href="mailto:kevinello42@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%85%E5%B0%9Dantlr4"><span class="toc-number">1.</span> <span class="toc-text">浅尝Antlr4</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#antlr%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">Antlr是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84%E8%AF%8D"><span class="toc-number">1.1.2.</span> <span class="toc-text">几个需要了解的词</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85antlr4"><span class="toc-number">1.2.</span> <span class="toc-text">安装antlr4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96targer-language%E4%B8%BApython%E7%9A%84%E5%88%86%E6%9E%90%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.</span> <span class="toc-text">获取targer language为python的分析模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96g4%E8%AF%AD%E6%B3%95%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">获取.g4语法文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%88%86%E6%9E%90%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.2.</span> <span class="toc-text">生成分析模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85antlr4-python3-runtime"><span class="toc-number">1.3.3.</span> <span class="toc-text">安装antlr4-python3-runtime</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89listener"><span class="toc-number">1.4.</span> <span class="toc-text">创建自定义Listener</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyzerpy"><span class="toc-number">1.4.1.</span> <span class="toc-text">analyzer.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast_processorpy"><span class="toc-number">1.4.2.</span> <span class="toc-text">ast_processor.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basic_info_listenerpy"><span class="toc-number">1.4.3.</span> <span class="toc-text">basic_info_listener.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/Git-%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8-1/" title="Git 进阶使用1"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/10/08/baby-git-release-6ede8f.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Git 进阶使用1"></a><div class="content"><a class="title" href="/2022/10/07/Git-%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8-1/" title="Git 进阶使用1">Git 进阶使用1</a><time datetime="2022-10-07T09:00:36.000Z" title="发表于 2022-10-07 17:00:36">2022-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/10/notion-%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="notion 初步使用指南"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/08/28/Notion_app_logo-64956b.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="notion 初步使用指南"></a><div class="content"><a class="title" href="/2022/08/10/notion-%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="notion 初步使用指南">notion 初步使用指南</a><time datetime="2022-08-09T17:49:07.000Z" title="发表于 2022-08-10 01:49:07">2022-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/01/%E5%A4%A7%E4%B8%80%E7%BB%9F%E7%AC%A6%E5%8F%B7%E8%BF%98%E5%8E%9F/" title="大一统符号还原"><img src="https://kevinello-1302687393.file.myqcloud.com/picgo/2022/08/03/image-20220803133758954-65fb61.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="大一统符号还原"></a><div class="content"><a class="title" href="/2022/08/01/%E5%A4%A7%E4%B8%80%E7%BB%9F%E7%AC%A6%E5%8F%B7%E8%BF%98%E5%8E%9F/" title="大一统符号还原">大一统符号还原</a><time datetime="2022-08-01T06:11:30.000Z" title="发表于 2022-08-01 14:11:30">2022-08-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/17/%E6%B5%85%E8%B0%88%E6%B5%81%E7%A8%8B-in-2022/" title="浅谈流程 in 2022"><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/07/17/755134-27e050.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="浅谈流程 in 2022"></a><div class="content"><a class="title" href="/2022/07/17/%E6%B5%85%E8%B0%88%E6%B5%81%E7%A8%8B-in-2022/" title="浅谈流程 in 2022">浅谈流程 in 2022</a><time datetime="2022-07-17T02:08:17.000Z" title="发表于 2022-07-17 10:08:17">2022-07-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/13/Golang-panic-recover-%E8%AF%A6%E8%A7%A3/" title="Golang panic&amp;recover 详解"><img src="http://kevinello-1302687393.file.myqcloud.com/picgo/2022/07/05/1-3N1cYeaexHSCofJq9fo3gQ-d27c5c.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Golang panic&amp;recover 详解"></a><div class="content"><a class="title" href="/2022/06/13/Golang-panic-recover-%E8%AF%A6%E8%A7%A3/" title="Golang panic&amp;recover 详解">Golang panic&amp;recover 详解</a><time datetime="2022-06-13T11:35:31.000Z" title="发表于 2022-06-13 19:35:31">2022-06-13</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://kevinello-1302687393.cos.ap-hongkong.myqcloud.com/img/metro.png)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Kevinello</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">🥳 🥳 🥳 🥳 🥳</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Algolia</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/search/optimized_algolia.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadUtterances () {
  let ele = document.createElement('script')
  ele.setAttribute('id', 'utterances_comment')
  ele.setAttribute('src', 'https://utteranc.es/client.js')
  ele.setAttribute('repo', 'Kevinello/gitalk')
  ele.setAttribute('issue-term', 'pathname')
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
  ele.setAttribute('theme', nowTheme)
  ele.setAttribute('crossorigin', 'anonymous')
  ele.setAttribute('async', 'true')
  document.getElementById('utterances-wrap').insertAdjacentElement('afterbegin',ele)
}

function utterancesTheme () {
  const iframe = document.querySelector('.utterances-frame')
  if (iframe) {
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
    const message = {
      type: 'set-theme',
      theme: theme
    };
    iframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }
}

if ('Utterances' === 'Utterances' || !false) {
  if (false) btf.loadComment(document.getElementById('utterances-wrap'), loadUtterances)
  else loadUtterances()
} else {
  function loadOtherComment () {
    loadUtterances()
  }
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'blog-comments-9gil6as164013b6c',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.vemoji)'))
      }
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'blog-comments-9gil6as164013b6c',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      document.getElementById('twikoo-count').innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Utterances' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>